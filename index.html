<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piscina Dashboard V10</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; --text: #1d1d1f; 
            --success: #34c759; --danger: #ff3b30; --warning: #ff9500; --info: #5ac8fa;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 30px; }
        .container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 30px; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.8rem; font-weight: 800; color: #333; }
        
        /* CARDS GENERALI */
        .card { background: var(--card); border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        .card-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 15px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        /* KPI ROW */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 10px rgba(0,0,0,0.03); position: relative; overflow: hidden; }
        .kpi-label { font-size: 0.8rem; color: #666; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: #333; display: block; }
        .kpi-sub { font-size: 0.85rem; color: #888; margin-top: 5px; font-weight: 500; }
        .trend-pos { color: var(--success); font-weight: 700; }
        .trend-neg { color: var(--danger); font-weight: 700; }
        .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.1; }

        /* INPUT SECTION */
        .input-row-main { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; background: #fafafa; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .input-group { display: flex; flex-direction: column; flex: 1; }
        .input-group label { font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #555; }
        .ticket-box { background: var(--card); border: 1px solid #d2d2d7; padding: 15px; border-radius: 12px; text-align: center; }
        .ticket-box input { width: 100%; font-size: 1.8rem; font-weight: 800; text-align: center; border: none; outline: none; background: transparent; color: var(--primary); }
        select, input[type="date"] { padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 0.95rem; }

        /* BUTTONS */
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--success); color: white; }
        .btn-edit { background: #f0f0f0; color: #333; padding: 6px 12px; border-radius: 6px; margin-right: 5px; }
        .btn-del { background: #fff1f0; color: var(--danger); padding: 6px 12px; border-radius: 6px; }

        /* GRIDS & LAYOUT */
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #eee; }

        /* TABS & FILTERS */
        .filter-header { display: flex; gap: 15px; align-items: center; background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #eee; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { padding: 8px 20px; border-radius: 20px; background: transparent; border: 1px solid transparent; cursor: pointer; font-weight: 600; color: #666; }
        .tab-btn.active { background: #eef2ff; color: var(--primary); border-color: #eef2ff; }

        .hidden { display: none; }
        #login-screen { max-width: 400px; margin: 80px auto; text-align: center; }
        .editing-mode { border: 2px solid var(--primary); background-color: #f0f7ff; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-std { background: #eef2ff; color: var(--primary); }
        .badge-summer { background: #fff8e6; color: #ff9500; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1>üèä‚Äç‚ôÇÔ∏è Dashboard Piscina</h1>
    <div class="card" style="margin-top:20px; text-align:left">
        <label style="font-weight:bold; font-size:0.8rem">Email</label>
        <input type="email" id="email" style="margin-bottom:15px; margin-top:5px; width:100%; padding:10px; border-radius:8px; border:1px solid #ccc">
        <label style="font-weight:bold; font-size:0.8rem">Password</label>
        <input type="password" id="password" style="margin-bottom:20px; margin-top:5px; width:100%; padding:10px; border-radius:8px; border:1px solid #ccc">
        <button class="btn btn-primary" onclick="doLogin()">Entra</button>
        <p id="login-error" style="color:red; margin-top:15px; text-align:center"></p>
    </div>
</div>

<div id="app-screen" class="container hidden">
    
    <div class="header">
        <h1>üìä Executive Dashboard</h1>
        <div>
            <span id="user-display" style="margin-right:15px; font-weight:500; color:#666"></span>
            <button class="btn" style="background:#e5e5ea; padding:8px 16px" onclick="doLogout()">Esci</button>
        </div>
    </div>

    <div class="main-layout">
        
        <div class="card" id="input-card" style="height:fit-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <div class="card-title" id="form-title" style="margin:0; border:none">Nuovo Inserimento</div>
                <button id="cancel-edit" class="btn hidden" onclick="cancelEdit()" style="background:#fff0f0; color:red; padding:6px 12px; font-size:0.8rem">Annulla</button>
            </div>

            <div class="input-group" style="margin-bottom:15px">
                <label>Data</label>
                <input type="date" id="i-date">
            </div>
            
            <div class="input-group" style="margin-bottom:15px">
                <label>Fascia / Vasca</label>
                <select id="i-fascia">
                    <optgroup label="üèä Vasca Interna">
                        <option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option>
                        <option value="Pranzo">Pranzo</option><option value="Sera">Sera</option>
                        <option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option>
                        <option value="Festivo">Festivo</option><option value="Unico">Unico</option>
                    </optgroup>
                    <optgroup label="‚òÄÔ∏è Vasca Esterna">
                        <option value="Estiva - Mattina">Estiva - Mattina</option>
                        <option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option>
                        <option value="Estiva - Unico">Estiva - Unico</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="input-group" style="margin-bottom:20px">
                <label>Meteo</label>
                <select id="i-meteo">
                    <option>‚òÄÔ∏è Sole</option>
                    <option>üî• Caldo elevato</option>
                    <option>‚õÖ Nuvoloso</option>
                    <option>üåßÔ∏è Pioggia</option>
                    <option>‚õàÔ∏è Temporale</option>
                    <option>‚ùÑÔ∏è Freddo</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
                <div class="ticket-box"><label style="font-size:0.7rem; font-weight:700; color:#666">INTERO</label><input type="number" id="q-intero" value="0" min="0" onfocus="this.select()"></div>
                <div class="ticket-box"><label style="font-size:0.7rem; font-weight:700; color:#666">RIDOTTO</label><input type="number" id="q-ridotto" value="0" min="0" onfocus="this.select()"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
                <div class="ticket-box"><label style="font-size:0.7rem; font-weight:700; color:#666">ABB. INT</label><input type="number" id="q-abb-int" value="0" min="0" onfocus="this.select()"></div>
                <div class="ticket-box"><label style="font-size:0.7rem; font-weight:700; color:#666">ABB. RID</label><input type="number" id="q-abb-rid" value="0" min="0" onfocus="this.select()"></div>
            </div>
            <div class="ticket-box" style="margin-bottom:20px"><label style="font-size:0.7rem; font-weight:700; color:#666">GRATUITO</label><input type="number" id="q-gratuito" value="0" min="0" onfocus="this.select()"></div>

            <button id="btn-save" class="btn btn-primary" onclick="saveData()">üíæ Salva</button>
        </div>

        <div>
            
            <div class="filter-header">
                <span style="font-weight:bold; color:#333">üìÖ Periodo:</span>
                <select id="dash-year" style="width:auto; padding:8px" onchange="renderDashboard()"><option value="all">Tutti gli Anni</option></select>
                <select id="dash-month" style="width:auto; padding:8px" onchange="renderDashboard()">
                    <option value="all">Tutto l'anno</option><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                    <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                </select>
                <div style="margin-left:auto" class="tab-menu">
                    <button class="tab-btn active" id="btn-view-dash" onclick="switchView('dash')">üìä Dashboard</button>
                    <button class="tab-btn" id="btn-view-list" onclick="switchView('list')">üìã Elenco Dati</button>
                </div>
            </div>

            <div id="view-dash">
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Totale Ingressi</div>
                        <div class="kpi-value" id="kpi-total">0</div>
                        <div class="kpi-icon">üë•</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Media Giornaliera</div>
                        <div class="kpi-value" id="kpi-avg">0</div>
                        <div class="kpi-sub">persone / giorno</div>
                        <div class="kpi-icon">‚ûó</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Giorno Record</div>
                        <div class="kpi-value" id="kpi-best-val">0</div>
                        <div class="kpi-sub" id="kpi-best-date">-</div>
                        <div class="kpi-icon">üèÜ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Vs Anno Precedente</div>
                        <div class="kpi-value" id="kpi-trend">0%</div>
                        <div class="kpi-sub" id="kpi-trend-label">Rispetto stesso periodo</div>
                        <div class="kpi-icon">üìà</div>
                    </div>
                </div>

                <div class="chart-box" style="margin-bottom:20px">
                    <div class="card-title">Andamento Temporale</div>
                    <canvas id="chartTrend" style="max-height:300px"></canvas>
                </div>

                <div class="analytics-grid">
                    <div class="chart-box">
                        <div class="card-title">Distribuzione Oraria</div>
                        <canvas id="chartFasce" style="max-height:200px"></canvas>
                    </div>
                    <div class="chart-box">
                        <div class="card-title">Composizione Clienti</div>
                        <div style="display:flex; align-items:center">
                            <div style="width:50%"><canvas id="chartPie"></canvas></div>
                            <div style="width:50%; padding-left:15px; font-size:0.85rem; line-height:1.6">
                                <div>Singoli: <b id="lbl-sing">0</b></div>
                                <div>Abbonati: <b id="lbl-abb">0</b></div>
                                <div>Gratuiti: <b id="lbl-grat">0</b></div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <div class="card-title">Impatto Meteo (Media)</div>
                        <canvas id="chartMeteo" style="max-height:200px"></canvas>
                    </div>
                    <div class="chart-box">
                        <div class="card-title">Trend Settimanale</div>
                        <canvas id="chartWeek" style="max-height:200px"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-list" class="card hidden" style="padding:0; overflow:hidden">
                <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:flex-end">
                    <button class="btn btn-success" style="padding:8px 16px; font-size:0.8rem" onclick="downloadCSV()">üì• Scarica Excel Completo</button>
                </div>
                <div style="overflow-y:auto; max-height:700px">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#f9f9f9; text-transform:uppercase; font-size:0.75rem; color:#888;">
                                <th style="padding:15px; text-align:left">Data</th>
                                <th style="padding:15px; text-align:left">Fascia</th>
                                <th style="text-align:center">Sing.</th>
                                <th style="text-align:center">Abb.</th>
                                <th style="text-align:center">Tot</th>
                                <th style="text-align:right; padding-right:15px"></th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚úÖ CONFIGURAZIONE FIREBASE (Non toccare se funzionava gi√†)
    const firebaseConfig = {
      apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0",
      authDomain: "piscinastats-64519.firebaseapp.com",
      projectId: "piscinastats-64519",
      storageBucket: "piscinastats-64519.firebasestorage.app",
      messagingSenderId: "297663099794",
      appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let allData = [];
    let editId = null;

    // --- AUTH ---
    window.doLogin = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
        catch(e) { document.getElementById('login-error').innerText = e.message; }
    };
    window.doLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.email;
            startListening(); 
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    // --- DB LISTENER ---
    function startListening() {
        const q = query(collection(db, "sessioni"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            populateYearFilters();
            renderDashboard(); 
        });
    }

    window.switchView = (view) => {
        document.getElementById('view-dash').classList.add('hidden');
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('btn-view-dash').classList.remove('active');
        document.getElementById('btn-view-list').classList.remove('active');
        
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.getElementById(`btn-view-${view}`).classList.add('active');
        
        if(view === 'list') renderList();
    };

    function populateYearFilters() {
        const years = [...new Set(allData.map(d => d.date.split('-')[0]))].sort().reverse();
        const sel = document.getElementById('dash-year');
        const curr = sel.value;
        sel.innerHTML = '<option value="all">Tutti gli Anni</option>';
        years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
        if(years.includes(curr)) sel.value = curr;
    }

    // --- MAIN DASHBOARD LOGIC ---
    window.renderDashboard = () => {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;

        // 1. FILTER DATA
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) &&
                   ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });

        if(document.getElementById('view-list').classList.contains('hidden') === false) renderList();

        // 2. CALC KPI
        const total = filtered.reduce((a,b)=>a+b.totale,0);
        document.getElementById('kpi-total').innerText = total.toLocaleString();

        // Avg per day
        const uniqueDays = new Set(filtered.map(d => d.date)).size;
        const avg = uniqueDays > 0 ? (total / uniqueDays).toFixed(0) : 0;
        document.getElementById('kpi-avg').innerText = avg;

        // Best Day
        let bestDay = {date:'-', val:0};
        const dayMap = {};
        filtered.forEach(d => {
            if(!dayMap[d.date]) dayMap[d.date] = 0;
            dayMap[d.date] += d.totale;
        });
        Object.entries(dayMap).forEach(([k,v]) => {
            if(v > bestDay.val) bestDay = {date:k, val:v};
        });
        document.getElementById('kpi-best-val').innerText = bestDay.val;
        document.getElementById('kpi-best-date').innerText = bestDay.date !== '-' ? bestDay.date.split('-').reverse().join('/') : '-';

        // TREND vs PREVIOUS YEAR (Growth)
        const trendEl = document.getElementById('kpi-trend');
        const trendLbl = document.getElementById('kpi-trend-label');
        if(y !== 'all') {
            const prevYear = (parseInt(y) - 1).toString();
            const prevData = allData.filter(d => {
                const date = new Date(d.date);
                return (date.getFullYear().toString() === prevYear) &&
                       ((m === 'all') || ((date.getMonth() + 1).toString() === m));
            });
            const prevTotal = prevData.reduce((a,b)=>a+b.totale,0);
            
            if(prevTotal > 0) {
                const diff = ((total - prevTotal) / prevTotal) * 100;
                const sign = diff > 0 ? "+" : "";
                trendEl.innerText = `${sign}${diff.toFixed(1)}%`;
                trendEl.className = diff >= 0 ? "kpi-value trend-pos" : "kpi-value trend-neg";
                trendLbl.innerText = `vs ${prevYear}`;
            } else {
                trendEl.innerText = "N/A";
                trendEl.className = "kpi-value";
                trendLbl.innerText = "No dati anno prec.";
            }
        } else {
            trendEl.innerText = "-";
            trendEl.className = "kpi-value";
            trendLbl.innerText = "Seleziona anno";
        }

        // 3. CHARTS
        
        // A) MAIN TREND CHART
        renderTrendChart(filtered, y, m);

        // B) DEEP CHARTS
        // Fasce
        const fMap = {};
        filtered.forEach(d => { if(!fMap[d.fascia]) fMap[d.fascia]=0; fMap[d.fascia]+=d.totale; });
        const fSorted = Object.entries(fMap).sort((a,b)=>b[1]-a[1]);
        renderBarChart('chartFasce', fSorted.map(x=>x[0]), fSorted.map(x=>x[1]), '#ff9500');

        // Meteo
        const mMap = {};
        filtered.forEach(d => { if(!mMap[d.meteo]) mMap[d.meteo]={t:0,c:0}; mMap[d.meteo].t+=d.totale; mMap[d.meteo].c++; });
        const mLabels = Object.keys(mMap);
        const mData = mLabels.map(k => (mMap[k].t / mMap[k].c).toFixed(0));
        renderBarChart('chartMeteo', mLabels, mData, '#5ac8fa');

        // Week
        const wStats = [0,0,0,0,0,0,0];
        filtered.forEach(d => wStats[new Date(d.date).getDay()] += d.totale);
        renderLineChart('chartWeek', ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'], wStats);

        // Pie
        let s=0, a=0, g=0;
        filtered.forEach(d => { s+=(d.int||0)+(d.rid||0); a+=(d.abb_int||0)+(d.abb_rid||0); g+=(d.grat||0); });
        document.getElementById('lbl-sing').innerText = s;
        document.getElementById('lbl-abb').innerText = a;
        document.getElementById('lbl-grat').innerText = g;
        renderDoughnut('chartPie', [s,a,g]);
    };

    // --- CHART FUNCTIONS ---
    let charts = {};

    function renderTrendChart(data, y, m) {
        const ctx = document.getElementById('chartTrend');
        let labels = [], values = [];
        
        if (m !== 'all') {
            const map = {};
            data.forEach(d => { 
                const day = new Date(d.date).getDate(); 
                if(!map[day]) map[day]=0; map[day]+=d.totale; 
            });
            labels = Object.keys(map).sort((a,b)=>parseInt(a)-parseInt(b));
            values = labels.map(k => map[k]);
        } else {
            const map = {};
            data.forEach(d => { 
                const date = new Date(d.date);
                const k = y === 'all' ? d.date.substring(0,7) : date.getMonth(); 
                if(!map[k]) map[k]=0; map[k]+=d.totale; 
            });
            if (y !== 'all') {
                const monthNames = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
                labels = monthNames;
                values = labels.map((_, i) => map[i] || 0);
            } else {
                labels = Object.keys(map).sort();
                values = labels.map(k => map[k]);
            }
        }
        if(charts['trend']) charts['trend'].destroy();
        charts['trend'] = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Ingressi', data: values, borderColor: '#007aff', backgroundColor:'rgba(0,122,255,0.1)', fill:true, tension:0.3 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
    }

    function renderBarChart(id, l, d, c) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar', data: { labels:l, datasets: [{ label:'', data:d, backgroundColor:c, borderRadius:4 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
    }
    function renderLineChart(id, l, d) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'line', data: { labels:l, datasets: [{ label:'', data:d, borderColor:'#ff3b30', tension:0.3 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
    }
    function renderDoughnut(id, d) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'doughnut', data: { labels:['S','A','G'], datasets:[{ data:d, backgroundColor:['#007aff','#ff9500','#ff3b30'] }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
    }

    // --- LIST & CRUD ---
    function renderList() {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) &&
                   ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });
        
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        filtered.forEach(d => {
            const isSummer = d.fascia.includes("Estiva");
            const badgeClass = isSummer ? 'badge badge-summer' : 'badge badge-std';
            const s = (d.int||0)+(d.rid||0);
            const a = (d.abb_int||0)+(d.abb_rid||0);
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee">
                    <td style="padding:15px; font-weight:600">${d.date.split('-').reverse().join('/')} <span style="font-weight:normal; color:#999; font-size:0.8rem">${d.meteo}</span></td>
                    <td><span class="${badgeClass}">${d.fascia}</span></td>
                    <td style="text-align:center">${s}</td>
                    <td style="text-align:center">${a}</td>
                    <td style="text-align:center; font-weight:bold">${d.totale}</td>
                    <td style="text-align:right">
                        <button class="btn-edit" onclick="startEdit('${d.id}')">‚úèÔ∏è</button>
                        <button class="btn-del" onclick="delItem('${d.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    }

    window.saveData = async () => {
        const date = document.getElementById('i-date').value;
        const v1 = parseInt(document.getElementById('q-intero').value)||0;
        const v2 = parseInt(document.getElementById('q-ridotto').value)||0;
        const v3 = parseInt(document.getElementById('q-gratuito').value)||0;
        const v4 = parseInt(document.getElementById('q-abb-int').value)||0;
        const v5 = parseInt(document.getElementById('q-abb-rid').value)||0;
        const total = v1+v2+v3+v4+v5;

        if(!date || total===0) return alert("Dati incompleti");
        
        const payload = {
            date, fascia: document.getElementById('i-fascia').value,
            meteo: document.getElementById('i-meteo').value,
            int: v1, rid: v2, grat: v3, abb_int: v4, abb_rid: v5, totale: total,
            lastUpdate: new Date()
        };

        const btn = document.getElementById('btn-save'); btn.disabled=true; btn.innerText="Wait...";
        try {
            if(editId) { await updateDoc(doc(db, "sessioni", editId), payload); cancelEdit(); }
            else { await addDoc(collection(db, "sessioni"), payload); resetInputs(); }
        } catch(e) { alert(e.message); }
        btn.disabled=false; btn.innerText= editId ? "Aggiorna" : "üíæ Salva";
    };

    function resetInputs() { document.querySelectorAll('.ticket-box input').forEach(i => i.value=0); }

    window.startEdit = (id) => {
        const item = allData.find(x=>x.id===id); if(!item) return;
        editId = id;
        document.getElementById('i-date').value = item.date;
        document.getElementById('i-fascia').value = item.fascia;
        document.getElementById('i-meteo').value = item.meteo;
        document.getElementById('q-intero').value = item.int;
        document.getElementById('q-ridotto').value = item.rid;
        document.getElementById('q-gratuito').value = item.grat;
        document.getElementById('q-abb-int').value = item.abb_int;
        document.getElementById('q-abb-rid').value = item.abb_rid;
        document.getElementById('btn-save').innerText = "Aggiorna";
        document.getElementById('cancel-edit').classList.remove('hidden');
    };
    window.cancelEdit = () => {
        editId = null; document.getElementById('btn-save').innerText="üíæ Salva";
        document.getElementById('cancel-edit').classList.add('hidden'); resetInputs();
    };
    window.delItem = async (id) => { if(confirm("Eliminare?")) await deleteDoc(doc(db, "sessioni", id)); };

    window.downloadCSV = () => {
        const blob = new Blob([
            "Data;Fascia;Meteo;Singoli;Abbonamenti;Gratuiti;TOTALE\n" + 
            allData.map(d=>`${d.date};${d.fascia};${d.meteo};${(d.int||0)+(d.rid||0)};${(d.abb_int||0)+(d.abb_rid||0)};${d.grat};${d.totale}`).join("\n")
        ], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Report_Piscina.csv"; a.click();
    };

    document.getElementById('i-date').valueAsDate = new Date();
</script>

</body>
</html>
