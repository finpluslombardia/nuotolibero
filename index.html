<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piscina Manager V18</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg-body: #f1f5f9; --bg-sidebar: #0f172a; --text-sidebar: #94a3b8;
            --card-bg: #ffffff; --text-main: #1e293b; --border: #e2e8f0;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 240px; background: var(--bg-sidebar); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px 20px; font-size: 1.1rem; font-weight: 700; color: #fff; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; padding: 20px 10px; margin: 0; flex: 1; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text-sidebar); font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: #1e293b; color: #fff; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        .sidebar-footer { padding: 20px; border-top: 1px solid #1e293b; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }

        /* CONTROL BAR (INPUT SEMPRE VISIBILE) */
        .control-bar { background: #fff; padding: 20px; border-bottom: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); z-index: 10; display: flex; flex-direction: column; gap: 15px; }
        .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .cb-title { font-weight: 700; color: #64748b; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .cb-row { display: flex; gap: 15px; align-items: stretch; }
        
        /* Input Groups */
        .group-ctx { display: flex; gap: 10px; flex: 1; }
        .group-tickets { display: flex; gap: 10px; flex: 2; background: #f8fafc; padding: 5px; border-radius: 10px; border: 1px solid var(--border); }
        .group-actions { display: flex; align-items: stretch; gap: 10px; }

        .inp-field { display: flex; flex-direction: column; flex: 1; }
        .inp-field label { font-size: 0.7rem; font-weight: 600; color: #64748b; margin-bottom: 4px; }
        .inp-field input, .inp-field select { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.9rem; background: #fff; height: 42px; }
        .inp-field input:focus, .inp-field select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

        .t-box { text-align: center; flex: 1; }
        .t-box label { font-size: 0.65rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 2px; white-space: nowrap; }
        .t-box input { width: 100%; text-align: center; font-weight: 700; color: var(--primary); font-size: 1.1rem; border: 1px solid transparent; background: transparent; padding: 5px; height: 35px; }
        .t-box input:focus { background: #fff; border-color: var(--primary); border-radius: 6px; }

        /* SCROLLABLE AREA */
        .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }

        /* DASHBOARD GRID */
        .filter-row { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 20px; }
        .filter-select { background: #fff; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .kpi-head { font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .kpi-val { font-size: 1.8rem; font-weight: 800; color: #0f172a; margin: 5px 0; }
        .kpi-sub { font-size: 0.8rem; font-weight: 500; }
        
        .charts-main { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .charts-sub { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 320px; display: flex; flex-direction: column; }
        .chart-card.small { height: 250px; }
        .chart-title { font-weight: 700; color: #334155; margin-bottom: 15px; font-size: 0.95rem; }

        /* BUTTONS */
        .btn { padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.1s; height: 42px; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(37,99,235,0.2); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .btn-icon { padding: 6px; width: 30px; height: 30px; border-radius: 6px; }

        /* TABLE */
        .table-wrap { background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .badge-summer { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .badge-std { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }

        .hidden { display: none !important; }
        .editing-mode { border: 2px solid var(--warning) !important; background: #fffbeb !important; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="width: 320px; text-align: center;">
        <h2 style="color:#0f172a; margin-bottom: 20px;">üîê Accesso Piscina</h2>
        <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #cbd5e1; border-radius:8px;">
        <input type="password" id="password" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:8px;">
        <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Entra</button>
        <p id="login-error" style="color:var(--danger); font-size:0.85rem; margin-top:15px"></p>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">üèä‚Äç‚ôÇÔ∏è Piscina Manager</div>
    <ul class="nav-links">
        <li class="nav-item active" id="nav-dash" onclick="switchView('dash')">üìä Dashboard</li>
        <li class="nav-item" id="nav-list" onclick="switchView('list')">üìã Archivio Dati</li>
    </ul>
    <div class="sidebar-footer">
        <div style="font-size:0.8rem; margin-bottom:10px; color:#64748b" id="user-display">User</div>
        <button class="btn" style="width:100%; background:transparent; border:1px solid #334155; color:#94a3b8; font-size:0.8rem" onclick="doLogout()">Disconnetti</button>
    </div>
</div>

<div class="main-content">
    
    <div class="control-bar" id="input-bar">
        <div class="cb-header">
            <span class="cb-title" id="form-title">Nuova Registrazione</span>
            <button id="cancel-edit" class="btn btn-danger hidden" style="height:30px; font-size:0.75rem" onclick="cancelEdit()">Annulla Modifica</button>
        </div>
        <div class="cb-row">
            <div class="group-ctx">
                <div class="inp-field" style="flex:0.8">
                    <label>Data</label>
                    <input type="date" id="i-date">
                </div>
                <div class="inp-field" style="flex:1.2">
                    <label>Fascia</label>
                    <select id="i-fascia">
                        <optgroup label="üèä Vasca Interna">
                            <option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option>
                            <option value="Pranzo">Pranzo</option><option value="Sera">Sera</option>
                            <option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option>
                            <option value="Festivo">Festivo</option><option value="Unico">Unico</option>
                        </optgroup>
                        <optgroup label="‚òÄÔ∏è Vasca Esterna">
                            <option value="Estiva - Mattina">Estiva - Mattina</option>
                            <option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option>
                            <option value="Estiva - Unico">Estiva - Unico</option>
                        </optgroup>
                    </select>
                </div>
                <div class="inp-field" style="flex:1">
                    <label>Meteo</label>
                    <select id="i-meteo">
                        <option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option>
                        <option value="üî• Sole + Caldo">üî• Sole + Caldo</option>
                        <option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option>
                        <option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option>
                        <option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option>
                        <option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option>
                        <option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option>
                        <option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option>
                        <option value="‚ùì N/D">‚ùì N/D</option>
                    </select>
                </div>
            </div>

            <div class="group-tickets">
                <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>ABB. PERIODO</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>ABB. 11 INGR.</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>GRATUITO</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
            </div>

            <div class="group-actions">
                <button id="btn-save" class="btn btn-primary" style="height:100%; min-width:100px" onclick="saveData()">SALVA</button>
            </div>
        </div>
    </div>

    <div class="scroll-area">
        
        <div id="view-dash">
            
            <div class="filter-row">
                <span style="font-weight:600; color:#64748b; font-size:0.9rem">Analisi Periodo:</span>
                <select id="dash-year" class="filter-select" onchange="renderDashboard()"><option value="all">Tutti gli Anni</option></select>
                <select id="dash-month" class="filter-select" onchange="renderDashboard()">
                    <option value="all">Tutto l'anno</option><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                    <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                </select>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-head">Media Giornaliera</div>
                    <div class="kpi-val" id="kpi-avg">0</div>
                    <div class="kpi-sub">persone / giorno</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-head">Vs Mese Precedente</div>
                    <div class="kpi-val" id="kpi-mom">0%</div>
                    <div class="kpi-sub" id="kpi-mom-label">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-head">Vs Anno Precedente</div>
                    <div class="kpi-val" id="kpi-yoy">0%</div>
                    <div class="kpi-sub" id="kpi-yoy-label">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-head">Proiezione Mese</div>
                    <div class="kpi-val" id="kpi-forecast" style="color:var(--info)">-</div>
                    <div class="kpi-sub" id="kpi-forecast-sub">stimata</div>
                </div>
            </div>

            <div class="charts-main">
                <div class="chart-card">
                    <div class="chart-title">Andamento Stagionale (Confronto Anni)</div>
                    <canvas id="chartYoY"></canvas>
                </div>
                <div class="chart-card" style="justify-content:center; text-align:center">
                    <div class="chart-title">Composizione</div>
                    <canvas id="chartPie" style="max-height:180px"></canvas>
                    <div style="margin-top:20px; font-size:0.9rem">
                        Totale: <strong id="deep-total" style="color:var(--primary); font-size:1.2rem">0</strong>
                    </div>
                </div>
            </div>

            <div class="charts-sub">
                <div class="chart-card small">
                    <div class="chart-title">Impatto Meteo</div>
                    <canvas id="chartMeteo"></canvas>
                </div>
                <div class="chart-card small">
                    <div class="chart-title">Trend Settimanale</div>
                    <canvas id="chartWeek"></canvas>
                </div>
                <div class="chart-card small">
                    <div class="chart-title">Fasce Orarie</div>
                    <canvas id="chartFasce"></canvas>
                </div>
            </div>
        </div>

        <div id="view-list" class="hidden">
            <div class="table-wrap">
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
                    <h3 style="margin:0; font-size:1.1rem; color:#334155">Archivio Completo</h3>
                    <button class="btn btn-primary" style="height:35px; font-size:0.8rem" onclick="downloadCSV()">Scarica Excel</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="data-table">
                        <thead>
                            <tr><th>Data</th><th>Fascia</th><th>Meteo</th><th>Singoli</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right">Azioni</th></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0",
      authDomain: "piscinastats-64519.firebaseapp.com",
      projectId: "piscinastats-64519",
      storageBucket: "piscinastats-64519.firebasestorage.app",
      messagingSenderId: "297663099794",
      appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let allData = [];
    let editId = null;

    // AUTH
    window.doLogin = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
        catch(e) { document.getElementById('login-error').innerText = e.message; }
    };
    window.doLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-display').innerText = user.email.split('@')[0];
            startListening(); 
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    });

    // DATA
    function startListening() {
        const q = query(collection(db, "sessioni"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            populateYearFilters();
            renderDashboard();
        });
    }

    // ACTIONS
    window.saveData = async () => {
        const date = document.getElementById('i-date').value;
        if(!date) return alert("Inserisci la data");
        const v1=parseInt(document.getElementById('q-intero').value)||0;
        const v2=parseInt(document.getElementById('q-ridotto').value)||0;
        const v3=parseInt(document.getElementById('q-gratuito').value)||0;
        const v4=parseInt(document.getElementById('q-abb-int').value)||0; // Abb Periodo
        const v5=parseInt(document.getElementById('q-abb-rid').value)||0; // Abb 11 Ingr
        const total = v1+v2+v3+v4+v5;
        if(total===0) return alert("Inserisci almeno un ingresso");

        const payload = {
            date, fascia: document.getElementById('i-fascia').value,
            meteo: document.getElementById('i-meteo').value,
            int: v1, rid: v2, grat: v3, abb_int: v4, abb_rid: v5, totale: total, lastUpdate: new Date()
        };

        const btn = document.getElementById('btn-save');
        btn.innerText = "Salvataggio..."; btn.disabled = true;

        try {
            if(editId) { await updateDoc(doc(db, "sessioni", editId), payload); cancelEdit(); }
            else { await addDoc(collection(db, "sessioni"), payload); resetInputs(); }
        } catch(e) { alert(e.message); }
        
        btn.innerText = editId ? "AGGIORNA" : "SALVA"; btn.disabled = false;
    };

    window.editItem = (id) => {
        const d = allData.find(x=>x.id===id); if(!d) return;
        editId = id;
        document.getElementById('i-date').value = d.date;
        document.getElementById('i-fascia').value = d.fascia;
        document.getElementById('i-meteo').value = d.meteo;
        document.getElementById('q-intero').value = d.int;
        document.getElementById('q-ridotto').value = d.rid;
        document.getElementById('q-gratuito').value = d.grat;
        document.getElementById('q-abb-int').value = d.abb_int;
        document.getElementById('q-abb-rid').value = d.abb_rid;
        
        document.getElementById('form-title').innerText = "Modifica ID: " + id.substr(0,4);
        document.getElementById('btn-save').innerText = "AGGIORNA";
        document.getElementById('btn-save').style.backgroundColor = "var(--warning)";
        document.getElementById('cancel-edit').classList.remove('hidden');
        document.getElementById('input-bar').classList.add('editing-mode');
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.cancelEdit = () => {
        editId = null; resetInputs();
        document.getElementById('form-title').innerText = "Nuova Registrazione";
        document.getElementById('btn-save').innerText = "SALVA";
        document.getElementById('btn-save').style.backgroundColor = "var(--primary)";
        document.getElementById('cancel-edit').classList.add('hidden');
        document.getElementById('input-bar').classList.remove('editing-mode');
    };

    window.delItem = async (id) => { if(confirm("Eliminare?")) await deleteDoc(doc(db, "sessioni", id)); };
    
    function resetInputs() { document.querySelectorAll('.t-box input').forEach(i => i.value=0); }

    // DASHBOARD & UTILS
    window.switchView = (view) => {
        document.getElementById('view-dash').classList.add('hidden');
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('nav-dash').classList.remove('active');
        document.getElementById('nav-list').classList.remove('active');
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.getElementById(`nav-${view}`).classList.add('active');
        if(view === 'list') renderList();
    };

    function populateYearFilters() {
        const years = [...new Set(allData.map(d => d.date.split('-')[0]))].sort().reverse();
        const sel = document.getElementById('dash-year');
        const curr = sel.value;
        sel.innerHTML = '<option value="all">Tutti gli Anni</option>';
        years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
        if(years.includes(curr)) sel.value = curr;
    }

    window.renderDashboard = () => {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) &&
                   ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });

        // KPI
        const total = filtered.reduce((a,b)=>a+b.totale,0);
        document.getElementById('deep-total').innerText = total.toLocaleString();
        
        const uniqueDays = new Set(filtered.map(d => d.date)).size;
        document.getElementById('kpi-avg').innerText = uniqueDays > 0 ? (total / uniqueDays).toFixed(0) : 0;

        // Forecast
        const now = new Date();
        if(y === now.getFullYear().toString() && m === (now.getMonth()+1).toString()) {
            const daysInM = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            const proj = Math.round((total / now.getDate()) * daysInM);
            document.getElementById('kpi-forecast').innerText = proj.toLocaleString();
        } else { document.getElementById('kpi-forecast').innerText = "-"; }

        // Trends
        calcTrend('kpi-yoy', total, y, m, 'year');
        calcTrend('kpi-mom', total, y, m, 'month');

        renderCharts(filtered, y, m);
        if(!document.getElementById('view-list').classList.contains('hidden')) renderList();
    };

    function calcTrend(elId, curr, y, m, type) {
        const el = document.getElementById(elId);
        const lbl = document.getElementById(elId+'-label');
        if(y==='all') { el.innerText="-"; lbl.innerText="Seleziona periodo"; return; }
        
        let prevTotal = 0, txt = "";
        if(type==='year') {
            const prevY = (parseInt(y)-1).toString();
            prevTotal = allData.filter(d => d.date.startsWith(prevY) && (m==='all' || (new Date(d.date).getMonth()+1)==m)).reduce((a,b)=>a+b.totale,0);
            txt = `vs ${prevY}`;
        } else {
            if(m==='all') { el.innerText="-"; return; }
            let pM = parseInt(m)-1, pY = parseInt(y);
            if(pM===0) { pM=12; pY--; }
            prevTotal = allData.filter(d => { const dt=new Date(d.date); return dt.getFullYear()==pY && (dt.getMonth()+1)==pM; }).reduce((a,b)=>a+b.totale,0);
            txt = "vs Mese prec.";
        }

        if(prevTotal > 0) {
            const diff = ((curr - prevTotal)/prevTotal)*100;
            el.innerText = (diff>0?"+":"") + diff.toFixed(1) + "%";
            el.className = diff>=0 ? "kpi-val trend-up" : "kpi-val trend-down";
            lbl.innerText = txt;
        } else { el.innerText = "N/A"; el.className = "kpi-val"; lbl.innerText = "No dati storici"; }
    }

    let chartInstances = {};
    function renderCharts(data, y, m) {
        // YoY
        const ctxYoY = document.getElementById('chartYoY');
        const labels = m !== 'all' ? Array.from({length:31},(_,i)=>i+1) : ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
        const currData = new Array(labels.length).fill(0);
        data.forEach(d => currData[(m!=='all' ? new Date(d.date).getDate()-1 : new Date(d.date).getMonth())] += d.totale);
        
        let datasets = [{ label: y==='all'?'Totale':y, data: currData, borderColor: '#2563eb', backgroundColor:'rgba(37,99,235,0.1)', fill:true, tension:0.4 }];
        
        if(y!=='all') {
            const prevY = (parseInt(y)-1).toString();
            const prevDataArr = new Array(labels.length).fill(0);
            allData.filter(d => d.date.startsWith(prevY) && (m==='all' || (new Date(d.date).getMonth()+1)==m))
                   .forEach(d => prevDataArr[(m!=='all' ? new Date(d.date).getDate()-1 : new Date(d.date).getMonth())] += d.totale);
            datasets.push({ label: prevY, data: prevDataArr, borderColor: '#9ca3af', borderDash:[5,5], tension:0.4, pointRadius:0, fill:false });
        }

        if(chartInstances['yoy']) chartInstances['yoy'].destroy();
        chartInstances['yoy'] = new Chart(ctxYoY, { type: 'line', data: { labels, datasets }, options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} } });

        // Pie
        let s=0, a=0, g=0; data.forEach(d => { s+=(d.int||0)+(d.rid||0); a+=(d.abb_int||0)+(d.abb_rid||0); g+=(d.grat||0); });
        if(chartInstances['pie']) chartInstances['pie'].destroy();
        chartInstances['pie'] = new Chart(document.getElementById('chartPie'), { type:'doughnut', data:{labels:['Singoli','Abbonati','Gratuiti'], datasets:[{data:[s,a,g], backgroundColor:['#3b82f6','#f59e0b','#ef4444']}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}} });

        // Meteo
        const mMap = {}; data.forEach(d => { if(!mMap[d.meteo]) mMap[d.meteo]={t:0,c:0}; mMap[d.meteo].t+=d.totale; mMap[d.meteo].c++; });
        if(chartInstances['meteo']) chartInstances['meteo'].destroy();
        chartInstances['meteo'] = new Chart(document.getElementById('chartMeteo'), { type:'bar', data:{labels:Object.keys(mMap), datasets:[{label:'Media', data:Object.keys(mMap).map(k=>(mMap[k].t/mMap[k].c).toFixed(0)), backgroundColor:'#0ea5e9'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });

        // Week
        const wStats = [0,0,0,0,0,0,0]; data.forEach(d => wStats[new Date(d.date).getDay()] += d.totale);
        if(chartInstances['week']) chartInstances['week'].destroy();
        chartInstances['week'] = new Chart(document.getElementById('chartWeek'), { type:'bar', data:{labels:['Dom','Lun','Mar','Mer','Gio','Ven','Sab'], datasets:[{label:'Totale', data:wStats, backgroundColor:'#8b5cf6', borderRadius:4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });

        // Fasce
        const fMap = {}; data.forEach(d => { if(!fMap[d.fascia]) fMap[d.fascia]=0; fMap[d.fascia]+=d.totale; });
        const fSort = Object.entries(fMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        if(chartInstances['fasce']) chartInstances['fasce'].destroy();
        chartInstances['fasce'] = new Chart(document.getElementById('chartFasce'), { type:'bar', data:{labels:fSort.map(x=>x[0]), datasets:[{label:'', data:fSort.map(x=>x[1]), backgroundColor:'#f59e0b', borderRadius:4}]}, options:{responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}} });
    }

    function renderList() {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) && ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        filtered.forEach(d => {
            const isSum = d.fascia.includes("Estiva");
            const badge = isSum ? 'badge badge-summer' : 'badge badge-std';
            const s = (d.int||0)+(d.rid||0); const a = (d.abb_int||0)+(d.abb_rid||0);
            tbody.innerHTML += `<tr>
                <td><span style="font-weight:600">${d.date.split('-').reverse().join('/')}</span></td>
                <td><span class="${badge}">${d.fascia}</span></td>
                <td style="font-size:0.85rem; color:#64748b">${d.meteo}</td>
                <td style="text-align:center">${s}</td><td style="text-align:center">${a}</td><td style="text-align:center">${d.grat}</td>
                <td style="font-weight:800; color:var(--primary); text-align:center">${d.totale}</td>
                <td style="text-align:right">
                    <button class="btn btn-icon" style="color:#3b82f6; background:#eff6ff" onclick="window.editItem('${d.id}')">‚úèÔ∏è</button>
                    <button class="btn btn-icon" style="color:#ef4444; background:#fef2f2" onclick="window.delItem('${d.id}')">üóëÔ∏è</button>
                </td></tr>`;
        });
    }

    window.downloadCSV = () => {
        const blob = new Blob([ "Data;Fascia;Meteo;Singoli;Abbonamenti;Gratuiti;TOTALE\n" + allData.map(d=>`${d.date};${d.fascia};${d.meteo};${(d.int||0)+(d.rid||0)};${(d.abb_int||0)+(d.abb_rid||0)};${d.grat};${d.totale}`).join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Report.csv"; a.click();
    };

    document.getElementById('i-date').valueAsDate = new Date();
</script>

</body>
</html>
