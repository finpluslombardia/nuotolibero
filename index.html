<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Facility Manager - Stat CF Lampugnano</title>
<!-- Font e Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        --primary: #3b82f6; /* Blue 500 */
        --primary-dark: #2563eb; /* Blue 600 */
        --secondary: #64748b; /* Slate 500 */
        --bg-body: #f1f5f9; /* Slate 100 */
        --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
        --text-main: #0f172a; /* Slate 900 */
        --text-muted: #64748b; /* Slate 500 */
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: 1px solid rgba(255, 255, 255, 0.8);
        --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --glass-blur: blur(12px);
        --sidebar-bg: #0f172a;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --radius: 12px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-main);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    /* UTILITIES */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { display: flex; flex-direction: column; }
    .gap-10 { gap: 10px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .w-full { width: 100%; }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    
    /* TOAST */
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: all 0.3s; pointer-events: auto; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { border-left: 4px solid var(--success); } 
    .toast-error { border-left: 4px solid var(--danger); }

    /* LAYOUT & SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 50; }
    .sidebar-header { padding: 25px 20px; font-size: 1.2rem; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; }
    .nav-section-title { padding: 20px 20px 8px; font-size: 0.7rem; text-transform: uppercase; color: #64748b; font-weight: 700; letter-spacing: 1px; }
    .nav-links { list-style: none; padding: 0 10px; margin: 0; }
    .nav-item { padding: 10px 15px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.95rem; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; font-weight: 600; }
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
    
    .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(2px); }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; }
    
    /* TOP BAR / CONTROL BAR */
    .control-bar { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; padding: 15px 20px; z-index: 30; flex-shrink: 0; transition: background 0.3s; }
    .control-bar.editing { background: #fffbeb; border-bottom: 2px solid var(--warning); }
    
    .mobile-header { display: none; padding: 15px; background: white; border-bottom: 1px solid #e2e8f0; align-items: center; gap: 15px; flex-shrink: 0; }
    .hamburger { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); padding: 0; }

    /* INPUTS & FORMS */
    .cb-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
    .inp-field { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
    .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .inp-field input, .inp-field select { width: 100%; height: 40px; padding: 0 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; color: var(--text-main); font-size: 0.9rem; transition: border 0.2s; font-family: inherit; }
    .inp-field input:focus, .inp-field select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    /* SPECIAL INPUTS */
    .group-tickets { display: flex; gap: 5px; background: white; padding: 5px 10px; border-radius: 10px; border: 1px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); overflow-x: auto; }
    .t-box { text-align: center; min-width: 60px; flex: 1; }
    .t-box label { font-size: 0.65rem; color: #94a3b8; display: block; margin-bottom: 2px; }
    .t-box input { border: none; background: transparent; text-align: center; font-weight: 700; font-size: 1.1rem; color: var(--primary-dark); padding: 0; height: auto; }
    .t-box input:focus { box-shadow: none; color: var(--text-main); }

    /* BUTTONS */
    .btn { height: 40px; padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid transparent; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; white-space: nowrap; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
    .btn-danger:hover { background: #fecaca; }
    .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 6px; }

    /* CONTENT AREA */
    .scroll-area { flex: 1; overflow-y: auto; padding: 20px; overflow-x: hidden; }
    .glass-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: var(--radius); box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 20px; margin-bottom: 20px; }
    
    /* KPIS & CHARTS */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .kpi-card { background: rgba(255,255,255,0.8); padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; }
    .kpi-val { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; margin: 5px 0; }
    .kpi-head { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    
    .chart-wrapper { position: relative; height: 300px; width: 100%; }

    /* TABLE STYLES */
    .table-container { overflow-x: auto; border-radius: var(--radius); background: rgba(255,255,255,0.5); border: 1px solid #cbd5e1; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; padding: 12px 16px; background: rgba(255,255,255,0.8); font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; backdrop-filter: blur(5px); }
    td { padding: 10px 16px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; color: #334155; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.5); }
    
    /* BADGES & COLORS IN TABLE */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
    .badge-ok { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
    .badge-ko { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .badge-warn { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
    .cell-date { font-weight: 700; color: var(--text-main); }
    .cell-sub { font-size: 0.8rem; color: var(--text-muted); }
    .cell-bold { font-weight: 700; }
    .cell-primary { color: var(--primary-dark); font-weight: 700; }

    /* LOADING SPINNER */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: opacity 0.3s; opacity: 0; pointer-events: none; }
    #loading-overlay.active { opacity: 1; pointer-events: all; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* LOGIN SCREEN */
    #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
    
    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
        .sidebar { position: fixed; height: 100%; left: 0; top: 0; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .mobile-header { display: flex; }
        .control-bar { padding: 10px 15px; }
        .cb-row { flex-direction: column; align-items: stretch; gap: 10px; }
        .inp-field { width: 100%; }
        .group-tickets { overflow-x: auto; padding-bottom: 10px; }
        .mobile-overlay.open { display: block; }
        .kpi-grid { grid-template-columns: 1fr 1fr; }
        .charts-row-split { grid-template-columns: 1fr; }
        .group-ctx { flex-wrap: wrap; }
    }
</style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay"><div class="spinner"></div></div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div class="glass-card" style="width:100%; max-width:400px; text-align:center; padding: 40px;">
        <h2 style="margin-bottom:10px; font-size:1.8rem;">üèä‚Äç‚ôÇÔ∏è Accesso</h2>
        <p style="color:var(--text-muted); margin-bottom:30px">Facility Manager Lampugnano</p>
        <div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div>
        <div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div>
        <button class="btn btn-primary w-full" style="height:48px;" onclick="doLogin()">Entra</button>
        <p id="login-error" style="color:var(--danger); font-size:0.85rem; margin-top:20px; font-weight:600"></p>
    </div>
</div>

<!-- MOBILE OVERLAY -->
<div class="mobile-overlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Facility Manager</span>
        <button class="hamburger" style="color:white; font-size:1.2rem; display:none" onclick="toggleSidebar()">‚úï</button>
    </div>
    
    <div class="nav-section-title">Operativit√†</div>
    <ul class="nav-links">
        <li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">
            <span>üé´</span> Ingressi Nuoto
        </li>
    </ul>

    <div class="nav-section-title">Controllo Tecnico</div>
    <ul class="nav-links">
        <li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')"><span>üíß</span> Valori Vasca</li>
        <li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')"><span>‚ö°</span> Controllo DAE</li>
        <li class="nav-item" id="nav-module-utenze" onclick="switchModule('utenze')"><span>üìä</span> Utenze & Consumi</li>
    </ul>

    <div class="sidebar-footer">
        <div style="font-size:0.85rem; margin-bottom:10px; color:#94a3b8;" id="user-display">Utente</div>
        <button class="btn w-full" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-size:0.8rem;" onclick="doLogout()">Esci</button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
    <!-- MOBILE HEADER -->
    <div class="mobile-header">
        <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
        <span style="font-weight:700; font-size:1.1rem">Facility Manager</span>
    </div>

    <!-- MODULE INGRESSI -->
    <div id="module-ingressi" class="module-container flex-col h-full">
        <div class="control-bar" id="cb-ingressi">
            <div class="flex justify-between items-center" style="margin-bottom:15px">
                <span class="font-bold uppercase text-xs" style="color:var(--text-muted)" id="title-ingressi">Nuova Registrazione</span>
                <button class="btn btn-danger hidden" id="cancel-ingressi" onclick="cancelEditIngressi()">Annulla</button>
            </div>
            
            <div class="cb-row">
                <div class="flex gap-10 group-ctx" style="flex:2">
                    <div class="inp-field"><label>Data</label><input type="date" id="i-date"></div>
                    <div class="inp-field"><label>Tipo Giorno</label>
                        <select id="i-type">
                            <option value="standard">üè¢ Standard</option>
                            <option value="festivo">üî¥ Festivo</option>
                            <option value="evento">üèÜ Evento</option>
                            <option value="maltempo">‚õàÔ∏è Maltempo</option>
                            <option value="extra">‚ö†Ô∏è Straordinario</option>
                        </select>
                    </div>
                    <div class="inp-field"><label>Fascia</label>
                        <select id="i-fascia">
                            <optgroup label="Vasca Interna">
                                <option value="Mattina">Mattina</option>
                                <option value="Mattina intera">Mattina intera</option>
                                <option value="Pranzo">Pranzo</option>
                                <option value="Sera">Sera</option>
                                <option value="Sabato pom">Sabato pom</option>
                                <option value="Domenica">Domenica</option>
                                <option value="Festivo">Festivo</option>
                                <option value="Unico">Unico</option>
                            </optgroup>
                            <optgroup label="Vasca Esterna">
                                <option value="Estiva - Mattina">Estiva - Mattina</option>
                                <option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option>
                                <option value="Estiva - Unico">Estiva - Unico</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="inp-field"><label>Meteo</label>
                        <select id="i-meteo">
                            <option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option>
                            <option value="üî• Sole + Caldo">üî• Sole + Caldo</option>
                            <option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option>
                            <option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option>
                            <option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option>
                            <option value="üå§Ô∏è Parz. Nuv.">üå§Ô∏è Parz. Nuv.</option>
                        </select>
                    </div>
                    <div class="inp-field items-center" style="flex:0.5; justify-content:center">
                         <label style="cursor:pointer; color:var(--danger); text-align:center">
                            <input type="checkbox" id="i-exclude"> NO MEDIA
                         </label>
                    </div>
                </div>

                <div class="group-tickets" style="flex:2">
                    <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB.PER</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB.11</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>GRATIS</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
                </div>
                
                <div style="flex:0.5; min-width:100px">
                    <button id="btn-save-ingressi" class="btn btn-primary w-full" style="height:60px" onclick="saveIngressi()">SALVA</button>
                </div>
            </div>
        </div>

        <div class="scroll-area">
            <div class="flex gap-10" style="margin-bottom:20px; overflow-x:auto; padding-bottom:5px">
                <button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button>
                <button class="btn" style="background:white; border:1px solid #e2e8f0" id="btn-sub-stats" onclick="switchSubView('stats')">Analisi</button>
                <button class="btn" style="background:white; border:1px solid #e2e8f0" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button>
            </div>

            <!-- SUB: OVERVIEW -->
            <div id="sub-overview">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-head">Media Giornaliera (Mese)</div>
                        <div class="kpi-val" id="ov-avg">0</div>
                        <div class="text-xs text-muted">persone / giorno</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-head">Vs Mese Precedente</div>
                        <div class="kpi-val" id="ov-mom">0%</div>
                        <div class="text-xs text-muted" id="ov-mom-label">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-head">Vs Anno Precedente</div>
                        <div class="kpi-val" id="ov-yoy">0%</div>
                        <div class="text-xs text-muted" id="ov-yoy-label">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-head">Proiezione Fine Mese</div>
                        <div class="kpi-val" id="ov-forecast" style="color:#a855f7">-</div>
                        <div class="text-xs text-muted">stima basata su media</div>
                    </div>
                </div>
                <div class="glass-card">
                    <div class="flex justify-between items-center" style="margin-bottom:15px">
                        <h3 style="margin:0; font-size:1rem">Andamento Ultimi 30 Giorni</h3>
                    </div>
                    <div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div>
                </div>
            </div>

            <!-- SUB: STATS -->
            <div id="sub-stats" class="hidden">
                 <div class="glass-card flex flex-col gap-10">
                    <h3 style="margin:0">Filtri Analisi</h3>
                    <div class="flex gap-10" style="flex-wrap:wrap">
                        <div class="inp-field"><label>Anno</label><select id="stat-year" onchange="renderStats()"></select></div>
                        <div class="inp-field"><label>Vasca</label><select id="stat-pool-filter" onchange="renderStats()"><option value="all">Tutte</option><option value="indoor">Interna</option><option value="outdoor">Esterna</option></select></div>
                    </div>
                 </div>
                 <div class="glass-card">
                    <h3 style="margin-bottom:15px">Andamento Mensile (Anno su Anno)</h3>
                    <div class="chart-wrapper"><canvas id="chartYoY"></canvas></div>
                 </div>
            </div>

            <!-- SUB: ARCHIVE -->
            <div id="sub-archive" class="hidden">
                 <div class="glass-card flex gap-10" style="flex-wrap:wrap; align-items:flex-end">
                     <div class="inp-field"><label>Dal</label><input type="date" id="arch-date-start"></div>
                     <div class="inp-field"><label>Al</label><input type="date" id="arch-date-end"></div>
                     <button class="btn btn-primary" onclick="renderIngressiArchive()">Cerca</button>
                     <button class="btn" onclick="downloadCSV()" style="margin-left:auto; border:1px solid #cbd5e1">üì• Excel</button>
                 </div>
                 <div class="table-container">
                     <table>
                         <thead><tr><th>Data</th><th>Dettagli</th><th>Interi</th><th>Ridotti</th><th>Abb.</th><th>Totale</th><th>Azioni</th></tr></thead>
                         <tbody id="tbody-ingressi"></tbody>
                     </table>
                 </div>
            </div>
        </div>
    </div>

    <!-- MODULE VASCA -->
    <div id="module-vasca" class="module-container hidden flex-col h-full">
        <div class="control-bar" id="cb-vasca">
             <div class="flex justify-between items-center mb-2" style="margin-bottom:10px">
                <span class="font-bold uppercase text-xs text-muted" id="title-vasca">Diario Vasca</span>
                <button class="btn btn-danger hidden" id="cancel-vasca" onclick="cancelEditVasca()">Annulla</button>
            </div>
            <div class="cb-row">
                <div class="flex gap-10 group-ctx" style="flex:1.5">
                    <div class="inp-field"><label>Data</label><input type="date" id="v-date"></div>
                    <div class="inp-field"><label>Ora</label><input type="time" id="v-time"></div>
                    <div class="inp-field"><label>Vasca</label><select id="v-type"><option value="interna">üè† Interna</option><option value="esterna">‚òÄÔ∏è Esterna</option></select></div>
                </div>
                <div class="group-tickets" style="flex:2">
                    <div class="t-box"><label>BAGN.</label><input type="number" id="v-bag" value="0"></div>
                    <div class="t-box"><label>T.ARIA</label><input type="number" step="0.1" id="v-ta" value="0"></div>
                    <div class="t-box"><label>T.H2O</label><input type="number" step="0.1" id="v-th" value="0"></div>
                    <div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div>
                    <div class="t-box"><label>Cl LIB</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div>
                    <div class="t-box"><label>Cl COMB</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div>
                    <div class="t-box"><label>Cl TOT</label><input type="number" step="0.1" id="v-clt" value="0" readonly style="color:#94a3b8"></div>
                </div>
                <button id="btn-save-vasca" class="btn btn-primary" onclick="saveVasca()" style="height:60px">SALVA</button>
            </div>
        </div>
        <div class="scroll-area">
             <div class="table-container">
                 <table>
                     <thead><tr><th>Data/Ora</th><th>Parametri Fisici</th><th>Chimica (pH/Cl)</th><th>Azioni</th></tr></thead>
                     <tbody id="tbody-vasca"></tbody>
                 </table>
             </div>
        </div>
    </div>

    <!-- MODULE DAE -->
    <div id="module-dae" class="module-container hidden flex-col h-full">
         <div class="control-bar">
            <span class="font-bold uppercase text-xs text-muted mb-2 block">Controllo DAE</span>
            <div class="cb-row">
                 <div class="inp-field"><label>Data</label><input type="date" id="d-date" readonly style="background:#f1f5f9"></div>
                 <div class="inp-field"><label>Stato</label><select id="d-status"><option value="OK">‚úÖ Operativo</option><option value="GUASTO">‚ùå Guasto / Anomalia</option></select></div>
                 <div class="inp-field flex-1"><label>Assistente Bagnanti</label><input type="text" id="d-ass" placeholder="Nome Cognome"></div>
                 <div class="inp-field flex-1"><label>Operatore</label><input type="text" id="d-op" placeholder="Chi firma?"></div>
                 <button class="btn btn-primary" onclick="saveDae()">REGISTRA</button>
            </div>
         </div>
         <div class="scroll-area">
             <div class="table-container">
                 <table>
                     <thead><tr><th>Data</th><th>Stato</th><th>Responsabili</th><th></th></tr></thead>
                     <tbody id="tbody-dae"></tbody>
                 </table>
             </div>
         </div>
    </div>

    <!-- MODULE UTENZE -->
    <div id="module-utenze" class="module-container hidden flex-col h-full">
         <div class="control-bar" id="cb-utenze">
            <div class="flex justify-between items-center mb-2" style="margin-bottom:10px">
                <span class="font-bold uppercase text-xs text-muted" id="title-utenze">Letture Contatori</span>
                <button class="btn btn-danger hidden" id="cancel-utenze" onclick="cancelEditUtenze()">Annulla</button>
            </div>
            <div class="cb-row">
                <div class="inp-field"><label>Data</label><input type="date" id="u-date"></div>
                <div class="inp-field"><label>Utenza</label>
                    <select id="u-type" onchange="toggleUtenzeMode()">
                        <option value="‚ö° Elettricit√†">‚ö° Elettricit√†</option>
                        <option value="üíß Acqua">üíß Acqua (m¬≥)</option>
                        <option value="üî• Gas Metano">üî• Gas Metano (m¬≥)</option>
                    </select>
                </div>
                
                <!-- Campi Dinamici -->
                <div id="u-elec-input" class="flex gap-10" style="flex:2">
                    <div class="inp-field"><label>F1 (A1)</label><input type="number" id="u-a1" step="any"></div>
                    <div class="inp-field"><label>F2 (A2)</label><input type="number" id="u-a2" step="any"></div>
                    <div class="inp-field"><label>F3 (A3)</label><input type="number" id="u-a3" step="any"></div>
                </div>
                <div id="u-single-input" class="inp-field hidden" style="flex:1"><label>Lettura</label><input type="number" id="u-val" step="any"></div>
                
                <div class="inp-field" style="flex:0.5"><label>Note</label><input type="text" id="u-note" placeholder="..."></div>
                <button id="btn-save-utenze" class="btn btn-primary" onclick="saveUtenze()">SALVA</button>
            </div>
         </div>
         <div class="scroll-area">
             <div class="flex gap-10" style="margin-bottom:20px; flex-wrap:wrap">
                <select id="u-range" onchange="renderUtenze()" class="inp-field" style="max-width:150px"><option value="30">Ultimi 30gg</option><option value="90">Ultimi 3 Mesi</option><option value="365">Ultimo Anno</option></select>
                <label class="flex items-center gap-10" style="font-size:0.9rem; font-weight:600; color:var(--text-muted)"><input type="checkbox" id="u-compare-year" onchange="renderUtenze()"> Confronta Anno Prec.</label>
             </div>
             
             <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))">
                <div class="glass-card chart-wrapper"><canvas id="chartElec"></canvas></div>
                <div class="glass-card chart-wrapper"><canvas id="chartWater"></canvas></div>
                <div class="glass-card chart-wrapper"><canvas id="chartGas"></canvas></div>
             </div>

             <div class="table-container">
                 <table>
                     <thead><tr><th>Data</th><th>Elettricit√† (Tot/Fasce)</th><th>Acqua</th><th>Gas</th><th>Note</th></tr></thead>
                     <tbody id="tbody-utenze"></tbody>
                 </table>
             </div>
         </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Configurazione Firebase
const firebaseConfig = { apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" };
const app = initializeApp(firebaseConfig); 
const auth = getAuth(app); 
const db = getFirestore(app);

// Stato Applicazione
let dataIngressi=[], dataVasca=[], dataDae=[], dataUtenze=[]; 
let editIdIngressi=null, editIdVasca=null, editIdUtenze=null;
let charts = {};

// Helpers
const el = (id) => document.getElementById(id);
const hide = (id) => el(id)?.classList.add('hidden');
const show = (id) => el(id)?.classList.remove('hidden');
const loading = (active) => el('loading-overlay').classList.toggle('active', active);

window.showToast = (msg, type='success') => { 
    const c = el('toast-container'); 
    const e = document.createElement('div'); 
    e.className = `toast toast-${type}`; 
    e.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> ${msg}`; 
    c.appendChild(e); 
    requestAnimationFrame(()=>e.classList.add('show')); 
    setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); 
};

// Auth
window.doLogin = async () => { 
    loading(true);
    try { await signInWithEmailAndPassword(auth, el('email').value, el('password').value); } 
    catch(e) { el('login-error').innerText = "Errore: credenziali non valide"; loading(false); } 
};
window.doLogout = () => signOut(auth);

onAuthStateChanged(auth, (u) => { 
    loading(false);
    if(u){ 
        hide('login-screen'); 
        el('user-display').innerText = u.email.split('@')[0]; 
        startDataListeners(); 
    } else { 
        show('login-screen'); 
    } 
});

// Realtime Data
function startDataListeners() {
    loading(true);
    const qIng = query(collection(db, "sessioni"), orderBy("date", "desc"), limit(2000));
    onSnapshot(qIng, (snap) => { dataIngressi = snap.docs.map(d=>({id:d.id,...d.data()})); refreshCurrentModule(); populateYearSelect(); loading(false); });

    const qVasca = query(collection(db, "valori_vasca"), orderBy("date", "desc"), limit(500));
    onSnapshot(qVasca, (snap) => { dataVasca = snap.docs.map(d=>({id:d.id,...d.data()})); if(isModuleActive('vasca')) renderVasca(); });

    const qDae = query(collection(db, "dae_log"), orderBy("date", "desc"), limit(100));
    onSnapshot(qDae, (snap) => { dataDae = snap.docs.map(d=>({id:d.id,...d.data()})); if(isModuleActive('dae')) renderDae(); });

    const qUtenze = query(collection(db, "utenze_log"), orderBy("date", "desc"), limit(1000));
    onSnapshot(qUtenze, (snap) => { dataUtenze = snap.docs.map(d=>({id:d.id,...d.data()})); if(isModuleActive('utenze')) renderUtenze(); });
}

// Navigation
window.toggleSidebar = () => {
    el('sidebar').classList.toggle('open');
    document.querySelector('.mobile-overlay').classList.toggle('open');
    document.querySelector('.hamburger').innerText = el('sidebar').classList.contains('open') ? '‚úï' : '‚ò∞';
};

window.switchModule = (m) => { 
    document.querySelectorAll('.module-container').forEach(e=>e.classList.add('hidden')); 
    show('module-'+m); 
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
    el('nav-module-'+m).classList.add('active'); 
    
    // Close sidebar on mobile after click
    if(window.innerWidth < 768) window.toggleSidebar();
    refreshCurrentModule();
};

window.switchSubView = (s) => {
    ['overview','stats','archive'].forEach(v => {
        hide('sub-'+v); 
        el('btn-sub-'+v).classList.remove('btn-primary');
        el('btn-sub-'+v).style.background = 'white';
        el('btn-sub-'+v).style.color = '#0f172a';
    });
    show('sub-'+s);
    const btn = el('btn-sub-'+s);
    btn.classList.add('btn-primary');
    btn.style.background = ''; // Reset inline
    btn.style.color = '';
    refreshCurrentModule();
};

function isModuleActive(m) { return !el('module-'+m).classList.contains('hidden'); }

function refreshCurrentModule() {
    if(isModuleActive('ingressi')) {
        if(!el('sub-overview').classList.contains('hidden')) renderOverview();
        if(!el('sub-stats').classList.contains('hidden')) renderStats();
        if(!el('sub-archive').classList.contains('hidden')) renderIngressiArchive();
    }
    if(isModuleActive('vasca')) renderVasca();
    if(isModuleActive('dae')) renderDae();
    if(isModuleActive('utenze')) renderUtenze();
}

// --- LOGICA INGRESSI ---

window.saveIngressi = async () => {
    const d = el('i-date').value; 
    if(!d) return showToast("Seleziona una data", "error");
    
    const p = { 
        date: d, 
        type: el('i-type').value, 
        fascia: el('i-fascia').value, 
        meteo: el('i-meteo').value, 
        excludeStats: el('i-exclude').checked,
        int: parseInt(el('q-intero').value)||0, 
        rid: parseInt(el('q-ridotto').value)||0, 
        grat: parseInt(el('q-gratuito').value)||0, 
        abb_int: parseInt(el('q-abb-int').value)||0, 
        abb_rid: parseInt(el('q-abb-rid').value)||0 
    };
    p.totale = p.int + p.rid + p.grat + p.abb_int + p.abb_rid;

    try {
        if(editIdIngressi) { 
            await updateDoc(doc(db,"sessioni",editIdIngressi), p); 
            showToast("Modifica salvata!"); 
            cancelEditIngressi(); 
        } else { 
            await addDoc(collection(db,"sessioni"), p); 
            showToast("Ingressi registrati!"); 
            // Reset fields
            document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); 
            el('i-exclude').checked = false; 
        }
    } catch(e) { showToast(e.message, "error"); }
};

window.renderIngressiArchive = () => {
    const start = el('arch-date-start').value;
    const end = el('arch-date-end').value;
    
    let f = dataIngressi.filter(d => {
        if(start && d.date < start) return false;
        if(end && d.date > end) return false;
        return true;
    });

    const tbody = el('tbody-ingressi');
    tbody.innerHTML = "";
    
    f.forEach(d => {
        const isExcluded = d.excludeStats;
        const style = isExcluded ? "opacity:0.6; background:#f8fafc" : "";
        const badge = d.type !== 'standard' ? `<span class="badge badge-warn">${d.type}</span>` : '';
        const excludeIcon = isExcluded ? "‚úÖ" : "üö´";
        
        tbody.innerHTML += `
        <tr style="${style}">
            <td><div class="cell-date">${d.date.split('-').reverse().join('/')}</div><div class="cell-sub">${d.fascia}</div></td>
            <td>${d.meteo} ${badge} <div class="cell-sub text-xs">${isExcluded ? 'Escluso media' : ''}</div></td>
            <td>${d.int}</td>
            <td>${d.rid}</td>
            <td>${d.abb_int + d.abb_rid}</td>
            <td class="cell-primary" style="font-size:1rem">${d.totale}</td>
            <td>
                <button class="btn btn-icon" style="background:#f1f5f9" onclick="toggleExclude('${d.id}', ${isExcluded})">${excludeIcon}</button>
                <button class="btn btn-icon" style="color:#2563eb; background:#eff6ff" onclick="editIngressi('${d.id}')">‚úèÔ∏è</button>
                <button class="btn btn-icon" style="color:#ef4444; background:#fef2f2" onclick="delDoc('sessioni','${d.id}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
};

window.editIngressi = (id) => {
    const d = dataIngressi.find(x=>x.id===id); if(!d) return;
    editIdIngressi = id;
    el('i-date').value = d.date; el('i-type').value = d.type;
    el('i-fascia').value = d.fascia; el('i-meteo').value = d.meteo;
    el('i-exclude').checked = d.excludeStats;
    el('q-intero').value = d.int; el('q-ridotto').value = d.rid;
    el('q-abb-int').value = d.abb_int; el('q-abb-rid').value = d.abb_rid;
    el('q-gratuito').value = d.grat;
    
    el('title-ingressi').innerText = "Modifica Registrazione";
    el('cb-ingressi').classList.add('editing');
    el('btn-save-ingressi').innerText = "AGGIORNA";
    show('cancel-ingressi');
    window.scrollTo({top:0, behavior:'smooth'});
};

window.cancelEditIngressi = () => {
    editIdIngressi = null;
    el('title-ingressi').innerText = "Nuova Registrazione";
    el('cb-ingressi').classList.remove('editing');
    el('btn-save-ingressi').innerText = "SALVA";
    hide('cancel-ingressi');
    document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0);
};

window.toggleExclude = async (id, curr) => {
    await updateDoc(doc(db,"sessioni",id), { excludeStats: !curr });
};

// --- LOGICA UTENZE ---
window.toggleUtenzeMode = () => {
    const t = el('u-type').value;
    const isElec = t === '‚ö° Elettricit√†';
    isElec ? show('u-elec-input') : hide('u-elec-input');
    !isElec ? show('u-single-input') : hide('u-single-input');
};

window.saveUtenze = async () => {
    const d = el('u-date').value; const t = el('u-type').value;
    let p = { date: d, type: t, note: el('u-note').value };
    
    if(t === '‚ö° Elettricit√†') {
        p.a1 = parseFloat(el('u-a1').value)||0;
        p.a2 = parseFloat(el('u-a2').value)||0;
        p.a3 = parseFloat(el('u-a3').value)||0;
        p.val = p.a1 + p.a2 + p.a3;
    } else {
        p.val = parseFloat(el('u-val').value)||0;
    }

    if(!d || p.val === 0) return showToast("Dati incompleti", "error");

    try {
        if(editIdUtenze) {
            await updateDoc(doc(db, "utenze_log", editIdUtenze), p);
            cancelEditUtenze();
            showToast("Modifica salvata");
        } else {
            await addDoc(collection(db, "utenze_log"), p);
            showToast("Lettura salvata");
            el('u-val').value = ''; el('u-a1').value=''; el('u-a2').value=''; el('u-a3').value='';
        }
    } catch(e) { showToast(e.message, "error"); }
};

window.renderUtenze = () => {
    // Tabella
    const tbody = el('tbody-utenze'); tbody.innerHTML = "";
    
    // Group By Date logic for Table
    const grouped = {};
    dataUtenze.forEach(d => {
        if(!grouped[d.date]) grouped[d.date] = { elec: null, water: null, gas: null, note: [] };
        if(d.type.includes('Elettricit√†')) grouped[d.date].elec = d;
        if(d.type.includes('Acqua')) grouped[d.date].water = d;
        if(d.type.includes('Gas')) grouped[d.date].gas = d;
        if(d.note) grouped[d.date].note.push(d.note);
    });

    Object.keys(grouped).sort().reverse().forEach(date => {
        const g = grouped[date];
        const fmtVal = (obj, unit) => obj ? `<div class="cell-bold">${obj.val.toLocaleString()} <span class="text-xs text-muted">${unit}</span></div>` : '<span class="text-muted">-</span>';
        const elecDet = g.elec ? `<div class="text-xs text-muted">F1:${g.elec.a1} F2:${g.elec.a2}</div>` : '';
        
        tbody.innerHTML += `
        <tr>
            <td class="cell-date">${date.split('-').reverse().join('/')}</td>
            <td>${fmtVal(g.elec, 'kWh')} ${elecDet}</td>
            <td>${fmtVal(g.water, 'm¬≥')}</td>
            <td>${fmtVal(g.gas, 'm¬≥')}</td>
            <td class="text-xs text-muted">${g.note.join(', ')}</td>
        </tr>`;
    });

    // Charts
    renderUtenzeCharts();
};

function renderUtenzeCharts() {
    const range = parseInt(el('u-range').value);
    const compare = el('u-compare-year').checked;
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - range);
    const cutoffStr = cutoff.toISOString().split('T')[0];
    
    const filterAndSort = (type) => dataUtenze.filter(d => d.type.includes(type) && d.date >= cutoffStr).sort((a,b)=>a.date.localeCompare(b.date));
    
    const drawChart = (canvasId, type, color, label) => {
        const data = filterAndSort(type);
        const labels = data.map(d => d.date.split('-').reverse().slice(0,2).join('/'));
        const vals = data.map(d => d.val);
        
        // Calculate Deltas (Consumption) instead of raw readings
        const deltas = vals.map((v, i) => i === 0 ? 0 : v - vals[i-1]);

        // Clean existing
        if(charts[canvasId]) charts[canvasId].destroy();
        
        charts[canvasId] = new Chart(el(canvasId), {
            type: 'bar',
            data: {
                labels: labels.slice(1), // Remove first day as it has no delta
                datasets: [{
                    label: `Consumo ${label}`,
                    data: deltas.slice(1),
                    backgroundColor: color,
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: label } } }
        });
    };

    drawChart('chartElec', 'Elettricit√†', '#fbbf24', 'Elettricit√† (kWh)');
    drawChart('chartWater', 'Acqua', '#3b82f6', 'Acqua (m¬≥)');
    drawChart('chartGas', 'Gas', '#ef4444', 'Gas (m¬≥)');
}

// --- LOGICA VASCA ---
window.saveVasca = async () => {
    const d = el('v-date').value; const t = el('v-time').value;
    if(!d || !t) return showToast("Data e Ora obbligatorie", "error");
    
    const p = {
        date: d, time: t,
        type: el('v-type').value,
        bag: el('v-bag').value,
        ta: el('v-ta').value, th: el('v-th').value,
        ph: el('v-ph').value, cll: el('v-cll').value, clc: el('v-clc').value,
        clt: el('v-clt').value
    };

    try {
        await addDoc(collection(db, "valori_vasca"), p);
        showToast("Valori registrati");
        document.querySelectorAll('#module-vasca .t-box input').forEach(i=>i.value=0);
    } catch(e) { showToast(e.message, "error"); }
};

window.renderVasca = () => {
    const tbody = el('tbody-vasca'); tbody.innerHTML = "";
    dataVasca.forEach(d => {
        const phAlert = (d.ph < 6.8 || d.ph > 7.6) ? 'badge-ko' : 'badge-ok';
        const clAlert = (d.cll < 0.7 || d.cll > 1.5) ? 'badge-warn' : 'badge-ok';
        
        tbody.innerHTML += `
        <tr>
            <td><div class="cell-date">${d.date.split('-').reverse().join('/')}</div><div class="cell-sub">${d.time} ${d.type==='esterna'?'‚òÄÔ∏è':'üè†'}</div></td>
            <td>
                <div>T.H2O: <b>${d.th}¬∞</b></div>
                <div class="text-xs text-muted">T.Aria: ${d.ta}¬∞ | Bag: ${d.bag}</div>
            </td>
            <td>
                <span class="badge ${phAlert}">pH ${d.ph}</span>
                <span class="badge ${clAlert}">Cl ${d.cll}</span>
                <div class="text-xs text-muted mt-1">Comb: ${d.clc} | Tot: ${d.clt}</div>
            </td>
            <td><button class="btn btn-icon btn-danger" onclick="delDoc('valori_vasca','${d.id}')">üóëÔ∏è</button></td>
        </tr>`;
    });
};

window.calcClTot = () => {
    const l = parseFloat(el('v-cll').value)||0;
    const c = parseFloat(el('v-clc').value)||0;
    el('v-clt').value = (l + c).toFixed(2);
};

// --- LOGICA DAE ---
window.saveDae = async () => {
    const d = new Date().toISOString().split('T')[0];
    const ass = el('d-ass').value; const op = el('d-op').value;
    if(!ass || !op) return showToast("Compila i nomi", "error");
    
    try {
        await addDoc(collection(db, "dae_log"), { date: d, ass, op, status: el('d-status').value });
        showToast("Controllo DAE registrato");
        el('d-ass').value=''; el('d-op').value='';
    } catch(e) { showToast(e.message, "error"); }
};

window.renderDae = () => {
    const tbody = el('tbody-dae'); tbody.innerHTML = "";
    dataDae.forEach(d => {
        const ok = d.status === 'OK';
        tbody.innerHTML += `<tr>
            <td class="cell-date">${d.date.split('-').reverse().join('/')}</td>
            <td><span class="badge ${ok ? 'badge-ok' : 'badge-ko'}">${d.status}</span></td>
            <td><div class="text-sm">Ass: ${d.ass}</div><div class="text-xs text-muted">Op: ${d.op}</div></td>
            <td><button class="btn btn-icon btn-danger" onclick="delDoc('dae_log','${d.id}')">üóëÔ∏è</button></td>
        </tr>`;
    });
};

// --- CHARTS & OVERVIEW ---
window.renderOverview = () => {
    const today = new Date();
    const currMonthStr = today.toISOString().slice(0, 7);
    
    // Filtra dati mese corrente
    const currentData = dataIngressi.filter(d => d.date.startsWith(currMonthStr) && !d.excludeStats);
    const total = currentData.reduce((acc, curr) => acc + curr.totale, 0);
    const days = new Set(currentData.map(d => d.date)).size;
    
    const avg = days > 0 ? Math.round(total / days) : 0;
    el('ov-avg').innerText = avg;
    
    const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
    el('ov-forecast').innerText = (avg * daysInMonth).toLocaleString();

    // Chart 30gg
    const labels = [], data = [];
    for(let i=29; i>=0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const dStr = d.toISOString().split('T')[0];
        labels.push(d.getDate() + '/' + (d.getMonth()+1));
        const dayVal = dataIngressi.filter(x => x.date === dStr && !x.excludeStats).reduce((a,b)=>a+b.totale,0);
        data.push(dayVal);
    }
    
    if(charts['chartRecent30']) charts['chartRecent30'].destroy();
    charts['chartRecent30'] = new Chart(el('chartRecent30'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ label: 'Ingressi', data: data, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } }
    });
};

window.populateYearSelect = () => {
    const years = [...new Set(dataIngressi.map(d => d.date.split('-')[0]))].sort().reverse();
    const sel = el('stat-year');
    if(sel.options.length === 0) {
        years.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.innerText = y; sel.appendChild(opt); });
    }
};

window.renderStats = () => {
    const year = el('stat-year').value || new Date().getFullYear();
    const pool = el('stat-pool-filter').value;
    
    let filtered = dataIngressi.filter(d => d.date.startsWith(year) && !d.excludeStats);
    
    if(pool === 'indoor') filtered = filtered.filter(d => !d.fascia.includes('Estiva'));
    if(pool === 'outdoor') filtered = filtered.filter(d => d.fascia.includes('Estiva'));
    
    const months = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
    const monthlyData = new Array(12).fill(0);
    
    filtered.forEach(d => {
        const m = parseInt(d.date.split('-')[1]) - 1;
        monthlyData[m] += d.totale;
    });

    if(charts['chartYoY']) charts['chartYoY'].destroy();
    charts['chartYoY'] = new Chart(el('chartYoY'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{ label: `Totale ${year}`, data: monthlyData, backgroundColor: '#3b82f6', borderRadius: 6 }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
};

// Utils
window.delDoc = async (c, id) => {
    if(confirm("Sei sicuro di voler eliminare questo record?")) {
        await deleteDoc(doc(db, c, id));
        showToast("Eliminato con successo");
    }
};

// Download CSV
window.downloadCSV = () => {
    if(!dataIngressi.length) return showToast("Nessun dato", "error");
    let csv = "Data,Tipo,Fascia,Totale\n";
    dataIngressi.forEach(d => { csv += `${d.date},${d.type},${d.fascia},${d.totale}\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'export_ingressi.csv'; a.click();
};

// Init
const today = new Date().toISOString().split('T')[0];
el('i-date').value = today;
el('v-date').value = today;
el('d-date').value = today;
el('u-date').value = today;

</script>
</body>
</html>
