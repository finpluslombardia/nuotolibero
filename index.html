<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stat CF Lampugnano</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    :root { --p: #2563eb; --bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #e9d5ff 100%); --txt: #1e293b; --mut: #475569; --g-bg: rgba(255, 255, 255, 0.45); --g-bd: 1px solid rgba(255, 255, 255, 0.6); --g-sh: 0 8px 32px 0 rgba(31, 38, 135, 0.07); --sb-g: rgba(15, 23, 42, 0.85); }
    * { box-sizing: border-box; outline: none; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--txt); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    
    /* UTILS & GLASS */
    .glass-card, .kpi-card, .chart-card, .table-wrap, #login-box { background: var(--g-bg); backdrop-filter: blur(12px); border-radius: 24px; box-shadow: var(--g-sh); border: var(--g-bd); padding: 25px; display: flex; flex-direction: column; }
    .hidden { display: none !important; }
    .btn { padding: 0 24px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; height: 44px; font-family: inherit; white-space: nowrap; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: linear-gradient(135deg, var(--p), #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
    .btn-danger { background: rgba(254, 202, 202, 0.4); color: #dc2626; border: 1px solid rgba(252, 165, 165, 0.5); }
    .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 10px; }
    
    /* LAYOUT */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.8); padding: 15px 25px; border-radius: 16px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { border-left: 5px solid #10b981; } .toast-error { border-left: 5px solid #ef4444; }

    .sidebar { width: 250px; background: var(--sb-g); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-header { padding: 30px 20px; font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .nav-section-title { padding: 20px 20px 10px; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 800; letter-spacing: 1px; }
    .nav-links { list-style: none; padding: 0 10px; margin: 0; }
    .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: #cbd5e1; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 0.9rem; }
    .nav-item:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-item.active { background: linear-gradient(90deg, var(--p), #4f46e5); color: #fff; box-shadow: 0 0 15px rgba(37,99,235,0.4); border: 1px solid rgba(255,255,255,0.2); }
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }

    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
    .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }
    
    /* CONTROLS */
    .control-bar { background: rgba(255,255,255,0.6); backdrop-filter: blur(15px); border-bottom: var(--g-bd); box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; transition: background 0.3s; }
    .control-bar.editing { background: rgba(254, 243, 199, 0.9); border-bottom: 2px solid #f59e0b; }
    .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .cb-title { font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; font-size: 0.8rem; }
    .cb-row { display: flex; gap: 15px; align-items: flex-end; width: 100%; }
    #cb-utenze .cb-row { flex-wrap: wrap; }
    .inp-field { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--mut); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inp-field input, .inp-field select, .ms-btn { padding: 0 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); font-size: 0.9rem; height: 44px; color: var(--txt); font-family: inherit; font-weight: 500; transition: 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); width: 100%; }
    .inp-field input:focus, .inp-field select:focus { background: #fff; border-color: var(--p); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
    .inp-locked { background: rgba(0,0,0,0.05) !important; color: #64748b !important; cursor: not-allowed; font-weight: 700; border: 1px solid rgba(0,0,0,0.1) !important; }

    /* GROUPS & TICKETS */
    .group-ctx { display: flex; gap: 10px; flex: 1.6; align-items: flex-end; min-width: 0; }
    .group-tickets, .group-chem { display: flex; gap: 5px; flex: 1; background: rgba(255,255,255,0.35); padding: 5px 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); align-items: center; justify-content: space-between; height: 64px; }
    .group-chem { flex: 2; padding: 8px; }
    .t-box { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 40px; flex: 1; }
    .t-box label { font-size: 0.6rem; font-weight: 800; color: var(--mut); text-transform: uppercase; margin-bottom: 2px; opacity: 0.8; letter-spacing: -0.5px; }
    .t-box input { width: 100%; text-align: center; font-weight: 800; color: var(--p); font-size: 1.2rem; border: none; background: transparent; padding: 0; height: auto; }

    /* MULTI SELECT */
    .ms-container { position: relative; }
    .ms-btn { display: flex; align-items: center; justify-content: space-between; cursor: pointer; color: #64748b; }
    .ms-dropdown { position: absolute; top: 105%; left: 0; width: 220px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 8px; z-index: 100; display: none; max-height: 250px; overflow-y: auto; }
    .ms-dropdown.show { display: block; }
    .ms-option { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: 0.1s; }
    .ms-option:hover { background: #f1f5f9; }

    /* KPI & CHARTS */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
    .kpi-card { padding: 20px; height: 130px; justify-content: center; background: rgba(255,255,255,0.55); }
    .kpi-head { font-size: 0.75rem; color: var(--mut); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
    .kpi-val { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
    .kpi-sub { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .kpi-context { font-size: 0.75rem; color: #64748b; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.05); width: 100%; display: flex; justify-content: space-between; font-weight: 500; }
    .chart-card { height: 360px; }
    .chart-wrapper { position: relative; flex: 1; width: 100%; height: 100%; overflow: hidden; }
    .charts-row-main { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; }
    .charts-row-split { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }

    /* TABLE */
    .table-wrap { padding: 0; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { text-align: left; padding: 18px 12px; background: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: 800; color: var(--mut); text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.4); font-size: 0.9rem; vertical-align: middle; font-weight: 500; }
    tr:hover td { background: rgba(255,255,255,0.3); }
    .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; backdrop-filter: blur(4px); }
    .badge-summer { background: rgba(255,237,213,0.7); color: #ea580c; border: 1px solid rgba(253,186,116,0.4); }
    .badge-std { background: rgba(219,234,254,0.7); color: #2563eb; border: 1px solid rgba(147,197,253,0.4); }
    .badge-ok { background: rgba(167,243,208,0.7); color: #065f46; border: 1px solid rgba(16,185,129,0.3); }
    .badge-ko { background: rgba(254,202,202,0.7); color: #991b1b; border: 1px solid rgba(239,68,68,0.3); }
    .badge-evt { background: rgba(253,224,71,0.7); color: #854d0e; border: 1px solid rgba(250,204,21,0.4); }
    
    /* FILTERS & OTHERS */
    .filter-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
    .filter-select { padding: 0 15px; border-radius: 12px; height: 40px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); }
    .benchmark-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.5); padding: 0 15px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.6); user-select: none; transition: 0.2s; }
    .benchmark-toggle:hover { background: #fff; }
    .archive-toolbar { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.4); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: var(--g-bd); flex-wrap: wrap; }
    .arch-input, .arch-select { height: 36px; padding: 0 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.9); font-size: 0.85rem; font-weight: 600; }
    .col-detail { color: var(--mut); font-size: 0.85rem; text-align: center; }
    .col-subtot { font-weight: 700; text-align: center; background: rgba(255,255,255,0.2); }
    .col-total { font-weight: 900; color: var(--txt); text-align: center; font-size: 1.1rem; }
    .bg-sub-blue { background-color: rgba(59, 130, 246, 0.05); } .bg-sub-purp { background-color: rgba(168, 85, 247, 0.05); }
    #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    #login-box { width: 400px; padding: 40px; text-align: center; }
</style>
</head>
<body>

<div id="toast-container"></div>
<div id="login-screen"><div id="login-box"><h2 style="margin-bottom:25px;font-weight:900;font-size:1.5rem">ğŸ” Accesso</h2><div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div><div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div><button class="btn btn-primary" style="width:100%;height:48px" onclick="doLogin()">Entra</button><p id="login-error" style="color:#dc2626;font-size:0.85rem;margin-top:20px;font-weight:600"></p></div></div>

<div class="sidebar">
    <div class="sidebar-header">ğŸŠâ€â™‚ï¸ Facility Manager</div>
    <div class="nav-section-title">Ingressi</div><ul class="nav-links"><li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">ğŸ« Nuoto Libero</li></ul>
    <div class="nav-section-title" style="margin-top:20px">Impianto</div>
    <ul class="nav-links"><li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')">ğŸ’§ Valori Vasca</li><li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')">âš¡ Controllo DAE</li><li class="nav-item" id="nav-module-utenze" onclick="switchModule('utenze')">ğŸ“Š Utenze</li></ul>
    <div class="sidebar-footer"><div style="font-size:0.85rem;margin-bottom:15px;color:#cbd5e1;font-weight:600" id="user-display">User</div><button class="btn" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:0.8rem;height:38px" onclick="doLogout()">Disconnetti</button></div>
</div>

<div class="main-content">
<div id="module-ingressi" class="module-container" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-ingressi">
        <div class="cb-header"><span class="cb-title" id="title-ingressi">Registrazione Ingressi</span><button class="btn btn-danger hidden" id="cancel-ingressi" style="height:30px;font-size:0.7rem;padding:0 15px" onclick="cancelEditIngressi()">Annulla</button></div>
        <div class="cb-row">
            <div class="group-ctx">
                <div class="inp-field" style="flex:1.2"><label>Data</label><input type="date" id="i-date"></div>
                <div class="inp-field" style="flex:1.3"><label>Tipo Giorno</label><select id="i-type"><option value="standard">ğŸ¢ Standard</option><option value="festivo">ğŸ”´ Festivo</option><option value="evento">ğŸ† Evento</option><option value="maltempo">â›ˆï¸ Maltempo</option><option value="extra">âš ï¸ Extra</option></select></div>
                <div class="inp-field" style="flex:1.5"><label>Fascia</label><select id="i-fascia"><optgroup label="ğŸŠ Vasca Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="â˜€ï¸ Vasca Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select></div>
                <div class="inp-field" style="flex:1.2"><label>Meteo</label><select id="i-meteo"><option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option><option value="ğŸ”¥ Sole + Caldo">ğŸ”¥ Sole + Caldo</option><option value="â„ï¸ Sole + Freddo">â„ï¸ Sole + Freddo</option><option value="ğŸŒ¦ï¸ Variabile">ğŸŒ¦ï¸ Variabile</option><option value="ğŸŒ¤ï¸ Parz Nuvoloso">ğŸŒ¤ï¸ Parz Nuvoloso</option><option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option><option value="ğŸŒ¥ï¸ Nuv + Freddo">ğŸŒ¥ï¸ Nuv + Freddo</option><option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option><option value="ğŸŒ¨ï¸ Piog + Freddo">ğŸŒ¨ï¸ Piog + Freddo</option><option value="â›ˆï¸ Temporale">â›ˆï¸ Temporale</option><option value="â“ N/D">â“ N/D</option></select></div>
                <div class="inp-field" style="flex:0.3;align-items:center;padding-bottom:8px"><label style="cursor:pointer;display:flex;flex-direction:column;align-items:center;color:#ef4444"><input type="checkbox" id="i-exclude" style="width:16px;height:16px;accent-color:#ef4444"><span style="font-size:0.55rem;margin-top:2px;font-weight:800">NO MEDIA</span></label></div>
            </div>
            <div class="group-tickets">
                <div class="t-box"><label>INT</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>RID</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>ABB</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>11 IN</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>GRA</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
            </div>
            <div class="group-actions"><button id="btn-save-ingressi" class="btn btn-primary" style="height:44px;min-width:100px" onclick="saveIngressi()">SALVA</button></div>
        </div>
    </div>
    <div class="scroll-area">
        <div class="filter-row" style="margin-bottom:20px;justify-content:center"><button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button><button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-stats" onclick="switchSubView('stats')">Statistiche</button><button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button></div>
        <div id="sub-overview">
            <div class="filter-row" style="margin-bottom:10px;justify-content:flex-end"><select id="ov-chart-type" class="filter-select" onchange="renderOverviewCharts()" style="font-weight:700;border:1px solid var(--p);color:var(--p)"><option value="line">ğŸ“ˆ Linea</option><option value="bar">ğŸ“Š Colonne</option></select></div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-head">Media (Mese)</div><div class="kpi-val" id="ov-avg">0</div><div class="kpi-sub">persone / giorno</div></div>
                <div class="kpi-card"><div class="kpi-head">Vs Mese Prec.</div><div class="kpi-val" id="ov-mom">0%</div><div class="kpi-sub" id="ov-mom-label">-</div></div>
                <div class="kpi-card"><div class="kpi-head">Vs Anno Prec.</div><div class="kpi-val" id="ov-yoy">0%</div><div class="kpi-sub" id="ov-yoy-label">-</div></div>
                <div class="kpi-card"><div class="kpi-head">Stima Fine Mese</div><div class="kpi-val" id="ov-forecast" style="color:#a855f7">-</div><div class="kpi-sub" id="ov-forecast-sub">proiezione</div></div>
            </div>
            <div class="chart-card"><div class="chart-header">Ultimi 30gg vs Anno Prec.</div><div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div></div>
            <div class="chart-card" style="margin-top:20px"><div class="chart-header">Ultimi 3 Mesi (90 gg)</div><div class="chart-wrapper"><canvas id="chartRecent90"></canvas></div></div>
            <div class="chart-card" style="margin-top:20px"><div class="chart-header">Ultimi 12 Mesi</div><div class="chart-wrapper"><canvas id="chartRecent12M"></canvas></div></div>
        </div>
        <div id="sub-stats" class="hidden">
            <div class="filter-row" style="justify-content:space-between;align-items:flex-end;background:rgba(255,255,255,0.4);padding:15px;border-radius:16px;border:var(--g-bd)">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
                    <div class="inp-field" style="width:160px"><label>ModalitÃ </label><select id="stat-mode" onchange="toggleStatMode()" style="font-weight:700;border-color:var(--p);color:var(--p)"><option value="year">ğŸ“… Anno Intero</option><option value="custom">ğŸ“† Personalizz.</option></select></div>
                    <div class="inp-field" id="stat-year-cont" style="width:100px"><label>Anno</label><select id="stat-year" onchange="renderStats()" style="font-weight:700"></select></div>
                    <div id="stat-custom-cont" class="hidden" style="display:flex;gap:10px;align-items:flex-end"><div class="inp-field" style="width:130px"><label>Dal</label><input type="date" id="stat-date-start"></div><div class="inp-field" style="width:130px"><label>Al</label><input type="date" id="stat-date-end"></div><button class="btn btn-primary" onclick="renderStats()" style="height:44px;padding:0 15px;font-size:1.1rem">ğŸ”</button></div>
                    <div class="inp-field" style="width:180px;position:relative"><label>Confronta</label><div class="ms-container" id="ms-compare"><div class="ms-btn" onclick="toggleMsDropdown()">Seleziona... â–¼</div><div class="ms-dropdown" id="ms-compare-list"></div></div></div>
                    <div class="inp-field" style="width:140px"><label>Vasca</label><select id="stat-pool-filter" onchange="renderStats()" style="font-weight:700"><option value="all">ğŸŠ Tutte</option><option value="indoor">ğŸ¢ Interna</option><option value="outdoor">â˜€ï¸ Esterna</option></select></div>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap"><select id="stat-chart-type" class="filter-select" onchange="renderStats()" style="font-weight:700;border:1px solid var(--p);color:var(--p)"><option value="line">ğŸ“ˆ Linea</option><option value="bar">ğŸ“Š Colonne</option></select><select id="day-type-filter" class="filter-select" onchange="renderStats()" style="font-weight:700;border:2px solid #a855f7;color:#6b21a8"><option value="all">ğŸ“… Tutti</option><option value="standard">ğŸ¢ Standard</option><option value="special">ğŸ† Eventi/Fest</option></select></div>
            </div>
            <div class="charts-row-main"><div class="chart-card"><div class="chart-header" id="yoy-title">Andamento</div><div class="chart-wrapper"><canvas id="chartYoY"></canvas></div></div></div>
            <div class="charts-row-main"><div class="chart-card"><div class="chart-header">Performance Settimanale</div><div class="chart-wrapper"><canvas id="chartWeek"></canvas></div></div></div>
            <div class="charts-row-split">
                <div class="chart-card" style="text-align:center"><div class="chart-header" style="text-align:left">Composizione</div><div class="chart-wrapper" style="max-height:220px;display:flex;justify-content:center"><canvas id="chartPie"></canvas></div><div style="margin-top:auto;padding-top:15px;border-top:1px solid rgba(0,0,0,0.05)"><div style="font-size:0.8rem;color:#64748b;font-weight:700">TOTALE</div><div id="deep-total" style="color:var(--p);font-size:1.8rem;font-weight:900">0</div></div></div>
                <div class="chart-card"><div class="chart-header">Meteo</div><div class="chart-wrapper"><canvas id="chartMeteo"></canvas></div></div>
            </div>
            <div class="charts-row-main"><div class="chart-card"><div class="chart-header">Fasce Orarie</div><div class="chart-wrapper"><canvas id="chartFasce"></canvas></div></div></div>
        </div>
        <div id="sub-archive" class="hidden">
            <div class="archive-toolbar"><span class="arch-label">DA:</span><input type="date" id="arch-date-start" class="arch-input" onchange="renderIngressiArchive()"><span class="arch-label">A:</span><input type="date" id="arch-date-end" class="arch-input" onchange="renderIngressiArchive()"><select id="arch-filter-fascia" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutte le Fasce</option><optgroup label="Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select><select id="arch-filter-meteo" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutto il Meteo</option><option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option><option value="ğŸ”¥ Sole + Caldo">ğŸ”¥ Sole + Caldo</option><option value="â„ï¸ Sole + Freddo">â„ï¸ Sole + Freddo</option><option value="ğŸŒ¦ï¸ Variabile">ğŸŒ¦ï¸ Variabile</option><option value="ğŸŒ¤ï¸ Parz Nuvoloso">ğŸŒ¤ï¸ Parz Nuvoloso</option><option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option><option value="ğŸŒ¥ï¸ Nuv + Freddo">ğŸŒ¥ï¸ Nuv + Freddo</option><option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option><option value="ğŸŒ¨ï¸ Piog + Freddo">ğŸŒ¨ï¸ Piog + Freddo</option><option value="â›ˆï¸ Temporale">â›ˆï¸ Temporale</option><option value="â“ N/D">â“ N/D</option></select><select id="arch-sort" class="arch-select" style="min-width:100px" onchange="renderIngressiArchive()"><option value="desc">â¬‡ï¸ Recenti</option><option value="asc">â¬†ï¸ Vecchi</option></select><button class="btn btn-danger" style="height:36px;width:36px;padding:0" onclick="resetArchiveFilters()">âœ•</button><button class="btn btn-primary" style="height:36px;font-size:0.8rem;padding:0 20px" onclick="downloadCSV()">Excel</button></div>
            <div class="table-wrap"><div style="overflow-x:auto;"><table id="table-ingressi"><thead><tr><th>Data</th><th>Fascia / Meteo</th><th>Int.</th><th>Rid.</th><th>Singoli</th><th>Per.</th><th>11 Ingr.</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-ingressi"></tbody></table></div></div>
        </div>
    </div>
</div>

<div id="module-vasca" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-vasca">
        <div class="cb-header"><span class="cb-title" id="title-vasca">Registrazione Valori Vasca</span><button class="btn btn-danger hidden" id="cancel-vasca" style="height:30px;font-size:0.7rem;padding:0 15px" onclick="cancelEditVasca()">Annulla</button></div>
        <div class="cb-row">
            <div class="group-ctx" style="flex:1.2;align-items:flex-end;gap:10px"><div class="inp-field" style="flex:1"><label>Data</label><input type="date" id="v-date"></div><div class="inp-field" style="flex:0.8"><label>Ora</label><input type="time" id="v-time"></div><div class="inp-field" style="flex:1.2"><label>Vasca</label><select id="v-type"><option value="interna">ğŸ  Interna</option><option value="esterna">â˜€ï¸ Esterna</option></select></div></div>
            <div class="group-chem" style="flex:2"><div class="t-box"><label>BAG</label><input type="number" id="v-bag" value="0"></div><div class="t-box"><label>T.AR</label><input type="number" step="0.1" id="v-ta" value="0"></div><div class="t-box"><label>T.H2O</label><input type="number" step="0.1" id="v-th" value="0"></div><div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div><div class="t-box"><label>CL.L</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div><div class="t-box"><label>CL.C</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div><div class="t-box"><label>CL.T</label><input type="number" step="0.1" id="v-clt" value="0"></div></div>
            <div class="group-actions"><button id="btn-save-vasca" class="btn btn-primary" style="height:44px;min-width:120px" onclick="saveVasca()">SALVA</button></div>
        </div>
    </div>
    <div class="scroll-area"><h2 style="margin-bottom:20px;font-weight:800;font-size:1.5rem">ğŸ’§ Diario Vasca</h2><div class="table-wrap"><div style="overflow-x:auto;"><table id="table-vasca"><thead><tr><th>Data</th><th>Ora / Vasca</th><th>Bagnanti</th><th>T. Aria</th><th>T. Acqua</th><th>pH</th><th>Cl Lib</th><th>Cl Comb</th><th>Cl Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-vasca"></tbody></table></div></div></div>
</div>

<div id="module-dae" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar"><div class="cb-header"><span class="cb-title">Controllo DAE</span></div><div class="cb-row"><div class="group-ctx"><div class="inp-field" style="flex:0.5"><label>Data</label><input type="date" id="d-date" class="inp-locked" readonly></div><div class="inp-field" style="flex:0.5"><label>Ora</label><input type="text" id="d-time" class="inp-locked" readonly></div><div class="inp-field" style="flex:0.8"><label>Stato</label><select id="d-status"><option value="OK">âœ… Funzionante</option><option value="GUASTO">âŒ Guasto</option></select></div><div class="inp-field" style="flex:1"><label>Ass. Bagnanti</label><input type="text" id="d-ass"></div><div class="inp-field" style="flex:1"><label>Segreteria</label><input type="text" id="d-op"></div></div><div class="group-actions"><button class="btn btn-primary" style="height:44px;min-width:120px" onclick="saveDae()">REGISTRA</button></div></div></div>
    <div class="scroll-area"><h2 style="margin-bottom:20px;font-weight:800;font-size:1.5rem">âš¡ Registro DAE</h2><div class="table-wrap"><div style="overflow-x:auto;"><table id="table-dae"><thead><tr><th>Data</th><th>Ora</th><th>Stato</th><th>Assistente</th><th>Segreteria</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-dae"></tbody></table></div></div></div>
</div>

<div id="module-utenze" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-utenze">
        <div class="cb-header"><span class="cb-title" id="title-utenze">Letture Utenze</span><button class="btn btn-danger hidden" id="cancel-utenze" style="height:30px;font-size:0.7rem;padding:0 15px" onclick="cancelEditUtenze()">Annulla</button></div>
        <div class="cb-row">
            <div class="inp-field" style="width:140px;flex:none"><label>Data</label><input type="date" id="u-date"></div>
            <div class="inp-field" style="flex:1"><label>Tipo</label><select id="u-type" onchange="toggleUtenzeMode()"><option value="âš¡ ElettricitÃ ">âš¡ ElettricitÃ </option><option value="ğŸ’§ Acqua">ğŸ’§ Acqua (mÂ³)</option><option value="ğŸ”¥ Gas Metano">ğŸ”¥ Gas Metano (mÂ³)</option></select></div>
            <div id="u-extra-elec-meteo" class="inp-field hidden" style="flex:1"><label>Meteo</label><select id="u-meteo"><option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option><option value="â›… Variabile">â›… Variabile</option><option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option><option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option></select></div>
            <div id="u-elec-input" style="display:contents"><div class="inp-field" style="flex:1"><label>A1 (F1)</label><input type="number" id="u-a1" step="any"></div><div class="inp-field" style="flex:1"><label>A2 (F2)</label><input type="number" id="u-a2" step="any"></div><div class="inp-field" style="flex:1"><label>A3 (F3)</label><input type="number" id="u-a3" step="any"></div></div>
            <div id="u-single-input" class="inp-field hidden" style="flex:1"><label>Lettura</label><input type="number" id="u-val" step="any"></div>
            <div id="u-extra-gas" class="inp-field hidden" style="width:100px;flex:none"><label>Temp (Â°C)</label><input type="number" id="u-temp" step="0.1"></div>
            <div class="inp-field" style="flex:1.5"><label>Note</label><input type="text" id="u-note"></div>
            <div style="width:120px;flex:none"><button id="btn-save-utenze" class="btn btn-primary" style="height:44px;width:100%" onclick="saveUtenze()">SALVA</button></div>
        </div>
    </div>
    <div class="scroll-area">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px"><h2 style="margin:0;font-size:1.3rem;font-weight:800">ğŸ“Š Analisi Utenze</h2><div style="display:flex;gap:10px;align-items:center"><select id="u-range" class="filter-select" onchange="renderUtenze()" style="font-weight:700"><option value="7">Ultimi 7gg</option><option value="30">Ultimi 30gg</option><option value="90">Ultimi 3 Mesi</option><option value="365">Ultimi 12 Mesi</option></select><select id="u-view-mode" class="filter-select" onchange="renderUtenze()" style="border:2px solid var(--p);color:var(--p);font-weight:700"><option value="delta">ğŸ“Š Consumo</option><option value="total">ğŸ“ˆ Lettura</option></select><label class="benchmark-toggle" style="height:40px"><input type="checkbox" id="u-compare-year" onchange="renderUtenze()"><span style="font-size:0.8rem">Vs Anno Prec.</span></label></div></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:25px">
            <div class="chart-card" style="height:250px;padding:15px"><div class="chart-header" style="font-size:0.85rem;color:#eab308">âš¡ ElettricitÃ  (kWh)</div><div class="chart-wrapper"><canvas id="chartElec"></canvas></div></div>
            <div class="chart-card" style="height:250px;padding:15px"><div class="chart-header" style="font-size:0.85rem;color:#3b82f6">ğŸ’§ Acqua (mÂ³)</div><div class="chart-wrapper"><canvas id="chartWater"></canvas></div></div>
            <div class="chart-card" style="height:250px;padding:15px"><div class="chart-header" style="font-size:0.85rem;color:#ef4444">ğŸ”¥ Gas (mÂ³)</div><div class="chart-wrapper"><canvas id="chartGas"></canvas></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px"><h3 style="margin:0;font-size:1.1rem;color:var(--txt)">ğŸ“… Confronto Mensile</h3><input type="month" id="u-kpi-month-selector" class="filter-select" style="font-weight:700;background:rgba(255,255,255,0.8)" onchange="renderUtenzeKPI()"></div>
        <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:25px"><div class="kpi-card" style="border-left:4px solid #eab308"><div class="kpi-head" id="u-kpi-elec-title">-</div><div class="kpi-val" id="u-kpi-elec-val">-</div><div class="kpi-sub" id="u-kpi-elec-sub">-</div><div class="kpi-context" id="u-kpi-elec-context"></div></div><div class="kpi-card" style="border-left:4px solid #3b82f6"><div class="kpi-head" id="u-kpi-water-title">-</div><div class="kpi-val" id="u-kpi-water-val">-</div><div class="kpi-sub" id="u-kpi-water-sub">-</div><div class="kpi-context" id="u-kpi-water-context"></div></div><div class="kpi-card" style="border-left:4px solid #ef4444"><div class="kpi-head" id="u-kpi-gas-title">-</div><div class="kpi-val" id="u-kpi-gas-val">-</div><div class="kpi-sub" id="u-kpi-gas-sub">-</div><div class="kpi-context" id="u-kpi-gas-context"></div></div></div>
        <h2 style="font-size:1.5rem;font-weight:800;margin-bottom:20px">ğŸ“ Storico</h2>
        <div class="archive-toolbar" style="margin-bottom:15px;background:rgba(255,255,255,0.5)"><div class="arch-group"><span class="arch-label">Dal:</span><input type="date" id="u-hist-start" class="arch-input" onchange="renderUtenze()"></div><div class="arch-group"><span class="arch-label">Al:</span><input type="date" id="u-hist-end" class="arch-input" onchange="renderUtenze()"></div><select id="u-hist-sort" class="arch-select" onchange="renderUtenze()"><option value="desc">â¬‡ï¸ Recenti</option><option value="asc">â¬†ï¸ Vecchi</option></select><button class="btn btn-danger" style="height:36px;padding:0 15px" onclick="resetUtenzeHistory()">âœ•</button></div>
        <div class="table-wrap"><div style="overflow-x:auto;"><table id="table-utenze"><thead><tr><th>Data</th><th style="color:#eab308;background:rgba(234,179,8,0.1)">âš¡ Lettura</th><th style="color:#eab308;background:rgba(234,179,8,0.1)">F1 / F2 / F3</th><th style="color:#3b82f6;background:rgba(59,130,246,0.1)">ğŸ’§ Acqua</th><th style="color:#ef4444;background:rgba(239,68,68,0.1)">ğŸ”¥ Gas</th><th>Note</th></tr></thead><tbody id="tbody-utenze"></tbody></table></div></div>
    </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({ apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" });
const auth = getAuth(app), db = getFirestore(app);
let dIn=[], dVa=[], dDae=[], dUt=[], edIn=null, edVa=null, edUt=null, ch={};
const $ = i => document.getElementById(i);
const val = i => $(i).value;
const setVal = (i,v) => $(i).value = v;
const isoDate = d => d.toISOString().split('T')[0];
const fmtDate = d => d.split('-').reverse().join('/');
const today = isoDate(new Date());

const commonChartOptions = { animation: false, responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true }, tooltip: { backgroundColor: 'rgba(15,23,42,0.95)', padding: 12, cornerRadius: 8 } }, layout: { padding: 25 } };

// AUTH
window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, val('email'), val('password')); } catch(e) { $('login-error').innerText = e.message; } };
window.doLogout = () => signOut(auth);
onAuthStateChanged(auth, u => {
    $('login-screen').classList.toggle('hidden', !!u);
    if(u) { $('user-display').innerText = u.email.split('@')[0]; initListeners(); }
});

function initListeners() {
    onSnapshot(query(collection(db, "sessioni"), orderBy("date", "desc"), limit(2000)), s => { dIn = s.docs.map(d=>({id:d.id,...d.data()})); populateFilters(); refreshView(); if(dUt.length) renderUtenze(); });
    onSnapshot(query(collection(db, "valori_vasca"), orderBy("date", "desc"), limit(500)), s => { dVa = s.docs.map(d=>({id:d.id,...d.data()})); if(!$('module-vasca').classList.contains('hidden')) renderVasca(); });
    onSnapshot(query(collection(db, "dae_log"), orderBy("date", "desc"), limit(200)), s => { dDae = s.docs.map(d=>({id:d.id,...d.data()})); if(!$('module-dae').classList.contains('hidden')) renderDae(); });
    onSnapshot(query(collection(db, "utenze_log"), orderBy("date", "desc"), limit(4000)), s => { dUt = s.docs.map(d=>({id:d.id,...d.data()})); if(!$('module-utenze').classList.contains('hidden')) renderUtenze(); });
}

window.populateFilters = () => {
    if(!dIn.length) return;
    const years = [...new Set(dIn.map(d => parseInt(d.date.split('-')[0])))].sort((a,b)=>b-a);
    const ms = $('ms-compare-list');
    ms.innerHTML = `<div class="ms-option"><input type="checkbox" value="avg" checked onchange="renderStats()"><span>ğŸ“Š Media</span></div>` + years.map(y=>`<div class="ms-option"><input type="checkbox" value="${y}" onchange="renderStats()"><span>${y}</span></div>`).join('');
    const cur = new Date().getFullYear();
    if(!val('stat-year')) $('stat-year').innerHTML = years.map(y=>`<option value="${y}" ${y===cur?'selected':''}>${y}</option>`).join('');
    renderStats();
};

window.toggleMsDropdown = () => $('ms-compare-list').classList.toggle('show');
window.onclick = e => { if (!e.target.closest('.ms-container')) $('ms-compare-list').classList.remove('show'); };

window.toggleStatMode = () => {
    const m = val('stat-mode') === 'year';
    $('stat-year-cont').classList.toggle('hidden', !m);
    $('stat-custom-cont').classList.toggle('hidden', m);
    if(!m && !val('stat-date-start')) {
        const n = new Date(); setVal('stat-date-start', isoDate(new Date(n.getFullYear(), n.getMonth(), 1))); setVal('stat-date-end', isoDate(new Date(n.getFullYear(), n.getMonth()+1, 0)));
    }
    renderStats();
};

function renderChart(id, type, labels, datasets, stacked=false) {
    if(typeof Chart === 'undefined') return;
    if(ch[id]) ch[id].destroy();
    const isBar = type === 'bar';
    datasets.forEach(d => { d.borderWidth = isBar?0:2; d.pointRadius = isBar?0:3; d.tension = 0.4; });
    ch[id] = new Chart($(id), { type, data: { labels, datasets }, options: { ...commonChartOptions, scales: { y: { beginAtZero: isBar, stacked }, x: { stacked } } } });
}

window.renderOverviewCharts = () => {
    if(!dIn.length) return;
    const type = val('ov-chart-type');
    const dates=[], l30=[], l30p=[], l90=[], l90p=[], m12=[], m12p=[], mLbl=[];
    const n = new Date();
    
    // Recent 30 & 90
    for(let i=89; i>=0; i--) {
        const d = new Date(); d.setDate(n.getDate()-i); const ds = isoDate(d);
        const dp = new Date(d); dp.setFullYear(dp.getFullYear()-1); const dps = isoDate(dp);
        const v = dIn.find(x=>x.date===ds && !x.excludeStats)?.totale || 0;
        const vp = dIn.find(x=>x.date===dps && !x.excludeStats)?.totale || 0;
        if(i<30) { dates.push(d.getDate()+'/'+(d.getMonth()+1)); l30.push(v); l30p.push(vp); }
        l90.push(v); l90p.push(vp);
    }
    // 12 Months
    for(let i=11; i>=0; i--) {
        const d = new Date(n.getFullYear(), n.getMonth()-i, 1);
        mLbl.push(d.toLocaleString('it-IT',{month:'short'}));
        m12.push(dIn.filter(x=>x.date.startsWith(isoDate(d).slice(0,7)) && !x.excludeStats).reduce((a,b)=>a+b.totale,0));
        m12p.push(dIn.filter(x=> { const xd=new Date(x.date); return xd.getMonth()===d.getMonth() && xd.getFullYear()===d.getFullYear()-1 && !x.excludeStats }).reduce((a,b)=>a+b.totale,0));
    }
    
    const bg = type==='bar'?'#2563eb':'rgba(37,99,235,0.1)';
    const ds = (l,d,dp,lb) => [{label:lb||'Dati', data:d, borderColor:'#2563eb', backgroundColor:bg, fill:true}, {label:'Anno Prec.', data:dp, borderColor:'#94a3b8', borderDash:[5,5], fill:false}];
    
    renderChart('chartRecent30', type, dates, ds(dates, l30, l30p, 'Ultimi 30gg'));
    const d90l = Array.from({length:90},(_,i)=>i); 
    renderChart('chartRecent90', type, d90l, ds(d90l, l90, l90p, 'Ultimi 90gg'));
    renderChart('chartRecent12M', type, mLbl, ds(mLbl, m12, m12p, 'Ultimi 12M'));
    
    // KPI
    const cm = isoDate(n).slice(0,7), pm = isoDate(new Date(n.getFullYear(), n.getMonth()-1, 1)).slice(0,7), ym = (n.getFullYear()-1)+isoDate(n).slice(4,7);
    const curr = dIn.filter(x=>x.date.startsWith(cm) && !x.excludeStats && x.totale>0);
    const totC = curr.reduce((a,b)=>a+b.totale,0);
    $('ov-avg').innerText = curr.length ? (totC/curr.length).toFixed(0) : 0;
    
    const calcDiff = (tot, compDateStr, domId) => {
        const comp = dIn.filter(x=>x.date.startsWith(compDateStr) && !x.excludeStats && new Date(x.date).getDate() <= n.getDate()).reduce((a,b)=>a+b.totale,0);
        const diff = comp>0 ? ((tot-comp)/comp)*100 : (tot>0?100:0);
        $(domId).innerHTML = comp>0 ? `<span style="color:${diff>=0?'#16a34a':'#dc2626'}">${diff>0?'+':''}${diff.toFixed(1)}%</span>` : 'N/D';
    };
    calcDiff(totC, pm, 'ov-mom'); calcDiff(totC, ym, 'ov-yoy');
    const dim = new Date(n.getFullYear(), n.getMonth()+1, 0).getDate();
    $('ov-forecast').innerText = curr.length ? ((totC/curr.length)*dim).toFixed(0) : '-';
};

window.renderStats = () => {
    if(!dIn.length) return;
    const mode = val('stat-mode'), pool = val('stat-pool-filter'), dayT = val('day-type-filter'), cType = val('stat-chart-type');
    const yMain = mode === 'year' ? parseInt(val('stat-year')) : new Date(val('stat-date-start')).getFullYear();
    const start = mode === 'year' ? isoDate(new Date(yMain,0,1)) : val('stat-date-start');
    const end = mode === 'year' ? isoDate(new Date(yMain,11,31)) : val('stat-date-end');
    const comps = Array.from(document.querySelectorAll('#ms-compare-list input:checked')).map(i=>i.value);
    
    const filter = d => {
        if(d.excludeStats) return false;
        if(pool === 'indoor' && d.fascia.includes('Estiva')) return false;
        if(pool === 'outdoor' && !d.fascia.includes('Estiva')) return false;
        if(dayT === 'standard' && d.type !== 'standard') return false;
        if(dayT === 'special' && d.type === 'standard') return false;
        return true;
    };
    
    const base = dIn.filter(filter);
    const mainSet = base.filter(d => d.date >= start && d.date <= end);
    $('deep-total').innerText = mainSet.reduce((a,b)=>a+b.totale,0).toLocaleString();

    // YOY Chart
    let lbls=[], mainD=[], dsets=[];
    if(mode==='year') {
        lbls = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
        mainD = new Array(12).fill(0);
        mainSet.forEach(d => mainD[parseInt(d.date.split('-')[1])-1] += d.totale);
    } else {
        const dMap={}; mainSet.forEach(d=>dMap[d.date]=(dMap[d.date]||0)+d.totale);
        for(let d=new Date(start); d<=new Date(end); d.setDate(d.getDate()+1)) {
            const k=isoDate(d); lbls.push(d.getDate()+'/'+(d.getMonth()+1)); mainD.push(dMap[k]||0);
        }
    }
    dsets.push({label:`${yMain}`, data:mainD, borderColor:'#2563eb', backgroundColor:cType==='bar'?'#2563eb':'rgba(37,99,235,0.1)', fill:true});
    
    const colors = ['#94a3b8', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
    comps.forEach((c, i) => {
        let cd = [];
        if(mode==='year') {
            cd = new Array(12).fill(0);
            for(let m=0; m<12; m++) {
                if(c==='avg') {
                    const l = base.filter(d => parseInt(d.date.split('-')[1])===m+1 && parseInt(d.date.split('-')[0])!==yMain);
                    const map={}; l.forEach(x=>map[x.date]=(map[x.date]||0)+x.totale);
                    const vals=Object.values(map); cd[m]=vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:0;
                } else {
                    cd[m] = base.filter(d=>parseInt(d.date.split('-')[0])===parseInt(c) && parseInt(d.date.split('-')[1])===m+1).reduce((a,b)=>a+b.totale,0);
                }
            }
        } else {
             // Custom range comparison simplified: match by Month-Day
             const dMap={}; 
             if(c==='avg') base.filter(d=>parseInt(d.date.split('-')[0])!==yMain).forEach(d=>{ const k=d.date.slice(5); dMap[k]=(dMap[k]||[]); dMap[k].push(d.totale); });
             else base.filter(d=>parseInt(d.date.split('-')[0])===parseInt(c)).forEach(d=>{ dMap[d.date.slice(5)]=[d.totale]; });
             
             for(let d=new Date(start); d<=new Date(end); d.setDate(d.getDate()+1)) {
                 const k = isoDate(d).slice(5); 
                 const vals = dMap[k] || [];
                 cd.push(vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0);
             }
        }
        dsets.push({label:c==='avg'?'Media':c, data:cd, borderColor:colors[i%5], borderDash:[5,5], fill:false});
    });
    renderChart('chartYoY', cType, lbls, dsets);
    
    // Week Chart
    const wLbls = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];
    const getWData = (src) => {
        const counts=new Array(7).fill(0), sums=new Array(7).fill(0);
        src.forEach(d => { const wd=(new Date(d.date).getDay()+6)%7; sums[wd]+=d.totale; counts[wd]++; });
        return sums.map((s,i)=>counts[i]?s/counts[i]:0);
    };
    renderChart('chartWeek', cType, wLbls, [{label:'Periodo', data:getWData(mainSet), backgroundColor:'#8b5cf6'}]);

    // Pie & Others
    const sums = {Int:0,Rid:0,Abb:0,Grat:0};
    mainSet.forEach(d => { sums.Int+=d.int; sums.Rid+=d.rid; sums.Abb+=d.abb_int+d.abb_rid; sums.Grat+=d.grat; });
    if(ch['chartPie']) ch['chartPie'].destroy();
    ch['chartPie'] = new Chart($('chartPie'), {type:'doughnut', data:{labels:Object.keys(sums), datasets:[{data:Object.values(sums), backgroundColor:['#2563eb','#60a5fa','#a855f7','#cbd5e1'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}}});

    const aggBar = (keyFn) => {
        const m={}; mainSet.forEach(d=>{ const k=keyFn(d); m[k]=(m[k]||0)+d.totale; });
        const l=Object.keys(m).sort();
        return {l, d:l.map(k=>m[k])};
    };
    const md = aggBar(d=>d.meteo), fd = aggBar(d=>d.fascia);
    renderChart('chartMeteo', 'bar', md.l, [{label:'Presenze', data:md.d, backgroundColor:'#f59e0b'}]);
    renderChart('chartFasce', 'bar', fd.l, [{label:'Presenze', data:fd.d, backgroundColor:'#2563eb'}], false);
    ch['chartFasce'].options.indexAxis = 'y'; ch['chartFasce'].update();
};

window.renderVasca = () => {
    const rows = [];
    const grouped = {}; dVa.forEach(d => { (grouped[d.date]=grouped[d.date]||[]).push(d); });
    Object.keys(grouped).sort().reverse().forEach(date => {
        const group = grouped[date].sort((a,b)=>b.time.localeCompare(a.time));
        const dh = `<div style="font-weight:800;color:#1e293b">${fmtDate(date)}</div>`;
        group.forEach((d, i) => {
            const isEst = d.type==='esterna';
            const phS = (d.ph<6.5||d.ph>7.5)?'background:#fee2e2;color:#b91c1c;font-weight:900':'';
            const clS = (d.cll<0.8||d.cll>1.7)?'background:#fee2e2;color:#b91c1c;font-weight:900':'';
            rows.push(`<tr style="border-bottom:${i===group.length-1?'2px solid rgba(0,0,0,0.1)':'1px solid rgba(0,0,0,0.05)'}">
                ${i===0?`<td rowspan="${group.length}" style="background:rgba(255,255,255,0.4)">${dh}</td>`:''}
                <td><div style="font-weight:700;color:#2563eb">${d.time}</div><span class="badge ${isEst?'badge-summer':'badge-std'}">${isEst?'â˜€ï¸ Esterna':'ğŸ  Interna'}</span></td>
                <td>${d.bag}</td><td>${d.ta}Â°</td><td>${d.th}Â°</td><td style="${phS}">${d.ph}</td><td style="${clS}">${d.cll}</td><td>${d.clc}</td><td>${d.clt}</td>
                <td style="text-align:right"><button class="btn btn-icon" style="color:var(--p);background:#eef2ff" onclick="editVasca('${d.id}')">âœï¸</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('valori_vasca','${d.id}')">ğŸ—‘ï¸</button></td>
            </tr>`);
        });
    });
    $('tbody-vasca').innerHTML = rows.join('');
};

window.renderIngressiArchive = () => {
    const s=val('arch-date-start'), e=val('arch-date-end'), fa=val('arch-filter-fascia'), me=val('arch-filter-meteo'), so=val('arch-sort');
    let f = dIn.filter(d => (!s||d.date>=s) && (!e||d.date<=e) && (fa==='all'||d.fascia===fa) && (me==='all'||d.meteo===me));
    f.sort((a,b) => so==='desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
    
    if(!f.length) { $('tbody-ingressi').innerHTML='<tr><td colspan="11" style="text-align:center;padding:20px">Nessun dato</td></tr>'; return; }
    
    const rows = [], grp = {}; f.forEach(d => (grp[d.date]=grp[d.date]||[]).push(d));
    Object.keys(grp).forEach(k => {
        const g = grp[k];
        g.forEach((d,i) => {
            const badg = d.type==='festivo'?'<span class="badge badge-ko">Festivo</span>':(d.type==='evento'?'<span class="badge badge-evt">Evento</span>':'');
            const ex = d.excludeStats;
            rows.push(`<tr style="${ex?'opacity:0.5;background:#f8fafc':''};border-bottom:${i===g.length-1?'2px solid #e2e8f0':'1px solid #f1f5f9'}">
                ${i===0?`<td rowspan="${g.length}" style="background:rgba(255,255,255,0.4)"><b>${fmtDate(k)}</b><br><small>${new Date(k).toLocaleDateString('it',{weekday:'short'})}</small></td>`:''}
                <td><b>${d.fascia}</b> ${badg}<br><small>${d.meteo}</small></td>
                <td class="bg-sub-blue">${d.int}</td><td class="bg-sub-blue">${d.rid}</td><td class="col-subtot bg-sub-blue" style="color:var(--p)">${d.int+d.rid}</td>
                <td class="bg-sub-purp">${d.abb_int}</td><td class="bg-sub-purp">${d.abb_rid}</td><td class="col-subtot bg-sub-purp" style="color:#a855f7">${d.abb_int+d.abb_rid}</td>
                <td>${d.grat}</td><td class="col-total">${d.totale}</td>
                <td style="text-align:right"><button class="btn btn-icon" style="color:#64748b;border:1px solid #e2e8f0;margin-right:5px;width:30px;height:30px" onclick="toggleExc('${d.id}',${ex})">${ex?'âœ…':'ğŸš«'}</button><button class="btn btn-icon" style="color:var(--p);background:#eef2ff" onclick="editIngressi('${d.id}')">âœï¸</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('sessioni','${d.id}')">ğŸ—‘ï¸</button></td>
            </tr>`);
        });
    });
    $('tbody-ingressi').innerHTML = rows.join('');
};

window.renderUtenze = () => {
    const range = parseInt(val('u-range')), lim = new Date(); lim.setDate(lim.getDate()-range); const limS = isoDate(lim);
    const mode = val('u-view-mode'), isD = mode==='delta', cmp = $('u-compare-year').checked;
    
    // Grouping
    const grp = {}; dUt.forEach(d => { if(!grp[d.date]) grp[d.date]={elec:null,water:null,gas:null}; 
        if(d.type.includes('Elett')) grp[d.date].elec=d; else if(d.type.includes('Acqua')) grp[d.date].water=d; else grp[d.date].gas=d; 
    });
    const dates = Object.keys(grp).sort();
    
    // Deltas
    const deltas={}; let prev={elec:null,water:null,gas:null};
    dates.forEach(d => {
        deltas[d]={}; ['elec','water','gas'].forEach(k => {
            if(grp[d][k]) { deltas[d][k] = prev[k]!==null ? Math.max(0, grp[d][k].val - prev[k]) : 0; prev[k]=grp[d][k].val; }
        });
    });

    // Charts
    const mkChart = (key, id, col) => {
        const flt = dates.filter(d => d >= limS);
        const ld = flt.map(d => fmtDate(d).slice(0,5));
        const dd = flt.map(d => isD ? (deltas[d][key]||0) : (grp[d][key]?.val||0));
        const dsets = [{label:isD?'Consumo':'Lettura', data:dd, borderColor:col, backgroundColor:col, fill:true}];
        
        if(cmp) {
            const prevD = flt.map(d => {
                const pd = new Date(d); pd.setFullYear(pd.getFullYear()-1); const pds = isoDate(pd);
                return isD ? (deltas[pds]?.[key]||0) : (grp[pds]?.[key]?.val||0);
            });
            dsets.push({label:'Anno Prec.', data:prevD, borderColor:col, borderDash:[5,5], fill:false, borderWidth:isD?2:1});
        }
        renderChart(id, isD?'bar':'line', ld, dsets);
    };
    mkChart('elec', 'chartElec', '#eab308'); mkChart('water', 'chartWater', '#3b82f6'); mkChart('gas', 'chartGas', '#ef4444');

    // Table History
    const s = val('u-hist-start'), e = val('u-hist-end'), so = val('u-hist-sort');
    let fd = dates.filter(d => (!s||d>=s) && (!e||d<=e));
    if(so === 'desc') fd.reverse();
    
    const tRows = fd.map(d => {
        const g = grp[d], dl = deltas[d];
        const cell = (o, v, c, u) => o ? `<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:800;color:${c}">${o.val.toLocaleString('it')}</span><div><button class="btn btn-icon" style="width:24px;height:24px;padding:0;font-size:0.7rem;color:var(--p);background:#eff6ff" onclick="editUtenze('${o.id}')">âœï¸</button><button class="btn btn-icon" style="width:24px;height:24px;padding:0;font-size:0.7rem;color:#ef4444;background:#fef2f2" onclick="delDoc('utenze_log','${o.id}')">Ã—</button></div></div><div style="font-size:0.75rem;color:${c}">+${v!==undefined?v.toLocaleString('it', {maximumFractionDigits:1}):'-'} ${u}</div>` : '-';
        return `<tr><td style="font-weight:800">${fmtDate(d)}</td>
        <td style="background:rgba(234,179,8,0.05)">${cell(g.elec, dl.elec, '#d97706', 'kWh')}</td>
        <td style="background:rgba(234,179,8,0.05);font-size:0.75rem">${g.elec?`F1:<b>${g.elec.a1}</b> F2:<b>${g.elec.a2}</b> F3:<b>${g.elec.a3}</b>`:''}</td>
        <td style="background:rgba(59,130,246,0.05)">${cell(g.water, dl.water, '#2563eb', 'mÂ³')}</td>
        <td style="background:rgba(239,68,68,0.05)">${cell(g.gas, dl.gas, '#dc2626', 'mÂ³')}</td>
        <td style="font-size:0.8rem;color:#64748b">${[g.elec?.note,g.water?.note,g.gas?.note].filter(Boolean).join('; ')}</td></tr>`;
    });
    $('tbody-utenze').innerHTML = tRows.join('');
};

window.renderUtenzeKPI = () => {
    // KPI logic simplified for brevity but functional
    const mStr = val('u-kpi-month-selector') || isoDate(new Date()).slice(0,7);
    const [y, m] = mStr.split('-').map(Number);
    
    // Helper to sum deltas for a specific month
    const sumMonth = (yr, mo, type) => {
        let sum = 0;
        dUt.filter(d => {
             const dt = new Date(d.date); return dt.getFullYear()===yr && dt.getMonth()+1===mo && d.type.includes(type);
        }).forEach(d => {
             // Find prev reading to calc delta
             const prevD = dUt.filter(x => x.date < d.date && x.type === d.type).sort((a,b)=>b.date.localeCompare(a.date))[0];
             if(prevD) sum += Math.max(0, d.val - prevD.val);
        });
        return sum;
    };

    const types = [['elec','ElettricitÃ ','kWh'],['water','Acqua','mÂ³'],['gas','Gas','mÂ³']];
    types.forEach(([k, t, u]) => {
        const curr = sumMonth(y, m, t);
        const prev = sumMonth(y-1, m, t);
        $(`u-kpi-${k}-title`).innerText = `${m}/${y}`;
        $(`u-kpi-${k}-val`).innerText = `${curr.toLocaleString('it')} ${u}`;
        const diff = prev>0 ? ((curr-prev)/prev)*100 : 0;
        $(`u-kpi-${k}-sub`).innerHTML = prev>0 ? `<span style="color:${diff>0?'#ef4444':'#10b981'}">${diff>0?'+':''}${diff.toFixed(1)}%</span> vs anno prec` : '-';
    });
};

window.renderDae = () => {
    const rows = dDae.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).map(d => 
        `<tr><td style="font-weight:700">${fmtDate(d.date)}</td><td style="color:#2563eb">${d.time}</td><td>${d.status==='OK'?'<span class="badge badge-ok">OK</span>':'<span class="badge badge-ko">GUASTO</span>'}</td><td>${d.ass}</td><td>${d.op}</td><td style="text-align:right"><button class="btn btn-icon" style="color:#ef4444" onclick="delDoc('dae_log','${d.id}')">ğŸ—‘ï¸</button></td></tr>`
    );
    $('tbody-dae').innerHTML = rows.join('');
};

// CRUD OPS
window.saveIngressi = async () => {
    const d = val('i-date'); if(!d) return showToast("Manca Data", "error");
    const p = { date:d, type:val('i-type'), fascia:val('i-fascia'), meteo:val('i-meteo'), excludeStats:$('i-exclude').checked, int:+val('q-intero'), rid:+val('q-ridotto'), grat:+val('q-gratuito'), abb_int:+val('q-abb-int'), abb_rid:+val('q-abb-rid') };
    p.totale = p.int+p.rid+p.grat+p.abb_int+p.abb_rid;
    try { await (edIn ? updateDoc(doc(db,"sessioni",edIn), p) : addDoc(collection(db,"sessioni"), p)); showToast("Salvato"); if(!edIn) resetForm('module-ingressi'); cancelEditIngressi(); } catch(e) { showToast(e.message, "error"); }
};
window.saveVasca = async () => {
    const p = { date:val('v-date'), time:val('v-time'), bag:val('v-bag'), ta:val('v-ta'), th:val('v-th'), ph:val('v-ph'), cll:val('v-cll'), clc:val('v-clc'), clt:val('v-clt'), type:val('v-type') };
    if(!p.date||!p.time) return showToast("Dati mancanti", "error");
    try { await (edVa ? updateDoc(doc(db,"valori_vasca",edVa), p) : addDoc(collection(db,"valori_vasca"), p)); showToast("Salvato"); cancelEditVasca(); } catch(e){ showToast(e.message,"error"); }
};
window.saveDae = async () => {
    if(!val('d-ass')||!val('d-op')) return showToast("Nomi mancanti","error");
    try { await addDoc(collection(db,"dae_log"),{date:val('d-date'),time:val('d-time'),ass:val('d-ass'),op:val('d-op'),status:val('d-status')}); showToast("Registrato"); setVal('d-ass',''); setVal('d-op',''); } catch(e){ showToast(e.message,"error"); }
};
window.saveUtenze = async () => {
    const t = val('u-type');
    const p = { date:val('u-date'), type:t, note:val('u-note') };
    if(t.includes('Elett')) { p.a1=+val('u-a1'); p.a2=+val('u-a2'); p.a3=+val('u-a3'); p.val=p.a1+p.a2+p.a3; p.meteo=val('u-meteo'); }
    else { p.val=+val('u-val'); if(t.includes('Gas')) p.temp=+val('u-temp'); }
    if(!p.date) return showToast("Manca Data","error");
    try { await (edUt ? updateDoc(doc(db,"utenze_log",edUt), p) : addDoc(collection(db,"utenze_log"), p)); showToast("Salvato"); cancelEditUtenze(); } catch(e){ showToast(e.message,"error"); }
};
window.delDoc = async (c,i) => { if(confirm("Eliminare?")) await deleteDoc(doc(db,c,i)); };
window.toggleExc = async (i,v) => updateDoc(doc(db,"sessioni",i), {excludeStats:!v});

// EDIT HANDLERS
window.editIngressi = id => { const d=dIn.find(x=>x.id===id); edIn=id; setVal('i-date',d.date); setVal('i-type',d.type||'standard'); setVal('i-fascia',d.fascia); setVal('i-meteo',d.meteo); $('i-exclude').checked=d.excludeStats; setVal('q-intero',d.int); setVal('q-ridotto',d.rid); setVal('q-gratuito',d.grat); setVal('q-abb-int',d.abb_int); setVal('q-abb-rid',d.abb_rid); toggleEdit('ingressi', true); };
window.editVasca = id => { const d=dVa.find(x=>x.id===id); edVa=id; setVal('v-date',d.date); setVal('v-time',d.time); setVal('v-type',d.type||'interna'); setVal('v-bag',d.bag); setVal('v-ta',d.ta); setVal('v-th',d.th); setVal('v-ph',d.ph); setVal('v-cll',d.cll); setVal('v-clc',d.clc); setVal('v-clt',d.clt); toggleEdit('vasca', true); };
window.editUtenze = id => { const d=dUt.find(x=>x.id===id); edUt=id; setVal('u-date',d.date); setVal('u-type',d.type); setVal('u-note',d.note||''); toggleUtenzeMode(); if(d.type.includes('Elett')) { setVal('u-a1',d.a1); setVal('u-a2',d.a2); setVal('u-a3',d.a3); setVal('u-meteo',d.meteo||'â˜€ï¸ Sole'); } else { setVal('u-val',d.val); if(d.temp) setVal('u-temp',d.temp); } toggleEdit('utenze', true); };

window.cancelEditIngressi = () => { edIn=null; resetForm('module-ingressi'); toggleEdit('ingressi', false); $('i-exclude').checked=false; };
window.cancelEditVasca = () => { edVa=null; toggleEdit('vasca', false); };
window.cancelEditUtenze = () => { edUt=null; resetForm('module-utenze'); toggleUtenzeMode(); toggleEdit('utenze', false); };

function toggleEdit(mod, isEdit) {
    const t = isEdit ? "Modifica" : "Registrazione", c = isEdit ? "#f59e0b" : "", tx = isEdit ? "AGGIORNA" : (mod==='dae'?'REGISTRA':'SALVA');
    $(`title-${mod}`).innerText = t + (mod==='vasca'?' Valori':(mod==='utenze'?' Letture':' Ingressi'));
    $(`btn-save-${mod}`).innerText = tx; $(`btn-save-${mod}`).style.background = c;
    $(`cancel-${mod}`).classList.toggle('hidden', !isEdit);
    $(`cb-${mod}`).classList.toggle('editing', isEdit);
    if(isEdit) window.scrollTo({top:0,behavior:'smooth'});
}
function resetForm(id) { $(id).querySelectorAll('input:not([type=date])').forEach(i=>i.value=''); }

window.switchModule = m => { document.querySelectorAll('.module-container').forEach(e=>e.classList.add('hidden')); $(`module-${m}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); $(`nav-module-${m}`).classList.add('active'); refreshView(); };
window.switchSubView = s => { ['overview','stats','archive'].forEach(v => { $(`sub-${v}`).classList.add('hidden'); $(`btn-sub-${v}`).classList.remove('btn-primary'); }); $(`sub-${s}`).classList.remove('hidden'); $(`btn-sub-${s}`).classList.add('btn-primary'); refreshView(); };

function refreshView() {
    if(!$('module-ingressi').classList.contains('hidden')) {
        if(!$('sub-overview').classList.contains('hidden')) renderOverviewCharts();
        if(!$('sub-stats').classList.contains('hidden')) renderStats();
        if(!$('sub-archive').classList.contains('hidden')) renderIngressiArchive();
    }
}

// UTILS
window.showToast = (msg, t='success') => { const c=$('toast-container'), e=document.createElement('div'); e.className=`toast toast-${t}`; e.innerHTML=`<span>${t==='success'?'âœ…':'âš ï¸'}</span> ${msg}`; c.appendChild(e); requestAnimationFrame(()=>e.classList.add('show')); setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); };
window.calcClTot = () => setVal('v-clt', ((+val('v-cll')||0) + (+val('v-clc')||0)).toFixed(2));
window.toggleUtenzeMode = () => { const t=val('u-type'); $('u-single-input').classList.toggle('hidden', t.includes('Elett')); $('u-elec-input').style.display = t.includes('Elett')?'contents':'none'; $('u-extra-elec-meteo').classList.toggle('hidden', !t.includes('Elett')); $('u-extra-gas').classList.toggle('hidden', !t.includes('Gas')); };
window.resetArchiveFilters = () => { setVal('arch-date-start',''); setVal('arch-date-end',''); setVal('arch-filter-fascia','all'); setVal('arch-filter-meteo','all'); renderIngressiArchive(); };
window.resetUtenzeHistory = () => { setVal('u-hist-start',''); setVal('u-hist-end',''); renderUtenze(); };
window.downloadCSV = () => {
    let csv = "Data;Tipo;Fascia;Totale\n" + dIn.map(d=>`${d.date};${d.type};${d.fascia};${d.totale}`).join('\n');
    const a = document.createElement("a"); a.href = "data:text/csv;charset=utf-8," + encodeURI(csv); a.download = "export.csv"; a.click();
};

setInterval(() => { if($('d-time')) setVal('d-time', new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})); }, 1000);
['i-date','v-date','d-date','u-date'].forEach(i => { if($(i)) setVal(i, today); });
</script>
</body>
</html>
