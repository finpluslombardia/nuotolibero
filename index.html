<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piscina Manager V17</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg-body: #f3f4f6; --bg-sidebar: #1e293b; --text-sidebar: #94a3b8;
            --card-bg: #ffffff; --text-main: #111827; --text-muted: #6b7280;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--bg-sidebar); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        .sidebar-header { padding: 25px; font-size: 1.2rem; font-weight: 700; color: #fff; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; padding: 20px 10px; margin: 0; flex: 1; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text-sidebar); font-weight: 500; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .nav-item:hover { background: #334155; color: #fff; }
        .nav-item.active { background: var(--primary); color: #fff; }
        .sidebar-footer { padding: 20px; border-top: 1px solid #334155; }
        .user-info { font-size: 0.8rem; color: var(--text-sidebar); margin-bottom: 10px; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 25px; }
        
        /* HEADER AREA */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .page-title { font-size: 1.8rem; font-weight: 800; color: #111827; margin: 0; }
        
        /* FILTERS BAR */
        .filters-row { display: flex; gap: 15px; background: #fff; padding: 10px 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); align-items: center; width: fit-content; }
        select { border: none; font-weight: 600; color: #374151; background: transparent; cursor: pointer; font-size: 0.95rem; outline: none; }
        
        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid var(--border); position: relative; overflow: hidden; }
        .kpi-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-val { font-size: 2rem; font-weight: 800; color: #111827; margin: 5px 0; }
        .kpi-sub { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .kpi-icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.05; color: #000; transform: rotate(-15deg); }

        /* CHARTS GRID */
        .charts-row-main { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; } /* 2/3 and 1/3 */
        .charts-row-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        
        .chart-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 700; color: #374151; font-size: 1rem; }

        /* BUTTONS */
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; transition: transform 0.1s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: #fff; border: 1px solid var(--border); color: #374151; }
        
        /* TABLE */
        .table-container { background: #fff; border-radius: 16px; padding: 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; background: #f9fafb; color: #6b7280; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid #f3f4f6; color: #374151; font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f9fafb; }
        
        /* MODAL (New Entry) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #fff; width: 500px; border-radius: 20px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.95rem; outline: none; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .ticket-input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; background: #f3f4f6; padding: 15px; border-radius: 12px; }
        .t-box { text-align: center; }
        .t-box label { font-size: 0.7rem; font-weight: 700; color: #6b7280; display: block; margin-bottom: 3px; }
        .t-box input { text-align: center; font-weight: 700; color: var(--primary); font-size: 1.1rem; }

        /* Login */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .bg-blue { background: #eff6ff; color: #1d4ed8; }
        .bg-orange { background: #fff7ed; color: #c2410c; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="width: 350px; text-align: center;">
        <h1 style="color:var(--primary); margin-bottom: 20px;">üèä‚Äç‚ôÇÔ∏è Piscina Manager</h1>
        <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
        <input type="password" id="password" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px; border:1px solid #ccc; border-radius:8px;">
        <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="doLogin()">Accedi</button>
        <p id="login-error" style="color:red; margin-top:10px; font-size:0.9rem"></p>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">üåä PiscinaStats</div>
    <ul class="nav-links">
        <li class="nav-item active" id="nav-dash" onclick="switchView('dash')">üìä Dashboard</li>
        <li class="nav-item" id="nav-list" onclick="switchView('list')">üìã Archivio Dati</li>
    </ul>
    <div class="sidebar-footer">
        <div class="user-info" id="user-display">Utente</div>
        <button class="btn btn-outline" style="width:100%; border:1px solid #475569; color:#cbd5e1; background:transparent; font-size:0.8rem" onclick="doLogout()">Esci</button>
    </div>
</div>

<div class="main-content" id="app-content">
    
    <div class="top-bar">
        <h2 class="page-title">Panoramica</h2>
        <div style="display: flex; gap: 15px;">
            <div class="filters-row">
                <span>üìÖ</span>
                <select id="dash-year" onchange="renderDashboard()"><option value="all">Tutti gli Anni</option></select>
                <span style="color:#e5e5ea">|</span>
                <select id="dash-month" onchange="renderDashboard()">
                    <option value="all">Tutto l'anno</option><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                    <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openModal()">‚ûï Nuovo Inserimento</button>
        </div>
    </div>

    <div id="view-dash">
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Media Giornaliera</div>
                <div class="kpi-val" id="kpi-avg">0</div>
                <div class="kpi-sub">persone / giorno</div>
                <div class="kpi-icon-bg">‚ûó</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Vs Mese Precedente</div>
                <div class="kpi-val" id="kpi-mom">0%</div>
                <div class="kpi-sub" id="kpi-mom-label">-</div>
                <div class="kpi-icon-bg">üóìÔ∏è</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Vs Anno Precedente</div>
                <div class="kpi-val" id="kpi-yoy">0%</div>
                <div class="kpi-sub" id="kpi-yoy-label">-</div>
                <div class="kpi-icon-bg">üìà</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Proiezione Mese</div>
                <div class="kpi-val" id="kpi-forecast" style="color:var(--info)">-</div>
                <div class="kpi-sub" id="kpi-forecast-sub">stimata</div>
                <div class="kpi-icon-bg">üîÆ</div>
            </div>
        </div>

        <div class="charts-row-main" style="margin-top:25px">
            <div class="chart-card" style="height: 350px;">
                <div class="chart-header">Andamento Stagionale (YoY)</div>
                <canvas id="chartYoY"></canvas>
            </div>
            <div class="chart-card" style="height: 350px; justify-content:center">
                <div class="chart-header">Composizione Clienti</div>
                <canvas id="chartPie" style="max-height: 200px;"></canvas>
                <div style="text-align:center; margin-top:20px; font-size:0.9rem; color:#555">
                    Totale Ingressi: <strong id="deep-total" style="font-size:1.1rem; color:var(--primary)">0</strong>
                </div>
            </div>
        </div>

        <div class="charts-row-secondary" style="margin-top:25px">
            <div class="chart-card">
                <div class="chart-header">Impatto Meteo</div>
                <canvas id="chartMeteo" style="height:180px"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header">Trend Settimanale</div>
                <canvas id="chartWeek" style="height:180px"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header">Fasce Orarie</div>
                <canvas id="chartFasce" style="height:180px"></canvas>
            </div>
        </div>

    </div>

    <div id="view-list" class="hidden">
        <div class="table-container">
            <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center">
                <h3 style="margin:0">Archivio Dati</h3>
                <button class="btn btn-outline" onclick="downloadCSV()">üì• Scarica Excel</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Data</th><th>Fascia</th><th>Meteo</th><th>Singoli</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="modal-form" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h2 style="margin:0; font-size:1.4rem" id="modal-title">Nuovo Inserimento</h2>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer">&times;</button>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="i-date">
            </div>
            <div class="form-group">
                <label>Meteo</label>
                <select id="i-meteo">
                    <option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option>
                    <option value="üî• Sole + Caldo">üî• Sole + Caldo</option>
                    <option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option>
                    <option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option>
                    <option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option>
                    <option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option>
                    <option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option>
                    <option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option>
                    <option value="‚ùì N/D">‚ùì N/D</option>
                </select>
            </div>
        </div>

        <div class="form-group" style="margin-bottom:15px">
            <label>Fascia Oraria / Vasca</label>
            <select id="i-fascia">
                <optgroup label="üèä Vasca Interna">
                    <option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option>
                    <option value="Pranzo">Pranzo</option><option value="Sera">Sera</option>
                    <option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option>
                    <option value="Festivo">Festivo</option><option value="Unico">Unico</option>
                </optgroup>
                <optgroup label="‚òÄÔ∏è Vasca Esterna">
                    <option value="Estiva - Mattina">Estiva - Mattina</option>
                    <option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option>
                    <option value="Estiva - Unico">Estiva - Unico</option>
                </optgroup>
            </select>
        </div>

        <div class="ticket-input-grid">
            <div class="t-box form-group"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
            <div class="t-box form-group"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
            <div class="t-box form-group"><label>GRATUITO</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
            <div class="t-box form-group"><label>ABB. INT</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
            <div class="t-box form-group"><label>ABB. 11 INGR.</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
        </div>

        <button id="btn-save" class="btn btn-primary" style="width:100%; margin-top:25px; justify-content:center; padding:15px" onclick="saveData()">üíæ Salva Dati</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0",
      authDomain: "piscinastats-64519.firebaseapp.com",
      projectId: "piscinastats-64519",
      storageBucket: "piscinastats-64519.firebasestorage.app",
      messagingSenderId: "297663099794",
      appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let allData = [];
    let editId = null;

    // --- AUTH ---
    window.doLogin = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
        catch(e) { document.getElementById('login-error').innerText = e.message; }
    };
    window.doLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-display').innerText = user.email.split('@')[0];
            startListening(); 
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    });

    // --- LOGIC ---
    function startListening() {
        const q = query(collection(db, "sessioni"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            populateYearFilters();
            renderDashboard();
        });
    }

    // --- MODAL ---
    window.openModal = (id = null) => {
        const modal = document.getElementById('modal-form');
        modal.style.display = 'flex';
        
        if (id) { // Edit Mode
            const d = allData.find(x => x.id === id);
            editId = id;
            document.getElementById('modal-title').innerText = "Modifica Dati";
            document.getElementById('i-date').value = d.date;
            document.getElementById('i-fascia').value = d.fascia;
            document.getElementById('i-meteo').value = d.meteo;
            document.getElementById('q-intero').value = d.int;
            document.getElementById('q-ridotto').value = d.rid;
            document.getElementById('q-gratuito').value = d.grat;
            document.getElementById('q-abb-int').value = d.abb_int;
            document.getElementById('q-abb-rid').value = d.abb_rid;
        } else { // New Mode
            editId = null;
            document.getElementById('modal-title').innerText = "Nuovo Inserimento";
            document.getElementById('i-date').valueAsDate = new Date();
            resetInputs();
        }
    };
    window.closeModal = () => document.getElementById('modal-form').style.display = 'none';
    function resetInputs() {
        document.querySelectorAll('.t-box input').forEach(i => i.value = 0);
    }

    // --- DASHBOARD ---
    window.switchView = (view) => {
        document.getElementById('view-dash').classList.add('hidden');
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('nav-dash').classList.remove('active');
        document.getElementById('nav-list').classList.remove('active');
        
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.getElementById(`nav-${view}`).classList.add('active');
        if(view === 'list') renderList();
    };

    function populateYearFilters() {
        const years = [...new Set(allData.map(d => d.date.split('-')[0]))].sort().reverse();
        const sel = document.getElementById('dash-year');
        const curr = sel.value;
        sel.innerHTML = '<option value="all">Tutti gli Anni</option>';
        years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
        if(years.includes(curr)) sel.value = curr;
    }

    window.renderDashboard = () => {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) &&
                   ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });

        // KPI
        const total = filtered.reduce((a,b)=>a+b.totale,0);
        document.getElementById('deep-total').innerText = total.toLocaleString();
        
        const uniqueDays = new Set(filtered.map(d => d.date)).size;
        document.getElementById('kpi-avg').innerText = uniqueDays > 0 ? (total / uniqueDays).toFixed(0) : 0;

        // Forecast
        const now = new Date();
        if(y === now.getFullYear().toString() && m === (now.getMonth()+1).toString()) {
            const daysInM = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            const proj = Math.round((total / now.getDate()) * daysInM);
            document.getElementById('kpi-forecast').innerText = proj.toLocaleString();
        } else {
            document.getElementById('kpi-forecast').innerText = "-";
        }

        // Trends (YoY & MoM)
        calcTrend('kpi-yoy', total, y, m, 'year');
        calcTrend('kpi-mom', total, y, m, 'month');

        // Charts
        renderCharts(filtered, y, m);
        if(!document.getElementById('view-list').classList.contains('hidden')) renderList();
    };

    function calcTrend(elId, curr, y, m, type) {
        const el = document.getElementById(elId);
        const lbl = document.getElementById(elId+'-label');
        if(y==='all') { el.innerText="-"; lbl.innerText="Seleziona periodo"; return; }
        
        let prevTotal = 0, txt = "";
        if(type==='year') {
            const prevY = (parseInt(y)-1).toString();
            prevTotal = allData.filter(d => d.date.startsWith(prevY) && (m==='all' || (new Date(d.date).getMonth()+1)==m)).reduce((a,b)=>a+b.totale,0);
            txt = `vs ${prevY}`;
        } else {
            if(m==='all') { el.innerText="-"; return; } // No MoM for full year
            let pM = parseInt(m)-1, pY = parseInt(y);
            if(pM===0) { pM=12; pY--; }
            prevTotal = allData.filter(d => { const dt=new Date(d.date); return dt.getFullYear()==pY && (dt.getMonth()+1)==pM; }).reduce((a,b)=>a+b.totale,0);
            txt = "vs Mese prec.";
        }

        if(prevTotal > 0) {
            const diff = ((curr - prevTotal)/prevTotal)*100;
            el.innerText = (diff>0?"+":"") + diff.toFixed(1) + "%";
            el.className = diff>=0 ? "kpi-val trend-up" : "kpi-val trend-down";
            lbl.innerText = txt;
        } else {
            el.innerText = "N/A"; el.className = "kpi-val"; lbl.innerText = "No dati storici";
        }
    }

    // --- CHARTS ---
    let chartInstances = {};
    function renderCharts(data, y, m) {
        // YoY
        const ctxYoY = document.getElementById('chartYoY');
        const labels = m !== 'all' ? Array.from({length:31},(_,i)=>i+1) : ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
        const currData = new Array(labels.length).fill(0);
        data.forEach(d => currData[(m!=='all' ? new Date(d.date).getDate()-1 : new Date(d.date).getMonth())] += d.totale);
        
        let datasets = [{ label: y==='all'?'Totale':y, data: currData, borderColor: '#2563eb', backgroundColor:'rgba(37,99,235,0.1)', fill:true, tension:0.4 }];
        
        if(y!=='all') {
            const prevY = (parseInt(y)-1).toString();
            const prevDataArr = new Array(labels.length).fill(0);
            allData.filter(d => d.date.startsWith(prevY) && (m==='all' || (new Date(d.date).getMonth()+1)==m))
                   .forEach(d => prevDataArr[(m!=='all' ? new Date(d.date).getDate()-1 : new Date(d.date).getMonth())] += d.totale);
            datasets.push({ label: prevY, data: prevDataArr, borderColor: '#9ca3af', borderDash:[5,5], tension:0.4, pointRadius:0, fill:false });
        }

        if(chartInstances['yoy']) chartInstances['yoy'].destroy();
        chartInstances['yoy'] = new Chart(ctxYoY, { type: 'line', data: { labels, datasets }, options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} } });

        // Pie
        let s=0, a=0, g=0; data.forEach(d => { s+=(d.int||0)+(d.rid||0); a+=(d.abb_int||0)+(d.abb_rid||0); g+=(d.grat||0); });
        if(chartInstances['pie']) chartInstances['pie'].destroy();
        chartInstances['pie'] = new Chart(document.getElementById('chartPie'), { type:'doughnut', data:{labels:['Singoli','Abbonati','Gratuiti'], datasets:[{data:[s,a,g], backgroundColor:['#3b82f6','#f59e0b','#ef4444']}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}} });

        // Meteo
        const mMap = {}; data.forEach(d => { if(!mMap[d.meteo]) mMap[d.meteo]={t:0,c:0}; mMap[d.meteo].t+=d.totale; mMap[d.meteo].c++; });
        if(chartInstances['meteo']) chartInstances['meteo'].destroy();
        chartInstances['meteo'] = new Chart(document.getElementById('chartMeteo'), { type:'bar', data:{labels:Object.keys(mMap), datasets:[{label:'Media', data:Object.keys(mMap).map(k=>(mMap[k].t/mMap[k].c).toFixed(0)), backgroundColor:'#0ea5e9'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });

        // Week
        const wStats = [0,0,0,0,0,0,0]; data.forEach(d => wStats[new Date(d.date).getDay()] += d.totale);
        if(chartInstances['week']) chartInstances['week'].destroy();
        chartInstances['week'] = new Chart(document.getElementById('chartWeek'), { type:'bar', data:{labels:['Dom','Lun','Mar','Mer','Gio','Ven','Sab'], datasets:[{label:'Totale', data:wStats, backgroundColor:'#8b5cf6', borderRadius:4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });

        // Fasce
        const fMap = {}; data.forEach(d => { if(!fMap[d.fascia]) fMap[d.fascia]=0; fMap[d.fascia]+=d.totale; });
        const fSort = Object.entries(fMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        if(chartInstances['fasce']) chartInstances['fasce'].destroy();
        chartInstances['fasce'] = new Chart(document.getElementById('chartFasce'), { type:'bar', data:{labels:fSort.map(x=>x[0]), datasets:[{label:'', data:fSort.map(x=>x[1]), backgroundColor:'#f59e0b', borderRadius:4}]}, options:{responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}} });
    }

    // --- LIST & CRUD ---
    function renderList() {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;
        const filtered = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) && ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        filtered.forEach(d => {
            const isSum = d.fascia.includes("Estiva");
            const badge = isSum ? 'badge bg-orange' : 'badge bg-blue';
            const s = (d.int||0)+(d.rid||0); const a = (d.abb_int||0)+(d.abb_rid||0);
            tbody.innerHTML += `<tr>
                <td>${d.date.split('-').reverse().join('/')}</td>
                <td><span class="${badge}">${d.fascia}</span></td>
                <td>${d.meteo}</td><td>${s}</td><td>${a}</td><td>${d.grat}</td>
                <td style="font-weight:800">${d.totale}</td>
                <td style="text-align:right">
                    <button class="btn-edit" onclick="window.editItem('${d.id}')">‚úèÔ∏è</button>
                    <button class="btn-del" onclick="window.delItem('${d.id}')">üóëÔ∏è</button>
                </td></tr>`;
        });
    }

    window.saveData = async () => {
        const date = document.getElementById('i-date').value;
        if(!date) return alert("Inserisci la data");
        const v1=parseInt(document.getElementById('q-intero').value)||0;
        const v2=parseInt(document.getElementById('q-ridotto').value)||0;
        const v3=parseInt(document.getElementById('q-gratuito').value)||0;
        const v4=parseInt(document.getElementById('q-abb-int').value)||0;
        const v5=parseInt(document.getElementById('q-abb-rid').value)||0;
        const total = v1+v2+v3+v4+v5;
        if(total===0) return alert("Inserisci almeno un ingresso");

        const payload = {
            date, fascia: document.getElementById('i-fascia').value,
            meteo: document.getElementById('i-meteo').value,
            int: v1, rid: v2, grat: v3, abb_int: v4, abb_rid: v5, totale: total, lastUpdate: new Date()
        };

        try {
            if(editId) { await updateDoc(doc(db, "sessioni", editId), payload); }
            else { await addDoc(collection(db, "sessioni"), payload); }
            closeModal();
        } catch(e) { alert(e.message); }
    };

    window.editItem = (id) => openModal(id);
    window.delItem = async (id) => { if(confirm("Eliminare?")) await deleteDoc(doc(db, "sessioni", id)); };
    
    window.downloadCSV = () => {
        const blob = new Blob([ "Data;Fascia;Meteo;Singoli;Abbonamenti;Gratuiti;TOTALE\n" + allData.map(d=>`${d.date};${d.fascia};${d.meteo};${(d.int||0)+(d.rid||0)};${(d.abb_int||0)+(d.abb_rid||0)};${d.grat};${d.totale}`).join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Report.csv"; a.click();
    };
</script>

</body>
</html>
