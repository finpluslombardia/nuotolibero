<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Stat CF Lampugnano</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
Â  Â  :root {
Â  Â  Â  Â  --primary: #2563eb;
Â  Â  Â  Â  --bg-body: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #e9d5ff 100%);
Â  Â  Â  Â  --text-main: #1e293b; --text-muted: #475569;
Â  Â  Â  Â  --glass-bg: rgba(255, 255, 255, 0.45);
Â  Â  Â  Â  --glass-border: 1px solid rgba(255, 255, 255, 0.6);
Â  Â  Â  Â  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
Â  Â  Â  Â  --glass-blur: blur(12px);
Â  Â  Â  Â  --sidebar-glass: rgba(15, 23, 42, 0.85);
Â  Â  }

Â  Â  * { box-sizing: border-box; outline: none; }
Â  Â  body {
Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
Â  Â  Â  Â  background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden;
Â  Â  }

Â  Â  /* TOAST */
Â  Â  #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
Â  Â  .toast { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 40px rgba(37, 99, 235, 0.15); padding: 15px 25px; border-radius: 16px; color: var(--text-main); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: all 0.3s; }
Â  Â  .toast.show { transform: translateY(0); opacity: 1; }
Â  Â  .toast-success { border-left: 5px solid #10b981; } .toast-error { border-left: 5px solid #ef4444; }

Â  Â  /* SIDEBAR */
Â  Â  .sidebar { width: 250px; background: var(--sidebar-glass); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
Â  Â  .sidebar-header { padding: 30px 20px; font-size: 1.1rem; font-weight: 700; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
Â  Â  .nav-section-title { padding: 20px 20px 10px; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 800; letter-spacing: 1px; }
Â  Â  .nav-links { list-style: none; padding: 0 10px; margin: 0; }
Â  Â  .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: #cbd5e1; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.9rem; }
Â  Â  .nav-item:hover { background: rgba(255,255,255,0.15); color: #fff; }
Â  Â  .nav-item.active { background: linear-gradient(90deg, var(--primary), #4f46e5); color: #fff; box-shadow: 0 0 15px rgba(37,99,235,0.4); border: 1px solid rgba(255,255,255,0.2); }
Â  Â  .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }

Â  Â  /* MAIN CONTENT */
Â  Â  .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }

Â  Â  /* CONTROL BAR */
Â  Â  .control-bar { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); border-bottom: var(--glass-border); box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; transition: background 0.3s; }
Â  Â  .control-bar.editing { background: rgba(254, 243, 199, 0.9); border-bottom: 2px solid #f59e0b; }
Â  Â  .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
Â  Â  .cb-title { font-weight: 800; color: var(--text-main); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
Â  Â Â 
Â  Â  /* CB-ROW BASE */
Â  Â  .cb-row { display: flex; gap: 15px; align-items: flex-end; width: 100%; }
Â  Â  #cb-utenze .cb-row { flex-wrap: wrap; }
Â  Â  #cb-ingressi .cb-row { flex-wrap: nowrap; gap: 15px; }
Â  Â  #cb-vasca .cb-row { flex-wrap: nowrap; gap: 15px; }
Â  Â Â 
Â  Â  /* INPUT FIELDS STANDARD */
Â  Â  .inp-field { display: flex; flex-direction: column; flex: 1; min-width: 0; }
Â  Â  .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  .inp-field input, .inp-field select { padding: 0 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); font-size: 0.9rem; height: 44px; color: var(--text-main); font-family: inherit; font-weight: 500; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); width: 100%; }
Â  Â  .inp-field input:focus, .inp-field select:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
Â  Â  .inp-locked { background: rgba(0,0,0,0.05) !important; color: #64748b !important; cursor: not-allowed; font-weight: 700; border: 1px solid rgba(0,0,0,0.1) !important; }
Â  Â Â 
Â  Â  /* MULTI SELECT CUSTOM */
Â  Â  .ms-container { position: relative; }
Â  Â  .ms-btn { width: 100%; height: 44px; background: rgba(255,255,255,0.65); border: 1px solid rgba(255,255,255,0.8); border-radius: 12px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #64748b; }
Â  Â  .ms-dropdown { position: absolute; top: 105%; left: 0; width: 220px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 8px; z-index: 100; display: none; max-height: 250px; overflow-y: auto; }
Â  Â  .ms-dropdown.show { display: block; }
Â  Â  .ms-option { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: background 0.1s; }
Â  Â  .ms-option:hover { background: #f1f5f9; }
Â  Â  .ms-option input { width: 16px; height: 16px; accent-color: var(--primary); }
Â  Â  .ms-option span { font-size: 0.85rem; color: var(--text-main); font-weight: 500; }

Â  Â  /* GRUPPI DEL LAYOUT INGRESSI */
Â  Â  .group-ctx { display: flex; gap: 10px; flex: 1.6; align-items: flex-end; min-width: 0; }
Â  Â  .group-tickets { display: flex; gap: 5px; flex: 1; background: rgba(255, 255, 255, 0.35); padding: 5px 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); align-items: center; justify-content: space-between; height: 64px; }
Â  Â  .group-actions { display: flex; align-items: flex-end; gap: 10px; flex: 0 0 auto; }
Â  Â  .group-chem { display: flex; gap: 8px; flex: 2; background: rgba(255, 255, 255, 0.3); padding: 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); align-items: center; justify-content: space-between; height: 64px; }
Â  Â Â 
Â  Â  /* TICKET BOX */
Â  Â  .t-box { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 40px; flex: 1; }
Â  Â  .t-box label { font-size: 0.6rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; text-align: center; width: 100%; opacity: 0.8; letter-spacing: -0.5px; }
Â  Â  .t-box input { width: 100%; text-align: center; font-weight: 800; color: var(--primary); font-size: 1.2rem; border: none; background: transparent; padding: 0; height: auto; font-family: inherit; }

Â  Â  .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }
Â  Â  .glass-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; }
Â  Â  .page-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

Â  Â  /* BUTTONS */
Â  Â  .btn { padding: 0 24px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; height: 44px; font-family: inherit; white-space: nowrap; }
Â  Â  .btn:active { transform: scale(0.97); }
Â  Â  .btn-primary { background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
Â  Â  .btn-danger { background: rgba(254, 202, 202, 0.4); color: #dc2626; border: 1px solid rgba(252, 165, 165, 0.5); }
Â  Â  .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 10px; }

Â  Â  /* FILTERS & MULTI-SELECT */
Â  Â  .filter-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
Â  Â  .filter-select { padding: 0 15px; border-radius: 12px; height: 40px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); }
Â  Â  .benchmark-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.5); padding: 0 15px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.6); user-select: none; transition: all 0.2s; }
Â  Â  .benchmark-toggle:hover { background: #fff; }
Â  Â  .benchmark-toggle input { width: 18px; height: 18px; accent-color: #64748b; cursor: pointer; }
Â  Â  .benchmark-toggle span { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }

Â  Â  /* KPI & CHARTS LAYOUT */
Â  Â  .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
Â  Â  .kpi-card { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 20px; height: 130px; justify-content: center; background: rgba(255,255,255,0.55); display: flex; flex-direction: column; }
Â  Â  .kpi-head { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
Â  Â  .kpi-val { font-size: 2.4rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
Â  Â  .kpi-sub { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
Â  Â  .kpi-context { font-size: 0.75rem; color: #64748b; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.05); width: 100%; display: flex; justify-content: space-between; font-weight: 500; }
Â  Â Â 
Â  Â  .chart-card { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; height: 360px; }
Â  Â  .chart-wrapper { position: relative; flex: 1; width: 100%; height: 100%; min-height: 0; overflow: hidden; }
Â  Â  .charts-row-main { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; }
Â  Â  .charts-row-split { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }

Â  Â  /* TABLE */
Â  Â  .table-wrap { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 0; overflow: hidden; display: flex; flex-direction: column; }
Â  Â  table { width: 100%; border-collapse: collapse; min-width: 1000px; }
Â  Â  th { text-align: left; padding: 18px 12px; background: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); }
Â  Â  td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.4); font-size: 0.9rem; vertical-align: middle; font-weight: 500; }
Â  Â  tr:hover td { background: rgba(255,255,255,0.3); }
Â  Â  tr.day-end td { border-bottom: 2px solid rgba(0,0,0,0.1) !important; }

Â  Â  .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; backdrop-filter: blur(4px); }
Â  Â  .badge-summer { background: rgba(255, 237, 213, 0.7); color: #ea580c; border: 1px solid rgba(253, 186, 116, 0.4); }
Â  Â  .badge-std { background: rgba(219, 234, 254, 0.7); color: #2563eb; border: 1px solid rgba(147, 197, 253, 0.4); }
Â  Â  .badge-ok { background: rgba(167, 243, 208, 0.7); color: #065f46; border: 1px solid rgba(16, 185, 129, 0.3); }
Â  Â  .badge-ko { background: rgba(254, 202, 202, 0.7); color: #991b1b; border: 1px solid rgba(239, 68, 68, 0.3); }
Â  Â  .badge-evt { background: rgba(253, 224, 71, 0.7); color: #854d0e; border: 1px solid rgba(250, 204, 21, 0.4); }

Â  Â  .col-detail { color: var(--text-muted); font-size: 0.85rem; text-align: center; }
Â  Â  .col-subtot { font-weight: 700; text-align: center; background: rgba(255,255,255,0.2); }
Â  Â  .col-total { font-weight: 900; color: var(--text-main); text-align: center; font-size: 1.1rem; }
Â  Â  .bg-sub-blue { background-color: rgba(59, 130, 246, 0.05); }
Â  Â  .bg-sub-purp { background-color: rgba(168, 85, 247, 0.05); }

Â  Â  .hidden { display: none !important; }
Â  Â  #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
Â  Â  #login-box { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 40px; text-align: center; width: 400px; display: flex; flex-direction: column; }
Â  Â  .archive-toolbar { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.4); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: var(--glass-border); flex-wrap: wrap; }
Â  Â  .arch-input, .arch-select { height: 36px; padding: 0 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.9); font-size: 0.85rem; color: var(--text-main); font-weight: 600; }
Â  Â  .trend-up { color: #16a34a; } .trend-down { color: #dc2626; }
</style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
Â  Â  <div id="login-box" class="glass-card">
Â  Â  Â  Â  <h2 style="color:var(--text-main); margin-bottom: 25px; font-weight: 900; font-size: 1.5rem;">ğŸ” Accesso</h2>
Â  Â  Â  Â  <div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div>
Â  Â  Â  Â  <div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div>
Â  Â  Â  Â  <button class="btn btn-primary" style="width:100%; font-size:1rem; height:48px;" onclick="doLogin()">Entra nel Gestionale</button>
Â  Â  Â  Â  <p id="login-error" style="color:#dc2626; font-size:0.85rem; margin-top:20px; font-weight:600"></p>
Â  Â  </div>
</div>

<div class="sidebar">
Â  Â  <div class="sidebar-header">ğŸŠâ€â™‚ï¸ Facility Manager</div>
Â  Â  <div class="nav-section-title">Ingressi</div>
Â  Â  <ul class="nav-links"><li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">ğŸ« Nuoto Libero</li></ul>
Â  Â  <div class="nav-section-title" style="margin-top:20px">Impianto</div>
Â  Â  <ul class="nav-links">
Â  Â  Â  Â  <li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')">ğŸ’§ Valori Vasca</li>
Â  Â  Â  Â  <li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')">âš¡ Controllo DAE</li>
Â  Â  Â  Â  <li class="nav-item" id="nav-module-utenze" onclick="switchModule('utenze')">ğŸ“Š Utenze</li>
Â  Â  </ul>
Â  Â  <div class="sidebar-footer">
Â  Â  Â  Â  <div style="font-size:0.85rem; margin-bottom:15px; color:#cbd5e1; font-weight:600" id="user-display">User</div>
Â  Â  Â  Â  <button class="btn" style="width:100%; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-size:0.8rem; height:38px" onclick="doLogout()">Disconnetti</button>
Â  Â  </div>
</div>

<div class="main-content">

<div id="module-ingressi" class="module-container" style="display:flex; flex-direction:column; height:100%">
Â  Â  <div class="control-bar" id="cb-ingressi">
Â  Â  Â  Â  <div class="cb-header">
Â  Â  Â  Â  Â  Â  <span class="cb-title" id="title-ingressi">Registrazione Ingressi</span>
Â  Â  Â  Â  Â  Â  <button class="btn btn-danger hidden" id="cancel-ingressi" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditIngressi()">Annulla Modifica</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="cb-row">
Â  Â  Â  Â  Â  Â  <div class="group-ctx">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.2"><label>Data</label><input type="date" id="i-date"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.3"><label>Tipo Giorno</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="i-type">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="standard">ğŸ¢ Standard</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="festivo">ğŸ”´ Festivo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="evento">ğŸ† Gara/Evento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="maltempo">â›ˆï¸ Maltempo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="extra">âš ï¸ Straordinario</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.5"><label>Fascia</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="i-fascia"><optgroup label="ğŸŠ Vasca Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="â˜€ï¸ Vasca Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.2"><label>Meteo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="i-meteo"><option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option><option value="ğŸ”¥ Sole + Caldo">ğŸ”¥ Sole + Caldo</option><option value="â„ï¸ Sole + Freddo">â„ï¸ Sole + Freddo</option><option value="ğŸŒ¦ï¸ Variabile">ğŸŒ¦ï¸ Variabile</option><option value="ğŸŒ¤ï¸ Parz Nuvoloso">ğŸŒ¤ï¸ Parz Nuvoloso</option><option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option><option value="ğŸŒ¥ï¸ Nuv + Freddo">ğŸŒ¥ï¸ Nuv + Freddo</option><option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option><option value="ğŸŒ¨ï¸ Piog + Freddo">ğŸŒ¨ï¸ Piog + Freddo</option><option value="â›ˆï¸ Temporale">â›ˆï¸ Temporale</option><option value="â“ N/D">â“ N/D</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:0.3; align-items:center; justify-content:center; padding-bottom:8px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="cursor:pointer; display:flex; flex-direction:column; align-items:center; color:#ef4444" title="Escludi">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="i-exclude" style="width:16px; height:16px; accent-color:#ef4444">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.55rem; margin-top:2px; font-weight:800">NO MEDIA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="group-tickets">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>ABB. PER.</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>ABB. 11</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>GRATUITO</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="group-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-save-ingressi" class="btn btn-primary" style="height:44px; min-width:100px" onclick="saveIngressi()">SALVA</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="scroll-area">
Â  Â  Â  Â  <div class="filter-row" style="margin-bottom:20px; justify-content:center">
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button>
Â  Â  Â  Â  Â  Â  <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-stats" onclick="switchSubView('stats')">Statistiche</button>
Â  Â  Â  Â  Â  Â  <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sub-overview">
Â  Â  Â  Â  Â  Â  <div class="filter-row" style="margin-bottom:10px; justify-content:flex-end">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="ov-chart-type" class="filter-select" onchange="renderOverviewCharts()" style="font-weight:700; border:1px solid var(--primary); color:var(--primary)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="line">ğŸ“ˆ Grafico a Linea</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="bar">ğŸ“Š Grafico a Colonne</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="kpi-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card"><div class="kpi-head">Media (Mese)</div><div class="kpi-val" id="ov-avg">0</div><div class="kpi-sub">persone / giorno</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card"><div class="kpi-head">Vs Mese Prec.</div><div class="kpi-val" id="ov-mom">0%</div><div class="kpi-sub" id="ov-mom-label">-</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card"><div class="kpi-head">Vs Anno Prec.</div><div class="kpi-val" id="ov-yoy">0%</div><div class="kpi-sub" id="ov-yoy-label">-</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card"><div class="kpi-head">Stima Fine Mese</div><div class="kpi-val" id="ov-forecast" style="color:#a855f7">-</div><div class="kpi-sub" id="ov-forecast-sub">proiezione</div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card"><div class="chart-header">Andamento Ultimi 30 Giorni vs Anno Prec. (Intelligente)</div><div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div></div>
Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="margin-top:20px"><div class="chart-header">Ultimi 3 Mesi (90 gg)</div><div class="chart-wrapper"><canvas id="chartRecent90"></canvas></div></div>
Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="margin-top:20px"><div class="chart-header">Andamento Ultimi 12 Mesi vs Anno Prec.</div><div class="chart-wrapper"><canvas id="chartRecent12M"></canvas></div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sub-stats" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="filter-row" style="justify-content:space-between; align-items:flex-end; background:rgba(255,255,255,0.4); padding:15px; border-radius:16px; border:var(--glass-border)">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:160px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ModalitÃ  Analisi</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="stat-mode" onchange="toggleStatMode()" style="font-weight:700; border-color:var(--primary); color:var(--primary)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="year">ğŸ“… Anno Intero</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="custom">ğŸ“† Periodo Personalizz.</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" id="stat-year-cont" style="width:100px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Anno</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="stat-year" onchange="renderStats()" style="font-weight:700"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="stat-custom-cont" class="hidden" style="display:flex; gap:10px; align-items:flex-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:130px"><label>Dal</label><input type="date" id="stat-date-start"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:130px"><label>Al</label><input type="date" id="stat-date-end"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="renderStats()" style="height:44px; padding:0 15px; font-size:1.1rem" title="Applica Filtro">ğŸ”</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:180px; position:relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Confronta con</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ms-container" id="ms-compare">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ms-btn" onclick="toggleMsDropdown()">Seleziona... â–¼</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ms-dropdown" id="ms-compare-list"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:140px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Vasca</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="stat-pool-filter" onchange="renderStats()" style="font-weight:700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="all">ğŸŠ Tutte</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="indoor">ğŸ¢ Interna</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="outdoor">â˜€ï¸ Esterna</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="stat-chart-type" class="filter-select" onchange="renderStats()" style="font-weight:700; border:1px solid var(--primary); color:var(--primary)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="line">ğŸ“ˆ Linea</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="bar">ğŸ“Š Colonne</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="day-type-filter" class="filter-select" onchange="renderStats()" style="font-weight:700; border:2px solid #a855f7; color:#6b21a8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="all">ğŸ“… Tutti i Giorni</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="standard">ğŸ¢ Solo Standard</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="special">ğŸ† Solo Eventi/Festivi</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header" id="yoy-title">Andamento Stagionale</div><div class="chart-wrapper"><canvas id="chartYoY"></canvas></div></div></div>
Â  Â  Â  Â  Â  Â  <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header">Performance Settimanale (Per Fascia)</div><div class="chart-wrapper" style="padding:0 15px"><canvas id="chartWeek"></canvas></div></div></div>
Â  Â  Â  Â  Â  Â  <div class="charts-row-split">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="justify-content:center; text-align:center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-header" style="width:100%; text-align:left">Composizione (Periodo Selezionato)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper" style="max-height:220px; display:flex; justify-content:center"><canvas id="chartPie"></canvas></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:auto; width:100%; padding-top:15px; border-top:1px solid rgba(0,0,0,0.05)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; font-weight:700" id="pie-label-text">TOTALE PERIODO</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="deep-total" style="color:var(--primary); font-size:1.8rem; font-weight:900">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card"><div class="chart-header">Performance Meteo</div><div class="chart-wrapper"><canvas id="chartMeteo"></canvas></div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header">PopolaritÃ  Fasce Orarie</div><div class="chart-wrapper"><canvas id="chartFasce"></canvas></div></div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sub-archive" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="archive-toolbar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="arch-group"><span class="arch-label">DA:</span><input type="date" id="arch-date-start" class="arch-input" onchange="renderIngressiArchive()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="arch-group"><span class="arch-label">A:</span><input type="date" id="arch-date-end" class="arch-input" onchange="renderIngressiArchive()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="arch-filter-fascia" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutte le Fasce</option><optgroup label="Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="arch-filter-meteo" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutto il Meteo</option><option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option><option value="ğŸ”¥ Sole + Caldo">ğŸ”¥ Sole + Caldo</option><option value="â„ï¸ Sole + Freddo">â„ï¸ Sole + Freddo</option><option value="ğŸŒ¦ï¸ Variabile">ğŸŒ¦ï¸ Variabile</option><option value="ğŸŒ¤ï¸ Parz Nuvoloso">ğŸŒ¤ï¸ Parz Nuvoloso</option><option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option><option value="ğŸŒ¥ï¸ Nuv + Freddo">ğŸŒ¥ï¸ Nuv + Freddo</option><option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option><option value="ğŸŒ¨ï¸ Piog + Freddo">ğŸŒ¨ï¸ Piog + Freddo</option><option value="â›ˆï¸ Temporale">â›ˆï¸ Temporale</option><option value="â“ N/D">â“ N/D</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="arch-sort" class="arch-select" style="min-width:100px" onchange="renderIngressiArchive()"><option value="desc">â¬‡ï¸ Recenti</option><option value="asc">â¬†ï¸ Vecchi</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" style="height:36px; width:36px; padding:0" onclick="resetArchiveFilters()">âœ•</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" style="height:36px; font-size:0.8rem; padding:0 20px" onclick="downloadCSV()">Scarica Excel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="table-wrap glass-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="overflow-x:auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="table-ingressi"><thead><tr><th>Data</th><th>Fascia / Meteo</th><th>Int.</th><th>Rid.</th><th>Singoli</th><th>Per.</th><th>11 Ingr.</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-ingressi"></tbody></table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="module-vasca" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
Â  Â  <div class="control-bar" id="cb-vasca">
Â  Â  Â  Â  <div class="cb-header"><span class="cb-title" id="title-vasca">Registrazione Valori Vasca</span><button class="btn btn-danger hidden" id="cancel-vasca" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditVasca()">Annulla Modifica</button></div>
Â  Â  Â  Â  <div class="cb-row">
Â  Â  Â  Â  Â  Â  <div class="group-ctx" style="flex:1.2; align-items:flex-end; gap:10px">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1"><label>Data</label><input type="date" id="v-date"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:0.8"><label>Orario</label><input type="time" id="v-time"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.2"><label>Vasca</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="v-type">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="interna">ğŸ  Interna</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="esterna">â˜€ï¸ Esterna</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="group-chem" style="flex:2">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>BAGNANTI</label><input type="number" id="v-bag" value="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>T. ARIA</label><input type="number" step="0.1" id="v-ta" value="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>T. H2O</label><input type="number" step="0.1" id="v-th" value="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>CL LIB.</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>CL COMB.</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t-box"><label>CL TOT.</label><input type="number" step="0.1" id="v-clt" value="0"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="group-actions"><button id="btn-save-vasca" class="btn btn-primary" style="height:44px; min-width:120px" onclick="saveVasca()">SALVA</button></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="scroll-area">
Â  Â  Â  Â  <h2 class="page-title">ğŸ’§ Diario Vasca</h2>
Â  Â  Â  Â  <div class="table-wrap glass-card"><div style="overflow-x:auto;"><table id="table-vasca"><thead><tr><th>Data</th><th>Ora / Vasca</th><th>Bagnanti</th><th>T. Aria</th><th>T. Acqua</th><th>pH</th><th>Cl Lib</th><th>Cl Comb</th><th>Cl Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-vasca"></tbody></table></div></div>
Â  Â  </div>
</div>

<div id="module-dae" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
Â  Â  <div class="control-bar">
Â  Â  Â  Â  <div class="cb-header"><span class="cb-title">Controllo Defibrillatore (DAE)</span></div>
Â  Â  Â  Â  <div class="cb-row">
Â  Â  Â  Â  Â  Â  <div class="group-ctx">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:0.5"><label>Data</label><input type="date" id="d-date" class="inp-locked" readonly></div><div class="inp-field" style="flex:0.5"><label>Ora Controllo</label><input type="text" id="d-time" class="inp-locked" readonly></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:0.8"><label>Stato</label><select id="d-status"><option value="OK">âœ… Funzionante</option><option value="GUASTO">âŒ Guasto / Anomalie</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1"><label>Assistente Bagnanti</label><input type="text" id="d-ass" placeholder="Nome Cognome"></div><div class="inp-field" style="flex:1"><label>Operatore Segreteria</label><input type="text" id="d-op" placeholder="Nome Cognome"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="group-actions"><button class="btn btn-primary" style="height:44px; min-width:120px" onclick="saveDae()">REGISTRA</button></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="scroll-area">
Â  Â  Â  Â  <h2 class="page-title">âš¡ Registro Controlli DAE</h2>
Â  Â  Â  Â  <div class="table-wrap glass-card"><div style="overflow-x:auto;"><table id="table-dae"><thead><tr><th>Data</th><th>Ora</th><th>Stato</th><th>Assistente Bagnanti</th><th>Operatore Segreteria</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-dae"></tbody></table></div></div>
Â  Â  </div>
</div>

<div id="module-utenze" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
Â  Â  <div class="control-bar" id="cb-utenze">
Â  Â  Â  Â  <div class="cb-header">
Â  Â  Â  Â  Â  Â  <span class="cb-title" id="title-utenze">Registrazione Letture Utenze</span>
Â  Â  Â  Â  Â  Â  <button class="btn btn-danger hidden" id="cancel-utenze" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditUtenze()">Annulla Modifica</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="cb-row">
Â  Â  Â  Â  Â  Â  <div class="inp-field" style="width:140px; flex:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Data</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="u-date">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Tipo Utenza</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="u-type" onchange="toggleUtenzeMode()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="âš¡ ElettricitÃ ">âš¡ ElettricitÃ </option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ğŸ’§ Acqua">ğŸ’§ Acqua (mÂ³)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ğŸ”¥ Gas Metano">ğŸ”¥ Gas Metano (mÂ³)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="u-extra-elec-meteo" class="inp-field hidden" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Meteo Giornata</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="u-meteo">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="â˜€ï¸ Sole">â˜€ï¸ Sole</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="â›… Variabile">â›… Variabile</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="â˜ï¸ Nuvoloso">â˜ï¸ Nuvoloso</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ğŸŒ§ï¸ Pioggia">ğŸŒ§ï¸ Pioggia</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="u-elec-input" style="display:contents;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>A1 (F1)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="u-a1" step="any">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>A2 (F2)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="u-a2" step="any">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>A3 (F3)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="u-a3" step="any">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="u-single-input" class="inp-field hidden" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Lettura Contatore</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="u-val" placeholder="Es. 12500" step="any">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="u-extra-gas" class="inp-field hidden" style="width:100px; flex:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Temp. (Â°C)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="u-temp" placeholder="Â°C" step="0.1">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="inp-field" style="flex:1.5;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Note</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="u-note" placeholder="Opzionale...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="width:120px; flex:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-save-utenze" class="btn btn-primary" style="height:44px; width:100%" onclick="saveUtenze()">SALVA</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="scroll-area">
Â  Â  Â  Â  <div class="filter-row" style="margin-bottom:20px; justify-content:center">
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" id="btn-sub-u-overview" onclick="switchSubViewUtenze('overview')">Panoramica</button>
Â  Â  Â  Â  Â  Â  <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-u-charts" onclick="switchSubViewUtenze('charts')">Grafici</button>
Â  Â  Â  Â  Â  Â  <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-u-archive" onclick="switchSubViewUtenze('archive')">Archivio</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Utenze Sub-View: Overview (KPI) -->
Â  Â  Â  Â  <div id="sub-u-overview">
Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin:0; font-size:1.1rem; color:var(--text-main)">ğŸ“… Confronto Mensile</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="month" id="u-kpi-month-selector" class="filter-select" style="font-weight:700; background:rgba(255,255,255,0.8)" onchange="renderUtenze()">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 25px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card" style="border-left: 4px solid #eab308">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-head" id="u-kpi-elec-title">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-val" id="u-kpi-elec-val">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-sub" id="u-kpi-elec-sub">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-context" id="u-kpi-elec-context"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card" style="border-left: 4px solid #3b82f6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-head" id="u-kpi-water-title">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-val" id="u-kpi-water-val">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-sub" id="u-kpi-water-sub">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-context" id="u-kpi-water-context"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card glass-card" style="border-left: 4px solid #ef4444">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-head" id="u-kpi-gas-title">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-val" id="u-kpi-gas-val">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-sub" id="u-kpi-gas-sub">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-context" id="u-kpi-gas-context"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Utenze Sub-View: Charts -->
Â  Â  Â  Â  <div id="sub-u-charts" class="hidden">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="page-title" style="margin:0; font-size:1.3rem">ğŸ“Š Analisi Utenze</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; align-items:center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="u-range" class="filter-select" onchange="renderUtenze()" style="font-weight:700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="7">Ultimi 7 Giorni</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="15">Ultimi 15 Giorni</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="30">Ultimi 30 Giorni</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="90">Ultimi 3 Mesi</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="180">Ultimi 6 Mesi</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="365">Ultimi 12 Mesi</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="u-view-mode" class="filter-select" onchange="renderUtenze()" style="border:2px solid var(--primary); color:var(--primary); font-weight:700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="delta">ğŸ“Š Consumo (Delta)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="total">ğŸ“ˆ Lettura (Totale)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="benchmark-toggle" style="height:40px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="u-compare-year" onchange="renderUtenze()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8rem">Confronta Anno Prec.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="display:flex; flex-direction:column; gap:25px; margin-bottom:25px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="height:300px; padding:15px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-header" style="font-size:0.85rem; color:#eab308">âš¡ ElettricitÃ  (kWh)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper"><canvas id="chartElec"></canvas></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="height:300px; padding:15px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-header" style="font-size:0.85rem; color:#3b82f6">ğŸ’§ Acqua (mÂ³)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper"><canvas id="chartWater"></canvas></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-card glass-card" style="height:300px; padding:15px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-header" style="font-size:0.85rem; color:#ef4444">ğŸ”¥ Gas (mÂ³)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper"><canvas id="chartGas"></canvas></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Utenze Sub-View: Archive -->
Â  Â  Â  Â  <div id="sub-u-archive" class="hidden">
Â  Â  Â  Â  Â  Â  <h2 class="page-title">ğŸ“ Storico Dettagliato</h2>
Â  Â  Â  Â  Â  Â  <div class="archive-toolbar" style="margin-bottom: 15px; background: rgba(255,255,255,0.5);">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="arch-group"><span class="arch-label">Dal:</span><input type="date" id="u-hist-start" class="arch-input" onchange="renderUtenze()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="arch-group"><span class="arch-label">Al:</span><input type="date" id="u-hist-end" class="arch-input" onchange="renderUtenze()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="u-hist-sort" class="arch-select" onchange="renderUtenze()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="desc">â¬‡ï¸ PiÃ¹ Recenti</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="asc">â¬†ï¸ PiÃ¹ Vecchi</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" style="height:36px; padding:0 15px" onclick="resetUtenzeHistory()">âœ•</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="table-wrap glass-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="overflow-x:auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="table-utenze">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Data</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:#eab308; background:rgba(234, 179, 8, 0.1)">âš¡ Lettura Totale</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:#eab308; background:rgba(234, 179, 8, 0.1)">F1 / F2 / F3</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:#3b82f6; background:rgba(59, 130, 246, 0.1)">ğŸ’§ Lettura Acqua</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:#ef4444; background:rgba(239, 68, 68, 0.1)">ğŸ”¥ Lettura Gas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Note</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-utenze"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" };
const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
let dataIngressi=[], dataVasca=[], dataDae=[], dataUtenze=[]; let editIdIngressi=null, editIdVasca=null, editIdUtenze=null;
const isChartReady = () => typeof Chart !== 'undefined';

const FESTIVITA_FISSE = ["01-01", "06-01", "25-04", "01-05", "02-06", "15-08", "01-11", "08-12", "25-12", "26-12"];
function getDataConfronto(dataCorrente) {
Â  Â  const m = String(dataCorrente.getMonth() + 1).padStart(2, '0');
Â  Â  const d = String(dataCorrente.getDate()).padStart(2, '0');
Â  Â  const chiaveData = `${d}-${m}`;
Â  Â  const dataAnnoPrec = new Date(dataCorrente);
Â  Â  if (FESTIVITA_FISSE.includes(chiaveData)) { dataAnnoPrec.setFullYear(dataCorrente.getFullYear() - 1); }
Â  Â  else { dataAnnoPrec.setDate(dataCorrente.getDate() - 364); }
Â  Â  return dataAnnoPrec;
}

// HELPERS DATE FIX - BULLETPROOF
function getStrDate(d) {
Â  Â  const year = d.getFullYear();
Â  Â  const month = String(d.getMonth() + 1).padStart(2, '0');
Â  Â  const day = String(d.getDate()).padStart(2, '0');
Â  Â  return `${year}-${month}-${day}`;
}

window.showToast = (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className = `toast toast-${type}`; e.innerHTML = `<span>${type==='success'?'âœ…':'âš ï¸'}</span> ${msg}`; c.appendChild(e); requestAnimationFrame(()=>e.classList.add('show')); setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); };
window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('login-error').innerText = e.message; } };
window.doLogout = () => signOut(auth);
onAuthStateChanged(auth, (u) => { if(u){ document.getElementById('login-screen').classList.add('hidden'); document.getElementById('user-display').innerText=u.email.split('@')[0]; startListening(); } else { document.getElementById('login-screen').classList.remove('hidden'); } });

function startListening() {
Â  Â  try {
Â  Â  Â  Â  // IMPORTANT: Listeners must populate data arrays before calling init functions
Â  Â  Â  Â  onSnapshot(query(collection(db, "sessioni"), orderBy("date", "desc"), limit(2000)), (snap) => {Â 
Â  Â  Â  Â  Â  Â  dataIngressi = snap.docs.map(d=>({id:d.id,...d.data()}));Â 
Â  Â  Â  Â  Â  Â  populateStatFilters();Â 
Â  Â  Â  Â  Â  Â  refreshCurrentView();
Â  Â  Â  Â  Â  Â  if(dataUtenze.length > 0) renderUtenze(); // Re-render Utenze if ingressi arrive later
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  onSnapshot(query(collection(db, "valori_vasca"), orderBy("date", "desc"), limit(500)), (snap) => {Â 
Â  Â  Â  Â  Â  Â  dataVasca = snap.docs.map(d=>({id:d.id,...d.data()}));Â 
Â  Â  Â  Â  Â  Â  if(!document.getElementById('module-vasca').classList.contains('hidden')) renderVasca();Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  onSnapshot(query(collection(db, "dae_log"), orderBy("date", "desc"), limit(200)), (snap) => {Â 
Â  Â  Â  Â  Â  Â  dataDae = snap.docs.map(d=>({id:d.id,...d.data()}));Â 
Â  Â  Â  Â  Â  Â  if(!document.getElementById('module-dae').classList.contains('hidden')) renderDae();Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  onSnapshot(query(collection(db, "utenze_log"), orderBy("date", "desc"), limit(4000)), (snap) => {Â 
Â  Â  Â  Â  Â  Â  dataUtenze = snap.docs.map(d=>({id:d.id,...d.data()}));Â 
Â  Â  Â  Â  Â  Â  if(!document.getElementById('module-utenze').classList.contains('hidden')) renderUtenze();Â 
Â  Â  Â  Â  });
Â  Â  } catch(e) { console.error(e); }
}

window.populateStatFilters = () => {
Â  Â  if(!dataIngressi.length) return;
Â  Â  const years = [...new Set(dataIngressi.map(d => new Date(d.date).getFullYear()))].sort().reverse();
Â  Â  const yearSel = document.getElementById('stat-year');
Â  Â  // Multi-Select Logic (Replacing <select>)
Â  Â  const msList = document.getElementById('ms-compare-list');
Â  Â  msList.innerHTML = `<div class="ms-option"><input type="checkbox" value="avg" checked onchange="renderStats()"><span>ğŸ“Š Media Storica</span></div>`;
Â  Â  years.forEach(y => {
Â  Â  Â  Â  msList.innerHTML += `<div class="ms-option"><input type="checkbox" value="${y}" onchange="renderStats()"><span>${y}</span></div>`;
Â  Â  });

Â  Â  const currYear = yearSel.value;
Â  Â  const todayYear = new Date().getFullYear();
Â  Â  if(!currYear) yearSel.value = years.includes(todayYear) ? todayYear : years[0];
Â  Â  renderStats();
};

window.toggleMsDropdown = () => {
Â  Â  document.getElementById('ms-compare-list').classList.toggle('show');
};

// Close dropdown when clicking outside
window.addEventListener('click', (e) => {
Â  Â  if (!e.target.closest('.ms-container')) {
Â  Â  Â  Â  document.getElementById('ms-compare-list').classList.remove('show');
Â  Â  }
});

window.toggleStatMode = () => {
Â  Â  const mode = document.getElementById('stat-mode').value;
Â  Â  const yCont = document.getElementById('stat-year-cont');
Â  Â  const cCont = document.getElementById('stat-custom-cont');
Â  Â  if(mode === 'year') {
Â  Â  Â  Â  yCont.classList.remove('hidden');
Â  Â  Â  Â  cCont.classList.add('hidden');
Â  Â  } else {
Â  Â  Â  Â  yCont.classList.add('hidden');
Â  Â  Â  Â  cCont.classList.remove('hidden');
Â  Â  Â  Â  cCont.style.display = 'flex';
Â  Â  Â  Â  if(!document.getElementById('stat-date-start').value) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('stat-date-start').value = firstDay;
Â  Â  Â  Â  Â  Â  document.getElementById('stat-date-end').value = lastDay;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  renderStats();
};

let ch={};
function renderDynamicChart(id, labels, datasets, type, isStacked=false) {
Â  Â  if(!isChartReady()) return;
Â  Â  if(ch[id]) ch[id].destroy();
Â  Â Â 
Â  Â  const scalesConfig = {Â 
Â  Â  Â  Â  y: { beginAtZero: type==='bar', stacked: isStacked },
Â  Â  Â  Â  x: { stacked: isStacked }
Â  Â  };

Â  Â  const isBar = type === 'bar';
Â  Â  const optimizedDatasets = datasets.map(d => ({
Â  Â  Â  Â  ...d,
Â  Â  Â  Â  backgroundColor: d.backgroundColor ? d.backgroundColor : (isBar ? '#2563eb' : (d.fill ? d.borderColor + '20' : undefined)),
Â  Â  Â  Â  borderWidth: isBar ? 0 : 2,
Â  Â  Â  Â  pointRadius: isBar ? 0 : 3,
Â  Â  Â  Â  type: d.type || type,Â 
Â  Â  Â  Â  borderDash: isBar ? [] : (d.borderDash || []),
Â  Â  Â  Â  tension: 0.4,
Â  Â  Â  Â  parsing: { yAxisKey: 'y' }
Â  Â  }));

Â  Â  ch[id] = new Chart(document.getElementById(id), {
Â  Â  Â  Â  type: type,
Â  Â  Â  Â  data: { labels: labels, datasets: optimizedDatasets },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  animation: false,
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  interaction: { mode: 'index', intersect: false },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: true },
Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(15, 23, 42, 0.95)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding: 12,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cornerRadius: 8,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleFont: { size: 13 },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodyFont: { size: 13, weight: 'bold' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  afterBody: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const punto = context.find(c => c.raw);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!punto) return [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (punto.raw.refDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dRef = new Date(punto.raw.refDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dStr = dRef.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return ['', '------------------', `Confrontato con:\n${dStr}`];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (punto.raw.extraInfo) return ['', `ğŸ“ ${punto.raw.extraInfo}`];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  layout: { padding: 25 },
Â  Â  Â  Â  Â  Â  scales: scalesConfig
Â  Â  Â  Â  }
Â  Â  });
}
function renderPie(id,l,d) { if(!isChartReady()) return; if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'doughnut',data:{labels:l,datasets:[{data:d,backgroundColor:['#2563eb','#60a5fa','#a855f7','#d8b4fe','#f59e0b','#ef4444'],borderWidth:0}]},options:{animation:false, responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{usePointStyle:true}}}}}); }
function renderMultiBar(id,l,ds,ax='x') { if(!isChartReady()) return; if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels:l,datasets:ds},options:{animation:false, responsive:true,maintainAspectRatio:false,indexAxis:ax,plugins:{legend:{display:true}}}}); }

window.renderOverview = () => { renderOverviewKPI(); renderOverviewCharts(); }
function renderOverviewKPI() {
Â  Â  if(!dataIngressi || dataIngressi.length === 0) return;
Â  Â  const today = new Date();
Â  Â  const currentMonthStr = today.toISOString().slice(0, 7);
Â  Â  const pm = new Date(today.getFullYear(), today.getMonth() - 1, 1);
Â  Â  const prevMonthStr = `${pm.getFullYear()}-${String(pm.getMonth()+1).padStart(2,'0')}`;
Â  Â  const ym = new Date(today.getFullYear() - 1, today.getMonth(), 1);
Â  Â  const yoyStr = `${ym.getFullYear()}-${String(ym.getMonth()+1).padStart(2,'0')}`;
Â  Â  const dCurrent = dataIngressi.filter(x => x.date.startsWith(currentMonthStr) && !x.excludeStats && x.totale > 0);
Â  Â  const totalCurrent = dCurrent.reduce((a,b)=>a+b.totale,0);
Â  Â  const daysCurrent = new Set(dCurrent.map(x=>x.date)).size;

Â  Â  document.getElementById('ov-avg').innerText = daysCurrent > 0 ? (totalCurrent/daysCurrent).toFixed(0) : 0;
Â  Â Â 
Â  Â  // FIX: Compare up to the same day number
Â  Â  const maxDay = today.getDate();
Â  Â  const pm_month_name = pm.toLocaleString('it-IT',{month:'long'});
Â  Â  const ym_year = ym.getFullYear();

Â  Â  const dPrev = dataIngressi.filter(x => {
Â  Â  Â  Â  return x.date.startsWith(prevMonthStr) && !x.excludeStats && x.totale > 0 && new Date(x.date).getDate() <= maxDay;
Â  Â  });
Â  Â  const totalPrev = dPrev.reduce((a,b)=>a+b.totale,0);
Â  Â Â 
Â  Â  let momHtml = "";
Â  Â  if (dPrev.length > 0) {
Â  Â  Â  Â  let diff = 0;
Â  Â  Â  Â  if (totalPrev > 0) diff = ((totalCurrent - totalPrev) / totalPrev) * 100;
Â  Â  Â  Â  else if (totalCurrent > 0) diff = 100;
Â  Â  Â  Â  const color = diff >= 0 ? "#16a34a" : "#dc2626";
Â  Â  Â  Â  const sign = diff > 0 ? "+" : "";
Â  Â  Â  Â  momHtml = `<span style="color:${color}">${sign}${diff.toFixed(1)}%</span>`;
Â  Â  } else { momHtml = `<span style="color:#94a3b8; font-size:1.5rem">N/D</span>`; }
Â  Â  document.getElementById('ov-mom').innerHTML = momHtml;
Â  Â  document.getElementById('ov-mom-label').innerText = `vs ${pm_month_name} (al ${maxDay})`;

Â  Â  const dYoy = dataIngressi.filter(x => {
Â  Â  Â  Â  return x.date.startsWith(yoyStr) && !x.excludeStats && x.totale > 0 && new Date(x.date).getDate() <= maxDay;
Â  Â  });
Â  Â  const totalYoy = dYoy.reduce((a,b)=>a+b.totale,0);
Â  Â Â 
Â  Â  let yoyHtml = "";
Â  Â  if (dYoy.length > 0) {
Â  Â  Â  Â  let diff = 0;
Â  Â  Â  Â  if (totalYoy > 0) diff = ((totalCurrent - totalYoy) / totalYoy) * 100;
Â  Â  Â  Â  else if (totalCurrent > 0) diff = 100;
Â  Â  Â  Â  const color = diff >= 0 ? "#16a34a" : "#dc2626";
Â  Â  Â  Â  const sign = diff > 0 ? "+" : "";
Â  Â  Â  Â  yoyHtml = `<span style="color:${color}">${sign}${diff.toFixed(1)}%</span>`;
Â  Â  } else { yoyHtml = `<span style="color:#94a3b8; font-size:1.5rem">N/D</span>`; }
Â  Â  document.getElementById('ov-yoy').innerHTML = yoyHtml;
Â  Â  document.getElementById('ov-yoy-label').innerText = `vs ${ym_year} (al ${maxDay})`;

Â  Â  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
Â  Â  if(daysCurrent > 0) {Â 
Â  Â  Â  Â  document.getElementById('ov-forecast').innerText = ((totalCurrent / daysCurrent) * daysInMonth).toFixed(0);Â 
Â  Â  Â  Â  document.getElementById('ov-forecast-sub').innerText = "proiezione (su giorni aperti)";
Â  Â  } else { document.getElementById('ov-forecast').innerText = "-"; }
}

window.renderOverviewCharts = () => {
Â  Â  if(!dataIngressi || dataIngressi.length === 0 || !isChartReady()) return;
Â  Â  const chartType = document.getElementById('ov-chart-type').value;
Â  Â  const today = new Date();
Â  Â  const dates=[], l30=[], l30_prev=[];
Â  Â  for(let i=29; i>=0; i--) {
Â  Â  Â  Â  const dt=new Date(); dt.setDate(today.getDate()-i); const dtStr=getStrDate(dt);
Â  Â  Â  Â  dates.push(`${dt.toLocaleDateString('it-IT',{weekday:'short'})} ${dt.getDate()}/${dt.getMonth()+1}`);
Â  Â  Â  Â  const dtPrev = getDataConfronto(dt);
Â  Â  Â  Â  const dtPrevStr = getStrDate(dtPrev);
Â  Â  Â  Â  const valOggi = dataIngressi.filter(x=>x.date===dtStr && !x.excludeStats).reduce((a,b)=>a+b.totale,0);
Â  Â  Â  Â  l30.push({ x: dates[dates.length-1], y: valOggi, refDate: dtPrevStr });
Â  Â  Â  Â  l30_prev.push(dataIngressi.filter(x=>x.date===dtPrevStr && !x.excludeStats).reduce((a,b)=>a+b.totale,0));
Â  Â  }
Â  Â Â 
Â  Â  const bgMain = chartType === 'bar' ? '#2563eb' : 'rgba(37, 99, 235, 0.1)';
Â  Â  const bgComp = chartType === 'bar' ? '#cbd5e1' : 'rgba(148, 163, 184, 0.05)';

Â  Â  renderDynamicChart('chartRecent30', dates, [
Â  Â  Â  Â  {label:'Ultimi 30gg', data:l30, borderColor:'#2563eb', backgroundColor:bgMain, fill:true},
Â  Â  Â  Â  {label:'Anno Prec.', data:l30_prev, borderColor:'#94a3b8', backgroundColor:bgComp, borderDash:[5,5], fill:false}
Â  Â  ], chartType);
Â  Â Â 
Â  Â  // 90 DAYS CHART
Â  Â  const dates90=[], l90=[], l90_prev=[];
Â  Â  for(let i=89; i>=0; i--) {
Â  Â  Â  Â  const dt=new Date(); dt.setDate(today.getDate()-i); const dtStr=getStrDate(dt);
Â  Â  Â  Â  dates90.push(`${dt.getDate()}/${dt.getMonth()+1}`);
Â  Â  Â  Â  const dtPrev = getDataConfronto(dt);
Â  Â  Â  Â  const dtPrevStr = getStrDate(dtPrev);
Â  Â  Â  Â  const valOggi = dataIngressi.filter(x=>x.date===dtStr && !x.excludeStats).reduce((a,b)=>a+b.totale,0);
Â  Â  Â  Â  l90.push({ x: dates90[dates90.length-1], y: valOggi, refDate: dtPrevStr });
Â  Â  Â  Â  l90_prev.push(dataIngressi.filter(x=>x.date===dtPrevStr && !x.excludeStats).reduce((a,b)=>a+b.totale,0));
Â  Â  }
Â  Â  renderDynamicChart('chartRecent90', dates90, [
Â  Â  Â  Â  {label:'Ultimi 90gg', data:l90, borderColor:'#2563eb', backgroundColor:bgMain, fill:true},
Â  Â  Â  Â  {label:'Anno Prec.', data:l90_prev, borderColor:'#94a3b8', backgroundColor:bgComp, borderDash:[5,5], fill:false}
Â  Â  ], chartType);


Â  Â  const m12=[], m12_prev=[], m_labels=[];
Â  Â  for(let i=11; i>=0; i--) {
Â  Â  Â  Â  const d=new Date(today.getFullYear(), today.getMonth()-i, 1); m_labels.push(d.toLocaleString('it-IT',{month:'short'}));
Â  Â  Â  Â  m12.push(dataIngressi.filter(x=>{const xd=new Date(x.date); return xd.getMonth()===d.getMonth() && xd.getFullYear()===d.getFullYear() && !x.excludeStats}).reduce((a,b)=>a+b.totale,0));
Â  Â  Â  Â  m12_prev.push(dataIngressi.filter(x=>{const xd=new Date(x.date); return xd.getMonth()===d.getMonth() && xd.getFullYear()===(d.getFullYear()-1) && !x.excludeStats}).reduce((a,b)=>a+b.totale,0));
Â  Â  }
Â  Â  renderDynamicChart('chartRecent12M', m_labels, [{label:'Ultimi 12M', data:m12, borderColor:'#2563eb', backgroundColor:bgMain, fill:true},{label:'12M Prec.', data:m12_prev, borderColor:'#94a3b8', backgroundColor:bgComp, borderDash:[5,5], fill:false}], chartType);
}

// HELPERS FOR MULTI COMPARE COLORS
const getCompColor = (idx) => {
Â  Â  const colors = ['#94a3b8', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
Â  Â  return colors[idx % colors.length];
};

const getFasciaColor = (f) => {
Â  Â  const map = {
Â  Â  Â  Â  "Mattina": "#60a5fa", "Mattina intera": "#3b82f6", "Pranzo": "#f59e0b",
Â  Â  Â  Â  "Sera": "#1e40af", "Sabato pom": "#8b5cf6", "Domenica": "#ec4899",
Â  Â  Â  Â  "Festivo": "#ef4444", "Unico": "#10b981",
Â  Â  Â  Â  "Estiva - Mattina": "#fcd34d", "Estiva - Pomeriggio": "#f97316", "Estiva - Unico": "#facc15"
Â  Â  };
Â  Â  return map[f] || "#94a3b8";
};

window.renderStats = () => {
Â  Â  if(!dataIngressi.length) return;
Â  Â  const mode = document.getElementById('stat-mode').value;
Â  Â Â 
Â  Â  // GET SELECTED COMPARISONS
Â  Â  const compInputs = document.querySelectorAll('#ms-compare-list input:checked');
Â  Â  const selectedComps = Array.from(compInputs).map(i => i.value);

Â  Â  const poolFilter = document.getElementById('stat-pool-filter').value;
Â  Â  const dayTypeFilter = document.getElementById('day-type-filter').value;
Â  Â  const chartType = document.getElementById('stat-chart-type').value;

Â  Â  let startDate, endDate, yearMain;
Â  Â  if(mode === 'year') {
Â  Â  Â  Â  yearMain = parseInt(document.getElementById('stat-year').value) || new Date().getFullYear(); // Safe Default
Â  Â  Â  Â  startDate = new Date(yearMain, 0, 1);
Â  Â  Â  Â  endDate = new Date(yearMain, 11, 31);
Â  Â  } else {
Â  Â  Â  Â  const sVal = document.getElementById('stat-date-start').value;
Â  Â  Â  Â  const eVal = document.getElementById('stat-date-end').value;
Â  Â  Â  Â  if(!sVal || !eVal) return;
Â  Â  Â  Â  startDate = new Date(sVal);
Â  Â  Â  Â  endDate = new Date(eVal);
Â  Â  Â  Â  yearMain = startDate.getFullYear();Â 
Â  Â  }

Â  Â  const filteredSource = dataIngressi.filter(d => {
Â  Â  Â  Â  if(d.excludeStats) return false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const isOutdoor = (d.fascia && d.fascia.includes('Estiva'));
Â  Â  Â  Â  if(poolFilter === 'indoor' && isOutdoor) return false;
Â  Â  Â  Â  if(poolFilter === 'outdoor' && !isOutdoor) return false;
Â  Â  Â  Â  if(dayTypeFilter === 'standard' && d.type !== 'standard') return false;
Â  Â  Â  Â  if(dayTypeFilter === 'special' && d.type === 'standard') return false;
Â  Â  Â  Â  return true;
Â  Â  });

Â  Â  const dataMap = {};
Â  Â  filteredSource.forEach(d => {
Â  Â  Â  Â  if(!dataMap[d.date]) dataMap[d.date] = [];
Â  Â  Â  Â  dataMap[d.date].push(d);
Â  Â  });

Â  Â  // BUILD MAIN DATASET
Â  Â  let fMain = [];
Â  Â  for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) {
Â  Â  Â  Â  const k = getStrDate(d);
Â  Â  Â  Â  if(dataMap[k]) fMain = fMain.concat(dataMap[k]);
Â  Â  }
Â  Â Â 
Â  Â  document.getElementById('deep-total').innerText = fMain.reduce((a,b)=>a+b.totale,0).toLocaleString();
Â  Â  if(!isChartReady()) return;

Â  Â  // COLOR LOGIC
Â  Â  const isBar = chartType === 'bar';
Â  Â  const bgMain = isBar ? '#2563eb' : 'rgba(37, 99, 235, 0.1)';

Â  Â  // --- CHART YOY ---
Â  Â  let labels = [];
Â  Â  let mainData = [];
Â  Â Â 
Â  Â  const today = new Date();
Â  Â  const currentMonth = today.getMonth();
Â  Â  const currentDay = today.getDate();
Â  Â  const isCurrentYear = (yearMain === today.getFullYear());

Â  Â  if(mode === 'year') {
Â  Â  Â  Â  labels = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
Â  Â  Â  Â  mainData = new Array(12).fill(0);
Â  Â  Â  Â  fMain.forEach(d => { mainData[new Date(d.date).getMonth()] += d.totale; });
Â  Â  Â  Â  document.getElementById('yoy-title').innerText = `Andamento Stagionale (${yearMain})`;
Â  Â  } else {
Â  Â  Â  Â  const days = [];
Â  Â  Â  Â  for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) {
Â  Â  Â  Â  Â  Â  days.push(new Date(d));
Â  Â  Â  Â  Â  Â  labels.push(d.toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit'}));
Â  Â  Â  Â  }
Â  Â  Â  Â  days.forEach(d => {
Â  Â  Â  Â  Â  Â  const k = getStrDate(d);
Â  Â  Â  Â  Â  Â  const val = dataMap[k] ? dataMap[k].reduce((a,b)=>a+b.totale, 0) : 0;
Â  Â  Â  Â  Â  Â  mainData.push(val);
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('yoy-title').innerText = `Andamento Periodo (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;
Â  Â  }

Â  Â  const datasets = [{ label: mode==='year' ? `Anno ${yearMain}` : 'Periodo Selezionato', data: mainData, borderColor: '#2563eb', backgroundColor: bgMain, tension: 0.4, fill: true }];

Â  Â  // LOOP THROUGH COMPARISONS
Â  Â  selectedComps.forEach((compVal, idx) => {
Â  Â  Â  Â  let compData = [];
Â  Â  Â  Â  let compLabel = compVal === 'avg' ? 'Media Storica' : `Anno ${compVal}`;
Â  Â  Â  Â  let col = getCompColor(idx);
Â  Â  Â  Â  let bgCol = isBar ? col : 'transparent';Â 

Â  Â  Â  Â  if(mode === 'year') {
Â  Â  Â  Â  Â  Â  for(let m=0; m<12; m++) {
Â  Â  Â  Â  Â  Â  Â  Â  let sum=0, count=0;
Â  Â  Â  Â  Â  Â  Â  Â  const limitDay = (isCurrentYear && m === currentMonth) ? currentDay : 32;

Â  Â  Â  Â  Â  Â  Â  Â  if(compVal === 'avg') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const allYears = [...new Set(filteredSource.map(d=>new Date(d.date).getFullYear()))].filter(y => y !== yearMain);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allYears.forEach(y => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = filteredSource.filter(d => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dd = new Date(d.date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return dd.getFullYear() === y && dd.getMonth() === m && dd.getDate() <= limitDay;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).reduce((a,b)=>a+b.totale,0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(val > 0) { sum += val; count++; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y = parseInt(compVal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sum = filteredSource.filter(d => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dd = new Date(d.date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return dd.getFullYear() === y && dd.getMonth() === m && dd.getDate() <= limitDay;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).reduce((a,b)=>a+b.totale,0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count = 1;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  compData.push(count>0 ? sum/count : 0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // CUSTOM RANGE LOGIC
Â  Â  Â  Â  Â  Â  const days = [];
Â  Â  Â  Â  Â  Â  for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) days.push(new Date(d));

Â  Â  Â  Â  Â  Â  // Build Hist Map
Â  Â  Â  Â  Â  Â  const histMap = {};Â 
Â  Â  Â  Â  Â  Â  filteredSource.forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  const dDate = new Date(d.date);
Â  Â  Â  Â  Â  Â  Â  Â  if(dDate.getFullYear() === yearMain) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const k = `${dDate.getMonth()}-${dDate.getDate()}`;
Â  Â  Â  Â  Â  Â  Â  Â  if(!histMap[k]) histMap[k] = [];
Â  Â  Â  Â  Â  Â  Â  Â  histMap[k].push(d);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  days.forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  const month = d.getMonth();
Â  Â  Â  Â  Â  Â  Â  Â  const day = d.getDate();
Â  Â  Â  Â  Â  Â  Â  Â  const k = `${month}-${day}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(compVal === 'avg') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let sum = 0, count = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(histMap[k]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const yearsInDay = [...new Set(histMap[k].map(x=>new Date(x.date).getFullYear()))];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yearsInDay.forEach(y => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = histMap[k].filter(x => new Date(x.date).getFullYear() === y).reduce((a,b)=>a+b.totale,0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sum += val; count++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  compData.push(count>0 ? sum/count : 0);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y = parseInt(compVal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = filteredSource.filter(x => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const xd = new Date(x.date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return xd.getFullYear() === y && xd.getMonth() === month && xd.getDate() === day;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).reduce((a,b)=>a+b.totale, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  compData.push(val);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  datasets.push({
Â  Â  Â  Â  Â  Â  label: compLabel,
Â  Â  Â  Â  Â  Â  data: compData,
Â  Â  Â  Â  Â  Â  borderColor: col,
Â  Â  Â  Â  Â  Â  backgroundColor: bgCol,
Â  Â  Â  Â  Â  Â  borderDash: isBar ? [] : [5,5],
Â  Â  Â  Â  Â  Â  fill: false, // Ensure no fill for comparison lines
Â  Â  Â  Â  Â  Â  tension: 0.4
Â  Â  Â  Â  });
Â  Â  });

Â  Â  renderDynamicChart('chartYoY', labels, datasets, chartType);


Â  Â  // --- WEEKLY CHART ---
Â  Â  const weekLabels = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];
Â  Â  const getJsDay = (i) => (i + 1) % 7;
Â  Â  let weekDatasets = [];
Â  Â  let isStacked = false;

Â  Â  if(chartType === 'bar') {
Â  Â  Â  Â  isStacked = true;Â 
Â  Â  Â  Â  const uniqueFasce = [...new Set(fMain.map(d => d.fascia))];
Â  Â  Â  Â  weekDatasets = uniqueFasce.map(fascia => {
Â  Â  Â  Â  Â  Â  const data = weekLabels.map((_, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  let subset = fMain.filter(d => new Date(d.date).getDay() === getJsDay(i) && d.fascia === fascia);
Â  Â  Â  Â  Â  Â  Â  Â  return subset.length ? subset.reduce((a,b)=>a+b.totale,0)/subset.length : 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  label: fascia,
Â  Â  Â  Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: getFasciaColor(fascia),
Â  Â  Â  Â  Â  Â  Â  Â  stack: 'main'Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  });

Â  Â  Â  Â  // Add Comparisons as side-by-side bars
Â  Â  Â  Â  selectedComps.forEach((compVal, idx) => {
Â  Â  Â  Â  Â  Â  let compSet = [];
Â  Â  Â  Â  Â  Â  if(compVal === 'avg') {
Â  Â  Â  Â  Â  Â  Â  Â  Â compSet = filteredSource.filter(d => new Date(d.date).getFullYear() !== yearMain);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â compSet = filteredSource.filter(d => new Date(d.date).getFullYear() === parseInt(compVal));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const compDataWeekly = weekLabels.map((_, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  let subset = compSet.filter(d => new Date(d.date).getDay() === getJsDay(i));
Â  Â  Â  Â  Â  Â  Â  Â  return subset.length ? subset.reduce((a,b)=>a+b.totale,0)/subset.length : 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  weekDatasets.push({
Â  Â  Â  Â  Â  Â  Â  Â  label: (compVal === 'avg' ? 'Media' : compVal) + ' (Tot)',
Â  Â  Â  Â  Â  Â  Â  Â  data: compDataWeekly,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: getCompColor(idx),
Â  Â  Â  Â  Â  Â  Â  Â  stack: 'comp'+idx
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  } else {
Â  Â  Â  Â  const calcWeekly = (dataset) => {
Â  Â  Â  Â  Â  Â  return weekLabels.map((_, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  let subset = dataset.filter(d => new Date(d.date).getDay() === getJsDay(i));
Â  Â  Â  Â  Â  Â  Â  Â  return subset.length ? subset.reduce((a,b)=>a+b.totale,0)/subset.length : 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â  weekDatasets = [{ label: `Media Selezionata`, data: calcWeekly(fMain), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true }];
Â  Â  Â  Â Â 
Â  Â  Â  Â  selectedComps.forEach((compVal, idx) => {
Â  Â  Â  Â  Â  Â  let compSet = [];
Â  Â  Â  Â  Â  Â  if(compVal === 'avg') {
Â  Â  Â  Â  Â  Â  Â  Â  Â compSet = filteredSource.filter(d => new Date(d.date).getFullYear() !== yearMain);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â compSet = filteredSource.filter(d => new Date(d.date).getFullYear() === parseInt(compVal));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  weekDatasets.push({
Â  Â  Â  Â  Â  Â  Â  Â  label: compVal === 'avg' ? 'Media' : compVal,
Â  Â  Â  Â  Â  Â  Â  Â  data: calcWeekly(compSet),
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: getCompColor(idx),
Â  Â  Â  Â  Â  Â  Â  Â  borderDash: [5,5],
Â  Â  Â  Â  Â  Â  Â  Â  fill: false
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  renderDynamicChart('chartWeek', weekLabels, weekDatasets, chartType, isStacked);

Â  Â  // ... Pie & MultiBar ...
Â  Â  let t = { 'Intero':0, 'Ridotto':0, 'Abb. Per.':0, 'Abb. 11':0, 'Gratis':0 };
Â  Â  fMain.forEach(d => { t['Intero'] += d.int||0; t['Ridotto'] += d.rid||0; t['Abb. Per.'] += d.abb_int||0; t['Abb. 11'] += d.abb_rid||0; t['Gratis'] += d.grat||0; });
Â  Â  renderPie('chartPie', Object.keys(t), Object.values(t));

Â  Â  const buildMultiSeries = (extractor) => {
Â  Â  Â  Â  let allLabels = new Set(); fMain.forEach(d => allLabels.add(extractor(d).key));
Â  Â  Â  Â  let sortedL = Array.from(allLabels).sort();
Â  Â  Â  Â  let dp = sortedL.map(l => {
Â  Â  Â  Â  Â  Â  let subset = fMain.filter(d => extractor(d).key === l);
Â  Â  Â  Â  Â  Â  return subset.reduce((a,b)=>a+extractor(b).val,0);
Â  Â  Â  Â  });
Â  Â  Â  Â  return { labels: sortedL, datasets: [{ label: `Totale`, data: dp, backgroundColor: '#2563eb' }] };
Â  Â  };
Â  Â  const meteoData = buildMultiSeries(d => ({key: d.meteo, val: d.totale}));
Â  Â  renderMultiBar('chartMeteo', meteoData.labels, meteoData.datasets);
Â  Â  const fasceData = buildMultiSeries(d => ({key: d.fascia, val: d.totale}));
Â  Â  renderMultiBar('chartFasce', fasceData.labels, fasceData.datasets, 'y');
};

function renderVasca() {Â 
Â  Â  const t=document.getElementById('tbody-vasca'); t.innerHTML="";Â 
Â  Â  const g=new Map(); dataVasca.forEach(d=>{if(!g.has(d.date))g.set(d.date,[]);g.get(d.date).push(d)});Â 
Â  Â  [...g.keys()].forEach(k=>{Â 
Â  Â  Â  Â  const e=g.get(k); e.sort((a,b)=>b.time.localeCompare(a.time));Â 
Â  Â  Â  Â  const dh=`<div style="font-weight:800;color:#1e293b">${k.split('-').reverse().join('/')}</div>`;Â 
Â  Â  Â  Â  e.forEach((d,i)=>{Â 
Â  Â  Â  Â  Â  Â  const b=i===e.length-1?"border-bottom:2px solid rgba(0,0,0,0.1)":"border-bottom:1px solid rgba(0,0,0,0.05)";Â 
Â  Â  Â  Â  Â  Â  const phVal = parseFloat(d.ph); const phAlert = (phVal < 6.5 || phVal > 7.5);
Â  Â  Â  Â  Â  Â  const phStyle = phAlert ? 'background:#fee2e2; color:#b91c1c; font-weight:900; border:1px solid #fca5a5' : 'font-weight:600';
Â  Â  Â  Â  Â  Â  const clVal = parseFloat(d.cll); const clAlert = (clVal < 0.8 || clVal > 1.7);
Â  Â  Â  Â  Â  Â  const clStyle = clAlert ? 'background:#fee2e2; color:#b91c1c; font-weight:900; border:1px solid #fca5a5' : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // POOL TYPE LOGIC
Â  Â  Â  Â  Â  Â  const typeLabel = d.type === 'esterna' ? '<span class="badge badge-summer">â˜€ï¸ Esterna</span>' : '<span class="badge badge-std">ğŸ  Interna</span>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  t.innerHTML+=`<tr style="${b}">
Â  Â  Â  Â  Â  Â  Â  Â  ${i===0?`<td rowspan="${e.length}" style="vertical-align:middle;background:rgba(255,255,255,0.4)">${dh}</td>`:''}Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:700;color:#2563eb">${d.time}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:2px">${typeLabel}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.bag}</td><td>${d.ta}Â°</td><td>${d.th}Â°</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="${phStyle}">${d.ph}</td><td style="${clStyle}">${d.cll}</td><td>${d.clc}</td><td style="font-weight:700">${d.clt}</td>Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right"><button class="btn btn-icon" style="color:var(--primary);background:#eef2ff" onclick="editVasca('${d.id}')">âœï¸</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('valori_vasca','${d.id}')">ğŸ—‘ï¸</button></td></tr>`;Â 
Â  Â  Â  Â  });Â 
Â  Â  });Â 
}

window.saveDae = async () => { const d=document.getElementById('d-date').value||new Date().toISOString().split('T')[0]; const a=document.getElementById('d-ass').value; const o=document.getElementById('d-op').value; const tVal = document.getElementById('d-time').value; if(!a||!o) return showToast("Compila nomi","error"); try { await addDoc(collection(db,"dae_log"),{date:d,time:tVal,ass:a,op:o,status:document.getElementById('d-status').value}); document.getElementById('d-ass').value=""; document.getElementById('d-op').value=""; showToast("DAE Registrato!"); } catch(e){ showToast(e.message,"error"); } };
function renderDae() { const t=document.getElementById('tbody-dae'); t.innerHTML=""; const sortedDae = [...dataDae].sort((a,b) => (b.date+b.time).localeCompare(a.date+a.time)); sortedDae.forEach(d=>{ const b=d.status==='OK'?'<span class="badge badge-ok">âœ… OK</span>':'<span class="badge badge-ko">âŒ GUASTO</span>'; t.innerHTML+=`<tr><td style="font-weight:700">${(d.date||'').split('-').reverse().join('/')}</td><td style="color:#2563eb;font-weight:600">${d.time||'-'}</td><td>${b}</td><td>${d.ass}</td><td>${d.op}</td><td style="text-align:right"><button class="btn btn-icon" style="color:#ef4444" onclick="delDoc('dae_log','${d.id}')">ğŸ—‘ï¸</button></td></tr>`; }); }

// UTENZE
window.toggleUtenzeMode = () => {
Â  Â  const type = document.getElementById('u-type').value;
Â  Â  const isSingle = type !== 'âš¡ ElettricitÃ ';
Â  Â  document.getElementById('u-single-input').classList.toggle('hidden', !isSingle);
Â  Â  const isElec = type === 'âš¡ ElettricitÃ ';
Â  Â  document.getElementById('u-elec-input').style.display = isElec ? 'contents' : 'none';
Â  Â  document.getElementById('u-extra-elec-meteo').classList.toggle('hidden', !isElec);
Â  Â  const isGas = type === 'ğŸ”¥ Gas Metano';
Â  Â  document.getElementById('u-extra-gas').classList.toggle('hidden', !isGas);
};
window.toggleUtenzeMode();
window.saveUtenze = async () => {
Â  Â  const d = document.getElementById('u-date').value; const type = document.getElementById('u-type').value; const note = document.getElementById('u-note').value;
Â  Â  let p = { date: d, type, note };
Â  Â  if(type === 'âš¡ ElettricitÃ ') {
Â  Â  Â  Â  const a1 = parseFloat(document.getElementById('u-a1').value)||0;
Â  Â  Â  Â  const a2 = parseFloat(document.getElementById('u-a2').value)||0;
Â  Â  Â  Â  const a3 = parseFloat(document.getElementById('u-a3').value)||0;
Â  Â  Â  Â  p.a1 = a1; p.a2 = a2; p.a3 = a3; p.val = a1+a2+a3;
Â  Â  Â  Â  p.meteo = document.getElementById('u-meteo').value;
Â  Â  } else {
Â  Â  Â  Â  p.val = parseFloat(document.getElementById('u-val').value);
Â  Â  Â  Â  if(type === 'ğŸ”¥ Gas Metano') { p.temp = parseFloat(document.getElementById('u-temp').value) || null; }
Â  Â  }
Â  Â  if(!d || (type!=='âš¡ ElettricitÃ ' && isNaN(p.val))) return showToast("Dati mancanti", "error");
Â  Â  try {
Â  Â  Â  Â  if(editIdUtenze) {
Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, "utenze_log", editIdUtenze), p); showToast("Modifica salvata!"); cancelEditUtenze();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await addDoc(collection(db, "utenze_log"), p); showToast("Salvato"); document.querySelectorAll('#cb-utenze input:not([type=date])').forEach(i=>i.value='');
Â  Â  Â  Â  }
Â  Â  } catch(e){ showToast(e.message, "error"); }
};

window.editUtenze = (id) => {
Â  Â  const d = dataUtenze.find(x => x.id === id); if(!d) return; editIdUtenze = id;
Â  Â  document.getElementById('u-date').value = d.date; document.getElementById('u-type').value = d.type; document.getElementById('u-note').value = d.note || '';
Â  Â  toggleUtenzeMode();
Â  Â  if(d.type === 'âš¡ ElettricitÃ ') {
Â  Â  Â  Â  document.getElementById('u-a1').value = d.a1; document.getElementById('u-a2').value = d.a2; document.getElementById('u-a3').value = d.a3; document.getElementById('u-meteo').value = d.meteo || 'â˜€ï¸ Sole';
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('u-val').value = d.val;
Â  Â  Â  Â  if(d.type === 'ğŸ”¥ Gas Metano') { document.getElementById('u-temp').value = d.temp || ''; }
Â  Â  }
Â  Â  document.getElementById('title-utenze').innerText = "Modifica Utenza"; document.getElementById('btn-save-utenze').innerText = "AGGIORNA"; document.getElementById('btn-save-utenze').style.background = "#f59e0b"; document.getElementById('cb-utenze').classList.add('editing'); document.getElementById('cancel-utenze').classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'});
};
window.cancelEditUtenze = () => {
Â  Â  editIdUtenze = null; document.getElementById('title-utenze').innerText = "Registrazione Letture Utenze"; document.getElementById('btn-save-utenze').innerText = "SALVA"; document.getElementById('btn-save-utenze').style.background = ""; document.getElementById('cb-utenze').classList.remove('editing'); document.getElementById('cancel-utenze').classList.add('hidden'); document.querySelectorAll('#cb-utenze input:not([type=date])').forEach(i=>i.value=''); toggleUtenzeMode();
};

window.switchSubViewUtenze=(s)=>{
Â  Â  ['overview','charts','archive'].forEach(v=>{ document.getElementById('sub-u-'+v).classList.add('hidden'); document.getElementById('btn-sub-u-'+v).classList.remove('btn-primary'); });
Â  Â  document.getElementById('sub-u-'+s).classList.remove('hidden'); document.getElementById('btn-sub-u-'+s).classList.add('btn-primary');
Â  Â  renderUtenze();
};

window.renderUtenze = () => {
Â  Â  if(!isChartReady()) return;
Â  Â  const viewMode = document.getElementById('u-view-mode').value; const isDelta = viewMode === 'delta'; const chartType = isDelta ? 'bar' : 'line';
Â  Â  const rangeDays = parseInt(document.getElementById('u-range').value); const limitDate = new Date(); limitDate.setDate(limitDate.getDate() - rangeDays); const limitStr = limitDate.toISOString().split('T')[0];
Â  Â  const showHistory = document.getElementById('u-compare-year').checked;
Â  Â  const grouped = {};
Â  Â  dataUtenze.forEach(d => {
Â  Â  Â  Â  if(!grouped[d.date]) grouped[d.date] = { date: d.date, elec: null, water: null, gas: null, notes: [] };
Â  Â  Â  Â  if(d.type === 'âš¡ ElettricitÃ ') grouped[d.date].elec = d;
Â  Â  Â  Â  if(d.type === 'ğŸ’§ Acqua') grouped[d.date].water = d;
Â  Â  Â  Â  if(d.type === 'ğŸ”¥ Gas Metano') grouped[d.date].gas = d;
Â  Â  Â  Â  if(d.note) grouped[d.date].notes.push(d.note);
Â  Â  });
Â  Â  const allDatesAsc = Object.keys(grouped).sort();
Â  Â  let prevVals = { elec: null, water: null, gas: null }; const deltas = {};
Â  Â  allDatesAsc.forEach(date => {
Â  Â  Â  Â  deltas[date] = { elec: null, water: null, gas: null }; const g = grouped[date];
Â  Â  Â  Â  const calcDelta = (key, valObj) => {
Â  Â  Â  Â  Â  Â  if(valObj) {
Â  Â  Â  Â  Â  Â  Â  Â  if(prevVals[key] !== null) { let d = valObj.val - prevVals[key]; if(d < 0) d = 0; deltas[date][key] = d; } else { deltas[date][key] = 0; } prevVals[key] = valObj.val;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  calcDelta('elec', g.elec); calcDelta('water', g.water); calcDelta('gas', g.gas);
Â  Â  });

Â  Â  // --- KPI LOGIC ---
Â  Â  let kpiDateObj = new Date();Â 
Â  Â  const selectedMonthVal = document.getElementById('u-kpi-month-selector').value;Â 

Â  Â  if (selectedMonthVal) {
Â  Â  Â  Â  kpiDateObj = new Date(selectedMonthVal + "-01");
Â  Â  } else if (allDatesAsc.length > 0) {
Â  Â  Â  Â  // Use string slicing for safer default date (avoids timezone shifts)
Â  Â  Â  Â  const lastDate = allDatesAsc[allDatesAsc.length - 1];
Â  Â  Â  Â  document.getElementById('u-kpi-month-selector').value = lastDate.slice(0, 7);
Â  Â  Â  Â  kpiDateObj = new Date(lastDate);
Â  Â  }

Â  Â  const thisMonth = kpiDateObj.getMonth();
Â  Â  const thisYear = kpiDateObj.getFullYear();
Â  Â  const prevYear = thisYear - 1;
Â  Â  const monthName = kpiDateObj.toLocaleString('it-IT', { month: 'long' });
Â  Â Â 
Â  Â  // Determine the "Max Day" for comparison
Â  Â  const realToday = new Date();
Â  Â  const isCurrentRealMonth = (thisYear === realToday.getFullYear() && thisMonth === realToday.getMonth());
Â  Â  const maxDay = isCurrentRealMonth ? realToday.getDate() : 32;Â 

Â  Â  let sumElec = { curr: 0, prev: 0, currMeteo: {sun:0, tot:0}, prevMeteo: {sun:0, tot:0} };
Â  Â  let sumWater = { curr: 0, prev: 0, currBag: {sum:0, count:0}, prevBag: {sum:0, count:0} };
Â  Â  let sumGas = { curr: 0, prev: 0, currTemp: [], prevTemp: [] };

Â  Â  Object.keys(deltas).forEach(dateStr => {
Â  Â  Â  Â  const d = new Date(dateStr);
Â  Â  Â  Â  if(d.getDate() <= maxDay) {
Â  Â  Â  Â  Â  Â  if(d.getMonth() === thisMonth) {
Â  Â  Â  Â  Â  Â  Â  Â  const gData = grouped[dateStr];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(d.getFullYear() === thisYear) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumElec.curr += deltas[dateStr].elec || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumWater.curr += deltas[dateStr].water || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumGas.curr += deltas[dateStr].gas || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Context Data Current
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.elec && gData.elec.meteo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumElec.currMeteo.tot++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.elec.meteo.includes('Sole')) sumElec.currMeteo.sun++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.gas && gData.gas.temp) sumGas.currTemp.push(gData.gas.temp);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Bagnanti Data Integration
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayBag = dataIngressi.find(x => x.date === dateStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dayBag) { sumWater.currBag.sum += dayBag.totale || 0; sumWater.currBag.count++; }

Â  Â  Â  Â  Â  Â  Â  Â  } else if(d.getFullYear() === prevYear) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumElec.prev += deltas[dateStr].elec || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumWater.prev += deltas[dateStr].water || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumGas.prev += deltas[dateStr].gas || 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Context Data Prev
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.elec && gData.elec.meteo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumElec.prevMeteo.tot++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.elec.meteo.includes('Sole')) sumElec.prevMeteo.sun++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(gData.gas && gData.gas.temp) sumGas.prevTemp.push(gData.gas.temp);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Bagnanti Data Integration Prev
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayBag = dataIngressi.find(x => x.date === dateStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dayBag) { sumWater.prevBag.sum += dayBag.totale || 0; sumWater.prevBag.count++; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Helper for context strings
Â  Â  const getMeteoStr = () => {
Â  Â  Â  Â  const c = sumElec.currMeteo.sun;
Â  Â  Â  Â  const p = sumElec.prevMeteo.sun;
Â  Â  Â  Â  return `Giorni Sole: <b>${c}</b> (vs ${p})`;
Â  Â  };
Â  Â  const getTempStr = () => {
Â  Â  Â  Â  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '-';
Â  Â  Â  Â  return `Temp Media: <b>${avg(sumGas.currTemp)}Â°C</b> (vs ${avg(sumGas.prevTemp)}Â°C)`;
Â  Â  };
Â  Â  const getBagStr = () => {
Â  Â  Â  Â  const avgC = sumWater.currBag.count ? (sumWater.currBag.sum / sumWater.currBag.count).toFixed(0) : 0;
Â  Â  Â  Â  const avgP = sumWater.prevBag.count ? (sumWater.prevBag.sum / sumWater.prevBag.count).toFixed(0) : 0;
Â  Â  Â  Â  return `Media Bagnanti: <b>${avgC}</b> (vs ${avgP})`;
Â  Â  };

Â  Â  const updateKpi = (type, valCurr, valPrev, unit, contextHtml) => {
Â  Â  Â  Â  let diff = 0;
Â  Â  Â  Â  let diffHtml = '<span style="color:#94a3b8; font-size:0.8rem">Dati insufficienti</span>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (valPrev > 0) {
Â  Â  Â  Â  Â  Â  diff = ((valCurr - valPrev) / valPrev) * 100;
Â  Â  Â  Â  Â  Â  const color = diff > 0 ? '#ef4444' : '#10b981';Â 
Â  Â  Â  Â  Â  Â  const sign = diff > 0 ? '+' : '';
Â  Â  Â  Â  Â  Â  const dayLabel = isCurrentRealMonth ? `(al ${maxDay})` : '';
Â  Â  Â  Â  Â  Â  diffHtml = `<span style="color:${color}; font-weight:800">${sign}${diff.toFixed(1)}%</span> vs ${monthName} ${prevYear} ${dayLabel}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById(`u-kpi-${type}-title`).innerText = `${monthName} ${thisYear}`;
Â  Â  Â  Â  document.getElementById(`u-kpi-${type}-val`).innerText = `${valCurr.toLocaleString('it-IT', {maximumFractionDigits:0})} ${unit}`;
Â  Â  Â  Â  document.getElementById(`u-kpi-${type}-sub`).innerHTML = diffHtml;
Â  Â  Â  Â  if(contextHtml) document.getElementById(`u-kpi-${type}-context`).innerHTML = contextHtml;
Â  Â  };

Â  Â  updateKpi('elec', sumElec.curr, sumElec.prev, 'kWh', getMeteoStr());
Â  Â  updateKpi('water', sumWater.curr, sumWater.prev, 'mÂ³', getBagStr());
Â  Â  updateKpi('gas', sumGas.curr, sumGas.prev, 'mÂ³', getTempStr());

Â  Â  // Chart Logic remains unchanged...
Â  Â  function prepareChartData(type) {
Â  Â  Â  Â  const filteredDates = allDatesAsc.filter(d => d >= limitStr);
Â  Â  Â  Â  const labels = [], dataTotal = [], dataDelta = [], dataHistoryTotal = [], dataHistoryDelta = [];
Â  Â  Â  Â  const typeKey = type === 'âš¡ ElettricitÃ ' ? 'elec' : (type === 'ğŸ’§ Acqua' ? 'water' : 'gas');
Â  Â  Â  Â  filteredDates.forEach((dateStr) => {
Â  Â  Â  Â  Â  Â  const curr = grouped[dateStr];
Â  Â  Â  Â  Â  Â  const dateObj = new Date(dateStr);
Â  Â  Â  Â  Â  Â  const label = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
Â  Â  Â  Â  Â  Â  labels.push(label);
Â  Â  Â  Â  Â  Â  let val = 0; let extra = "";
Â  Â  Â  Â  Â  Â  if(typeKey === 'elec' && curr.elec) { val = curr.elec.val; extra = `Meteo: ${curr.elec.meteo||'N/D'}`; }
Â  Â  Â  Â  Â  Â  if(typeKey === 'water' && curr.water) { val = curr.water.val; }
Â  Â  Â  Â  Â  Â  if(typeKey === 'gas' && curr.gas) { val = curr.gas.val; extra = curr.gas.temp ? `Temp: ${curr.gas.temp}Â°C` : ''; }
Â  Â  Â  Â  Â  Â  dataTotal.push({ x: label, y: val, extraInfo: extra, rawDate: dateStr });
Â  Â  Â  Â  Â  Â  const dVal = deltas[dateStr] ? deltas[dateStr][typeKey] : 0;
Â  Â  Â  Â  Â  Â  dataDelta.push({ x: label, y: dVal, extraInfo: extra, rawDate: dateStr });
Â  Â  Â  Â  Â  Â  if(showHistory) {
Â  Â  Â  Â  Â  Â  Â  Â  const dObj = new Date(dateStr); dObj.setFullYear(dObj.getFullYear() - 1); const prevYearStr = dObj.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  let hVal = null;
Â  Â  Â  Â  Â  Â  Â  Â  if(grouped[prevYearStr]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeKey==='elec' && grouped[prevYearStr].elec) hVal = grouped[prevYearStr].elec.val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeKey==='water' && grouped[prevYearStr].water) hVal = grouped[prevYearStr].water.val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeKey==='gas' && grouped[prevYearStr].gas) hVal = grouped[prevYearStr].gas.val;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  dataHistoryTotal.push(hVal !== null ? { x: label, y: hVal, refDate: prevYearStr } : null);
Â  Â  Â  Â  Â  Â  Â  Â  let hDelta = null;
Â  Â  Â  Â  Â  Â  Â  Â  if(deltas[prevYearStr] && deltas[prevYearStr][typeKey] !== null) { hDelta = deltas[prevYearStr][typeKey]; }
Â  Â  Â  Â  Â  Â  Â  Â  dataHistoryDelta.push(hDelta !== null ? { x: label, y: hDelta, refDate: prevYearStr } : null);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return { labels, dataTotal, dataDelta, dataHistoryTotal, dataHistoryDelta };
Â  Â  }

Â  Â  const elecData = prepareChartData('âš¡ ElettricitÃ '); const waterData = prepareChartData('ğŸ’§ Acqua'); const gasData = prepareChartData('ğŸ”¥ Gas Metano');
Â  Â  function makeDatasets(mainData, historyData, colorMain, colorHist) {
Â  Â  Â  Â  const ds = [{ label: isDelta ? 'Consumo' : 'Lettura', data: isDelta ? mainData.dataDelta : mainData.dataTotal, borderColor: colorMain, backgroundColor: colorMain, fill: true, tension: 0.3, order: 1, type: isDelta ? 'bar' : 'line' }];
Â  Â  Â  Â  if(showHistory) {
Â  Â  Â  Â  Â  Â  ds.push({ label: isDelta ? 'Anno Prec.' : 'Lettura Anno Prec.', data: isDelta ? historyData.dataHistoryDelta : historyData.dataHistoryTotal, borderColor: colorHist, backgroundColor: isDelta ? colorHist : 'transparent', borderDash: isDelta ? [] : [4,4], borderWidth: isDelta ? 0 : 2, pointRadius: isDelta ? 0 : 2, type: isDelta ? 'bar' : 'line', order: 2, fill: false, tension: 0.3 });
Â  Â  Â  Â  }
Â  Â  Â  Â  return ds;
Â  Â  }
Â  Â  // Only render charts if their container is visible
Â  Â  if (!document.getElementById('sub-u-charts').classList.contains('hidden')) {
Â  Â  Â  Â  renderDynamicChart('chartElec', elecData.labels, makeDatasets(elecData, elecData, '#eab308', '#fde047'), chartType);
Â  Â  Â  Â  renderDynamicChart('chartWater', waterData.labels, makeDatasets(waterData, waterData, '#3b82f6', '#93c5fd'), chartType);
Â  Â  Â  Â  renderDynamicChart('chartGas', gasData.labels, makeDatasets(gasData, gasData, '#ef4444', '#fca5a5'), chartType);
Â  Â  }

Â  Â  const t = document.getElementById('tbody-utenze'); t.innerHTML = ""; const datesDesc = [...allDatesAsc].reverse();
Â  Â Â 
Â  Â  // HISTORY FILTER LOGIC
Â  Â  const histStart = document.getElementById('u-hist-start').value;
Â  Â  const histEnd = document.getElementById('u-hist-end').value;
Â  Â  const histSort = document.getElementById('u-hist-sort').value;

Â  Â  let filteredDates = [...datesDesc];
Â  Â  if(histStart) filteredDates = filteredDates.filter(d => d >= histStart);
Â  Â  if(histEnd) filteredDates = filteredDates.filter(d => d <= histEnd);
Â  Â  if(histSort === 'asc') filteredDates.reverse();

Â  Â  const rowsBuffer = [];
Â  Â  filteredDates.forEach(date => {
Â  Â  Â  Â  const g = grouped[date]; const d = deltas[date];
Â  Â  Â  Â  const makeCell = (obj, deltaVal, color, suffix='') => {
Â  Â  Â  Â  Â  Â  if(!obj) return '<span style="color:#ccc">-</span>';
Â  Â  Â  Â  Â  Â  let deltaHtml = '';
Â  Â  Â  Â  Â  Â  if(deltaVal !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  const warnStyle = (deltaVal > 1000 && suffix!=='kWh') ? 'color:#ef4444; text-decoration:underline' : `color:${color}`;
Â  Â  Â  Â  Â  Â  Â  Â  deltaHtml = `<div style="font-size:0.75rem; ${warnStyle}; opacity:0.8; font-weight:700">Consumo: +${deltaVal.toLocaleString('it-IT', {maximumFractionDigits: 1})} ${suffix}</div>`;
Â  Â  Â  Â  Â  Â  } else { deltaHtml = `<div style="font-size:0.75rem; color:#94a3b8">Primo dato</div>`; }
Â  Â  Â  Â  Â  Â  return `<div style="display:flex; flex-direction:column; gap:2px">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center; justify-content:space-between; gap:5px"><span style="font-weight:800; font-size:1rem; color:${color}">${obj.val.toLocaleString('it-IT')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:2px"><button class="btn btn-icon" style="width:24px; height:24px; padding:0; font-size:0.7rem; color:var(--primary); border:1px solid #dbeafe; background:#eff6ff" onclick="editUtenze('${obj.id}')">âœï¸</button><button class="btn btn-icon" style="width:24px; height:24px; padding:0; font-size:0.7rem; color:#ef4444; border:1px solid #fee2e2; background:#fef2f2" onclick="delDoc('utenze_log','${obj.id}')">Ã—</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>${deltaHtml}</div>`;
Â  Â  Â  Â  };
Â  Â  Â  Â  let elecDet = '-';
Â  Â  Â  Â  if(g.elec) {
Â  Â  Â  Â  Â  Â  const meteoBadge = g.elec.meteo ? `<br><span style="font-size:0.75rem; background:#f1f5f9; padding:2px 6px; border-radius:4px">Meteo: ${g.elec.meteo}</span>` : '';
Â  Â  Â  Â  Â  Â  elecDet = `<div style="font-size:0.75rem; color:#64748b">F1: <b>${g.elec.a1||0}</b> | F2: <b>${g.elec.a2||0}</b> | F3: <b>${g.elec.a3||0}</b>${meteoBadge}</div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  let gasCell = makeCell(g.gas, d.gas, '#dc2626', 'mÂ³');
Â  Â  Â  Â  if(g.gas && g.gas.temp) { gasCell += `<div style="font-size:0.7rem; color:#64748b; margin-top:4px; border-top:1px solid rgba(0,0,0,0.05); padding-top:2px">ğŸŒ¡ï¸ Temp: <b>${g.gas.temp}Â°C</b></div>`; }
Â  Â  Â  Â  const noteStr = g.notes.length > 0 ? g.notes.join('; ') : '';
Â  Â  Â  Â  const dateFmt = date.split('-').reverse().join('/');
Â  Â  Â  Â  rowsBuffer.push(`<tr><td style="font-weight:800; color:var(--text-main); vertical-align:top; padding-top:15px">${dateFmt}</td><td style="background:rgba(234, 179, 8, 0.05); vertical-align:top">${makeCell(g.elec, d.elec, '#d97706', 'kWh')}</td><td style="background:rgba(234, 179, 8, 0.05); vertical-align:top">${elecDet}</td><td style="background:rgba(59, 130, 246, 0.05); vertical-align:top">${makeCell(g.water, d.water, '#2563eb', 'mÂ³')}</td><td style="background:rgba(239, 68, 68, 0.05); vertical-align:top">${gasCell}</td><td style="font-size:0.8rem; color:#64748b; font-style:italic; vertical-align:top; padding-top:15px">${noteStr}</td></tr>`);
Â  Â  });
Â  Â  t.innerHTML = rowsBuffer.join('');
};

window.resetUtenzeHistory = () => {
Â  Â  document.getElementById('u-hist-start').value = "";
Â  Â  document.getElementById('u-hist-end').value = "";
Â  Â  document.getElementById('u-hist-sort').value = "desc";
Â  Â  renderUtenze();
};

window.saveIngressi = async () => {
Â  Â  const d = document.getElementById('i-date').value; if(!d) return showToast("Data mancante","error");
Â  Â  // Removed all zero checks here
Â  Â  const p = { date:d, type:document.getElementById('i-type').value, fascia:document.getElementById('i-fascia').value, meteo:document.getElementById('i-meteo').value, excludeStats: document.getElementById('i-exclude').checked, int:parseInt(document.getElementById('q-intero').value)||0, rid:parseInt(document.getElementById('q-ridotto').value)||0, grat:parseInt(document.getElementById('q-gratuito').value)||0, abb_int:parseInt(document.getElementById('q-abb-int').value)||0, abb_rid:parseInt(document.getElementById('q-abb-rid').value)||0 };
Â  Â  p.totale = p.int + p.rid + p.grat + p.abb_int + p.abb_rid;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  if(editIdIngressi) { await updateDoc(doc(db,"sessioni",editIdIngressi), p); showToast("Aggiornato"); cancelEditIngressi(); } else { await addDoc(collection(db,"sessioni"), p); showToast("Salvato"); document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); document.getElementById('i-exclude').checked = false; }
Â  Â  } catch(e){ showToast(e.message,"error"); }
};
window.editIngressi = (id) => { const d = dataIngressi.find(x=>x.id===id); if(!d) return; editIdIngressi = id; document.getElementById('i-date').value=d.date; document.getElementById('i-type').value=d.type||'standard'; document.getElementById('i-fascia').value=d.fascia; document.getElementById('i-meteo').value=d.meteo; document.getElementById('i-exclude').checked = d.excludeStats || false; document.getElementById('q-intero').value=d.int; document.getElementById('q-ridotto').value=d.rid; document.getElementById('q-gratuito').value=d.grat; document.getElementById('q-abb-int').value=d.abb_int; document.getElementById('q-abb-rid').value=d.abb_rid; document.getElementById('title-ingressi').innerText="Modifica Ingressi"; document.getElementById('btn-save-ingressi').innerText="AGGIORNA"; document.getElementById('btn-save-ingressi').style.background="#f59e0b"; document.getElementById('cancel-ingressi').classList.remove('hidden'); document.getElementById('cb-ingressi').classList.add('editing'); window.scrollTo({top:0,behavior:'smooth'}); };
window.cancelEditIngressi = () => { editIdIngressi=null; document.getElementById('title-ingressi').innerText="Registrazione Ingressi"; document.getElementById('btn-save-ingressi').innerText="SALVA"; document.getElementById('btn-save-ingressi').style.background=""; document.getElementById('cancel-ingressi').classList.add('hidden'); document.getElementById('cb-ingressi').classList.remove('editing'); document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); document.getElementById('i-exclude').checked = false; };
window.saveVasca = async () => { const date = document.getElementById('v-date').value; const time = document.getElementById('v-time').value; if(!date || !time) return showToast("Data/Ora mancanti","error"); const payload = { date, time, bag:document.getElementById('v-bag').value, ta:document.getElementById('v-ta').value, th:document.getElementById('v-th').value, ph:document.getElementById('v-ph').value, cll:document.getElementById('v-cll').value, clc:document.getElementById('v-clc').value, clt:document.getElementById('v-clt').value }; try { if(editIdVasca){ await updateDoc(doc(db,"valori_vasca",editIdVasca), payload); showToast("Aggiornato"); cancelEditVasca(); } else { await addDoc(collection(db,"valori_vasca"), payload); showToast("Salvato"); } } catch(e){ showToast(e.message,"error"); } };
window.editVasca = (id) => { const d = dataVasca.find(x=>x.id===id); if(!d)return; editIdVasca=id; document.getElementById('v-date').value=d.date; document.getElementById('v-time').value=d.time; document.getElementById('v-bag').value=d.bag; document.getElementById('v-ta').value=d.ta; document.getElementById('v-th').value=d.th; document.getElementById('v-ph').value=d.ph; document.getElementById('v-cll').value=d.cll; document.getElementById('v-clc').value=d.clc; document.getElementById('v-clt').value=d.clt; document.getElementById('title-vasca').innerText="Modifica Valori"; document.getElementById('btn-save-vasca').innerText="AGGIORNA"; document.getElementById('btn-save-vasca').style.background="#f59e0b"; document.getElementById('cancel-vasca').classList.remove('hidden'); document.getElementById('cb-vasca').classList.add('editing'); window.scrollTo({top:0,behavior:'smooth'}); };
window.cancelEditVasca = () => { editIdVasca=null; document.getElementById('title-vasca').innerText="Registrazione Valori"; document.getElementById('btn-save-vasca').innerText="SALVA"; document.getElementById('btn-save-vasca').style.background=""; document.getElementById('cancel-vasca').classList.add('hidden'); document.getElementById('cb-vasca').classList.remove('editing'); };
window.calcClTot = () => { document.getElementById('v-clt').value = ((parseFloat(document.getElementById('v-cll').value)||0) + (parseFloat(document.getElementById('v-clc').value)||0)).toFixed(2); };
window.delDoc = async (c,i) => { if(confirm("Eliminare?")){ await deleteDoc(doc(db,c,i)); showToast("Eliminato"); } };
window.toggleExcludeStats = async (id, currentVal) => { try { await updateDoc(doc(db, "sessioni", id), { excludeStats: !currentVal }); showToast(!currentVal ? "Giorno escluso dalla media" : "Giorno reincluso nella media"); } catch(e) { showToast(e.message, "error"); } };
window.renderIngressiArchive = () => {
Â  Â  const start = document.getElementById('arch-date-start').value; const end = document.getElementById('arch-date-end').value; const fascia = document.getElementById('arch-filter-fascia').value; const meteo = document.getElementById('arch-filter-meteo').value; const sort = document.getElementById('arch-sort').value;
Â  Â  const f = dataIngressi.filter(d => { if (start && d.date < start) return false; if (end && d.date > end) return false; if (fascia !== 'all' && d.fascia !== fascia) return false; if (meteo !== 'all' && d.meteo !== meteo) return false; return true; });
Â  Â  f.sort((a,b)=>{const da=new Date(a.date), db=new Date(b.date); return sort==='desc'?db-da:da-db});
Â  Â  const t=document.getElementById('tbody-ingressi'); t.innerHTML="";
Â  Â  if(f.length === 0) { t.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:20px;">Nessun dato trovato.</td></tr>'; return; }
Â  Â  const g=new Map(); f.forEach(d=>{if(!g.has(d.date))g.set(d.date,[]); g.get(d.date).push(d)});
Â  Â  const rowsBuffer = [];
Â  Â  [...g.keys()].forEach(k=>{
Â  Â  Â  Â  const e=g.get(k);
Â  Â  Â  Â  const dh=`<div style="font-weight:800;font-size:0.95rem;color:#1e293b">${k.split('-').reverse().join('/')}</div><div style="font-size:0.8rem;color:#64748b">${new Date(k).toLocaleDateString('it-IT',{weekday:'short'}).toUpperCase()}</div>`;
Â  Â  Â  Â  e.forEach((d,i)=>{
Â  Â  Â  Â  Â  Â  const b=i===e.length-1?"border-bottom:2px solid rgba(0,0,0,0.1)":"border-bottom:1px solid rgba(0,0,0,0.05)";
Â  Â  Â  Â  Â  Â  let badge = d.type === 'festivo' ? '<span class="badge badge-ko" style="margin-left:5px">ğŸ”´ Festivo</span>' : d.type === 'evento' ? '<span class="badge badge-evt" style="margin-left:5px">ğŸ† Evento</span>' : d.type === 'extra' ? '<span class="badge badge-summer" style="margin-left:5px">âš ï¸ Extra</span>' : '';
Â  Â  Â  Â  Â  Â  if (d.type === 'maltempo') badge = '<span class="badge" style="background:#475569; color:white; margin-left:5px">â›ˆï¸ Maltempo</span>';
Â  Â  Â  Â  Â  Â  const isExcluded = d.excludeStats === true;
Â  Â  Â  Â  Â  Â  const rowStyle = isExcluded ? "opacity:0.5; background: repeating-linear-gradient(45deg,rgba(0,0,0,0.02),rgba(0,0,0,0.02) 10px,rgba(0,0,0,0.06) 10px,rgba(0,0,0,0.06) 20px);" : "";
Â  Â  Â  Â  Â  Â  const excludeIcon = isExcluded ? "âœ…" : "ğŸš«";
Â  Â  Â  Â  Â  Â  rowsBuffer.push(`<tr style="${b}; ${rowStyle}">${i===0?`<td rowspan="${e.length}" style="vertical-align:middle;background:rgba(255,255,255,0.4)">${dh}</td>`:''} <td><b>${d.fascia}</b>${badge}<br><small style="color:#64748b">${d.meteo}</small>${isExcluded?'<br><b style="color:#ef4444;font-size:0.65rem">ESCLUSO MEDIA</b>':''}</td> <td class="col-detail bg-sub-blue">${d.int}</td><td class="col-detail bg-sub-blue">${d.rid}</td><td class="col-subtot bg-sub-blue" style="color:var(--primary)">${(d.int||0)+(d.rid||0)}</td> <td class="col-detail bg-sub-purp">${d.abb_int}</td><td class="col-detail bg-sub-purp">${d.abb_rid}</td><td class="col-subtot bg-sub-purp" style="color:#a855f7">${(d.abb_int||0)+(d.abb_rid||0)}</td> <td class="col-detail">${d.grat}</td><td class="col-total">${d.totale}</td> <td style="text-align:right; min-width:110px"><button class="btn btn-icon" style="color:#64748b;background:transparent;border:1px solid #e2e8f0;margin-right:5px;width:30px;height:30px" onclick="toggleExcludeStats('${d.id}', ${isExcluded})">${excludeIcon}</button><button class="btn btn-icon" style="color:var(--primary);background:#eef2ff" onclick="editIngressi('${d.id}')">âœï¸</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('sessioni','${d.id}')">ğŸ—‘ï¸</button></td></tr>`);
Â  Â  Â  Â  });
Â  Â  });
Â  Â  t.innerHTML = rowsBuffer.join('');
}
window.switchModule=(m)=>{ document.querySelectorAll('.module-container').forEach(e=>e.classList.add('hidden')); document.getElementById('module-'+m).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-module-'+m).classList.add('active'); if(m==='ingressi')refreshCurrentView(); if(m==='vasca')renderVasca(); if(m==='dae')renderDae(); if(m==='utenze')renderUtenze(); };
window.switchSubView=(s)=>{ ['overview','stats','archive'].forEach(v=>{ document.getElementById('sub-'+v).classList.add('hidden'); document.getElementById('btn-sub-'+v).classList.remove('btn-primary'); }); document.getElementById('sub-'+s).classList.remove('hidden'); document.getElementById('btn-sub-'+s).classList.add('btn-primary'); refreshCurrentView(); };
function refreshCurrentView(){ if(!document.getElementById('sub-overview').classList.contains('hidden')) renderOverview(); if(!document.getElementById('sub-stats').classList.contains('hidden')) renderStats(); if(!document.getElementById('sub-archive').classList.contains('hidden')) renderIngressiArchive(); }
setInterval(()=>{ const n=new Date(); const s=n.getHours().toString().padStart(2,'0')+":"+n.getMinutes().toString().padStart(2,'0'); if(document.getElementById('d-time')) document.getElementById('d-time').value=s; },1000);
const today=new Date().toISOString().split('T')[0]; document.getElementById('i-date').value=today; document.getElementById('v-date').value=today; document.getElementById('d-date').value=today; document.getElementById('u-date').value=today;
window.downloadCSV = () => { const start = document.getElementById('arch-date-start').value; const end = document.getElementById('arch-date-end').value; const fascia = document.getElementById('arch-filter-fascia').value; const meteo = document.getElementById('arch-filter-meteo').value; const filtered = dataIngressi.filter(d => { if (start && d.date < start) return false; if (end && d.date > end) return false; if (fascia !== 'all' && d.fascia !== fascia) return false; if (meteo !== 'all' && d.meteo !== meteo) return false; return true; }); if(!filtered.length) return showToast("Nessun dato da scaricare", "error"); let csvContent = "data:text/csv;charset=utf-8,Data;Tipo;Fascia;Meteo;EsclusoMedia;Intero;Ridotto;Abbonamenti;Gratuiti;Totale\n"; filtered.forEach(row => { csvContent += `${row.date};${row.type||'standard'};${row.fascia};${row.meteo};${row.excludeStats?'SI':'NO'};${row.int};${row.rid};${row.abb_int + row.abb_rid};${row.grat};${row.totale}\n`; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "archivio_ingressi.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
window.resetArchiveFilters = () => { document.getElementById('arch-date-start').value=""; document.getElementById('arch-date-end').value=""; document.getElementById('arch-filter-fascia').value="all"; document.getElementById('arch-filter-meteo').value="all"; renderIngressiArchive(); };
</script>

</body>
</html>
