<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piscina Deep Analytics V8</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #007aff; --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; 
            --border: #d2d2d7; --success: #34c759; --danger: #ff3b30;
            --chart-1: #5856d6; --chart-2: #ff9500; --chart-3: #ff2d55; --chart-4: #5ac8fa;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 30px; }
        .container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 30px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.8rem; font-weight: 800; color: #333; }
        
        .card { background: var(--card); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
        .card-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 15px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* INPUT */
        .input-row-main { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; background: #fafafa; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .input-group { display: flex; flex-direction: column; flex: 1; }
        .input-group label { font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #555; }
        .input-grid-tickets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .ticket-box { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 10px; text-align: center; }
        .ticket-box input { width: 100%; font-size: 1.8rem; font-weight: 800; text-align: center; border: none; outline: none; background: transparent; color: var(--primary); }
        select, input[type="date"] { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--success); color: white; }
        .btn-edit { background: #f0f0f0; color: #333; padding: 5px 10px; border-radius: 6px; margin-right: 5px; }
        .btn-del { background: #fff1f0; color: var(--danger); padding: 5px 10px; border-radius: 6px; }

        /* ANALYTICS GRID */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .mini-stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; }
        .tab-btn { padding: 8px 16px; border-radius: 20px; background: #e0e0e0; border: none; cursor: pointer; font-weight: 600; color: #666; }
        .tab-btn.active { background: #333; color: #fff; }

        .hidden { display: none; }
        #login-screen { max-width: 400px; margin: 80px auto; text-align: center; }
        .editing-mode { border: 2px solid var(--primary); background-color: #f0f7ff; }
        
        /* Badge */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-std { background: #eef2ff; color: var(--primary); }
        .badge-summer { background: #fff8e6; color: #ff9500; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1>üèä‚Äç‚ôÇÔ∏è Dashboard Piscina</h1>
    <div class="card" style="margin-top:20px; text-align:left">
        <label style="font-weight:bold; font-size:0.8rem">Email</label>
        <input type="email" id="email" style="margin-bottom:15px; margin-top:5px">
        <label style="font-weight:bold; font-size:0.8rem">Password</label>
        <input type="password" id="password" style="margin-bottom:20px; margin-top:5px">
        <button class="btn btn-primary" onclick="doLogin()">Entra</button>
        <p id="login-error" style="color:red; margin-top:15px; text-align:center"></p>
    </div>
</div>

<div id="app-screen" class="container hidden">
    
    <div class="header">
        <h1>üìä Deep Intelligence</h1>
        <div>
            <span id="user-display" style="margin-right:15px; font-weight:500; color:#666"></span>
            <button class="btn" style="background:#e5e5ea; padding:8px 16px" onclick="doLogout()">Esci</button>
        </div>
    </div>

    <div class="card" id="input-card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="card-title" id="form-title" style="margin:0; border:none">Nuovo Inserimento</div>
            <button id="cancel-edit" class="btn hidden" onclick="cancelEdit()" style="background:#fff0f0; color:red; padding:6px 15px">Annulla</button>
        </div>
        <div style="border-bottom:1px solid #eee; margin-bottom:20px"></div>

        <div class="input-row-main">
            <div class="input-group">
                <label>Data</label>
                <input type="date" id="i-date">
            </div>
            <div class="input-group">
                <label>Fascia / Vasca</label>
                <select id="i-fascia">
                    <optgroup label="üèä Vasca Interna">
                        <option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option>
                        <option value="Pranzo">Pranzo</option><option value="Sera">Sera</option>
                        <option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option>
                        <option value="Festivo">Festivo</option><option value="Unico">Unico</option>
                    </optgroup>
                    <optgroup label="‚òÄÔ∏è Vasca Esterna">
                        <option value="Estiva - Mattina">Estiva - Mattina</option>
                        <option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option>
                    </optgroup>
                </select>
            </div>
            <div class="input-group">
                <label>Meteo</label>
                <select id="i-meteo">
                    <option>‚òÄÔ∏è Sole</option><option>‚õÖ Nuvoloso</option><option>üåßÔ∏è Pioggia</option><option>‚ùÑÔ∏è Freddo</option>
                </select>
            </div>
        </div>

        <div class="input-grid-tickets">
            <div class="ticket-box"><label>Intero</label><input type="number" id="q-intero" value="0" min="0" onfocus="this.select()"></div>
            <div class="ticket-box"><label>Ridotto</label><input type="number" id="q-ridotto" value="0" min="0" onfocus="this.select()"></div>
            <div class="ticket-box"><label>Gratuito</label><input type="number" id="q-gratuito" value="0" min="0" onfocus="this.select()"></div>
            <div class="ticket-box"><label>Abb. Int.</label><input type="number" id="q-abb-int" value="0" min="0" onfocus="this.select()"></div>
            <div class="ticket-box"><label>Abb. Rid.</label><input type="number" id="q-abb-rid" value="0" min="0" onfocus="this.select()"></div>
        </div>

        <button id="btn-save" class="btn btn-primary" onclick="saveData()">üíæ Salva nel Database</button>
    </div>

    <div style="display:grid; grid-template-rows: auto 1fr; gap:0">
        
        <div style="background:#e5e5ea; padding:5px; border-radius:12px 12px 0 0; display:flex; width:fit-content; margin-bottom:0">
            <button class="tab-btn active" id="tab-btn-dash" onclick="switchView('dash')">üìà Dashboard Avanzata</button>
            <button class="tab-btn" id="tab-btn-archive" onclick="switchView('archive')">üìã Archivio Dati</button>
        </div>

        <div id="view-dash" class="card" style="border-top-left-radius:0; background:#fafafa; border:1px solid #ddd">
            
            <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #eee">
                <span style="font-weight:bold; color:#555">üéØ Filtra Analisi:</span>
                <select id="dash-year" style="width:auto; padding:5px" onchange="renderDashboard()"><option value="all">Tutti gli Anni</option></select>
                <select id="dash-month" style="width:auto; padding:5px" onchange="renderDashboard()">
                    <option value="all">Tutto l'anno</option><option value="1">Gen</option><option value="2">Feb</option><option value="3">Mar</option>
                    <option value="4">Apr</option><option value="5">Mag</option><option value="6">Giu</option><option value="7">Lug</option><option value="8">Ago</option><option value="9">Set</option><option value="10">Ott</option><option value="11">Nov</option><option value="12">Dic</option>
                </select>
                <div style="margin-left:auto; font-size:1.2rem; font-weight:800; color:var(--primary)">Totale: <span id="dash-total-val">0</span></div>
            </div>

            <div class="analytics-grid">
                <div class="mini-stat-card">
                    <div class="card-title">‚õàÔ∏è Impatto Meteo (Media Ingressi)</div>
                    <canvas id="chartMeteo" style="max-height:200px"></canvas>
                    <p style="font-size:0.8rem; color:#888; margin-top:10px">Confronto media ingressi per condizione atmosferica.</p>
                </div>
                
                <div class="mini-stat-card">
                    <div class="card-title">üî• Fasce Orarie (Heatmap)</div>
                    <canvas id="chartFasce" style="max-height:200px"></canvas>
                </div>

                <div class="mini-stat-card">
                    <div class="card-title">üìÖ Giorni della Settimana</div>
                    <canvas id="chartWeek" style="max-height:200px"></canvas>
                </div>

                <div class="mini-stat-card">
                    <div class="card-title">üë• Composizione Clienti</div>
                    <div style="display:flex; align-items:center">
                        <div style="width:50%"><canvas id="chartPie"></canvas></div>
                        <div style="width:50%; padding-left:15px; font-size:0.9rem">
                            <div>üîµ Singoli: <b id="lbl-sing">0</b></div>
                            <div>üü† Abbonati: <b id="lbl-abb">0</b></div>
                            <div>üî¥ Gratuiti: <b id="lbl-grat">0</b></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="view-archive" class="card hidden" style="border-top-left-radius:0;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <div style="display:flex; gap:10px">
                    <select id="filter-year" style="width:auto; padding:5px" onchange="applyFilters()"><option value="all">Tutti</option></select>
                </div>
                <button class="btn btn-success" style="padding:6px 12px; font-size:0.8rem" onclick="downloadCSV()">üì• Export Excel</button>
            </div>
            <div style="overflow-y:auto; max-height:600px">
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background:#f9f9f9; text-transform:uppercase; font-size:0.75rem; color:#888;">
                            <th style="padding:10px; text-align:left">Data</th>
                            <th style="padding:10px; text-align:left">Fascia</th>
                            <th style="text-align:center">Sing.</th>
                            <th style="text-align:center">Abb.</th>
                            <th style="text-align:center">Tot</th>
                            <th style="text-align:right"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚úÖ CONFIGURAZIONE FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0",
      authDomain: "piscinastats-64519.firebaseapp.com",
      projectId: "piscinastats-64519",
      storageBucket: "piscinastats-64519.firebasestorage.app",
      messagingSenderId: "297663099794",
      appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let allData = [];
    let editId = null;

    // --- AUTH ---
    window.doLogin = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
        catch(e) { document.getElementById('login-error').innerText = e.message; }
    };
    window.doLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.email;
            startListening(); 
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    // --- DB LISTENER ---
    function startListening() {
        const q = query(collection(db, "sessioni"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            populateYearFilters();
            renderDashboard(); // Carica dashboard
            applyFilters(); // Carica archivio
        });
    }

    window.switchView = (view) => {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.getElementById(`tab-btn-${view}`).classList.add('active');
    };

    function populateYearFilters() {
        const years = [...new Set(allData.map(d => d.date.split('-')[0]))].sort().reverse();
        ['filter-year', 'dash-year'].forEach(id => {
            const sel = document.getElementById(id);
            const curr = sel.value;
            sel.innerHTML = '<option value="all">Tutti gli Anni</option>';
            years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
            if(years.includes(curr)) sel.value = curr;
        });
    }

    // --- DASHBOARD LOGIC (The Brain) ---
    window.renderDashboard = () => {
        const y = document.getElementById('dash-year').value;
        const m = document.getElementById('dash-month').value;

        // Filtra i dati
        const data = allData.filter(d => {
            const date = new Date(d.date);
            return ((y === 'all') || (date.getFullYear().toString() === y)) &&
                   ((m === 'all') || ((date.getMonth() + 1).toString() === m));
        });

        document.getElementById('dash-total-val').innerText = data.reduce((a,b)=>a+b.totale,0);

        // 1. METEO (Media)
        const meteoStats = {};
        data.forEach(d => {
            if(!meteoStats[d.meteo]) meteoStats[d.meteo] = {tot:0, count:0};
            meteoStats[d.meteo].tot += d.totale;
            meteoStats[d.meteo].count++;
        });
        const meteoLabels = Object.keys(meteoStats);
        const meteoData = meteoLabels.map(k => (meteoStats[k].tot / meteoStats[k].count).toFixed(0));
        renderBarChart('chartMeteo', meteoLabels, meteoData, 'Media Ingressi', '#5856d6');

        // 2. FASCE ORARIE (Totali)
        const fasceStats = {};
        data.forEach(d => {
            if(!fasceStats[d.fascia]) fasceStats[d.fascia] = 0;
            fasceStats[d.fascia] += d.totale;
        });
        // Ordina per valore
        const sortedFasce = Object.entries(fasceStats).sort((a,b)=>b[1]-a[1]);
        renderBarChart('chartFasce', sortedFasce.map(x=>x[0]), sortedFasce.map(x=>x[1]), 'Totale Ingressi', '#ff9500');

        // 3. GIORNI SETTIMANA
        const weekStats = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; // 0=Dom
        data.forEach(d => {
            const day = new Date(d.date).getDay();
            weekStats[day] += d.totale;
        });
        const weekLabels = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
        const weekData = [weekStats[0], weekStats[1], weekStats[2], weekStats[3], weekStats[4], weekStats[5], weekStats[6]];
        renderLineChart('chartWeek', weekLabels, weekData);

        // 4. PIE CHART
        let sing=0, abb=0, grat=0;
        data.forEach(d => {
            sing += (d.int||0) + (d.rid||0);
            abb += (d.abb_int||0) + (d.abb_rid||0);
            grat += (d.grat||0);
        });
        document.getElementById('lbl-sing').innerText = sing;
        document.getElementById('lbl-abb').innerText = abb;
        document.getElementById('lbl-grat').innerText = grat;
        renderDoughnut('chartPie', [sing, abb, grat]);
    };

    // Chart Helpers
    let charts = {};
    function renderBarChart(id, labels, data, label, color) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'bar',
            data: { labels, datasets: [{ label, data, backgroundColor: color, borderRadius:5 }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} }
        });
    }
    function renderLineChart(id, labels, data) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Trend Settimanale', data, borderColor: '#ff2d55', backgroundColor:'rgba(255,45,85,0.1)', fill:true, tension:0.3 }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} }
        });
    }
    function renderDoughnut(id, data) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: { labels: ['Singoli', 'Abbonati', 'Gratuiti'], datasets: [{ data, backgroundColor: ['#007aff', '#ff9500', '#ff3b30'] }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
    }

    // --- ARCHIVE LOGIC ---
    window.applyFilters = () => {
        const y = document.getElementById('filter-year').value;
        const filtered = allData.filter(d => (y === 'all') || (new Date(d.date).getFullYear().toString() === y));
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        filtered.forEach(d => {
            const isSummer = d.fascia.includes("Estiva");
            const badgeClass = isSummer ? 'badge badge-summer' : 'badge badge-std';
            const s = (d.int||0)+(d.rid||0);
            const a = (d.abb_int||0)+(d.abb_rid||0);
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee">
                    <td style="padding:10px">${d.date.split('-').reverse().join('/')} <br><small style="color:#999">${d.meteo}</small></td>
                    <td style="padding:10px"><span class="${badgeClass}">${d.fascia}</span></td>
                    <td style="text-align:center">${s}</td>
                    <td style="text-align:center">${a}</td>
                    <td style="text-align:center; font-weight:bold">${d.totale}</td>
                    <td style="text-align:right">
                        <button class="btn-edit" onclick="startEdit('${d.id}')">‚úèÔ∏è</button>
                        <button class="btn-del" onclick="delItem('${d.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    };

    // --- SAVE / EDIT / DEL ---
    window.saveData = async () => {
        const date = document.getElementById('i-date').value;
        const v1 = parseInt(document.getElementById('q-intero').value)||0;
        const v2 = parseInt(document.getElementById('q-ridotto').value)||0;
        const v3 = parseInt(document.getElementById('q-gratuito').value)||0;
        const v4 = parseInt(document.getElementById('q-abb-int').value)||0;
        const v5 = parseInt(document.getElementById('q-abb-rid').value)||0;
        const total = v1+v2+v3+v4+v5;

        if(!date || total===0) return alert("Dati incompleti");

        const payload = {
            date, fascia: document.getElementById('i-fascia').value,
            meteo: document.getElementById('i-meteo').value,
            int: v1, rid: v2, grat: v3, abb_int: v4, abb_rid: v5, totale: total,
            lastUpdate: new Date()
        };

        const btn = document.getElementById('btn-save'); btn.disabled=true; btn.innerText="Salvataggio...";
        try {
            if(editId) { await updateDoc(doc(db, "sessioni", editId), payload); cancelEdit(); }
            else { await addDoc(collection(db, "sessioni"), payload); resetInputs(); }
        } catch(e) { alert(e.message); }
        btn.disabled=false; btn.innerText= editId ? "Aggiorna" : "üíæ Salva nel Database";
    };

    function resetInputs() { document.querySelectorAll('.ticket-box input').forEach(i => i.value=0); }

    window.startEdit = (id) => {
        const item = allData.find(x=>x.id===id); if(!item) return;
        editId = id;
        document.getElementById('i-date').value = item.date;
        document.getElementById('i-fascia').value = item.fascia;
        document.getElementById('i-meteo').value = item.meteo;
        document.getElementById('q-intero').value = item.int;
        document.getElementById('q-ridotto').value = item.rid;
        document.getElementById('q-gratuito').value = item.grat;
        document.getElementById('q-abb-int').value = item.abb_int;
        document.getElementById('q-abb-rid').value = item.abb_rid;
        
        document.getElementById('input-card').classList.add('editing-mode');
        document.getElementById('form-title').innerText = "Modifica";
        document.getElementById('btn-save').innerText = "Aggiorna";
        document.getElementById('cancel-edit').classList.remove('hidden');
    };
    window.cancelEdit = () => {
        editId = null; document.getElementById('input-card').classList.remove('editing-mode');
        document.getElementById('form-title').innerText="Nuovo Inserimento"; document.getElementById('btn-save').innerText="üíæ Salva nel Database";
        document.getElementById('cancel-edit').classList.add('hidden'); resetInputs();
    };
    window.delItem = async (id) => { if(confirm("Eliminare?")) await deleteDoc(doc(db, "sessioni", id)); };

    window.downloadCSV = () => {
        const blob = new Blob([
            "Data;Fascia;Meteo;Singoli;Abbonamenti;Gratuiti;TOTALE\n" + 
            allData.map(d=>`${d.date};${d.fascia};${d.meteo};${(d.int||0)+(d.rid||0)};${(d.abb_int||0)+(d.abb_rid||0)};${d.grat};${d.totale}`).join("\n")
        ], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Report_Piscina.csv"; a.click();
    };

    document.getElementById('i-date').valueAsDate = new Date();
</script>

</body>
</html>
