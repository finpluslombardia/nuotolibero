<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piscina Facility Suite V49 Reordered</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #2563eb; 
            --bg-body: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #e9d5ff 100%);
            --text-main: #1e293b; --text-muted: #475569;
            --glass-bg: rgba(255, 255, 255, 0.45);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --glass-blur: blur(12px);
            --sidebar-glass: rgba(15, 23, 42, 0.85);
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; 
        }

        /* TOAST */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 40px rgba(37, 99, 235, 0.15); padding: 15px 25px; border-radius: 16px; color: var(--text-main); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-success { border-left: 5px solid #10b981; } .toast-error { border-left: 5px solid #ef4444; }

        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--sidebar-glass); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 30px 20px; font-size: 1.1rem; font-weight: 700; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .nav-section-title { padding: 20px 20px 10px; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 800; letter-spacing: 1px; }
        .nav-links { list-style: none; padding: 0 10px; margin: 0; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: #cbd5e1; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, var(--primary), #4f46e5); color: #fff; box-shadow: 0 0 15px rgba(37,99,235,0.4); border: 1px solid rgba(255,255,255,0.2); }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }

        /* CONTROL BAR */
        .control-bar { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); border-bottom: var(--glass-border); box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; transition: background 0.3s; }
        .control-bar.editing { background: rgba(254, 243, 199, 0.9); border-bottom: 2px solid #f59e0b; }
        .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .cb-title { font-weight: 800; color: var(--text-main); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
        .cb-row { display: flex; gap: 20px; align-items: stretch; }
        .inp-field { display: flex; flex-direction: column; flex: 1; }
        .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; }
        .inp-field input, .inp-field select { padding: 0 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); font-size: 0.95rem; height: 44px; color: var(--text-main); font-family: inherit; font-weight: 500; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .inp-field input:focus, .inp-field select:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
        .inp-locked { background: rgba(0,0,0,0.05) !important; color: #64748b !important; cursor: not-allowed; font-weight: 700; border: 1px solid rgba(0,0,0,0.1) !important; }
        .group-ctx { display: flex; gap: 15px; flex: 1; }
        .group-tickets { display: flex; gap: 15px; flex: 2; background: rgba(255, 255, 255, 0.3); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); }
        .group-chem { display: flex; gap: 10px; flex: 3; background: rgba(255, 255, 255, 0.3); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); }
        .group-actions { display: flex; align-items: stretch; gap: 10px; }
        .t-box { text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .t-box label { font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; text-align: center; width: 100%; opacity: 0.8; }
        .t-box input { width: 100%; text-align: center; font-weight: 800; color: var(--primary); font-size: 1.3rem; border: none; background: transparent; padding: 0; height: auto; font-family: inherit; text-shadow: 0 1px 1px rgba(255,255,255,0.8); }

        .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }
        .glass-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; }
        .page-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* BUTTONS */
        .btn { padding: 0 24px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; height: 44px; font-family: inherit; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-danger { background: rgba(254, 202, 202, 0.4); color: #dc2626; border: 1px solid rgba(252, 165, 165, 0.5); }
        .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 10px; }

        /* FILTERS & MULTI-SELECT */
        .filter-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
        .filter-select { padding: 0 15px; border-radius: 12px; height: 40px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); }
        .multi-select-container { position: relative; display: inline-block; }
        .multi-select-btn { padding: 0 20px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); font-size: 0.9rem; font-weight: 600; color: var(--text-main); cursor: pointer; display: flex; align-items: center; gap: 10px; min-width: 120px; justify-content: space-between; }
        .multi-select-dropdown { position: absolute; top: 110%; right: 0; width: 200px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 10px; z-index: 100; display: none; }
        .multi-select-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .multi-option { padding: 8px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 8px; transition: background 0.1s; user-select: none; }
        .multi-option:hover { background: rgba(37,99,235,0.1); }
        .multi-option input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }
        .multi-option span { font-size: 0.9rem; font-weight: 500; color: var(--text-main); flex: 1; }
        .benchmark-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.5); padding: 0 15px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.6); user-select: none; transition: all 0.2s; }
        .benchmark-toggle:hover { background: #fff; }
        .benchmark-toggle input { width: 18px; height: 18px; accent-color: #64748b; cursor: pointer; }
        .benchmark-toggle span { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }

        /* KPI & CHARTS LAYOUT */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { @extend .glass-card; padding: 20px; height: 130px; justify-content: center; background: rgba(255,255,255,0.55); }
        .kpi-head { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
        .kpi-val { font-size: 2.4rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
        .kpi-sub { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        
        .chart-card { @extend .glass-card; height: 360px; }
        .chart-wrapper { position: relative; flex: 1; width: 100%; height: 100%; min-height: 0; overflow: hidden; }
        
        /* GRID SYSTEM OPTIMIZED */
        .charts-row-main { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; } 
        .charts-row-split { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; } 

        /* TABLE */
        .table-wrap { @extend .glass-card; padding: 0; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { text-align: left; padding: 18px 12px; background: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.4); font-size: 0.9rem; vertical-align: middle; font-weight: 500; }
        tr:hover td { background: rgba(255,255,255,0.3); }
        tr.day-end td { border-bottom: 2px solid rgba(0,0,0,0.1) !important; }

        .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; backdrop-filter: blur(4px); }
        .badge-summer { background: rgba(255, 237, 213, 0.7); color: #ea580c; border: 1px solid rgba(253, 186, 116, 0.4); }
        .badge-std { background: rgba(219, 234, 254, 0.7); color: #2563eb; border: 1px solid rgba(147, 197, 253, 0.4); }
        .badge-ok { background: rgba(167, 243, 208, 0.7); color: #065f46; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-ko { background: rgba(254, 202, 202, 0.7); color: #991b1b; border: 1px solid rgba(239, 68, 68, 0.3); }

        .col-detail { color: var(--text-muted); font-size: 0.85rem; text-align: center; }
        .col-subtot { font-weight: 700; text-align: center; background: rgba(255,255,255,0.2); }
        .col-total { font-weight: 900; color: var(--text-main); text-align: center; font-size: 1.1rem; }
        .bg-sub-blue { background-color: rgba(59, 130, 246, 0.05); }
        .bg-sub-purp { background-color: rgba(168, 85, 247, 0.05); }

        .hidden { display: none !important; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #login-box { @extend .glass-card; width: 400px; padding: 40px; text-align: center; }
        .archive-toolbar { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.4); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: var(--glass-border); }
        .arch-input, .arch-select { height: 36px; padding: 0 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.9); font-size: 0.85rem; color: var(--text-main); font-weight: 600; }
        .trend-up { color: #16a34a; } .trend-down { color: #dc2626; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
    <div id="login-box" class="glass-card">
        <h2 style="color:var(--text-main); margin-bottom: 25px; font-weight: 900; font-size: 1.5rem;">üîê Accesso</h2>
        <div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div>
        <div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div>
        <button class="btn btn-primary" style="width:100%; font-size:1rem; height:48px;" onclick="doLogin()">Entra nel Gestionale</button>
        <p id="login-error" style="color:#dc2626; font-size:0.85rem; margin-top:20px; font-weight:600"></p>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">üèä‚Äç‚ôÇÔ∏è Facility Manager</div>
    <div class="nav-section-title">Ingressi</div>
    <ul class="nav-links"><li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">üé´ Nuoto Libero</li></ul>
    <div class="nav-section-title" style="margin-top:20px">Impianto</div>
    <ul class="nav-links">
        <li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')">üíß Valori Vasca</li>
        <li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')">‚ö° Controllo DAE</li>
    </ul>
    <div class="sidebar-footer">
        <div style="font-size:0.85rem; margin-bottom:15px; color:#cbd5e1; font-weight:600" id="user-display">User</div>
        <button class="btn" style="width:100%; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-size:0.8rem; height:38px" onclick="doLogout()">Disconnetti</button>
    </div>
</div>

<div class="main-content">

    <div id="module-ingressi" class="module-container" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar" id="cb-ingressi">
            <div class="cb-header">
                <span class="cb-title" id="title-ingressi">Registrazione Ingressi</span>
                <button class="btn btn-danger hidden" id="cancel-ingressi" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditIngressi()">Annulla Modifica</button>
            </div>
            <div class="cb-row">
                <div class="group-ctx">
                    <div class="inp-field" style="flex:0.8"><label>Data</label><input type="date" id="i-date"></div>
                    <div class="inp-field" style="flex:1.2"><label>Fascia</label>
                        <select id="i-fascia"><optgroup label="üèä Vasca Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="‚òÄÔ∏è Vasca Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
                    </div>
                    <div class="inp-field" style="flex:1"><label>Meteo</label>
                        <select id="i-meteo"><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="üî• Sole + Caldo">üî• Sole + Caldo</option><option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option><option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option><option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option><option value="‚ùì N/D">‚ùì N/D</option></select>
                    </div>
                </div>
                <div class="group-tickets">
                    <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB. PERIODO</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB. 11 INGR.</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>GRATUITO</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
                </div>
                <div class="group-actions"><button id="btn-save-ingressi" class="btn btn-primary" style="height:100%; min-width:120px" onclick="saveIngressi()">SALVA</button></div>
            </div>
        </div>

        <div class="scroll-area">
            <div class="filter-row" style="margin-bottom:20px; justify-content:center">
                <button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button>
                <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-stats" onclick="switchSubView('stats')">Statistiche</button>
                <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button>
            </div>

            <div id="sub-overview">
                <div class="kpi-grid">
                    <div class="kpi-card glass-card"><div class="kpi-head">Media (Mese)</div><div class="kpi-val" id="ov-avg">0</div><div class="kpi-sub">persone / giorno</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Vs Mese Prec.</div><div class="kpi-val" id="ov-mom">0%</div><div class="kpi-sub" id="ov-mom-label">-</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Vs Anno Prec.</div><div class="kpi-val" id="ov-yoy">0%</div><div class="kpi-sub" id="ov-yoy-label">-</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Stima Fine Mese</div><div class="kpi-val" id="ov-forecast" style="color:#a855f7">-</div><div class="kpi-sub" id="ov-forecast-sub">proiezione</div></div>
                </div>
                <div class="chart-card glass-card"><div class="chart-header">Andamento Ultimi 30 Giorni vs Anno Prec.</div><div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div></div>
                <div class="chart-card glass-card" style="margin-top:20px"><div class="chart-header">Andamento Ultimi 12 Mesi vs Anno Prec.</div><div class="chart-wrapper"><canvas id="chartRecent12M"></canvas></div></div>
            </div>

            <div id="sub-stats" class="hidden">
                <div class="filter-row" style="justify-content:flex-end">
                    <label class="benchmark-toggle"><input type="checkbox" id="show-history" onchange="renderStats()"><span>Confronta con Storico</span></label>
                    <select id="stat-mode" class="filter-select" onchange="renderStats()" style="font-weight:700"><option value="avg">üìä Media</option><option value="total">‚àë Totale</option></select>
                    <div class="multi-select-container"><div class="multi-select-btn" onclick="toggleMultiYear()">üìÖ Anni <span id="year-count" style="font-size:0.8rem;background:rgba(0,0,0,0.1);padding:2px 6px;border-radius:4px;margin-left:5px">Tutti</span></div><div class="multi-select-dropdown" id="year-dropdown"></div></div>
                    <select id="dash-month" class="filter-select" onchange="renderStats()"><option value="all">Tutto l'anno</option><option value="1">Gen</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">Mag</option><option value="6">Giu</option><option value="7">Lug</option><option value="8">Ago</option><option value="9">Set</option><option value="10">Ott</option><option value="11">Nov</option><option value="12">Dic</option></select>
                </div>

                <div class="charts-row-main">
                    <div class="chart-card glass-card">
                        <div class="chart-header" id="yoy-title">Andamento Stagionale</div>
                        <div class="chart-wrapper"><canvas id="chartYoY"></canvas></div>
                    </div>
                </div>

                <div class="charts-row-main">
                    <div class="chart-card glass-card">
                        <div class="chart-header">Performance Settimanale</div>
                        <div class="chart-wrapper"><canvas id="chartWeek"></canvas></div>
                    </div>
                </div>

                <div class="charts-row-split">
                    <div class="chart-card glass-card" style="justify-content:center; text-align:center">
                        <div class="chart-header" style="width:100%; text-align:left">Composizione Dettagliata</div>
                        <div class="chart-wrapper" style="max-height:220px; display:flex; justify-content:center"><canvas id="chartPie"></canvas></div>
                        <div style="margin-top:auto; width:100%; padding-top:15px; border-top:1px solid rgba(0,0,0,0.05)">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; font-weight:700" id="pie-label-text">TOTALE SELEZIONE</div>
                            <div id="deep-total" style="color:var(--primary); font-size:1.8rem; font-weight:900">0</div>
                        </div>
                    </div>
                    <div class="chart-card glass-card">
                        <div class="chart-header">Performance Meteo</div>
                        <div class="chart-wrapper"><canvas id="chartMeteo"></canvas></div>
                    </div>
                </div>

                <div class="charts-row-main">
                    <div class="chart-card glass-card">
                        <div class="chart-header">Popolarit√† Fasce Orarie</div>
                        <div class="chart-wrapper"><canvas id="chartFasce"></canvas></div>
                    </div>
                </div>

            </div>

            <div id="sub-archive" class="hidden">
                <div class="archive-toolbar">
                    <div class="arch-group"><span class="arch-label">DA:</span><input type="date" id="arch-date-start" class="arch-input" onchange="renderIngressiArchive()"></div>
                    <div class="arch-group"><span class="arch-label">A:</span><input type="date" id="arch-date-end" class="arch-input" onchange="renderIngressiArchive()"></div>
                    <select id="arch-filter-fascia" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutte le Fasce</option><optgroup label="Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
                    <select id="arch-filter-meteo" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutto il Meteo</option><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="üî• Sole + Caldo">üî• Sole + Caldo</option><option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option><option value="‚ùì N/D">‚ùì N/D</option></select>
                    <select id="arch-sort" class="arch-select" style="min-width:100px" onchange="renderIngressiArchive()"><option value="desc">‚¨áÔ∏è Recenti</option><option value="asc">‚¨ÜÔ∏è Vecchi</option></select>
                    <button class="btn btn-danger" style="height:36px; width:36px; padding:0" onclick="resetArchiveFilters()">‚úï</button>
                    <button class="btn btn-primary" style="height:36px; font-size:0.8rem; padding:0 20px" onclick="downloadCSV()">Scarica Excel</button>
                </div>
                <div class="table-wrap glass-card">
                    <div style="overflow-x:auto;">
                        <table id="table-ingressi">
                            <thead><tr><th>Data</th><th>Fascia / Meteo</th><th>Int.</th><th>Rid.</th><th>Singoli</th><th>Per.</th><th>11 Ingr.</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right"></th></tr></thead>
                            <tbody id="tbody-ingressi"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="module-vasca" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar" id="cb-vasca">
            <div class="cb-header"><span class="cb-title" id="title-vasca">Registrazione Valori Vasca</span><button class="btn btn-danger hidden" id="cancel-vasca" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditVasca()">Annulla Modifica</button></div>
            <div class="cb-row">
                <div class="group-ctx" style="flex:0.6"><div class="inp-field"><label>Data</label><input type="date" id="v-date"></div><div class="inp-field"><label>Orario</label><input type="time" id="v-time"></div></div>
                <div class="group-chem">
                    <div class="t-box"><label>BAGNANTI</label><input type="number" id="v-bag" value="0"></div><div class="t-box"><label>T. ARIA</label><input type="number" step="0.1" id="v-ta" value="0"></div><div class="t-box"><label>T. H2O</label><input type="number" step="0.1" id="v-th" value="0"></div><div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div><div class="t-box"><label>CL LIB.</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div><div class="t-box"><label>CL COMB.</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div><div class="t-box"><label>CL TOT.</label><input type="number" step="0.1" id="v-clt" value="0"></div>
                </div>
                <div class="group-actions"><button id="btn-save-vasca" class="btn btn-primary" style="height:100%; min-width:120px" onclick="saveVasca()">SALVA</button></div>
            </div>
        </div>
        <div class="scroll-area">
            <h2 class="page-title">üíß Diario Vasca</h2>
            <div class="table-wrap glass-card"><div style="overflow-x:auto;"><table id="table-vasca"><thead><tr><th>Data</th><th>Ora</th><th>Bagnanti</th><th>T. Aria</th><th>T. Acqua</th><th>pH</th><th>Cl Lib</th><th>Cl Comb</th><th>Cl Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-vasca"></tbody></table></div></div>
        </div>
    </div>

    <div id="module-dae" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar">
            <div class="cb-header"><span class="cb-title">Controllo Defibrillatore (DAE)</span></div>
            <div class="cb-row">
                <div class="group-ctx">
                    <div class="inp-field" style="flex:0.5"><label>Data</label><input type="date" id="d-date" class="inp-locked" readonly></div><div class="inp-field" style="flex:0.5"><label>Ora Controllo</label><input type="text" id="d-time" class="inp-locked" readonly></div>
                    <div class="inp-field" style="flex:0.8"><label>Stato</label><select id="d-status"><option value="OK">‚úÖ Funzionante</option><option value="GUASTO">‚ùå Guasto / Anomalie</option></select></div>
                    <div class="inp-field" style="flex:1"><label>Assistente Bagnanti</label><input type="text" id="d-ass" placeholder="Nome Cognome"></div><div class="inp-field" style="flex:1"><label>Operatore Segreteria</label><input type="text" id="d-op" placeholder="Nome Cognome"></div>
                </div>
                <div class="group-actions"><button class="btn btn-primary" style="height:100%; min-width:120px" onclick="saveDae()">REGISTRA</button></div>
            </div>
        </div>
        <div class="scroll-area">
            <h2 class="page-title">‚ö° Registro Controlli DAE</h2>
            <div class="table-wrap glass-card"><div style="overflow-x:auto;"><table id="table-dae"><thead><tr><th>Data</th><th>Ora</th><th>Stato</th><th>Assistente Bagnanti</th><th>Operatore Segreteria</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-dae"></tbody></table></div></div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
    let dataIngressi=[], dataVasca=[], dataDae=[]; let editIdIngressi=null, editIdVasca=null;

    window.showToast = (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className = `toast toast-${type}`; e.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> ${msg}`; c.appendChild(e); requestAnimationFrame(()=>e.classList.add('show')); setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); };
    window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('login-error').innerText = e.message; } };
    window.doLogout = () => signOut(auth);
    onAuthStateChanged(auth, (u) => { if(u){ document.getElementById('login-screen').classList.add('hidden'); document.getElementById('user-display').innerText=u.email.split('@')[0]; startListening(); } else { document.getElementById('login-screen').classList.remove('hidden'); } });

    function startListening() {
        onSnapshot(query(collection(db, "sessioni"), orderBy("date", "desc")), (snap) => { dataIngressi = snap.docs.map(d=>({id:d.id,...d.data()})); populateYearFilters(); refreshCurrentView(); });
        onSnapshot(query(collection(db, "valori_vasca"), orderBy("date", "desc")), (snap) => { dataVasca = snap.docs.map(d=>({id:d.id,...d.data()})); if(!document.getElementById('module-vasca').classList.contains('hidden')) renderVasca(); });
        onSnapshot(query(collection(db, "dae_log"), orderBy("date", "desc"), orderBy("time", "desc")), (snap) => { dataDae = snap.docs.map(d=>({id:d.id,...d.data()})); if(!document.getElementById('module-dae').classList.contains('hidden')) renderDae(); });
    }

    // MULTI-SELECT YEAR LOGIC
    let selectedYears = [];
    window.toggleMultiYear = () => { document.getElementById('year-dropdown').classList.toggle('show'); };
    window.updateSelectedYears = () => {
        const checkboxes = document.querySelectorAll('.year-checkbox');
        selectedYears = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
        document.getElementById('year-count').innerText = selectedYears.length > 0 ? selectedYears.length + ' selezionati' : 'Tutti';
        renderStats();
    };
    function populateYearFilters(){ 
        const y=[...new Set(dataIngressi.map(d=>d.date.split('-')[0]))].sort().reverse(); 
        const container = document.getElementById('year-dropdown');
        container.innerHTML = '';
        y.forEach(year => {
            container.innerHTML += `
                <label class="multi-option">
                    <input type="checkbox" class="year-checkbox" value="${year}" onchange="updateSelectedYears()">
                    <span>${year}</span>
                </label>`;
        });
    }
    window.addEventListener('click', function(e){ if(!document.querySelector('.multi-select-container').contains(e.target)) document.getElementById('year-dropdown').classList.remove('show'); });

    // RENDER STATS (V49: REORDERED & PIE LOGIC)
    window.renderStats = () => {
        const m = document.getElementById('dash-month').value;
        const mode = document.getElementById('stat-mode').value; 
        const showHistory = document.getElementById('show-history').checked;
        
        const f = dataIngressi.filter(d => {
            const dt = new Date(d.date);
            const yMatch = selectedYears.length === 0 || selectedYears.includes(dt.getFullYear().toString());
            const mMatch = m === 'all' || (dt.getMonth() + 1).toString() === m;
            return yMatch && mMatch;
        });

        // 1. CHART YoY (Line)
        let labels=[], sets=[];
        const avgMonthlyTotals = new Array(12).fill(0);
        const uniqueYears = new Set(dataIngressi.map(d=>d.date.split('-')[0])).size;
        dataIngressi.forEach(d => { avgMonthlyTotals[new Date(d.date).getMonth()] += d.totale; });
        const avgData = avgMonthlyTotals.map(t => uniqueYears > 0 ? t/uniqueYears : 0);
        const historyDataset = { label: 'Media Storica', data: avgData, borderColor: '#9ca3af', borderDash: [5,5], borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 };
        const colors = ['#2563eb', '#a855f7', '#f59e0b', '#10b981', '#ef4444'];

        if(selectedYears.length > 0) {
            document.getElementById('yoy-title').innerText = "Confronto Annuale";
            labels = m !== 'all' ? Array.from({length:31},(_,i)=>i+1) : ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
            selectedYears.forEach((year, idx) => {
                const yd = new Array(labels.length).fill(0);
                dataIngressi.filter(d => d.date.startsWith(year) && (m==='all' || (new Date(d.date).getMonth()+1)==m))
                            .forEach(d => yd[m!=='all' ? new Date(d.date).getDate()-1 : new Date(d.date).getMonth()] += d.totale);
                sets.push({ label: year, data: yd, borderColor: colors[idx % colors.length], backgroundColor: colors[idx % colors.length]+'20', fill: false, tension: 0.4 });
            });
            if(showHistory && m === 'all') { sets.push(historyDataset); }
        } else {
            document.getElementById('yoy-title').innerText = "Media Storica (Tutti gli Anni)";
            labels=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
            sets=[{...historyDataset, borderColor:'#2563eb', borderDash:[], backgroundColor:'rgba(37,99,235,0.1)', fill:true, pointRadius:3}];
        }
        renderChart('chartYoY', 'line', labels, sets);

        // 2. PIE (SMART AVG/TOTAL)
        let t = { 'Intero':0, 'Ridotto':0, 'Abb. Per.':0, 'Abb. 11':0, 'Gratis':0 };
        f.forEach(d => { t['Intero'] += d.int||0; t['Ridotto'] += d.rid||0; t['Abb. Per.'] += d.abb_int||0; t['Abb. 11'] += d.abb_rid||0; t['Gratis'] += d.grat||0; });
        
        let totalVal = f.reduce((a,b)=>a+b.totale,0);
        let displayTotal = totalVal;
        let pieData = Object.values(t);

        if(mode === 'avg') {
            const uniqueDays = new Set(f.map(d => d.date)).size || 1;
            displayTotal = (totalVal / uniqueDays).toFixed(0);
            pieData = pieData.map(v => (v / uniqueDays).toFixed(1)); // Avg per day
            document.getElementById('pie-label-text').innerText = "MEDIA GIORNALIERA";
        } else {
            document.getElementById('pie-label-text').innerText = "TOTALE SELEZIONE";
        }
        
        document.getElementById('deep-total').innerText = parseFloat(displayTotal).toLocaleString();
        renderPie('chartPie', Object.keys(t), pieData);

        // HELPERS FOR MULTI-SERIES BAR
        const buildMultiSeries = (extractor, sortLabels=false) => {
            let yearsToUse = selectedYears.length > 0 ? selectedYears : [];
            let allLabels = new Set();
            dataIngressi.forEach(d => allLabels.add(extractor(d).key));
            let sortedL = Array.from(allLabels); if(sortLabels) sortedL.sort();
            
            let historyDataPoints = sortedL.map(l => {
                let subset = dataIngressi.filter(d => extractor(d).key === l && (m==='all'||(new Date(d.date).getMonth()+1)==m));
                if(subset.length===0) return 0;
                let sum = subset.reduce((a,b) => a + extractor(b).val, 0);
                return mode==='avg' ? (sum/subset.length).toFixed(0) : sum;
            });
            const historyBarSet = { label: 'Media Storica', data: historyDataPoints, backgroundColor: '#cbd5e1', borderRadius:4 };

            let datasets = [];
            if(yearsToUse.length === 0) {
                datasets.push({ ...historyBarSet, backgroundColor: '#2563eb' });
            } else {
                yearsToUse.forEach((y, idx) => {
                    let dataPoints = sortedL.map(l => {
                        let subset = dataIngressi.filter(d => d.date.startsWith(y) && extractor(d).key === l && (m==='all'||(new Date(d.date).getMonth()+1)==m));
                        if(subset.length===0) return 0;
                        let sum = subset.reduce((a,b) => a + extractor(b).val, 0);
                        return mode==='avg' ? (sum/subset.length).toFixed(0) : sum;
                    });
                    datasets.push({ label: y, data: dataPoints, backgroundColor: colors[idx % colors.length], borderRadius:4 });
                });
                if(showHistory) datasets.push(historyBarSet);
            }
            return { labels: sortedL, datasets };
        };

        const meteoData = buildMultiSeries(d => ({key: d.meteo, val: d.totale}));
        renderMultiBar('chartMeteo', meteoData.labels, meteoData.datasets);

        const weekLabels = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom']; // FIXED ORDER
        let weekSets = [];
        
        // Helper to get JS day index (0-6) from our ordered label index (0=Lun...6=Dom)
        // JS: 0=Sun, 1=Mon...6=Sat. 
        // Label 0 (Lun) -> JS 1. Label 6 (Dom) -> JS 0.
        const getJsDay = (i) => (i + 1) % 7;

        let historyWeekData = weekLabels.map((_, i) => {
             let subset = dataIngressi.filter(d => new Date(d.date).getDay() === getJsDay(i) && (m==='all'||(new Date(d.date).getMonth()+1)==m));
             if(subset.length===0) return 0;
             let sum = subset.reduce((a,b)=>a+b.totale,0);
             return mode==='avg' ? (sum/subset.length).toFixed(0) : sum;
        });

        if(selectedYears.length === 0) {
            weekSets.push({ label: 'Media Storica', data: historyWeekData, backgroundColor: '#8b5cf6', borderRadius:4 });
        } else {
            selectedYears.forEach((y, idx) => {
                let dataP = weekLabels.map((_, i) => {
                    let subset = dataIngressi.filter(d => d.date.startsWith(y) && new Date(d.date).getDay() === getJsDay(i) && (m==='all'||(new Date(d.date).getMonth()+1)==m));
                    if(subset.length===0) return 0;
                    let sum = subset.reduce((a,b)=>a+b.totale,0);
                    return mode==='avg' ? (sum/subset.length).toFixed(0) : sum;
                });
                weekSets.push({ label: y, data: dataP, backgroundColor: colors[idx % colors.length], borderRadius:4 });
            });
            if(showHistory) weekSets.push({ label: 'Media Storica', data: historyWeekData, backgroundColor: '#cbd5e1', borderRadius:4 });
        }
        renderMultiBar('chartWeek', weekLabels, weekSets);

        const fasceData = buildMultiSeries(d => ({key: d.fascia, val: d.totale}), true);
        renderMultiBar('chartFasce', fasceData.labels, fasceData.datasets, 'y');
    };

    // ... (SAVE LOGIC UNCHANGED) ...
    window.saveIngressi = async () => { const date = document.getElementById('i-date').value; if(!date) return showToast("Data mancante","error"); const payload = { date, fascia:document.getElementById('i-fascia').value, meteo:document.getElementById('i-meteo').value, int:parseInt(document.getElementById('q-intero').value)||0, rid:parseInt(document.getElementById('q-ridotto').value)||0, grat:parseInt(document.getElementById('q-gratuito').value)||0, abb_int:parseInt(document.getElementById('q-abb-int').value)||0, abb_rid:parseInt(document.getElementById('q-abb-rid').value)||0, totale:(parseInt(document.getElementById('q-intero').value)||0)+(parseInt(document.getElementById('q-ridotto').value)||0)+(parseInt(document.getElementById('q-gratuito').value)||0)+(parseInt(document.getElementById('q-abb-int').value)||0)+(parseInt(document.getElementById('q-abb-rid').value)||0) }; if(payload.totale===0) return showToast("Inserisci dati","error"); try { if(editIdIngressi) { await updateDoc(doc(db,"sessioni",editIdIngressi), payload); showToast("Aggiornato"); cancelEditIngressi(); } else { await addDoc(collection(db,"sessioni"), payload); showToast("Salvato"); document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); } } catch(e){ showToast(e.message,"error"); } };
    window.editIngressi = (id) => { const d = dataIngressi.find(x=>x.id===id); if(!d) return; editIdIngressi = id; document.getElementById('i-date').value=d.date; document.getElementById('i-fascia').value=d.fascia; document.getElementById('i-meteo').value=d.meteo; document.getElementById('q-intero').value=d.int; document.getElementById('q-ridotto').value=d.rid; document.getElementById('q-gratuito').value=d.grat; document.getElementById('q-abb-int').value=d.abb_int; document.getElementById('q-abb-rid').value=d.abb_rid; document.getElementById('title-ingressi').innerText="Modifica Ingressi"; document.getElementById('btn-save-ingressi').innerText="AGGIORNA"; document.getElementById('btn-save-ingressi').style.background="#f59e0b"; document.getElementById('cancel-ingressi').classList.remove('hidden'); document.getElementById('cb-ingressi').classList.add('editing'); window.scrollTo({top:0,behavior:'smooth'}); };
    window.cancelEditIngressi = () => { editIdIngressi=null; document.getElementById('title-ingressi').innerText="Registrazione Ingressi"; document.getElementById('btn-save-ingressi').innerText="SALVA"; document.getElementById('btn-save-ingressi').style.background=""; document.getElementById('cancel-ingressi').classList.add('hidden'); document.getElementById('cb-ingressi').classList.remove('editing'); document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); };
    window.saveVasca = async () => { const date = document.getElementById('v-date').value; const time = document.getElementById('v-time').value; if(!date || !time) return showToast("Data/Ora mancanti","error"); const payload = { date, time, bag:document.getElementById('v-bag').value, ta:document.getElementById('v-ta').value, th:document.getElementById('v-th').value, ph:document.getElementById('v-ph').value, cll:document.getElementById('v-cll').value, clc:document.getElementById('v-clc').value, clt:document.getElementById('v-clt').value }; try { if(editIdVasca){ await updateDoc(doc(db,"valori_vasca",editIdVasca), payload); showToast("Aggiornato"); cancelEditVasca(); } else { await addDoc(collection(db,"valori_vasca"), payload); showToast("Salvato"); } } catch(e){ showToast(e.message,"error"); } };
    window.editVasca = (id) => { const d = dataVasca.find(x=>x.id===id); if(!d)return; editIdVasca=id; document.getElementById('v-date').value=d.date; document.getElementById('v-time').value=d.time; document.getElementById('v-bag').value=d.bag; document.getElementById('v-ta').value=d.ta; document.getElementById('v-th').value=d.th; document.getElementById('v-ph').value=d.ph; document.getElementById('v-cll').value=d.cll; document.getElementById('v-clc').value=d.clc; document.getElementById('v-clt').value=d.clt; document.getElementById('title-vasca').innerText="Modifica Valori"; document.getElementById('btn-save-vasca').innerText="AGGIORNA"; document.getElementById('btn-save-vasca').style.background="#f59e0b"; document.getElementById('cancel-vasca').classList.remove('hidden'); document.getElementById('cb-vasca').classList.add('editing'); window.scrollTo({top:0,behavior:'smooth'}); };
    window.cancelEditVasca = () => { editIdVasca=null; document.getElementById('title-vasca').innerText="Registrazione Valori"; document.getElementById('btn-save-vasca').innerText="SALVA"; document.getElementById('btn-save-vasca').style.background=""; document.getElementById('cancel-vasca').classList.add('hidden'); document.getElementById('cb-vasca').classList.remove('editing'); };
    window.calcClTot = () => { document.getElementById('v-clt').value = ((parseFloat(document.getElementById('v-cll').value)||0) + (parseFloat(document.getElementById('v-clc').value)||0)).toFixed(2); };
    window.saveDae = async () => { const d=document.getElementById('d-date').value||new Date().toISOString().split('T')[0]; const a=document.getElementById('d-ass').value; const o=document.getElementById('d-op').value; if(!a||!o) return showToast("Compila nomi","error"); try { await addDoc(collection(db,"dae_log"),{date:d,time:new Date().toLocaleTimeString(),ass:a,op:o,status:document.getElementById('d-status').value}); document.getElementById('d-ass').value=""; document.getElementById('d-op').value=""; showToast("DAE Registrato!"); } catch(e){ showToast(e.message,"error"); } };
    window.delDoc = async (c,i) => { if(confirm("Eliminare?")){ await deleteDoc(doc(db,c,i)); showToast("Eliminato"); } };
    
    // NAVIGATION
    window.switchModule=(m)=>{ document.querySelectorAll('.module-container').forEach(e=>e.classList.add('hidden')); document.getElementById('module-'+m).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-module-'+m).classList.add('active'); if(m==='ingressi')refreshCurrentView(); if(m==='vasca')renderVasca(); if(m==='dae')renderDae(); };
    window.switchSubView=(s)=>{ ['overview','stats','archive'].forEach(v=>{ document.getElementById('sub-'+v).classList.add('hidden'); document.getElementById('btn-sub-'+v).classList.remove('btn-primary'); }); document.getElementById('sub-'+s).classList.remove('hidden'); document.getElementById('btn-sub-'+s).classList.add('btn-primary'); refreshCurrentView(); };
    function refreshCurrentView(){ if(!document.getElementById('sub-overview').classList.contains('hidden')) renderOverview(); if(!document.getElementById('sub-stats').classList.contains('hidden')) renderStats(); if(!document.getElementById('sub-archive').classList.contains('hidden')) renderIngressiArchive(); }

    function renderOverview() { const n=new Date(); const y=n.getFullYear(); const m=n.getMonth()+1; const d=dataIngressi.filter(x=>{const dt=new Date(x.date); return dt.getFullYear()===y && (dt.getMonth()+1)===m}); const t=d.reduce((a,b)=>a+b.totale,0); const days=new Set(d.map(x=>x.date)).size; document.getElementById('ov-avg').innerText = days>0?(t/days).toFixed(0):0; const l30=new Date(); l30.setDate(l30.getDate()-30); const rd=dataIngressi.filter(x=>new Date(x.date)>=l30).sort((a,b)=>new Date(a.date)-new Date(b.date)); const dm={}; rd.forEach(x=>{const k=x.date.split('-').slice(1).reverse().join('/'); if(!dm[k])dm[k]=0; dm[k]+=x.totale;}); renderLineChart('chartRecent30', Object.keys(dm), Object.values(dm), '#2563eb'); 
    const m12=[], m12_prev=[], m_labels=[]; const today=new Date();
        for(let i=11; i>=0; i--) {
            const date=new Date(today.getFullYear(), today.getMonth()-i, 1); m_labels.push(date.toLocaleString('it-IT',{month:'short'}));
            m12.push(dataIngressi.filter(x=>{const xd=new Date(x.date); return xd.getMonth()===date.getMonth() && xd.getFullYear()===date.getFullYear()}).reduce((a,b)=>a+b.totale,0));
            m12_prev.push(dataIngressi.filter(x=>{const xd=new Date(x.date); return xd.getMonth()===date.getMonth() && xd.getFullYear()===(date.getFullYear()-1)}).reduce((a,b)=>a+b.totale,0));
        }
        renderLineChart('chartRecent12M', m_labels, [{data:m12, borderColor:'#2563eb', fill:true},{data:m12_prev, borderColor:'#94a3b8', borderDash:[5,5], fill:false}]);
    }
    function renderVasca() { const t=document.getElementById('tbody-vasca'); t.innerHTML=""; const g=new Map(); dataVasca.forEach(d=>{if(!g.has(d.date))g.set(d.date,[]);g.get(d.date).push(d)}); [...g.keys()].forEach(k=>{ const e=g.get(k); e.sort((a,b)=>b.time.localeCompare(a.time)); const dh=`<div style="font-weight:800;color:#1e293b">${k.split('-').reverse().join('/')}</div>`; e.forEach((d,i)=>{ const b=i===e.length-1?"border-bottom:2px solid rgba(0,0,0,0.1)":"border-bottom:1px solid rgba(0,0,0,0.05)"; t.innerHTML+=`<tr style="${b}">${i===0?`<td rowspan="${e.length}" style="vertical-align:middle;background:rgba(255,255,255,0.4)">${dh}</td>`:''} <td style="font-weight:700;color:#2563eb">${d.time}</td><td>${d.bag}</td><td>${d.ta}¬∞</td><td>${d.th}¬∞</td><td style="font-weight:600">${d.ph}</td><td>${d.cll}</td><td>${d.clc}</td><td style="font-weight:700">${d.clt}</td> <td style="text-align:right"><button class="btn btn-icon" style="color:var(--primary);background:#eef2ff" onclick="editVasca('${d.id}')">‚úèÔ∏è</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('valori_vasca','${d.id}')">üóëÔ∏è</button></td></tr>`; }); }); }
    function renderDae() { const t=document.getElementById('tbody-dae'); t.innerHTML=""; [...dataDae].sort((a,b)=>new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time)).forEach(d=>{ const b=d.status==='OK'?'<span class="badge badge-ok">‚úÖ OK</span>':'<span class="badge badge-ko">‚ùå GUASTO</span>'; t.innerHTML+=`<tr><td style="font-weight:700">${d.date.split('-').reverse().join('/')}</td><td style="color:#2563eb;font-weight:600">${d.time}</td><td>${b}</td><td>${d.ass}</td><td>${d.op}</td><td style="text-align:right"><button class="btn btn-icon" style="color:#ef4444" onclick="delDoc('dae_log','${d.id}')">üóëÔ∏è</button></td></tr>`; }); }
    function renderIngressiArchive() { const s=document.getElementById('arch-sort').value; const f=dataIngressi.filter(d=>true); /* Filter logic in helper */ f.sort((a,b)=>{const da=new Date(a.date), db=new Date(b.date); return s==='desc'?db-da:da-db}); const t=document.getElementById('tbody-ingressi'); t.innerHTML=""; const g=new Map(); f.forEach(d=>{if(!g.has(d.date))g.set(d.date,[]); g.get(d.date).push(d)}); [...g.keys()].forEach(k=>{ const e=g.get(k); const dh=`<div style="font-weight:800;font-size:0.95rem;color:#1e293b">${k.split('-').reverse().join('/')}</div><div style="font-size:0.8rem;color:#64748b">${new Date(k).toLocaleDateString('it-IT',{weekday:'short'}).toUpperCase()}</div>`; e.forEach((d,i)=>{ const b=i===e.length-1?"border-bottom:2px solid rgba(0,0,0,0.1)":"border-bottom:1px solid rgba(0,0,0,0.05)"; t.innerHTML+=`<tr style="${b}">${i===0?`<td rowspan="${e.length}" style="vertical-align:middle;background:rgba(255,255,255,0.4)">${dh}</td>`:''} <td><b>${d.fascia}</b><br><small style="color:#64748b">${d.meteo}</small></td> <td class="col-detail bg-sub-blue">${d.int}</td><td class="col-detail bg-sub-blue">${d.rid}</td><td class="col-subtot bg-sub-blue" style="color:var(--primary)">${(d.int||0)+(d.rid||0)}</td> <td class="col-detail bg-sub-purp">${d.abb_int}</td><td class="col-detail bg-sub-purp">${d.abb_rid}</td><td class="col-subtot bg-sub-purp" style="color:#a855f7">${(d.abb_int||0)+(d.abb_rid||0)}</td> <td class="col-detail">${d.grat}</td><td class="col-total">${d.totale}</td> <td style="text-align:right"><button class="btn btn-icon" style="color:var(--primary);background:#eef2ff" onclick="editIngressi('${d.id}')">‚úèÔ∏è</button><button class="btn btn-icon" style="color:#ef4444;background:#fef2f2" onclick="delDoc('sessioni','${d.id}')">üóëÔ∏è</button></td></tr>`; }); }); }

    // CHART HELPERS
    let ch={}; const opts={responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}};
    function renderLineChart(id,l,sets) { if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'line',data:{labels:l,datasets:sets.map(s=>({...s, tension:0.4, backgroundColor:s.fill?s.borderColor+'20':undefined}))},options:opts}); }
    function renderBar(id,l,d,c,ax='x') { if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels:l,datasets:[{data:d,backgroundColor:c,borderRadius:6}]},options:{...opts,indexAxis:ax}}); }
    function renderPie(id,l,d) { if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'doughnut',data:{labels:l,datasets:[{data:d,backgroundColor:['#2563eb','#60a5fa','#a855f7','#d8b4fe','#f59e0b','#ef4444'],borderWidth:0}]},options:{...opts,plugins:{legend:{position:'right',labels:{usePointStyle:true}}}}}); }
    function renderChart(id,t,l,ds) { if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:t,data:{labels:l,datasets:ds},options:{...opts,plugins:{legend:{display:true}}}}); }
    function renderMultiBar(id,l,ds,ax='x') { if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels:l,datasets:ds},options:{...opts,indexAxis:ax,plugins:{legend:{display:true}}}}); }

    // INIT
    setInterval(()=>{ const n=new Date(); const s=n.getHours().toString().padStart(2,'0')+":"+n.getMinutes().toString().padStart(2,'0'); if(document.getElementById('d-time')) document.getElementById('d-time').value=s; },1000);
    const today=new Date().toISOString().split('T')[0]; document.getElementById('i-date').value=today; document.getElementById('v-date').value=today; document.getElementById('d-date').value=today;
    window.downloadCSV = () => showToast("Download avviato...");
    window.resetArchiveFilters = () => renderIngressiArchive();
</script>

</body>
</html>
