<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Importante per mobile -->
<title>Stat CF Lampugnano - Advanced</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        /* LIGHT THEME DEFAULT */
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --bg-body: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #e9d5ff 100%);
        --text-main: #1e293b; 
        --text-muted: #475569;
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: 1px solid rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        --glass-blur: blur(12px);
        --sidebar-bg: rgba(15, 23, 42, 0.95);
        --input-bg: rgba(255,255,255,0.75);
        --input-border: rgba(255,255,255,0.8);
        --table-head-bg: rgba(255,255,255,0.9);
        --card-bg-solid: rgba(255,255,255,0.55);
    }

    /* DARK THEME VARS */
    [data-theme="dark"] {
        --bg-body: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #171717 100%);
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --glass-bg: rgba(30, 41, 59, 0.7);
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        --sidebar-bg: #020617;
        --input-bg: rgba(15, 23, 42, 0.6);
        --input-border: rgba(255,255,255,0.15);
        --table-head-bg: #1e293b;
        --card-bg-solid: rgba(30, 41, 59, 0.6);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg-body); 
        color: var(--text-main); 
        margin: 0; 
        display: flex; 
        height: 100vh; 
        overflow: hidden;
        transition: background 0.3s ease;
    }

    /* UTILITIES */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* TOAST */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: var(--glass-bg); backdrop-filter: blur(15px); border: var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 15px 25px; border-radius: 16px; color: var(--text-main); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: all 0.3s; pointer-events: auto; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { border-left: 5px solid #10b981; } .toast-error { border-left: 5px solid #ef4444; }

    /* SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.05); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 100; }
    .sidebar-header { padding: 30px 20px; font-size: 1.2rem; font-weight: 800; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .nav-section-title { padding: 25px 20px 10px; font-size: 0.7rem; text-transform: uppercase; color: #64748b; font-weight: 800; letter-spacing: 1.5px; }
    .nav-links { list-style: none; padding: 0 10px; margin: 0; }
    .nav-item { padding: 14px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.95rem; }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; transform: translateX(3px); }
    .nav-item.active { background: linear-gradient(90deg, var(--primary), var(--primary-dark)); color: #fff; box-shadow: 0 4px 15px rgba(37,99,235,0.3); border: 1px solid rgba(255,255,255,0.1); }
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
    
    /* MOBILE SIDEBAR OVERLAY */
    .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; backdrop-filter: blur(2px); }
    .mobile-toggle { display: none; position: absolute; top: 20px; left: 20px; z-index: 50; background: var(--primary); color: white; border: none; padding: 8px; border-radius: 8px; cursor: pointer; }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; background: transparent; }

    /* CONTROL BAR */
    .control-bar { background: var(--glass-bg); backdrop-filter: blur(15px); border-bottom: var(--glass-border); box-shadow: var(--glass-shadow); padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; transition: background 0.3s; position: relative; }
    .control-bar.editing { background: rgba(245, 158, 11, 0.15); border-bottom: 2px solid #f59e0b; }
    .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .cb-title { font-weight: 800; color: var(--text-main); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
    
    /* THEME TOGGLE */
    .theme-toggle { cursor: pointer; background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
    .theme-toggle:hover { background: rgba(255,255,255,0.1); }

    /* FORM ELEMENTS */
    .cb-row { display: flex; gap: 15px; align-items: flex-end; width: 100%; flex-wrap: wrap; }
    .inp-field { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
    .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inp-field input, .inp-field select { padding: 0 12px; border-radius: 12px; border: 1px solid var(--input-border); background: var(--input-bg); font-size: 0.9rem; height: 44px; color: var(--text-main); font-family: inherit; font-weight: 500; transition: all 0.2s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); width: 100%; }
    .inp-field input:focus, .inp-field select:focus { background: var(--glass-bg); border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
    
    /* TICKET BOXES */
    .group-tickets { display: flex; gap: 5px; flex: 1; background: rgba(255, 255, 255, 0.1); padding: 5px 8px; border-radius: 16px; border: 1px solid var(--glass-border); align-items: center; justify-content: space-between; height: 64px; min-width: 300px; }
    .t-box { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 40px; flex: 1; }
    .t-box label { font-size: 0.6rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
    .t-box input { width: 100%; text-align: center; font-weight: 800; color: var(--primary); font-size: 1.2rem; border: none; background: transparent; padding: 0; height: auto; }

    /* CONTENT AREA */
    .scroll-area { flex: 1; overflow-y: auto; padding: 25px; scroll-behavior: smooth; }
    .scroll-area::-webkit-scrollbar { width: 8px; }
    .scroll-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
    
    .glass-card { background: var(--card-bg-solid); backdrop-filter: var(--glass-blur); border-radius: 20px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; transition: transform 0.2s; }
    .glass-card:hover { transform: translateY(-2px); }

    /* BUTTONS */
    .btn { padding: 0 20px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; height: 44px; font-family: inherit; white-space: nowrap; color: var(--text-main); background: rgba(255,255,255,0.3); }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); border: none; }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-danger { background: rgba(220, 38, 38, 0.1); color: #ef4444; border: 1px solid rgba(220, 38, 38, 0.3); }
    .btn-danger:hover { background: #ef4444; color: white; }
    .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; }

    /* CHARTS & KPI */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .kpi-card { @extend .glass-card; background: var(--card-bg-solid); height: 130px; justify-content: center; }
    .kpi-val { font-size: 2.2rem; font-weight: 800; color: var(--text-main); line-height: 1; margin: 8px 0; }
    .chart-card { @extend .glass-card; height: 380px; }
    .chart-wrapper { position: relative; flex: 1; width: 100%; height: 100%; min-height: 0; }

    /* TABLE */
    .table-wrap { @extend .glass-card; padding: 0; overflow: hidden; display: flex; flex-direction: column; background: var(--glass-bg); max-height: 600px; }
    .table-container { overflow-x: auto; flex: 1; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    thead { position: sticky; top: 0; z-index: 5; } /* STICKY HEADER */
    th { text-align: left; padding: 18px 12px; background: var(--table-head-bg); font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
    td { padding: 12px; border-bottom: 1px solid rgba(128, 128, 128, 0.1); font-size: 0.9rem; vertical-align: middle; font-weight: 500; color: var(--text-main); }
    tr:hover td { background: rgba(128, 128, 128, 0.05); }

    /* LOADING SPINNER */
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* LOGIN */
    #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }

    /* MEDIA QUERIES */
    @media (max-width: 1024px) {
        .mobile-toggle { display: block; }
        .sidebar { position: fixed; height: 100%; transform: translateX(-100%); box-shadow: 2px 0 20px rgba(0,0,0,0.2); }
        .sidebar.open { transform: translateX(0); }
        .mobile-overlay.open { display: block; }
        .main-content { margin-left: 0; padding-top: 50px; }
        .control-bar { padding: 15px; }
        .charts-row-split { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <div style="margin-top:20px; font-weight:700; color:var(--text-main)">Caricamento...</div>
</div>

<div id="toast-container"></div>

<div class="mobile-overlay" onclick="toggleSidebar()"></div>
<button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>

<div id="login-screen">
    <div class="glass-card" style="width: 400px; text-align: center; padding: 40px;">
        <h2 style="color:var(--text-main); margin-bottom: 25px; font-weight: 900; font-size: 1.5rem;">üîê Accesso</h2>
        <div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div>
        <div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div>
        <button class="btn btn-primary" style="width:100%; font-size:1rem; height:48px;" onclick="doLogin()">Entra nel Gestionale</button>
        <p id="login-error" style="color:#dc2626; font-size:0.85rem; margin-top:20px; font-weight:600"></p>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>üèä‚Äç‚ôÇÔ∏è Facility Mgr</span>
        <button style="background:transparent; border:none; color:white; font-size:1.2rem; cursor:pointer" class="hidden" onclick="toggleSidebar()">√ó</button>
    </div>
    
    <div class="nav-section-title">Ingressi</div>
    <ul class="nav-links"><li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">üé´ Nuoto Libero</li></ul>
    
    <div class="nav-section-title">Impianto</div>
    <ul class="nav-links">
        <li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')">üíß Valori Vasca</li>
        <li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')">‚ö° Controllo DAE</li>
        <li class="nav-item" id="nav-module-utenze" onclick="switchModule('utenze')">üìä Utenze</li>
    </ul>

    <div class="sidebar-footer">
        <div style="font-size:0.85rem; margin-bottom:15px; color:#cbd5e1; font-weight:600; display:flex; align-items:center; gap:8px">
            <span style="width:8px; height:8px; background:#10b981; border-radius:50%"></span>
            <span id="user-display">User</span>
        </div>
        <button class="btn" style="width:100%; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-size:0.8rem; height:38px" onclick="doLogout()">Disconnetti</button>
    </div>
</div>

<div class="main-content">

    <!-- MODULE INGRESSI -->
    <div id="module-ingressi" class="module-container fade-in" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar" id="cb-ingressi">
            <div class="cb-header">
                <span class="cb-title" id="title-ingressi">Registrazione Ingressi</span>
                <div style="display:flex; gap:10px">
                    <button class="theme-toggle" onclick="toggleTheme()">üåó Tema</button>
                    <button class="btn btn-danger hidden" id="cancel-ingressi" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditIngressi()">Annulla Modifica</button>
                </div>
            </div>
            <div class="cb-row">
                 <div class="inp-field" style="flex:1.2; min-width:140px"><label>Data</label><input type="date" id="i-date"></div>
                 <div class="inp-field" style="flex:1.3"><label>Tipo Giorno</label>
                    <select id="i-type">
                        <option value="standard">üè¢ Standard</option>
                        <option value="festivo">üî¥ Festivo</option>
                        <option value="evento">üèÜ Gara/Evento</option>
                        <option value="maltempo">‚õàÔ∏è Maltempo</option>
                        <option value="extra">‚ö†Ô∏è Straordinario</option>
                    </select>
                </div>
                <div class="inp-field" style="flex:1.5"><label>Fascia</label>
                    <select id="i-fascia"><optgroup label="üèä Vasca Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="‚òÄÔ∏è Vasca Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
                </div>
                <div class="inp-field" style="flex:1.2"><label>Meteo</label>
                    <select id="i-meteo"><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="üî• Sole + Caldo">üî• Sole + Caldo</option><option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option><option value="üå¶Ô∏è Variabile">üå¶Ô∏è Variabile</option><option value="üå§Ô∏è Parz Nuvoloso">üå§Ô∏è Parz Nuvoloso</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option><option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option><option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option><option value="‚ùì N/D">‚ùì N/D</option></select>
                </div>
                <div class="group-tickets">
                    <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB. P.</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>ABB. 11</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                    <div class="t-box"><label>GRATIS</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
                </div>
                <div class="inp-field" style="flex:0.3; align-items:center; justify-content:center; min-width:60px">
                    <label style="cursor:pointer; color:#ef4444; font-size:0.7rem; text-align:center">No Stat<br><input type="checkbox" id="i-exclude" style="width:18px; height:18px; accent-color:#ef4444; margin-top:2px"></label>
                </div>
                <button id="btn-save-ingressi" class="btn btn-primary" style="height:44px; min-width:100px; flex:0.5" onclick="saveIngressi()">SALVA</button>
            </div>
        </div>

        <div class="scroll-area">
            <div style="display:flex; gap:10px; margin-bottom:20px; justify-content:center; flex-wrap:wrap">
                <button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button>
                <button class="btn" id="btn-sub-stats" onclick="switchSubView('stats')">Statistiche</button>
                <button class="btn" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button>
            </div>

            <!-- VIEW: OVERVIEW -->
            <div id="sub-overview">
                <div class="kpi-grid">
                    <div class="kpi-card glass-card"><div class="kpi-head">Media (Mese)</div><div class="kpi-val" id="ov-avg">0</div><div class="kpi-sub" style="color:var(--text-muted)">persone / giorno</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Vs Mese Prec.</div><div class="kpi-val" id="ov-mom">0%</div><div class="kpi-sub" id="ov-mom-label">-</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Vs Anno Prec.</div><div class="kpi-val" id="ov-yoy">0%</div><div class="kpi-sub" id="ov-yoy-label">-</div></div>
                    <div class="kpi-card glass-card"><div class="kpi-head">Stima Fine Mese</div><div class="kpi-val" id="ov-forecast" style="color:#a855f7">-</div><div class="kpi-sub">proiezione</div></div>
                </div>
                <div class="chart-card glass-card"><div class="cb-header">Andamento 30 Giorni</div><div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div></div>
            </div>

            <!-- VIEW: STATS -->
            <div id="sub-stats" class="hidden">
                 <div class="filter-row" style="display:flex; gap:10px; margin-bottom:20px; background:var(--card-bg-solid); padding:15px; border-radius:16px; align-items:flex-end; flex-wrap:wrap">
                     <div class="inp-field" style="width:160px"><label>Modalit√†</label><select id="stat-mode" onchange="toggleStatMode()"><option value="year">üìÖ Anno Intero</option><option value="custom">üìÜ Periodo Personalizz.</option></select></div>
                     <div class="inp-field" id="stat-year-cont" style="width:100px"><label>Anno</label><select id="stat-year" onchange="renderStats()"></select></div>
                     <div id="stat-custom-cont" class="hidden" style="display:flex; gap:10px">
                         <div class="inp-field" style="width:130px"><label>Dal</label><input type="date" id="stat-date-start"></div>
                         <div class="inp-field" style="width:130px"><label>Al</label><input type="date" id="stat-date-end"></div>
                         <button class="btn btn-primary" onclick="renderStats()">üîç</button>
                     </div>
                     <div class="inp-field" style="width:160px"><label>Confronta</label><select id="stat-compare" onchange="renderStats()"><option value="none">Nessuno</option><option value="avg">Media Storica</option></select></div>
                 </div>
                 <div class="chart-card glass-card" style="margin-bottom:20px"><div class="cb-header">Andamento Stagionale</div><div class="chart-wrapper"><canvas id="chartYoY"></canvas></div></div>
                 <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px">
                     <div class="chart-card glass-card"><div class="cb-header">Giorno Settimana</div><div class="chart-wrapper"><canvas id="chartWeek"></canvas></div></div>
                     <div class="chart-card glass-card"><div class="cb-header">Distribuzione</div><div class="chart-wrapper"><canvas id="chartPie"></canvas></div></div>
                 </div>
            </div>

            <!-- VIEW: ARCHIVE -->
            <div id="sub-archive" class="hidden">
                <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:15px; flex-wrap:wrap; background:var(--card-bg-solid); padding:15px; border-radius:15px">
                    <div class="inp-field" style="width:140px"><label>Dal</label><input type="date" id="arch-date-start" onchange="renderIngressiArchive()"></div>
                    <div class="inp-field" style="width:140px"><label>Al</label><input type="date" id="arch-date-end" onchange="renderIngressiArchive()"></div>
                    <button class="btn btn-primary" onclick="downloadCSV()">Scarica Excel</button>
                    <button class="btn btn-danger" onclick="resetArchiveFilters()">Reset</button>
                </div>
                <div class="table-wrap">
                    <div class="table-container">
                        <table id="table-ingressi"><thead><tr><th>Data</th><th>Dettaglio</th><th>Int.</th><th>Rid.</th><th>Abb.</th><th>Grat</th><th>Totale</th><th style="text-align:right">Azioni</th></tr></thead><tbody id="tbody-ingressi"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE VASCA -->
    <div id="module-vasca" class="module-container hidden fade-in" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar" id="cb-vasca">
            <div class="cb-header"><span class="cb-title" id="title-vasca">Valori Vasca</span><button class="theme-toggle" onclick="toggleTheme()">üåó Tema</button></div>
            <div class="cb-row">
                 <div class="inp-field" style="flex:1"><label>Data</label><input type="date" id="v-date"></div>
                 <div class="inp-field" style="flex:0.8"><label>Ora</label><input type="time" id="v-time"></div>
                 <div class="inp-field" style="flex:1"><label>Tipo</label><select id="v-type"><option value="interna">üè† Interna</option><option value="esterna">‚òÄÔ∏è Esterna</option></select></div>
                 <div class="group-tickets" style="flex:2">
                     <div class="t-box"><label>BAGN.</label><input type="number" id="v-bag" value="0"></div>
                     <div class="t-box"><label>T. ARIA</label><input type="number" step="0.1" id="v-ta" value="0"></div>
                     <div class="t-box"><label>T. H2O</label><input type="number" step="0.1" id="v-th" value="0"></div>
                     <div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div>
                     <div class="t-box"><label>CL L.</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div>
                     <div class="t-box"><label>CL C.</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div>
                     <div class="t-box"><label>CL TOT</label><input type="number" step="0.1" id="v-clt" value="0" readonly></div>
                 </div>
                 <button id="btn-save-vasca" class="btn btn-primary" onclick="saveVasca()">SALVA</button>
                 <button class="btn btn-danger hidden" id="cancel-vasca" onclick="cancelEditVasca()">X</button>
            </div>
        </div>
        <div class="scroll-area">
            <div class="table-wrap"><div class="table-container"><table id="table-vasca"><thead><tr><th>Data/Ora</th><th>Parametri Fisici</th><th>Chimica (pH/Cl)</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-vasca"></tbody></table></div></div>
        </div>
    </div>
    
    <!-- MODULE DAE/UTENZE (Structure Simplified for brevity, similar upgrade applied) -->
    <div id="module-dae" class="module-container hidden fade-in" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar">
             <div class="cb-header"><span class="cb-title">Controllo DAE</span><button class="theme-toggle" onclick="toggleTheme()">üåó Tema</button></div>
             <div class="cb-row">
                 <div class="inp-field"><label>Data</label><input type="date" id="d-date" readonly></div>
                 <div class="inp-field"><label>Ora</label><input type="text" id="d-time" readonly></div>
                 <div class="inp-field"><label>Stato</label><select id="d-status"><option value="OK">‚úÖ Funzionante</option><option value="GUASTO">‚ùå Guasto / Anomalie</option></select></div>
                 <div class="inp-field" style="flex:2"><label>Operatori (Ass. Bagnanti / Segreteria)</label><div style="display:flex; gap:5px"><input type="text" id="d-ass" placeholder="Assistente"><input type="text" id="d-op" placeholder="Segreteria"></div></div>
                 <button class="btn btn-primary" onclick="saveDae()">REGISTRA</button>
             </div>
        </div>
        <div class="scroll-area">
             <div class="table-wrap"><div class="table-container"><table id="table-dae"><thead><tr><th>Timestamp</th><th>Stato</th><th>Operatori</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-dae"></tbody></table></div></div>
        </div>
    </div>

    <div id="module-utenze" class="module-container hidden fade-in" style="display:flex; flex-direction:column; height:100%">
        <div class="control-bar" id="cb-utenze">
             <div class="cb-header"><span class="cb-title" id="title-utenze">Letture Utenze</span><button class="theme-toggle" onclick="toggleTheme()">üåó Tema</button></div>
             <div class="cb-row">
                 <div class="inp-field" style="max-width:140px"><label>Data</label><input type="date" id="u-date"></div>
                 <div class="inp-field"><label>Tipo</label><select id="u-type" onchange="toggleUtenzeMode()"><option value="‚ö° Elettricit√†">‚ö° Elettricit√†</option><option value="üíß Acqua">üíß Acqua (m¬≥)</option><option value="üî• Gas Metano">üî• Gas Metano (m¬≥)</option></select></div>
                 
                 <!-- Dynamic Fields -->
                 <div id="u-elec-input" style="display:contents">
                     <div class="inp-field"><label>F1</label><input type="number" id="u-a1" step="any"></div>
                     <div class="inp-field"><label>F2</label><input type="number" id="u-a2" step="any"></div>
                     <div class="inp-field"><label>F3</label><input type="number" id="u-a3" step="any"></div>
                     <div class="inp-field"><label>Meteo</label><select id="u-meteo"><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option></select></div>
                 </div>
                 <div id="u-single-input" class="inp-field hidden"><label>Lettura</label><input type="number" id="u-val" step="any"></div>
                 <div id="u-extra-gas" class="inp-field hidden" style="max-width:100px"><label>Temp Ext</label><input type="number" id="u-temp" placeholder="¬∞C"></div>
                 
                 <button id="btn-save-utenze" class="btn btn-primary" onclick="saveUtenze()">SALVA</button>
                 <button class="btn btn-danger hidden" id="cancel-utenze" onclick="cancelEditUtenze()">X</button>
             </div>
        </div>
        <div class="scroll-area">
            <div style="margin-bottom:20px; text-align:center">
                 <button class="btn btn-primary" id="btn-sub-u-overview" onclick="switchSubViewUtenze('overview')">Panoramica</button>
                 <button class="btn" id="btn-sub-u-charts" onclick="switchSubViewUtenze('charts')">Grafici</button>
                 <button class="btn" id="btn-sub-u-archive" onclick="switchSubViewUtenze('archive')">Archivio</button>
            </div>
            
            <div id="sub-u-overview">
                <div class="kpi-grid">
                    <div class="kpi-card glass-card" style="border-left:4px solid #eab308"><div class="kpi-head">Elettricit√† (Mese)</div><div class="kpi-val" id="u-kpi-elec-val">-</div><div class="kpi-sub" id="u-kpi-elec-sub"></div></div>
                    <div class="kpi-card glass-card" style="border-left:4px solid #3b82f6"><div class="kpi-head">Acqua (Mese)</div><div class="kpi-val" id="u-kpi-water-val">-</div><div class="kpi-sub" id="u-kpi-water-sub"></div></div>
                    <div class="kpi-card glass-card" style="border-left:4px solid #ef4444"><div class="kpi-head">Gas (Mese)</div><div class="kpi-val" id="u-kpi-gas-val">-</div><div class="kpi-sub" id="u-kpi-gas-sub"></div></div>
                </div>
            </div>
            <div id="sub-u-charts" class="hidden">
                <div class="chart-card glass-card" style="margin-bottom:20px"><div class="cb-header">Elettricit√†</div><div class="chart-wrapper"><canvas id="chartElec"></canvas></div></div>
                <div class="chart-card glass-card"><div class="cb-header">Gas & Acqua</div><div class="chart-wrapper"><canvas id="chartGas"></canvas></div></div>
            </div>
            <div id="sub-u-archive" class="hidden">
                 <div class="table-wrap"><div class="table-container"><table id="table-utenze"><thead><tr><th>Data</th><th>Elettricit√†</th><th>Acqua</th><th>Gas</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-utenze"></tbody></table></div></div>
            </div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// FIREBASE CONFIG (Mantenuto originale)
const firebaseConfig = { apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" };
const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

let dataIngressi=[], dataVasca=[], dataDae=[], dataUtenze=[]; 
let editIdIngressi=null, editIdVasca=null, editIdUtenze=null;
let charts = {};

// THEME LOGIC
window.toggleTheme = () => {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    // Refresh charts colors
    Object.values(charts).forEach(c => c.destroy());
    charts={};
    refreshCurrentView();
};
// Set initial theme
if(localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

// SIDEBAR LOGIC
window.toggleSidebar = () => {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.mobile-overlay').classList.toggle('open');
};

// DATE HELPERS
function getStrDate(d) { return d.toISOString().split('T')[0]; }

// UI HELPERS
window.showToast = (msg, type='success') => { 
    const c = document.getElementById('toast-container'); 
    const e = document.createElement('div'); 
    e.className = `toast toast-${type}`; 
    e.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> ${msg}`; 
    c.appendChild(e); 
    requestAnimationFrame(()=>e.classList.add('show')); 
    setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); 
};

// AUTH
window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('login-error').innerText = e.message; } };
window.doLogout = () => signOut(auth);
onAuthStateChanged(auth, (u) => { 
    document.getElementById('loader').style.opacity = '0';
    setTimeout(()=>document.getElementById('loader').classList.add('hidden'),500);
    
    if(u){ 
        document.getElementById('login-screen').classList.add('hidden'); 
        document.getElementById('user-display').innerText=u.email.split('@')[0]; 
        startListening(); 
    } else { 
        document.getElementById('login-screen').classList.remove('hidden'); 
    } 
});

// DATA LISTENING
function startListening() {
    try {
        onSnapshot(query(collection(db, "sessioni"), orderBy("date", "desc"), limit(2000)), (snap) => { 
            dataIngressi = snap.docs.map(d=>({id:d.id,...d.data()})); 
            populateStatFilters(); 
            if(!document.getElementById('module-ingressi').classList.contains('hidden')) refreshCurrentView(); 
        });
        onSnapshot(query(collection(db, "valori_vasca"), orderBy("date", "desc"), limit(500)), (snap) => { 
            dataVasca = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-vasca').classList.contains('hidden')) renderVasca(); 
        });
        onSnapshot(query(collection(db, "dae_log"), orderBy("date", "desc"), limit(200)), (snap) => { 
            dataDae = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-dae').classList.contains('hidden')) renderDae(); 
        });
        onSnapshot(query(collection(db, "utenze_log"), orderBy("date", "desc"), limit(4000)), (snap) => { 
            dataUtenze = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-utenze').classList.contains('hidden')) renderUtenze(); 
        });
    } catch(e) { console.error(e); }
}

// NAVIGATION
window.switchModule=(m)=>{ 
    document.querySelectorAll('.module-container').forEach(e=>e.classList.add('hidden')); 
    document.getElementById('module-'+m).classList.remove('hidden'); 
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
    document.getElementById('nav-module-'+m).classList.add('active'); 
    // Mobile close
    document.getElementById('sidebar').classList.remove('open');
    document.querySelector('.mobile-overlay').classList.remove('open');

    if(m==='ingressi')refreshCurrentView(); 
    if(m==='vasca')renderVasca(); 
    if(m==='dae')renderDae(); 
    if(m==='utenze')renderUtenze(); 
};
window.switchSubView=(s)=>{ ['overview','stats','archive'].forEach(v=>{ document.getElementById('sub-'+v).classList.add('hidden'); document.getElementById('btn-sub-'+v).classList.remove('btn-primary'); }); document.getElementById('sub-'+s).classList.remove('hidden'); document.getElementById('btn-sub-'+s).classList.add('btn-primary'); refreshCurrentView(); };
window.refreshCurrentView = () => { if(!document.getElementById('sub-overview').classList.contains('hidden')) renderOverview(); if(!document.getElementById('sub-stats').classList.contains('hidden')) renderStats(); if(!document.getElementById('sub-archive').classList.contains('hidden')) renderIngressiArchive(); };

// --- INGRESSI LOGIC ---
window.populateStatFilters = () => {
    const yS = document.getElementById('stat-year');
    if(yS.options.length > 0) return; // already populated
    const years = [...new Set(dataIngressi.map(d => new Date(d.date).getFullYear()))].sort().reverse();
    const curr = new Date().getFullYear();
    if(!years.includes(curr)) years.unshift(curr);
    years.forEach(y => yS.innerHTML += `<option value="${y}">${y}</option>`);
};

window.toggleStatMode = () => {
    const m = document.getElementById('stat-mode').value;
    document.getElementById('stat-year-cont').classList.toggle('hidden', m!=='year');
    document.getElementById('stat-custom-cont').classList.toggle('hidden', m!=='custom');
    renderStats();
};

// CHART HELPERS
const getChartColors = () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return {
        text: isDark ? '#94a3b8' : '#475569',
        grid: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
        primary: '#2563eb'
    };
};

function renderChart(id, type, labels, datasets) {
    if(charts[id]) charts[id].destroy();
    const ctx = document.getElementById(id);
    if(!ctx) return;
    const colors = getChartColors();
    
    charts[id] = new Chart(ctx, {
        type: type,
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
            },
            plugins: { legend: { labels: { color: colors.text } } }
        }
    });
}

// OVERVIEW RENDER
window.renderOverview = () => {
    if(!dataIngressi.length) return;
    const now = new Date();
    const monthPrefix = getStrDate(now).slice(0,7);
    const currData = dataIngressi.filter(d => d.date.startsWith(monthPrefix) && !d.excludeStats);
    
    const tot = currData.reduce((a,b)=>a+b.totale,0);
    const count = currData.length;
    const avg = count ? (tot/count).toFixed(0) : 0;
    document.getElementById('ov-avg').innerText = avg;
    
    // Forecast
    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    document.getElementById('ov-forecast').innerText = count ? ((tot/count)*daysInMonth).toFixed(0) : '-';

    // Chart 30gg
    const labels=[], data=[];
    for(let i=29; i>=0; i--){
        const d = new Date(); d.setDate(now.getDate()-i);
        const ds = getStrDate(d);
        labels.push(d.getDate()+'/'+(d.getMonth()+1));
        const entry = dataIngressi.find(x=>x.date===ds);
        data.push(entry ? entry.totale : 0);
    }
    renderChart('chartRecent30', 'line', labels, [{
        label: 'Ingressi', data: data, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.2)', fill: true, tension: 0.4
    }]);
};

// STATS RENDER
window.renderStats = () => {
    const mode = document.getElementById('stat-mode').value;
    let filtered = [];
    if(mode === 'year'){
        const y = document.getElementById('stat-year').value;
        filtered = dataIngressi.filter(d => d.date.startsWith(y) && !d.excludeStats);
    } else {
        const s = document.getElementById('stat-date-start').value;
        const e = document.getElementById('stat-date-end').value;
        if(s && e) filtered = dataIngressi.filter(d => d.date >= s && d.date <= e && !d.excludeStats);
    }
    
    // YoY (Semplificato per esempio)
    const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const mData = new Array(12).fill(0);
    filtered.forEach(d => mData[new Date(d.date).getMonth()] += d.totale);
    renderChart('chartYoY', 'bar', months, [{label: 'Totale', data: mData, backgroundColor: '#3b82f6'}]);
    
    // Week
    const days = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
    const wData = new Array(7).fill(0); const wCount = new Array(7).fill(0);
    filtered.forEach(d => { const day = new Date(d.date).getDay(); wData[day]+=d.totale; wCount[day]++; });
    const wAvg = wData.map((t,i) => wCount[i] ? t/wCount[i] : 0);
    renderChart('chartWeek', 'bar', days, [{label: 'Media Giornaliera', data: wAvg, backgroundColor: '#8b5cf6'}]);

    // Pie
    let t = { 'Int':0, 'Rid':0, 'Abb':0, 'Grat':0 };
    filtered.forEach(d => { t.Int+=d.int; t.Rid+=d.rid; t.Abb+=(d.abb_int+d.abb_rid); t.Grat+=d.grat; });
    if(charts['chartPie']) charts['chartPie'].destroy();
    charts['chartPie'] = new Chart(document.getElementById('chartPie'), {
        type: 'doughnut', data: { labels: Object.keys(t), datasets: [{ data: Object.values(t), backgroundColor: ['#3b82f6','#60a5fa','#a855f7','#94a3b8'] }] }, options: { plugins: { legend: { position:'right', labels: { color: getChartColors().text } } } }
    });
};

// ARCHIVE RENDER
window.renderIngressiArchive = () => {
    const s = document.getElementById('arch-date-start').value;
    const e = document.getElementById('arch-date-end').value;
    let f = dataIngressi;
    if(s) f = f.filter(d => d.date >= s);
    if(e) f = f.filter(d => d.date <= e);
    
    const tbody = document.getElementById('tbody-ingressi');
    tbody.innerHTML = f.length ? '' : '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted)">Nessun dato</td></tr>';
    
    f.forEach(d => {
        const dateFmt = d.date.split('-').reverse().join('/');
        const isExcl = d.excludeStats;
        const style = isExcl ? 'opacity:0.6; text-decoration:line-through' : '';
        tbody.innerHTML += `
            <tr style="${style}">
                <td style="font-weight:700">${dateFmt}</td>
                <td><div style="font-weight:bold">${d.fascia}</div><div style="font-size:0.8rem; color:var(--text-muted)">${d.meteo}</div></td>
                <td>${d.int}</td>
                <td>${d.rid}</td>
                <td>${d.abb_int + d.abb_rid}</td>
                <td>${d.grat}</td>
                <td style="font-weight:900; color:var(--primary)">${d.totale}</td>
                <td style="text-align:right">
                    <button class="btn btn-icon" onclick="editIngressi('${d.id}')">‚úèÔ∏è</button>
                    <button class="btn btn-icon" style="color:#ef4444" onclick="deleteDoc('sessioni','${d.id}')">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });
};

// CRUD INGRESSI
window.saveIngressi = async () => {
    const d = document.getElementById('i-date').value;
    if(!d) return showToast("Data mancante", "error");
    const p = {
        date: d, type: document.getElementById('i-type').value, fascia: document.getElementById('i-fascia').value,
        meteo: document.getElementById('i-meteo').value, excludeStats: document.getElementById('i-exclude').checked,
        int: +document.getElementById('q-intero').value, rid: +document.getElementById('q-ridotto').value,
        grat: +document.getElementById('q-gratuito').value, abb_int: +document.getElementById('q-abb-int').value,
        abb_rid: +document.getElementById('q-abb-rid').value
    };
    p.totale = p.int + p.rid + p.grat + p.abb_int + p.abb_rid;
    try {
        if(editIdIngressi) { await updateDoc(doc(db,"sessioni",editIdIngressi), p); cancelEditIngressi(); }
        else { await addDoc(collection(db,"sessioni"), p); document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0); }
        showToast("Salvato!");
    } catch(e) { showToast(e.message, "error"); }
};

window.editIngressi = (id) => {
    const d = dataIngressi.find(x=>x.id===id); if(!d) return;
    editIdIngressi=id;
    document.getElementById('i-date').value=d.date; document.getElementById('i-type').value=d.type||'standard';
    document.getElementById('i-fascia').value=d.fascia; document.getElementById('i-meteo').value=d.meteo;
    document.getElementById('i-exclude').checked=d.excludeStats||false;
    document.getElementById('q-intero').value=d.int; document.getElementById('q-ridotto').value=d.rid;
    document.getElementById('q-gratuito').value=d.grat; document.getElementById('q-abb-int').value=d.abb_int;
    document.getElementById('q-abb-rid').value=d.abb_rid;
    document.getElementById('title-ingressi').innerText="Modifica Riga";
    document.getElementById('cb-ingressi').classList.add('editing');
    document.getElementById('cancel-ingressi').classList.remove('hidden');
    window.scrollTo({top:0, behavior:'smooth'});
};
window.cancelEditIngressi = () => {
    editIdIngressi=null; document.getElementById('title-ingressi').innerText="Registrazione Ingressi";
    document.getElementById('cb-ingressi').classList.remove('editing');
    document.getElementById('cancel-ingressi').classList.add('hidden');
    document.querySelectorAll('#module-ingressi .t-box input').forEach(i=>i.value=0);
};

// VASCA LOGIC
window.renderVasca = () => {
    const t = document.getElementById('tbody-vasca'); t.innerHTML="";
    dataVasca.forEach(d => {
        const phStyle = (d.ph<6.8 || d.ph>7.6) ? 'color:#ef4444; font-weight:bold' : '';
        const clStyle = (d.cll<0.6 || d.cll>1.5) ? 'color:#ef4444; font-weight:bold' : '';
        t.innerHTML += `
            <tr>
                <td><b>${d.date.split('-').reverse().join('/')}</b><br><span style="color:var(--primary)">${d.time}</span> <small>${d.type==='interna'?'üè†':'‚òÄÔ∏è'}</small></td>
                <td>Bag: ${d.bag}<br>Aria: ${d.ta}¬∞ H2O: ${d.th}¬∞</td>
                <td>pH: <span style="${phStyle}">${d.ph}</span><br>Cl Lib: <span style="${clStyle}">${d.cll}</span> (Tot: ${d.clt})</td>
                <td style="text-align:right"><button class="btn btn-icon" onclick="editVasca('${d.id}')">‚úèÔ∏è</button><button class="btn btn-icon" style="color:#ef4444" onclick="deleteDoc('valori_vasca','${d.id}')">üóëÔ∏è</button></td>
            </tr>`;
    });
};
window.saveVasca = async () => {
    const d = document.getElementById('v-date').value;
    if(!d) return showToast("Data mancante", "error");
    const p = {
        date:d, time:document.getElementById('v-time').value, type:document.getElementById('v-type').value,
        bag: +document.getElementById('v-bag').value, ta: +document.getElementById('v-ta').value,
        th: +document.getElementById('v-th').value, ph: +document.getElementById('v-ph').value,
        cll: +document.getElementById('v-cll').value, clc: +document.getElementById('v-clc').value,
        clt: +document.getElementById('v-clt').value
    };
    try {
        if(editIdVasca) { await updateDoc(doc(db,"valori_vasca",editIdVasca), p); cancelEditVasca(); }
        else { await addDoc(collection(db,"valori_vasca"), p); }
        showToast("Valori salvati");
    } catch(e) { showToast(e.message,"error"); }
};
window.calcClTot = () => { document.getElementById('v-clt').value = ((+document.getElementById('v-cll').value||0) + (+document.getElementById('v-clc').value||0)).toFixed(2); };
window.editVasca = (id) => {
    const d = dataVasca.find(x=>x.id===id); if(!d)return; editIdVasca=id;
    document.getElementById('v-date').value=d.date; document.getElementById('v-time').value=d.time;
    document.getElementById('v-bag').value=d.bag; document.getElementById('v-ta').value=d.ta;
    document.getElementById('v-th').value=d.th; document.getElementById('v-ph').value=d.ph;
    document.getElementById('v-cll').value=d.cll; document.getElementById('v-clc').value=d.clc;
    document.getElementById('v-clt').value=d.clt;
    document.getElementById('cancel-vasca').classList.remove('hidden');
    document.getElementById('cb-vasca').classList.add('editing');
};
window.cancelEditVasca = () => { editIdVasca=null; document.getElementById('cancel-vasca').classList.add('hidden'); document.getElementById('cb-vasca').classList.remove('editing'); };

// GENERIC DELETE
window.deleteDoc = async (coll, id) => { if(confirm("Eliminare definitivamente?")) { await deleteDoc(doc(db,coll,id)); showToast("Eliminato"); } };

// UTENZE LOGIC (Simplified)
window.toggleUtenzeMode = () => {
    const t = document.getElementById('u-type').value;
    document.getElementById('u-elec-input').style.display = t.includes('Elettricit√†') ? 'contents' : 'none';
    document.getElementById('u-single-input').classList.toggle('hidden', t.includes('Elettricit√†'));
    document.getElementById('u-extra-gas').classList.toggle('hidden', !t.includes('Gas'));
};
window.renderUtenze = () => {
    const t = document.getElementById('tbody-utenze'); t.innerHTML="";
    // Raggruppamento per data (logica semplificata per visualizzazione)
    const grouped = {};
    dataUtenze.forEach(d => {
        if(!grouped[d.date]) grouped[d.date] = {e:null,w:null,g:null};
        if(d.type.includes('Elettricit√†')) grouped[d.date].e = d.val;
        if(d.type.includes('Acqua')) grouped[d.date].w = d.val;
        if(d.type.includes('Gas')) grouped[d.date].g = d.val;
    });
    Object.keys(grouped).sort().reverse().forEach(date => {
        const g = grouped[date];
        t.innerHTML += `<tr><td>${date.split('-').reverse().join('/')}</td>
        <td style="color:#eab308; font-weight:bold">${g.e ? g.e.toFixed(1) : '-'}</td>
        <td style="color:#3b82f6; font-weight:bold">${g.w ? g.w.toFixed(1) : '-'}</td>
        <td style="color:#ef4444; font-weight:bold">${g.g ? g.g.toFixed(1) : '-'}</td><td></td></tr>`;
    });
};
window.saveUtenze = async () => {
    const d = document.getElementById('u-date').value; const t = document.getElementById('u-type').value;
    let val = 0;
    let extra = {};
    if(t.includes('Elettricit√†')) {
        const a1=+document.getElementById('u-a1').value; const a2=+document.getElementById('u-a2').value; const a3=+document.getElementById('u-a3').value;
        val = a1+a2+a3; extra={a1,a2,a3,meteo:document.getElementById('u-meteo').value};
    } else {
        val = +document.getElementById('u-val').value;
        if(t.includes('Gas')) extra={temp:+document.getElementById('u-temp').value};
    }
    if(!d) return showToast("Data mancante","error");
    await addDoc(collection(db,"utenze_log"), {date:d, type:t, val, ...extra});
    showToast("Utenza salvata");
};
window.switchSubViewUtenze = (v) => {
     ['overview','charts','archive'].forEach(x => {
         document.getElementById('sub-u-'+x).classList.add('hidden');
         document.getElementById('btn-sub-u-'+x).classList.remove('btn-primary');
     });
     document.getElementById('sub-u-'+v).classList.remove('hidden');
     document.getElementById('btn-sub-u-'+v).classList.add('btn-primary');
     if(v==='archive') renderUtenze();
};

// EXPORT CSV FIX (BOM included)
window.downloadCSV = () => {
    const s = document.getElementById('arch-date-start').value;
    const e = document.getElementById('arch-date-end').value;
    let f = dataIngressi;
    if(s) f = f.filter(d => d.date >= s);
    if(e) f = f.filter(d => d.date <= e);
    
    if(!f.length) return showToast("Nessun dato", "error");
    let csv = "\uFEFFData;Tipo;Fascia;Meteo;Intero;Ridotto;Gratuito;Abbonamenti;Totale\n";
    f.forEach(r => {
        csv += `${r.date};${r.type};${r.fascia};${r.meteo};${r.int};${r.rid};${r.grat};${r.abb_int+r.abb_rid};${r.totale}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `report_${s||'inizio'}_${e||'fine'}.csv`;
    link.click();
};

// INIT
const today = new Date().toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
setInterval(()=>{ if(document.getElementById('d-time')) document.getElementById('d-time').value = new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}); }, 1000);

</script>
</body>
</html>
