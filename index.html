<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Stat CF Lampugnano</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        --primary: #2563eb;
        --bg-body: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #e9d5ff 100%);
        --text-main: #1e293b; --text-muted: #475569;
        --glass-bg: rgba(255, 255, 255, 0.45);
        --glass-border: 1px solid rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        --glass-blur: blur(12px);
        --sidebar-glass: rgba(15, 23, 42, 0.85);
    }

    * { box-sizing: border-box; outline: none; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden;
    }

    /* TOAST */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 40px rgba(37, 99, 235, 0.15); padding: 15px 25px; border-radius: 16px; color: var(--text-main); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transform: translateY(20px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { border-left: 5px solid #10b981; } .toast-error { border-left: 5px solid #ef4444; }

    /* SIDEBAR */
    .sidebar { width: 250px; background: var(--sidebar-glass); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-header { padding: 30px 20px; font-size: 1.1rem; font-weight: 700; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .nav-section-title { padding: 20px 20px 10px; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 800; letter-spacing: 1px; }
    .nav-links { list-style: none; padding: 0 10px; margin: 0; }
    .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: #cbd5e1; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 0.9rem; }
    .nav-item:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-item.active { background: linear-gradient(90deg, var(--primary), #4f46e5); color: #fff; box-shadow: 0 0 15px rgba(37,99,235,0.4); border: 1px solid rgba(255,255,255,0.2); }
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }

    /* CONTROL BAR */
    .control-bar { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); border-bottom: var(--glass-border); box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; transition: background 0.3s; }
    .control-bar.editing { background: rgba(254, 243, 199, 0.9); border-bottom: 2px solid #f59e0b; }
    .cb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .cb-title { font-weight: 800; color: var(--text-main); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
    
    /* CB-ROW BASE */
    .cb-row { display: flex; gap: 15px; align-items: flex-end; width: 100%; }
    #cb-utenze .cb-row { flex-wrap: wrap; }
    #cb-ingressi .cb-row { flex-wrap: nowrap; gap: 15px; }
    #cb-vasca .cb-row { flex-wrap: nowrap; gap: 15px; }
    
    /* INPUT FIELDS STANDARD */
    .inp-field { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    .inp-field label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inp-field input, .inp-field select { padding: 0 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); font-size: 0.9rem; height: 44px; color: var(--text-main); font-family: inherit; font-weight: 500; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); width: 100%; }
    .inp-field input:focus, .inp-field select:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
    .inp-locked { background: rgba(0,0,0,0.05) !important; color: #64748b !important; cursor: not-allowed; font-weight: 700; border: 1px solid rgba(0,0,0,0.1) !important; }
    
    /* MULTI SELECT CUSTOM */
    .ms-container { position: relative; }
    .ms-btn { width: 100%; height: 44px; background: rgba(255,255,255,0.65); border: 1px solid rgba(255,255,255,0.8); border-radius: 12px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #64748b; }
    .ms-dropdown { position: absolute; top: 105%; left: 0; width: 220px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 8px; z-index: 100; display: none; max-height: 250px; overflow-y: auto; }
    .ms-dropdown.show { display: block; }
    .ms-option { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: background 0.1s; }
    .ms-option:hover { background: #f1f5f9; }
    .ms-option input { width: 16px; height: 16px; accent-color: var(--primary); }
    .ms-option span { font-size: 0.85rem; color: var(--text-main); font-weight: 500; }

    /* GRUPPI DEL LAYOUT INGRESSI */
    .group-ctx { display: flex; gap: 10px; flex: 1.6; align-items: flex-end; min-width: 0; }
    .group-tickets { display: flex; gap: 5px; flex: 1; background: rgba(255, 255, 255, 0.35); padding: 5px 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); align-items: center; justify-content: space-between; height: 64px; }
    .group-actions { display: flex; align-items: flex-end; gap: 10px; flex: 0 0 auto; }
    .group-chem { display: flex; gap: 8px; flex: 2; background: rgba(255, 255, 255, 0.3); padding: 8px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); align-items: center; justify-content: space-between; height: 64px; }
    
    /* TICKET BOX */
    .t-box { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 40px; flex: 1; }
    .t-box label { font-size: 0.6rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; text-align: center; width: 100%; opacity: 0.8; letter-spacing: -0.5px; }
    .t-box input { width: 100%; text-align: center; font-weight: 800; color: var(--primary); font-size: 1.2rem; border: none; background: transparent; padding: 0; height: auto; font-family: inherit; }

    .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }
    .glass-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; }
    .page-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

    /* BUTTONS */
    .btn { padding: 0 24px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; height: 44px; font-family: inherit; white-space: nowrap; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
    .btn-danger { background: rgba(254, 202, 202, 0.4); color: #dc2626; border: 1px solid rgba(252, 165, 165, 0.5); }
    .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 10px; }

    /* FILTERS & MULTI-SELECT */
    .filter-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
    .filter-select { padding: 0 15px; border-radius: 12px; height: 40px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.65); }
    .benchmark-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.5); padding: 0 15px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.6); user-select: none; transition: all 0.2s; }
    .benchmark-toggle:hover { background: #fff; }
    .benchmark-toggle input { width: 18px; height: 18px; accent-color: #64748b; cursor: pointer; }
    .benchmark-toggle span { font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }

    /* KPI & CHARTS LAYOUT */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 25px; } /* Changed to 5 for YTD */
    .insight-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; } /* Changed to 4 for Forecast */
    .insight-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
    .kpi-card { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 20px; height: 130px; justify-content: center; background: rgba(255,255,255,0.55); display: flex; flex-direction: column; }
    .kpi-head { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
    .kpi-val { font-size: 2.4rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
    .kpi-sub { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .kpi-context { font-size: 0.75rem; color: #64748b; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.05); width: 100%; display: flex; justify-content: space-between; font-weight: 500; }
    
    .chart-card { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 25px; display: flex; flex-direction: column; height: 360px; }
    .chart-wrapper { position: relative; flex: 1; width: 100%; height: 100%; min-height: 0; overflow: hidden; }
    .charts-row-main { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; }
    .charts-row-split { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }

    /* TABLE */
    .table-wrap { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 0; overflow: hidden; display: flex; flex-direction: column; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { text-align: left; padding: 18px 12px; background: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.4); font-size: 0.9rem; vertical-align: middle; font-weight: 500; }
    tr:hover td { background: rgba(255,255,255,0.3); }
    tr.day-end td { border-bottom: 2px solid rgba(0,0,0,0.1) !important; }

    .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; backdrop-filter: blur(4px); }
    .badge-summer { background: rgba(255, 237, 213, 0.7); color: #ea580c; border: 1px solid rgba(253, 186, 116, 0.4); }
    .badge-std { background: rgba(219, 234, 254, 0.7); color: #2563eb; border: 1px solid rgba(147, 197, 253, 0.4); }
    .badge-ok { background: rgba(167, 243, 208, 0.7); color: #065f46; border: 1px solid rgba(16, 185, 129, 0.3); }
    .badge-ko { background: rgba(254, 202, 202, 0.7); color: #991b1b; border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge-evt { background: rgba(253, 224, 71, 0.7); color: #854d0e; border: 1px solid rgba(250, 204, 21, 0.4); }

    .col-detail { color: var(--text-muted); font-size: 0.85rem; text-align: center; }
    .col-subtot { font-weight: 700; text-align: center; background: rgba(255,255,255,0.2); }
    .col-total { font-weight: 900; color: var(--text-main); text-align: center; font-size: 1.1rem; }
    .bg-sub-blue { background-color: rgba(59, 130, 246, 0.05); }
    .bg-sub-purp { background-color: rgba(168, 85, 247, 0.05); }

    .hidden { display: none !important; }
    #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    #login-box { @extend .glass-card; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; box-shadow: var(--glass-shadow); border: var(--glass-border); padding: 40px; text-align: center; width: 400px; display: flex; flex-direction: column; }
    .archive-toolbar { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.4); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: var(--glass-border); flex-wrap: wrap; }
    .arch-input, .arch-select { height: 36px; padding: 0 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.9); font-size: 0.85rem; color: var(--text-main); font-weight: 600; }
    .trend-up { color: #16a34a; } .trend-down { color: #dc2626; }
</style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
    <div id="login-box" class="glass-card">
        <h2 style="color:var(--text-main); margin-bottom: 25px; font-weight: 900; font-size: 1.5rem;">üîê Accesso</h2>
        <div class="inp-field" style="margin-bottom:15px"><input type="email" id="email" placeholder="Email"></div>
        <div class="inp-field" style="margin-bottom:25px"><input type="password" id="password" placeholder="Password"></div>
        <button class="btn btn-primary" style="width:100%; font-size:1rem; height:48px;" onclick="doLogin()">Entra nel Gestionale</button>
        <p id="login-error" style="color:#dc2626; font-size:0.85rem; margin-top:20px; font-weight:600"></p>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">üèä‚Äç‚ôÇÔ∏è CF Lampugnano</div>
    <div class="nav-section-title">Ingressi</div>
    <ul class="nav-links"><li class="nav-item active" id="nav-module-ingressi" onclick="switchModule('ingressi')">üé´ Nuoto Libero</li></ul>
    <div class="nav-section-title" style="margin-top:20px">Impianto</div>
    <ul class="nav-links">
        <li class="nav-item" id="nav-module-vasca" onclick="switchModule('vasca')">üíß Valori Vasca</li>
        <li class="nav-item" id="nav-module-dae" onclick="switchModule('dae')">‚ö° Controllo DAE</li>
        <li class="nav-item" id="nav-module-utenze" onclick="switchModule('utenze')">üìä Utenze</li>
    </ul>
    <div class="sidebar-footer">
        <div style="font-size:0.85rem; margin-bottom:15px; color:#cbd5e1; font-weight:600" id="user-display">User</div>
        <button class="btn" style="width:100%; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-size:0.8rem; height:38px" onclick="doLogout()">Disconnetti</button>
    </div>
</div>

<div class="main-content">

<div id="module-ingressi" class="module-container" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-ingressi">
        <div class="cb-header">
            <span class="cb-title" id="title-ingressi">Registrazione Ingressi</span>
            <button class="btn btn-danger hidden" id="cancel-ingressi" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditIngressi()">Annulla Modifica</button>
        </div>
        <div class="cb-row">
            <div class="group-ctx">
                <div class="inp-field" style="flex:1.2"><label>Data</label><input type="date" id="i-date"></div>
                <div class="inp-field" style="flex:1.3"><label>Tipo Giorno</label>
                    <select id="i-type">
                        <option value="standard">üè¢ Standard</option>
                        <option value="festivo">üî¥ Festivo</option>
                        <option value="evento">üèÜ Gara/Evento</option>
                        <option value="maltempo">‚õàÔ∏è Maltempo</option>
                        <option value="extra">‚ö†Ô∏è Straordinario</option>
                    </select>
                </div>
                <div class="inp-field" style="flex:1.5"><label>Fascia</label>
                    <select id="i-fascia"><optgroup label="üèä Vasca Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="‚òÄÔ∏è Vasca Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
                </div>
                <div class="inp-field" style="flex:1.2"><label>Meteo</label>
                    <select id="i-meteo"><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="üî• Sole + Caldo">üî• Sole + Caldo</option><option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option><option value="üå¶Ô∏è Variabile">üå¶Ô∏è Variabile</option><option value="üå§Ô∏è Parz Nuvoloso">üå§Ô∏è Parz Nuvoloso</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option><option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option><option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option><option value="‚ùì N/D">‚ùì N/D</option></select>
                </div>
                <div class="inp-field" style="flex:0.3; align-items:center; justify-content:center; padding-bottom:8px">
                    <label style="cursor:pointer; display:flex; flex-direction:column; align-items:center; color:#ef4444" title="Escludi">
                        <input type="checkbox" id="i-exclude" style="width:16px; height:16px; accent-color:#ef4444">
                        <span style="font-size:0.55rem; margin-top:2px; font-weight:800">NO MEDIA</span>
                    </label>
                </div>
            </div>

            <div class="group-tickets">
                <div class="t-box"><label>INTERO</label><input type="number" id="q-intero" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>RIDOTTO</label><input type="number" id="q-ridotto" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>ABB. PER.</label><input type="number" id="q-abb-int" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>ABB. 11</label><input type="number" id="q-abb-rid" value="0" onfocus="this.select()"></div>
                <div class="t-box"><label>GRATUITO</label><input type="number" id="q-gratuito" value="0" onfocus="this.select()"></div>
            </div>

            <div class="group-actions">
                <button id="btn-save-ingressi" class="btn btn-primary" style="height:44px; min-width:100px" onclick="saveIngressi()">SALVA</button>
            </div>
        </div>
    </div>

    <div class="scroll-area">
        <div class="filter-row" style="margin-bottom:20px; justify-content:center">
            <button class="btn btn-primary" id="btn-sub-overview" onclick="switchSubView('overview')">Panoramica</button>
            <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-stats" onclick="switchSubView('stats')">Statistiche</button>
            <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-archive" onclick="switchSubView('archive')">Archivio</button>
        </div>

        <div id="sub-overview">
            <div class="filter-row" style="margin-bottom:10px; justify-content:flex-end">
                <select id="ov-chart-type" class="filter-select" onchange="renderOverviewCharts()" style="font-weight:700; border:1px solid var(--primary); color:var(--primary)">
                    <option value="line">üìà Grafico a Linea</option>
                    <option value="bar">üìä Grafico a Colonne</option>
                </select>
            </div>
            
            <!-- TOP KPI GRID (5 COLUMNS) -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="kpi-card glass-card">
                    <div class="kpi-head">Ingressi Totali (Mese)</div>
                    <div class="kpi-val" id="ov-total-curr">0</div>
                    <div class="kpi-sub" id="ov-total-sub" style="color:#2563eb">in corso...</div>
                </div>
                <div class="kpi-card glass-card">
                    <div class="kpi-head">Media Giornaliera</div>
                    <div class="kpi-val" id="ov-avg">0</div>
                    <div class="kpi-sub" id="ov-avg-trend">-</div>
                </div>
                <div class="kpi-card glass-card">
                    <div class="kpi-head">Vs Mese Prec.</div>
                    <div class="kpi-val" id="ov-mom">0%</div>
                    <div class="kpi-sub" id="ov-mom-label">-</div>
                </div>
                <div class="kpi-card glass-card">
                    <div class="kpi-head">Vs Anno Prec.</div>
                    <div class="kpi-val" id="ov-yoy">0%</div>
                    <div class="kpi-sub" id="ov-yoy-label">-</div>
                </div>
                <!-- NEW YTD BOX INSTEAD OF FORECAST -->
                <div class="kpi-card glass-card">
                    <div class="kpi-head">Trend Anno (YTD)</div>
                    <div class="kpi-val" id="ov-ytd">0%</div>
                    <div class="kpi-sub" id="ov-ytd-label">vs anno prec.</div>
                </div>
            </div>
            
            <!-- HIGHLIGHTS GRID (4 COLUMNS NOW) -->
            <div class="insight-grid" style="grid-template-columns: repeat(4, 1fr);">
                <!-- BOX 1: ESTREMI (Record + Nero) -->
                <div class="kpi-card glass-card" style="height:140px; border-left:4px solid #f59e0b; justify-content:space-evenly">
                    <div class="kpi-head" style="color:#b45309">üìà Estremi Giornalieri</div>
                    
                    <!-- Record -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; width:100%">
                        <div>
                            <div style="font-size:0.7rem; color:#d97706; font-weight:700">üèÜ RECORD</div>
                            <div class="kpi-val" id="hl-record-val" style="font-size:1.5rem; margin:0">0</div>
                        </div>
                        <div class="kpi-sub" id="hl-record-date" style="font-size:0.8rem; color:#b45309; margin-bottom:5px">-</div>
                    </div>
                    
                    <div style="width:100%; height:1px; background:rgba(0,0,0,0.05); margin:5px 0"></div>

                    <!-- Nero -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; width:100%">
                        <div>
                            <div style="font-size:0.7rem; color:#b91c1c; font-weight:700">üìâ NERO</div>
                            <div class="kpi-val" id="hl-min-val" style="font-size:1.5rem; margin:0; color:#ef4444">-</div>
                        </div>
                        <div class="kpi-sub" id="hl-min-date" style="font-size:0.8rem; color:#7f1d1d; margin-bottom:5px">-</div>
                    </div>
                </div>

                <!-- BOX 2: PREFERENZE (Best + Worst) -->
                <div class="kpi-card glass-card" style="height:140px; border-left:4px solid #2563eb; justify-content:space-evenly">
                    <div class="kpi-head" style="color:#1d4ed8">üìÖ Analisi Settimanale</div>
                    
                    <!-- Best -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; width:100%">
                        <div>
                            <div style="font-size:0.7rem; color:#1e40af; font-weight:700">‚ù§Ô∏è PREFERITO</div>
                            <div class="kpi-val" id="hl-bestday-val" style="font-size:1.3rem; margin:0; color:#2563eb">-</div>
                        </div>
                        <div class="kpi-sub" id="hl-bestday-avg" style="font-size:0.8rem; color:#1e40af; margin-bottom:5px">Media: 0</div>
                    </div>

                    <div style="width:100%; height:1px; background:rgba(0,0,0,0.05); margin:5px 0"></div>

                    <!-- Worst -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; width:100%">
                        <div>
                            <div style="font-size:0.7rem; color:#475569; font-weight:700">üíî MENO AMBITO</div>
                            <div class="kpi-val" id="hl-worstday-val" style="font-size:1.3rem; margin:0; color:#64748b">-</div>
                        </div>
                        <div class="kpi-sub" id="hl-worstday-avg" style="font-size:0.8rem; color:#475569; margin-bottom:5px">Media: 0</div>
                    </div>
                </div>

                <!-- BOX 3: METEO -->
                <div class="kpi-card glass-card" style="height:140px; border-left:4px solid #10b981; justify-content:center; align-items:center; text-align:center">
                    <div class="kpi-head" style="color:#047857; margin-bottom:10px">‚òÄÔ∏è Fattore Meteo</div>
                    <div class="kpi-val" id="hl-sun-pct" style="font-size:2.8rem; color:#10b981; line-height:1">0%</div>
                    <div class="kpi-sub" style="font-size:0.85rem; color:#065f46; margin-top:5px">Giorni di Sole nel Mese</div>
                </div>

                <!-- BOX 4: FORECAST (MOVED HERE) -->
                <div class="kpi-card glass-card" style="height:140px; border-left:4px solid #a855f7; justify-content:center; align-items:center; text-align:center">
                    <div class="kpi-head" style="color:#7e22ce; margin-bottom:10px">Stima Fine Mese</div>
                    <div class="kpi-val" id="ov-forecast" style="font-size:2.8rem; color:#a855f7; line-height:1">-</div>
                    <div class="kpi-sub" id="ov-forecast-sub" style="font-size:0.85rem; color:#7e22ce; margin-top:5px">proiezione</div>
                </div>
            </div>

            <div class="chart-card glass-card"><div class="chart-header">Andamento Ultimi 30 Giorni vs Anno Prec. (Intelligente)</div><div class="chart-wrapper"><canvas id="chartRecent30"></canvas></div></div>
            <div class="chart-card glass-card" style="margin-top:20px"><div class="chart-header">Ultimi 3 Mesi (90 gg)</div><div class="chart-wrapper"><canvas id="chartRecent90"></canvas></div></div>
            <div class="chart-card glass-card" style="margin-top:20px"><div class="chart-header">Andamento Ultimi 12 Mesi vs Anno Prec.</div><div class="chart-wrapper"><canvas id="chartRecent12M"></canvas></div></div>
        </div>

        <div id="sub-stats" class="hidden">
            <div class="filter-row" style="justify-content:space-between; align-items:flex-end; background:rgba(255,255,255,0.4); padding:15px; border-radius:16px; border:var(--glass-border)">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
                    <div class="inp-field" style="width:160px">
                        <label>Modalit√† Analisi</label>
                        <select id="stat-mode" onchange="toggleStatMode()" style="font-weight:700; border-color:var(--primary); color:var(--primary)">
                            <option value="year">üìÖ Anno Intero</option>
                            <option value="custom">üìÜ Periodo Personalizz.</option>
                        </select>
                    </div>
                    <div class="inp-field" id="stat-year-cont" style="width:100px">
                        <label>Anno</label>
                        <select id="stat-year" onchange="renderStats()" style="font-weight:700"></select>
                    </div>
                    <div id="stat-custom-cont" class="hidden" style="display:flex; gap:10px; align-items:flex-end">
                        <div class="inp-field" style="width:130px"><label>Dal</label><input type="date" id="stat-date-start"></div>
                        <div class="inp-field" style="width:130px"><label>Al</label><input type="date" id="stat-date-end"></div>
                        <button class="btn btn-primary" onclick="renderStats()" style="height:44px; padding:0 15px; font-size:1.1rem" title="Applica Filtro">üîé</button>
                    </div>
                    
                    <div class="inp-field" style="width:180px; position:relative">
                        <label>Confronta con</label>
                        <div class="ms-container" id="ms-compare">
                            <div class="ms-btn" onclick="toggleMsDropdown()">Seleziona... ‚ñº</div>
                            <div class="ms-dropdown" id="ms-compare-list"></div>
                        </div>
                    </div>

                    <div class="inp-field" style="width:140px">
                        <label>Vasca</label>
                        <select id="stat-pool-filter" onchange="renderStats()" style="font-weight:700">
                            <option value="all">üèä Tutte</option>
                            <option value="indoor">üè¢ Interna</option>
                            <option value="outdoor">‚òÄÔ∏è Esterna</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
                    <select id="stat-chart-type" class="filter-select" onchange="renderStats()" style="font-weight:700; border:1px solid var(--primary); color:var(--primary)">
                        <option value="line">üìà Linea</option>
                        <option value="bar">üìä Colonne</option>
                    </select>
                    <select id="day-type-filter" class="filter-select" onchange="renderStats()" style="font-weight:700; border:2px solid #a855f7; color:#6b21a8">
                        <option value="all">üìÖ Tutti i Giorni</option>
                        <option value="standard">üè¢ Solo Standard</option>
                        <option value="special">üèÜ Solo Eventi/Festivi</option>
                    </select>
                </div>
            </div>

            <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header" id="yoy-title">Andamento Stagionale</div><div class="chart-wrapper"><canvas id="chartYoY"></canvas></div></div></div>
            <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header">Performance Settimanale (Per Fascia)</div><div class="chart-wrapper" style="padding:0 15px"><canvas id="chartWeek"></canvas></div></div></div>
            <div class="charts-row-split">
                <div class="chart-card glass-card" style="justify-content:center; text-align:center">
                    <div class="chart-header" style="width:100%; text-align:left">Composizione (Periodo Selezionato)</div>
                    <div class="chart-wrapper" style="max-height:220px; display:flex; justify-content:center"><canvas id="chartPie"></canvas></div>
                    <div style="margin-top:auto; width:100%; padding-top:15px; border-top:1px solid rgba(0,0,0,0.05)">
                        <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; font-weight:700" id="pie-label-text">TOTALE PERIODO</div>
                        <div id="deep-total" style="color:var(--primary); font-size:1.8rem; font-weight:900">0</div>
                    </div>
                </div>
                <div class="chart-card glass-card"><div class="chart-header">Performance Meteo</div><div class="chart-wrapper"><canvas id="chartMeteo"></canvas></div></div>
            </div>
            <div class="charts-row-main"><div class="chart-card glass-card"><div class="chart-header">Popolarit√† Fasce Orarie</div><div class="chart-wrapper"><canvas id="chartFasce"></canvas></div></div></div>
        </div>

        <div id="sub-archive" class="hidden">
            <div class="archive-toolbar">
                <div class="arch-group"><span class="arch-label">DA:</span><input type="date" id="arch-date-start" class="arch-input" onchange="renderIngressiArchive()"></div>
                <div class="arch-group"><span class="arch-label">A:</span><input type="date" id="arch-date-end" class="arch-input" onchange="renderIngressiArchive()"></div>
                <select id="arch-filter-fascia" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutte le Fasce</option><optgroup label="Interna"><option value="Mattina">Mattina</option><option value="Mattina intera">Mattina intera</option><option value="Pranzo">Pranzo</option><option value="Sera">Sera</option><option value="Sabato pom">Sabato pom</option><option value="Domenica">Domenica</option><option value="Festivo">Festivo</option><option value="Unico">Unico</option></optgroup><optgroup label="Esterna"><option value="Estiva - Mattina">Estiva - Mattina</option><option value="Estiva - Pomeriggio">Estiva - Pomeriggio</option><option value="Estiva - Unico">Estiva - Unico</option></optgroup></select>
                <select id="arch-filter-meteo" class="arch-select" onchange="renderIngressiArchive()"><option value="all">Tutto il Meteo</option><option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option><option value="üî• Sole + Caldo">üî• Sole + Caldo</option><option value="‚ùÑÔ∏è Sole + Freddo">‚ùÑÔ∏è Sole + Freddo</option><option value="üå¶Ô∏è Variabile">üå¶Ô∏è Variabile</option><option value="üå§Ô∏è Parz Nuvoloso">üå§Ô∏è Parz Nuvoloso</option><option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option><option value="üå•Ô∏è Nuv + Freddo">üå•Ô∏è Nuv + Freddo</option><option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option><option value="üå®Ô∏è Piog + Freddo">üå®Ô∏è Piog + Freddo</option><option value="‚õàÔ∏è Temporale">‚õàÔ∏è Temporale</option><option value="‚ùì N/D">‚ùì N/D</option></select>
                <select id="arch-sort" class="arch-select" style="min-width:100px" onchange="renderIngressiArchive()"><option value="desc">‚¨áÔ∏è Recenti</option><option value="asc">‚¨ÜÔ∏è Vecchi</option></select>
                <button class="btn btn-danger" style="height:36px; width:36px; padding:0" onclick="resetArchiveFilters()">‚úï</button>
                <button class="btn btn-primary" style="height:36px; font-size:0.8rem; padding:0 20px" onclick="downloadCSV()">Scarica Excel</button>
            </div>
            <div class="table-wrap glass-card">
                <div style="overflow-x:auto;">
                    <table id="table-ingressi"><thead><tr><th>Data</th><th>Fascia / Meteo</th><th>Int.</th><th>Rid.</th><th>Singoli</th><th>Per.</th><th>11 Ingr.</th><th>Abb.</th><th>Grat</th><th>Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-ingressi"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="module-vasca" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-vasca">
        <div class="cb-header"><span class="cb-title" id="title-vasca">Registrazione Valori Vasca</span><button class="btn btn-danger hidden" id="cancel-vasca" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditVasca()">Annulla Modifica</button></div>
        <div class="cb-row">
            <div class="group-ctx" style="flex:1.2; align-items:flex-end; gap:10px">
                <div class="inp-field" style="flex:1"><label>Data</label><input type="date" id="v-date"></div>
                <div class="inp-field" style="flex:0.8"><label>Orario</label><input type="time" id="v-time"></div>
                <div class="inp-field" style="flex:1.2"><label>Vasca</label>
                    <select id="v-type">
                        <option value="interna">üè† Interna</option>
                        <option value="esterna">‚òÄÔ∏è Esterna</option>
                    </select>
                </div>
            </div>
            <div class="group-chem" style="flex:2">
                <div class="t-box"><label>BAGNANTI</label><input type="number" id="v-bag" value="0"></div>
                <div class="t-box"><label>T. ARIA</label><input type="number" step="0.1" id="v-ta" value="0"></div>
                <div class="t-box"><label>T. H2O</label><input type="number" step="0.1" id="v-th" value="0"></div>
                <div class="t-box"><label>pH</label><input type="number" step="0.1" id="v-ph" value="0"></div>
                <div class="t-box"><label>CL LIB.</label><input type="number" step="0.1" id="v-cll" value="0" oninput="calcClTot()"></div>
                <div class="t-box"><label>CL COMB.</label><input type="number" step="0.1" id="v-clc" value="0" oninput="calcClTot()"></div>
                <div class="t-box"><label>CL TOT.</label><input type="number" step="0.1" id="v-clt" value="0"></div>
            </div>
            <div class="group-actions"><button id="btn-save-vasca" class="btn btn-primary" style="height:44px; min-width:120px" onclick="saveVasca()">SALVA</button></div>
        </div>
    </div>
    <div class="scroll-area">
        <h2 class="page-title">üíß Diario Vasca</h2>
        
        <!-- NEW VASCA TOOLBAR -->
        <div class="archive-toolbar" style="margin-bottom: 15px; background: rgba(255,255,255,0.5);">
            <div class="arch-group"><span class="arch-label">Data:</span><input type="date" id="v-search-date" class="arch-input" onchange="renderVasca()"></div>
            <select id="v-search-type" class="arch-select" onchange="renderVasca()">
                <option value="all">üèä Tutte le Vasche</option>
                <option value="interna">üè† Interna</option>
                <option value="esterna">‚òÄÔ∏è Esterna</option>
            </select>
            <select id="v-search-alert" class="arch-select" onchange="renderVasca()" style="color:#b91c1c; font-weight:700">
                <option value="all" style="color:var(--text-main)">‚úÖ Tutti i Dati</option>
                <option value="alert">‚ö†Ô∏è Solo Anomalie</option>
            </select>
            <button class="btn btn-danger" style="height:36px; padding:0 15px" onclick="resetVascaFilter()">‚úï</button>
        </div>

        <div class="table-wrap glass-card"><div style="overflow-x:auto;"><table id="table-vasca"><thead><tr><th>Data</th><th>Ora / Vasca</th><th>Bagnanti</th><th>T. Aria</th><th>T. Acqua</th><th>pH</th><th>Cl Lib</th><th>Cl Comb</th><th>Cl Tot</th><th style="text-align:right"></th></tr></thead><tbody id="tbody-vasca"></tbody></table></div></div>
    </div>
</div>

<div id="module-dae" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar">
        <div class="cb-header"><span class="cb-title">Controllo Defibrillatore (DAE)</span></div>
        <div class="cb-row">
            <div class="group-ctx">
                <div class="inp-field" style="flex:0.5"><label>Data</label><input type="date" id="d-date" class="inp-locked" readonly></div><div class="inp-field" style="flex:0.5"><label>Ora Controllo</label><input type="text" id="d-time" class="inp-locked" readonly></div>
                <div class="inp-field" style="flex:0.8"><label>Stato</label><select id="d-status"><option value="OK">‚úÖ Funzionante</option><option value="GUASTO">‚ùå Guasto / Anomalie</option></select></div>
                <div class="inp-field" style="flex:1"><label>Assistente Bagnanti</label><input type="text" id="d-ass" placeholder="Nome Cognome"></div><div class="inp-field" style="flex:1"><label>Operatore Segreteria</label><input type="text" id="d-op" placeholder="Nome Cognome"></div>
            </div>
            <div class="group-actions"><button class="btn btn-primary" style="height:44px; min-width:120px" onclick="saveDae()">REGISTRA</button></div>
        </div>
    </div>
    <div class="scroll-area">
        <h2 class="page-title">‚ö° Registro Controlli DAE</h2>
        
        <!-- NEW DAE TOOLBAR -->
        <div class="archive-toolbar" style="margin-bottom: 15px; background: rgba(255,255,255,0.5);">
            <div class="arch-group">
                <span class="arch-label">Cerca Data:</span>
                <input type="date" id="d-search-date" class="arch-input" onchange="renderDae()">
            </div>
            <button class="btn btn-danger" style="height:36px; padding:0 15px" onclick="resetDaeFilter()">‚úï</button>
        </div>

        <div class="table-wrap glass-card">
            <div style="overflow-x:auto;">
                <table id="table-dae">
                    <thead><tr><th>Data</th><th>Ora</th><th>Stato</th><th>Assistente Bagnanti</th><th>Operatore Segreteria</th><th style="text-align:right"></th></tr></thead>
                    <tbody id="tbody-dae"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="module-utenze" class="module-container hidden" style="display:flex; flex-direction:column; height:100%">
    <div class="control-bar" id="cb-utenze">
        <div class="cb-header">
            <span class="cb-title" id="title-utenze">Registrazione Letture Utenze</span>
            <button class="btn btn-danger hidden" id="cancel-utenze" style="height:30px; font-size:0.7rem; padding:0 15px" onclick="cancelEditUtenze()">Annulla Modifica</button>
        </div>
        
        <div class="cb-row">
            <div class="inp-field" style="width:140px; flex:none;">
                <label>Data</label>
                <input type="date" id="u-date">
            </div>
            <div class="inp-field" style="flex:1;">
                <label>Tipo Utenza</label>
                <select id="u-type" onchange="toggleUtenzeMode()">
                    <option value="‚ö° Elettricit√†">‚ö° Elettricit√†</option>
                    <option value="üíß Acqua">üíß Acqua (m¬≥)</option>
                    <option value="üî• Gas Metano">üî• Gas Metano (m¬≥)</option>
                </select>
            </div>
            <div id="u-extra-elec-meteo" class="inp-field hidden" style="flex:1;">
                <label>Meteo Giornata</label>
                <select id="u-meteo">
                    <option value="‚òÄÔ∏è Sole">‚òÄÔ∏è Sole</option>
                    <option value="‚õÖ Variabile">‚õÖ Variabile</option>
                    <option value="‚òÅÔ∏è Nuvoloso">‚òÅÔ∏è Nuvoloso</option>
                    <option value="üåßÔ∏è Pioggia">üåßÔ∏è Pioggia</option>
                </select>
            </div>
            <div id="u-elec-input" style="display:contents;">
                <div class="inp-field" style="flex:1">
                    <label>A1 (F1)</label>
                    <input type="number" id="u-a1" step="any">
                </div>
                <div class="inp-field" style="flex:1">
                    <label>A2 (F2)</label>
                    <input type="number" id="u-a2" step="any">
                </div>
                <div class="inp-field" style="flex:1">
                    <label>A3 (F3)</label>
                    <input type="number" id="u-a3" step="any">
                </div>
            </div>
            <div id="u-single-input" class="inp-field hidden" style="flex:1;">
                <label>Lettura Contatore</label>
                <input type="number" id="u-val" placeholder="Es. 12500" step="any">
            </div>
            <div id="u-extra-gas" class="inp-field hidden" style="width:100px; flex:none;">
                <label>Temp. (¬∞C)</label>
                <input type="number" id="u-temp" placeholder="¬∞C" step="0.1">
            </div>
            <div class="inp-field" style="flex:1.5;">
                <label>Note</label>
                <input type="text" id="u-note" placeholder="Opzionale...">
            </div>
            <div style="width:120px; flex:none;">
                <button id="btn-save-utenze" class="btn btn-primary" style="height:44px; width:100%" onclick="saveUtenze()">SALVA</button>
            </div>
        </div>
    </div>

    <div class="scroll-area">
        <div class="filter-row" style="margin-bottom:20px; justify-content:center">
            <button class="btn btn-primary" id="btn-sub-u-overview" onclick="switchSubViewUtenze('overview')">Panoramica</button>
            <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-u-charts" onclick="switchSubViewUtenze('charts')">Grafici</button>
            <button class="btn" style="border:1px solid rgba(0,0,0,0.1)" id="btn-sub-u-archive" onclick="switchSubViewUtenze('archive')">Archivio</button>
        </div>

        <!-- Utenze Sub-View: Overview (KPI) -->
        <div id="sub-u-overview">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px">
                <h3 style="margin:0; font-size:1.1rem; color:var(--text-main)">üìÖ Confronto Mensile</h3>
                <input type="month" id="u-kpi-month-selector" class="filter-select" style="font-weight:700; background:rgba(255,255,255,0.8)" onchange="renderUtenze()">
            </div>

            <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 25px;">
                <div class="kpi-card glass-card" style="border-left: 4px solid #eab308">
                    <div class="kpi-head" id="u-kpi-elec-title">-</div>
                    <div class="kpi-val" id="u-kpi-elec-val">-</div>
                    <div class="kpi-sub" id="u-kpi-elec-sub">-</div>
                    <div class="kpi-context" id="u-kpi-elec-context"></div>
                </div>
                <div class="kpi-card glass-card" style="border-left: 4px solid #3b82f6">
                    <div class="kpi-head" id="u-kpi-water-title">-</div>
                    <div class="kpi-val" id="u-kpi-water-val">-</div>
                    <div class="kpi-sub" id="u-kpi-water-sub">-</div>
                    <div class="kpi-context" id="u-kpi-water-context"></div>
                </div>
                <div class="kpi-card glass-card" style="border-left: 4px solid #ef4444">
                    <div class="kpi-head" id="u-kpi-gas-title">-</div>
                    <div class="kpi-val" id="u-kpi-gas-val">-</div>
                    <div class="kpi-sub" id="u-kpi-gas-sub">-</div>
                    <div class="kpi-context" id="u-kpi-gas-context"></div>
                </div>
            </div>

            <div class="insight-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="kpi-card glass-card" style="height:110px; border-left:4px solid #eab308">
                    <div class="kpi-head" style="color:#a16207">‚ö° Consumi Estremi (Mese)</div>
                    <div style="display:flex; justify-content:space-between; width:100%; margin-top:5px; font-size:0.85rem; font-weight:600">
                        <div>Max: <span style="color:#a16207; font-weight:800" id="u-hl-elec-max">-</span></div>
                        <div style="color:#854d0e; font-size:0.75rem" id="u-hl-elec-max-date">-</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; width:100%; margin-top:2px; font-size:0.85rem; font-weight:600; border-top:1px solid rgba(0,0,0,0.05); padding-top:2px">
                        <div>Min: <span style="color:#10b981; font-weight:800" id="u-hl-elec-min">-</span></div>
                        <div style="color:#047857; font-size:0.75rem" id="u-hl-elec-min-date">-</div>
                    </div>
                </div>
                
                <!-- NEW BOX: LAST 24H VALUES -->
                <div class="kpi-card glass-card" style="height:110px; border-left:4px solid #8b5cf6">
                    <div class="kpi-head" style="color:#7c3aed">üïí Ultime 24 Ore</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px">
                        <div style="font-size:0.8rem; font-weight:600; color:#eab308">‚ö° <span id="u-last-elec">-</span></div>
                        <div style="font-size:0.7rem; color:#64748b" id="u-last-elec-date">-</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px; border-top:1px solid rgba(0,0,0,0.05); padding-top:2px">
                        <div style="font-size:0.8rem; font-weight:600; color:#3b82f6">üíß <span id="u-last-water">-</span></div>
                        <div style="font-size:0.7rem; color:#64748b" id="u-last-water-date">-</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px; border-top:1px solid rgba(0,0,0,0.05); padding-top:2px">
                        <div style="font-size:0.8rem; font-weight:600; color:#ef4444">üî• <span id="u-last-gas">-</span></div>
                        <div style="font-size:0.7rem; color:#64748b" id="u-last-gas-date">-</div>
                    </div>
                </div>

                <div class="kpi-card glass-card" style="height:110px; border-left:4px solid #ef4444">
                    <div class="kpi-head" style="color:#b91c1c">üî• Consumi Estremi (Mese)</div>
                    <div style="display:flex; justify-content:space-between; width:100%; margin-top:5px; font-size:0.85rem; font-weight:600">
                        <div>Max: <span style="color:#b91c1c; font-weight:800" id="u-hl-gas-max">-</span></div>
                        <div style="color:#7f1d1d; font-size:0.75rem" id="u-hl-gas-max-date">-</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; width:100%; margin-top:2px; font-size:0.85rem; font-weight:600; border-top:1px solid rgba(0,0,0,0.05); padding-top:2px">
                        <div>Min: <span style="color:#10b981; font-weight:800" id="u-hl-gas-min">-</span></div>
                        <div style="color:#047857; font-size:0.75rem" id="u-hl-gas-min-date">-</div>
                    </div>
                </div>
            </div>

            <div class="table-wrap glass-card" style="margin-top:25px">
                <h3 style="padding:15px 20px; margin:0; font-size:1rem; border-bottom:1px solid rgba(0,0,0,0.05)">üìÖ Riepilogo Mensile Consumi</h3>
                <div style="overflow-x:auto;">
                    <table id="table-utenze-monthly">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th style="color:#eab308">‚ö° Elettricit√† (kWh)</th>
                                <th style="color:#3b82f6">üíß Acqua (m¬≥)</th>
                                <th style="color:#ef4444">üî• Gas (m¬≥)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-utenze-monthly"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Utenze Sub-View: Charts -->
        <div id="sub-u-charts" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px">
                <h2 class="page-title" style="margin:0; font-size:1.3rem">üìä Analisi Utenze</h2>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                    <select id="u-range" class="filter-select" onchange="toggleUtenzeChartMode()" style="font-weight:700">
                        <option value="7">Ultimi 7 Giorni</option>
                        <option value="15">Ultimi 15 Giorni</option>
                        <option value="30">Ultimi 30 Giorni</option>
                        <option value="90">Ultimi 3 Mesi</option>
                        <option value="180">Ultimi 6 Mesi</option>
                        <option value="365">Ultimi 12 Mesi</option>
                        <option value="custom">üìÖ Periodo Personalizzato</option>
                    </select>
                    
                    <!-- NEW CUSTOM INPUTS -->
                    <div id="u-chart-custom-inputs" class="hidden" style="display:flex; gap:5px; align-items:center">
                        <input type="date" id="u-chart-start" class="filter-select" style="width:130px">
                        <input type="date" id="u-chart-end" class="filter-select" style="width:130px">
                        <button class="btn btn-primary" onclick="renderUtenze()" style="height:40px; padding:0 15px">OK</button>
                    </div>

                    <select id="u-view-mode" class="filter-select" onchange="renderUtenze()" style="border:2px solid var(--primary); color:var(--primary); font-weight:700">
                        <option value="delta">üìä Consumo (Delta)</option>
                        <option value="total">üìà Lettura (Totale)</option>
                    </select>
                    <label class="benchmark-toggle" style="height:40px">
                        <input type="checkbox" id="u-compare-year" onchange="renderUtenze()">
                        <span style="font-size:0.8rem">Confronta Anno Prec.</span>
                    </label>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:25px; margin-bottom:25px;">
                <div class="chart-card glass-card" style="height:300px; padding:15px">
                    <div class="chart-header" style="font-size:0.85rem; color:#eab308">‚ö° Elettricit√† (kWh) vs Meteo</div>
                    <div class="chart-wrapper"><canvas id="chartElec"></canvas></div>
                </div>
                <div class="chart-card glass-card" style="height:300px; padding:15px">
                    <div class="chart-header" style="font-size:0.85rem; color:#3b82f6">üíß Acqua (m¬≥)</div>
                    <div class="chart-wrapper"><canvas id="chartWater"></canvas></div>
                </div>
                <div class="chart-card glass-card" style="height:300px; padding:15px">
                    <div class="chart-header" style="font-size:0.85rem; color:#ef4444">üî• Gas (m¬≥) vs Temp. Esterna</div>
                    <div class="chart-wrapper"><canvas id="chartGas"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Utenze Sub-View: Archive -->
        <div id="sub-u-archive" class="hidden">
            <h2 class="page-title">üìù Storico Dettagliato</h2>
            <div class="archive-toolbar" style="margin-bottom: 15px; background: rgba(255,255,255,0.5);">
                <div class="arch-group"><span class="arch-label">Dal:</span><input type="date" id="u-hist-start" class="arch-input" onchange="renderUtenze()"></div>
                <div class="arch-group"><span class="arch-label">Al:</span><input type="date" id="u-hist-end" class="arch-input" onchange="renderUtenze()"></div>
                <select id="u-hist-sort" class="arch-select" onchange="renderUtenze()">
                    <option value="desc">‚¨áÔ∏è Pi√π Recenti</option>
                    <option value="asc">‚¨ÜÔ∏è Pi√π Vecchi</option>
                </select>
                <button class="btn btn-danger" style="height:36px; padding:0 15px" onclick="resetUtenzeHistory()">‚úï</button>
                <button class="btn btn-primary" style="height:36px; font-size:0.8rem; padding:0 20px" onclick="downloadUtenzeCSV()">Scarica Excel</button>
            </div>

            <div class="table-wrap glass-card">
                <div style="overflow-x:auto;">
                    <table id="table-utenze">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th style="color:#eab308; background:rgba(234, 179, 8, 0.1)">‚ö° Lettura Totale</th>
                                <th style="color:#eab308; background:rgba(234, 179, 8, 0.1)">F1 / F2 / F3</th>
                                <th style="color:#3b82f6; background:rgba(59, 130, 246, 0.1)">üíß Lettura Acqua</th>
                                <th style="color:#ef4444; background:rgba(239, 68, 68, 0.1)">üî• Lettura Gas</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-utenze"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCfXF61GUht7VPwkRTTiAn-nlhqEhDTW-0", authDomain: "piscinastats-64519.firebaseapp.com", projectId: "piscinastats-64519", storageBucket: "piscinastats-64519.firebasestorage.app", messagingSenderId: "297663099794", appId: "1:297663099794:web:edd9ffc2f7a90f7549c74b" };
const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
let dataIngressi=[], dataVasca=[], dataDae=[], dataUtenze=[]; let editIdIngressi=null, editIdVasca=null, editIdUtenze=null;
const isChartReady = () => typeof Chart !== 'undefined';

const FESTIVITA_FISSE = ["01-01", "06-01", "25-04", "01-05", "02-06", "15-08", "01-11", "08-12", "25-12", "26-12"];
function getDataConfronto(dataCorrente) {
    const m = String(dataCorrente.getMonth() + 1).padStart(2, '0');
    const d = String(dataCorrente.getDate()).padStart(2, '0');
    const chiaveData = `${d}-${m}`;
    const dataAnnoPrec = new Date(dataCorrente);
    if (FESTIVITA_FISSE.includes(chiaveData)) { dataAnnoPrec.setFullYear(dataCorrente.getFullYear() - 1); }
    else { dataAnnoPrec.setDate(dataCorrente.getDate() - 364); }
    return dataAnnoPrec;
}

// HELPERS DATE FIX - BULLETPROOF
function getStrDate(d) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

window.showToast = (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className = `toast toast-${type}`; e.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> ${msg}`; c.appendChild(e); requestAnimationFrame(()=>e.classList.add('show')); setTimeout(()=>{e.classList.remove('show');setTimeout(()=>e.remove(),300)},3000); };
window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('login-error').innerText = e.message; } };
window.doLogout = () => signOut(auth);
onAuthStateChanged(auth, (u) => { if(u){ document.getElementById('login-screen').classList.add('hidden'); document.getElementById('user-display').innerText=u.email.split('@')[0]; startListening(); } else { document.getElementById('login-screen').classList.remove('hidden'); } });

function startListening() {
    try {
        // IMPORTANT: Listeners must populate data arrays before calling init functions
        onSnapshot(query(collection(db, "sessioni"), orderBy("date", "desc"), limit(2000)), (snap) => { 
            dataIngressi = snap.docs.map(d=>({id:d.id,...d.data()})); 
            populateStatFilters(); 
            refreshCurrentView();
            if(dataUtenze.length > 0) renderUtenze(); // Re-render Utenze if ingressi arrive later
        });
        
        onSnapshot(query(collection(db, "valori_vasca"), orderBy("date", "desc"), limit(500)), (snap) => { 
            dataVasca = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-vasca').classList.contains('hidden')) renderVasca(); 
        });

        onSnapshot(query(collection(db, "dae_log"), orderBy("date", "desc"), limit(200)), (snap) => { 
            dataDae = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-dae').classList.contains('hidden')) renderDae(); 
        });

        onSnapshot(query(collection(db, "utenze_log"), orderBy("date", "desc"), limit(4000)), (snap) => { 
            dataUtenze = snap.docs.map(d=>({id:d.id,...d.data()})); 
            if(!document.getElementById('module-utenze').classList.contains('hidden')) renderUtenze(); 
        });
    } catch(e) { console.error(e); }
}

window.populateStatFilters = () => {
    if(!dataIngressi.length) return;
    const years = [...new Set(dataIngressi.map(d => new Date(d.date).getFullYear()))].sort().reverse();
    const yearSel = document.getElementById('stat-year');
    
    // FIX: Populate the main year selector options
    const currentVal = yearSel.value;
    yearSel.innerHTML = "";
    years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.innerText = y;
        yearSel.appendChild(opt);
    });

    // Multi-Select Logic (Replacing <select>)
    const msList = document.getElementById('ms-compare-list');
    msList.innerHTML = `<div class="ms-option"><input type="checkbox" value="avg" checked onchange="renderStats()"><span>üìä Media Storica</span></div>`;
    years.forEach(y => {
        msList.innerHTML += `<div class="ms-option"><input type="checkbox" value="${y}" onchange="renderStats()"><span>${y}</span></div>`;
    });

    const todayYear = new Date().getFullYear();
    if(currentVal && years.includes(parseInt(currentVal))) {
        yearSel.value = currentVal;
    } else if(years.includes(todayYear)) {
        yearSel.value = todayYear;
    } else {
        yearSel.value = years[0];
    }
    
    renderStats();
};

window.toggleMsDropdown = () => {
    document.getElementById('ms-compare-list').classList.toggle('show');
};

// Close dropdown when clicking outside
window.addEventListener('click', (e) => {
    if (!e.target.closest('.ms-container')) {
        document.getElementById('ms-compare-list').classList.remove('show');
    }
});

window.toggleStatMode = () => {
    const mode = document.getElementById('stat-mode').value;
    const yCont = document.getElementById('stat-year-cont');
    const cCont = document.getElementById('stat-custom-cont');
    if(mode === 'year') {
        yCont.classList.remove('hidden');
        cCont.classList.add('hidden');
    } else {
        yCont.classList.add('hidden');
        cCont.classList.remove('hidden');
        cCont.style.display = 'flex';
        if(!document.getElementById('stat-date-start').value) {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('stat-date-start').value = firstDay;
            document.getElementById('stat-date-end').value = lastDay;
        }
    }
    renderStats();
};

let ch={};
function renderDynamicChart(id, labels, datasets, type, isStacked=false) {
    if(!isChartReady()) return;
    if(ch[id]) ch[id].destroy();
    
    // Check for secondary axis usage in datasets
    const useSecondary = datasets.some(d => d.yAxisID === 'y1');

    const scalesConfig = { 
        y: { 
            beginAtZero: type==='bar', 
            stacked: isStacked,
            display: true,
            position: 'left'
        },
        x: { stacked: isStacked }
    };

    if(useSecondary) {
        scalesConfig.y1 = {
            beginAtZero: true,
            display: true,
            position: 'right',
            grid: { drawOnChartArea: false } // Only draw grid for main axis
        };
    }

    const isBar = type === 'bar';
    const optimizedDatasets = datasets.map(d => ({
        ...d,
        backgroundColor: d.backgroundColor ? d.backgroundColor : (isBar ? '#2563eb' : (d.fill ? d.borderColor + '20' : undefined)),
        borderWidth: d.borderWidth !== undefined ? d.borderWidth : (isBar ? 0 : 2),
        pointRadius: d.pointRadius !== undefined ? d.pointRadius : (isBar ? 0 : 3),
        type: d.type || type, 
        borderDash: isBar ? [] : (d.borderDash || []),
        tension: 0.4,
        parsing: { yAxisKey: 'y' }
    }));

    ch[id] = new Chart(document.getElementById(id), {
        type: type,
        data: { labels: labels, datasets: optimizedDatasets },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 13 },
                    bodyFont: { size: 13, weight: 'bold' },
                    callbacks: {
                        afterBody: function(context) {
                            const punto = context.find(c => c.raw);
                            if(!punto) return [];
                            if (punto.raw.refDate) {
                                const dRef = new Date(punto.raw.refDate);
                                const dStr = dRef.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                                return ['', '------------------', `Confrontato con:\n${dStr}`];
                            }
                            if (punto.raw.extraInfo) return ['', `üìù ${punto.raw.extraInfo}`];
                            return [];
                        }
                    }
                }
            },
            layout: { padding: 25 },
            scales: scalesConfig
        }
    });
}
function renderPie(id,l,d) { if(!isChartReady()) return; if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'doughnut',data:{labels:l,datasets:[{data:d,backgroundColor:['#2563eb','#60a5fa','#a855f7','#d8b4fe','#f59e0b','#ef4444'],borderWidth:0}]},options:{animation:false, responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{usePointStyle:true}}}}}); }
function renderMultiBar(id,l,ds,ax='x') { if(!isChartReady()) return; if(ch[id])ch[id].destroy(); ch[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels:l,datasets:ds},options:{animation:false, responsive:true,maintainAspectRatio:false,indexAxis:ax,plugins:{legend:{display:true}}}}); }

window.renderOverview = () => { renderOverviewKPI(); renderOverviewCharts(); }
function renderOverviewKPI() {
    if(!dataIngressi || dataIngressi.length === 0) return;
    const today = new Date();
    const currentMonthStr = today.toISOString().slice(0, 7);
    const pm = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const prevMonthStr = `${pm.getFullYear()}-${String(pm.getMonth()+1).padStart(2,'0')}`;
    const ym = new Date(today.getFullYear() - 1, today.getMonth(), 1);
    const yoyStr = `${ym.getFullYear()}-${String(ym.getMonth()+1).padStart(2,'0')}`;
    const currYear = today.getFullYear();
    const pm_month_name = pm.toLocaleString('it-IT',{month:'long'});
    const ym_year = ym.getFullYear();
    
    // 1. Filtro dati correnti (Mese)
    const dCurrent = dataIngressi.filter(x => x.date.startsWith(currentMonthStr) && !x.excludeStats);
    const totalCurrent = dCurrent.reduce((a,b)=>a+b.totale,0);
    const uniqueDays = new Set(dCurrent.map(x=>x.date));
    const daysCurrent = uniqueDays.size;

    // DETERMINAZIONE GIORNO MASSIMO (Progressive Month Day) - FIXED WITH STRING PARSING
    // If there are future data in the current month, maxDay advances to align comparison
    let maxDay = today.getDate();
    if (dCurrent.length > 0) {
        const days = dCurrent.map(x => parseInt(x.date.split('-')[2])); // Safe parsing
        const maxDataDay = Math.max(...days);
        if (maxDataDay > maxDay) maxDay = maxDataDay;
    }

    // 2. YoY Calculation (Mese Corrente vs Stesso Mese Anno Scorso)
    const dYoy = dataIngressi.filter(x => {
        const day = parseInt(x.date.split('-')[2]);
        return x.date.startsWith(yoyStr) && !x.excludeStats && day <= maxDay;
    });
    const totalYoy = dYoy.reduce((a,b)=>a+b.totale,0);

    // DISPLAY: Ingressi Totali
    document.getElementById('ov-total-curr').innerText = totalCurrent.toLocaleString();
    
    let totalYoyDiffHtml = '';
    // Always calculate diff, assuming 0 if no data
    let diffYoy = 0;
    if (totalYoy > 0) {
        diffYoy = ((totalCurrent - totalYoy) / totalYoy) * 100;
    } else if (totalCurrent > 0) {
        diffYoy = 100; // 0 to >0 is 100% growth (symbolic)
    } else {
        diffYoy = 0; // 0 vs 0
    }
    
    const colorYoy = diffYoy === 0 ? "#64748b" : (diffYoy > 0 ? "#16a34a" : "#dc2626"); 
    const signYoy = diffYoy > 0 ? "+" : "";
    totalYoyDiffHtml = `<span style="color:${colorYoy}; font-weight:700">${signYoy}${diffYoy.toFixed(1)}%</span> <span style="font-size:0.75rem; color:#64748b">vs ${ym_year}</span>`;
    
    document.getElementById('ov-total-sub').innerHTML = totalYoyDiffHtml;

    // DISPLAY: Media Giornaliera
    const avgCurrent = daysCurrent > 0 ? (totalCurrent/daysCurrent) : 0;
    document.getElementById('ov-avg').innerText = avgCurrent.toFixed(0);
    
    // Avg Comparison logic (Vs Media INTERO Mese Anno Precedente)
    const dYoyFullMonth = dataIngressi.filter(x => x.date.startsWith(yoyStr) && !x.excludeStats);
    const uniqueDaysYoyFull = new Set(dYoyFullMonth.map(x=>x.date)).size;
    const avgYoy = uniqueDaysYoyFull > 0 ? (dYoyFullMonth.reduce((a,b)=>a+b.totale,0) / uniqueDaysYoyFull) : 0;

    let avgTrendHtml = '-';
    // Always show vs avg, even if 0
    const diffAvg = avgCurrent - avgYoy;
    const colorAvg = diffAvg === 0 ? '#64748b' : (diffAvg > 0 ? '#10b981' : '#ef4444');
    const iconAvg = diffAvg > 0 ? '‚¨Ü' : (diffAvg < 0 ? '‚¨á' : '=');
    avgTrendHtml = `<span style="color:${colorAvg}; font-weight:700">${iconAvg} vs ${avgYoy.toFixed(0)}</span> <span style="font-size:0.7rem; color:#64748b">(${ym_year})</span>`;
    
    document.getElementById('ov-avg-trend').innerHTML = avgTrendHtml;
    
    // 3. Vs Mese Prec (MoM) partial comparison
    const dPrevPartial = dataIngressi.filter(x => {
        const day = parseInt(x.date.split('-')[2]);
        return x.date.startsWith(prevMonthStr) && !x.excludeStats && day <= maxDay;
    });
    const totalPrevPartial = dPrevPartial.reduce((a,b)=>a+b.totale,0);
    
    let momHtml = "";
    let diffMom = 0;
    if (totalPrevPartial > 0) {
        diffMom = ((totalCurrent - totalPrevPartial) / totalPrevPartial) * 100;
    } else if (totalCurrent > 0) {
        diffMom = 100;
    } else {
        diffMom = 0;
    }
    
    const colorMom = diffMom === 0 ? "#64748b" : (diffMom > 0 ? "#16a34a" : "#dc2626");
    const signMom = diffMom > 0 ? "+" : "";
    momHtml = `<span style="color:${colorMom}">${signMom}${diffMom.toFixed(1)}%</span>`;
    
    document.getElementById('ov-mom').innerHTML = momHtml;
    document.getElementById('ov-mom-label').innerText = `vs ${pm_month_name} (al ${maxDay})`;

    // 4. YoY (Month vs Prev Year Month)
    let yoyBoxHtml = "";
    // Reuse diffYoy calculated for the first box
    
    const colorYoyBox = diffYoy === 0 ? "#64748b" : (diffYoy > 0 ? "#16a34a" : "#dc2626");
    const signYoyBox = diffYoy > 0 ? "+" : "";
    yoyBoxHtml = `<span style="color:${colorYoyBox}">${signYoyBox}${diffYoy.toFixed(1)}%</span>`;

    document.getElementById('ov-yoy').innerHTML = yoyBoxHtml;
    document.getElementById('ov-yoy-label').innerText = `vs ${ym_year} (al ${maxDay})`;

    // 5. YTD Trend (Anno vs Anno Prec)
    // Fix YTD Limit Date: Use the max date available in the current year, OR today, whichever is greater
    // Actually, we should cap YTD at the last inserted data point of current year to be accurate.
    const allCurrentYearData = dataIngressi.filter(x => new Date(x.date).getFullYear() === currYear && !x.excludeStats);
    let limitYTD = new Date();
    if(allCurrentYearData.length > 0) {
        // Find max date
        const maxDateStr = allCurrentYearData.reduce((max, p) => p.date > max ? p.date : max, allCurrentYearData[0].date);
        limitYTD = new Date(maxDateStr);
    }
    
    // YTD Max Day of Year (DDD) calculation might be overkill, simpler is string comparison for YYYY-MM-DD
    // But since years differ, we need to compare MM-DD.
    const limitMonth = limitYTD.getMonth(); 
    const limitDayOfMonth = limitYTD.getDate();

    const totalYtdCurr = allCurrentYearData.reduce((a,b)=>a+b.totale,0);

    // Filtra Anno Precedente (YTD allineato)
    const prevYearVal = currYear - 1;
    
    const dYtdPrev = dataIngressi.filter(x => {
        const dt = new Date(x.date);
        if (dt.getFullYear() !== prevYearVal || x.excludeStats) return false;
        
        // Check if date is before or equal to limit (MM-DD)
        if (dt.getMonth() < limitMonth) return true;
        if (dt.getMonth() === limitMonth && dt.getDate() <= limitDayOfMonth) return true;
        return false;
    });
    const totalYtdPrev = dYtdPrev.reduce((a,b)=>a+b.totale,0);

    let ytdHtml = "";
    let diffYtd = 0;
    if (totalYtdPrev > 0) {
        diffYtd = ((totalYtdCurr - totalYtdPrev) / totalYtdPrev) * 100;
    } else if (totalYtdCurr > 0) {
        diffYtd = 100;
    } else {
        diffYtd = 0;
    }

    const colorYtd = diffYtd === 0 ? "#64748b" : (diffYtd > 0 ? "#16a34a" : "#dc2626");
    const signYtd = diffYtd > 0 ? "+" : "";
    ytdHtml = `<span style="color:${colorYtd}">${signYtd}${diffYtd.toFixed(1)}%</span>`;
    
    document.getElementById('ov-ytd').innerHTML = ytdHtml;
    document.getElementById('ov-ytd-label').innerText = `vs ${prevYearVal} (al ${limitYTD.getDate()}/${limitYTD.getMonth()+1})`;


    // 6. Forecast
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    if(daysCurrent > 0) { 
        document.getElementById('ov-forecast').innerText = ((totalCurrent / daysCurrent) * daysInMonth).toFixed(0); 
        document.getElementById('ov-forecast-sub').innerText = "proiezione";
    } else { document.getElementById('ov-forecast').innerText = "-"; }

    // --- HIGHLIGHTS LOGIC ---
    // 1. Aggreghiamo i dati per data
    const dailyTotals = {};
    const todayStrHighlights = getStrDate(new Date()); // Renamed to avoid confusion
    dCurrent.forEach(d => {
        if (!dailyTotals[d.date]) dailyTotals[d.date] = 0;
        dailyTotals[d.date] += d.totale;
    });
    const dailyArr = Object.keys(dailyTotals).map(date => ({ date: date, totale: dailyTotals[date] }));

    if(dailyArr.length > 0) {
        // Record Max
        const recordDay = dailyArr.reduce((prev, curr) => (prev.totale > curr.totale) ? prev : curr);
        const rd = new Date(recordDay.date);
        document.getElementById('hl-record-val').innerText = recordDay.totale;
        document.getElementById('hl-record-date').innerText = rd.toLocaleDateString('it-IT', {weekday:'short', day:'numeric'});

        // Minimo (No oggi, per evitare falsi positivi mentre si inseriscono i dati)
        // Se l'unico dato √® oggi, mostra quello.
        let dailyArrFinished = dailyArr.filter(d => d.date !== todayStrHighlights);
        if(dailyArrFinished.length === 0) dailyArrFinished = dailyArr; // Fallback

        if (dailyArrFinished.length > 0) {
            const minDay = dailyArrFinished.reduce((prev, curr) => (prev.totale < curr.totale) ? prev : curr);
            const md = new Date(minDay.date);
            document.getElementById('hl-min-val').innerText = minDay.totale;
            document.getElementById('hl-min-date').innerText = md.toLocaleDateString('it-IT', {weekday:'short', day:'numeric'});
        } else {
            document.getElementById('hl-min-val').innerText = "-";
            document.getElementById('hl-min-date').innerText = "Dati parziali";
        }

        // Day of Week Stats
        const dayCounts = {}; 
        dailyArr.forEach(d => {
            const dayIdx = new Date(d.date).getDay();
            if(!dayCounts[dayIdx]) dayCounts[dayIdx] = {sum:0, count:0};
            dayCounts[dayIdx].sum += d.totale;
            dayCounts[dayIdx].count++;
        });
        let bestDayIdx = -1; let maxAvg = -1; let worstDayIdx = -1; let minAvg = Infinity;
        Object.keys(dayCounts).forEach(k => {
            const avg = dayCounts[k].sum / dayCounts[k].count;
            if(avg > maxAvg) { maxAvg = avg; bestDayIdx = k; }
            if(avg < minAvg) { minAvg = avg; worstDayIdx = k; }
        });
        const daysMap = ['Domenica','Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato'];
        if(bestDayIdx !== -1) {
            document.getElementById('hl-bestday-val').innerText = daysMap[bestDayIdx];
            document.getElementById('hl-bestday-avg').innerText = `Media: ${maxAvg.toFixed(0)}`;
        }
        if(worstDayIdx !== -1) {
            document.getElementById('hl-worstday-val').innerText = daysMap[worstDayIdx];
            document.getElementById('hl-worstday-avg').innerText = `Media: ${minAvg.toFixed(0)}`;
        }

        // Fattore Meteo
        const sunnyCount = dCurrent.filter(d => d.meteo && (d.meteo.includes('Sole') || d.meteo.includes('Sereno') || d.meteo.includes('Caldo'))).length;
        const pct = (sunnyCount / dCurrent.length) * 100;
        document.getElementById('hl-sun-pct').innerText = pct.toFixed(0) + "%";

    } else {
        document.getElementById('hl-record-val').innerText = "-";
        document.getElementById('hl-min-val').innerText = "-";
        document.getElementById('hl-bestday-val').innerText = "-";
        document.getElementById('hl-worstday-val').innerText = "-";
        document.getElementById('hl-sun-pct').innerText = "-%";
    }
}
